
<html>
<head>
<link href="../lg.css" rel="stylesheet" type="text/css" media="screen, projection"  />
<link rel="shortcut icon" href="../favicon.ico" />
<title>Digital Television LG #118</title>

<style type="text/css" media="screen, projection">
<!--

-->
</style>

<link rel="alternate" type="application/rss+xml" title="LG RSS" href="lg.rss" />
<link rel="alternate" type="application/rdf+xml" title="LG RDF" href="lg.rdf" />
<link rel="alternate" type="application/atom+xml" title="LG Atom" href="lg.atom.xml" />

</head>

<body>


<img src="../gx/2003/newlogo-blank-200-gold2.jpg" id="logo" alt="Linux Gazette"/>
<p id="fun">...making Linux just a little more fun!</p>


<div class="content articlecontent">

<div id="previousnexttop">
<A HREF="huff.html" >&lt;-- prev</A> | <A HREF="savage.html" >next --&gt;</A>
</div>



<h1>Digital Television</h1>
<p id="by"><b>By <A HREF="../authors/knaggs.html">Peter Knaggs</A></b></p>

<p>
<p>Sorry to start off with such a bunch of alphabet soup, but it
seems unavoidable, when trying to make sense of the subject of
digital television. In the USA, terrestrial digital video
broadcasts are transmitted in <a href=
"http://en.wikipedia.org/wiki/8VSB" target=
"_top">8VSB-modulated</a> <a href=
"http://en.wikipedia.org/wiki/ATSC" target=
"_top">ATSC-encoded</a> <a href=
"http://en.wikipedia.org/wiki/MPEG-2" target="_top">MPEG-2</a>
transport streams, containing high-definition content in
progressive 720p (1280x720) and interlaced 1080i (1920x1080)
formats. I'm still not even sure what the official name for this
stuff is, so let's just call it HDTV.</p>

<h2><a name="So_How_Can_I_Get_This_HDTV_Stuff" id=
"So_How_Can_I_Get_This_HDTV_Stuff"></a> So How Can I Get This
HDTV Stuff?</h2>

<p>There are two aspects to consider. The first is your antenna,
and the second is the card to use in your Linux box. It may
strike you as unusual, in these modern times, for me to suggest
that the most economical way of upgrading the quality of your TV
reception is not to subscribe to some new-fangled "digital cable",
but rather to use an old-fashioned antenna, the kind you probably
used to have up on the roof of the house when you were a kid.</p>

<h3><a name="Antenna_Considerations" id=
"Antenna_Considerations"></a> Antenna Considerations</h3>

<p>
You can
check what sort of antenna you're likely to need by going to
<a href="http://www.antennaweb.com/" target="_top">Antenna
Web</a>, and also by looking up the particular stations you find
there in the <a href="http://www.fcc.gov/mb/video/tvq.html"
target="_top">FCC database</a>, to get an idea of their
transmission power (ERP) and height above the terrain (HAAT). The
FCC provide the antenna locations, in terms of latitude and
longitude. You can find the entire table of stations in <a href=
"http://www.fcc.gov/mb/video/files/" target="_top">this
directory</a>, in the following files: <a href=
"http://www.fcc.gov/mb/video/files/table1.pdf" target=
"_top">table1.pdf</a> <a href=
"http://www.fcc.gov/mb/video/files/table2.pdf" target=
"_top">table2.pdf</a> <a href=
"http://www.fcc.gov/mb/video/files/table2a.pdf" target=
"_top">table2a.pdf</a>. For example, doing a search for Zip code
CA94065, you'll find plenty of stations that can be received with
nothing more than a regular indoor TV antenna (i.e., a plain piece
of wire, nothing special). Since the digital TV transmitters tend
to have been installed on the same towers used by 
analog TV transmitters, apparently a fairly good indicator of
whether or not you'll be able to receive digital TV is to see
what sort of analog TV reception you currently get with just a
basic VHF antenna. If you can get even a few "snowy" channels
with analog TV, your chances are good for digital TV.

<h3><a name="The_PC_Card" id="The_PC_Card"></a> The PC
Card</h3>

<p>
As of March 2005, there seem to be only three HDTV cards
for use in Linux PCs, the <a href=
"DigitalTelevision.html#The_pcHDTV_Card" target=
"_top">pcHDTV</a>, the <a href=
"DigitalTelevision.html#The_Air2PC_card" target="_top">Air2PC</a>
card, and the <a href=
"http://www.itee.uq.edu.au/%7Echrisp/Linux-DVB/DVICO/" target=
"_top">FusionHDTV</a> card. I've tried the pcHDTV card.

<h3><a name="Initial_Results" id="Initial_Results"></a> Initial
Results</h3>

<p>
Back in March 2005, to get going and to see what the
pcHDTV card was capable of, I installed one pcHDTV HD-3000 card
into a <a href=
"http://www.penlug.org/twiki/bin/view/Main/LinuxHardwareInfoDellDimensionXPS"
target="_top">Dell Dimension XPS</a>, and one into an <a href=
"http://www.penlug.org/twiki/bin/view/Main/LinuxHardwareInfoAsusP4R8L"
target="_top">ASUS Barebone</a>. I installed the <a href=
"http://mysettopbox.tv/knoppmyth.html" target="_top">KnoppMyth
distribution</a> from <a href=
"http://hust.la/KnoppMyth/KnoppMythR512.iso" target=
"_top">KnoppMythR5A12</a>, then built and installed the <a href=
"http://www.pchdtv.com/downloads/xine-hd-0.8.tar.gz" target=
"_top">xine-hd sources</a> provided by pcHDTV on their
accompanying CD, and followed the advice in the very amazing,
accompanying three-page printed handout to use the command:

<pre>
dtvscan /dev/dtv &gt; $HOME/.xine/channels.atsc
</pre>

<p>
This created a file with the following contents (using only a
wire antenna):</p>

<pre>
KNTV-HD:      :11.1 :12: 4:0
NBC Wea:      :11.2 :12: 5:0
KNTV-HD:      :11.1 :12: 4:0
NBC Wea:      :11.2 :12: 5:0
KGO-DT :      : 7.1 :24: 3:0
KGO-DT :      : 7.2 :24: 4:0
KTSF D1:      :26.1 :27: 2:0
KTSF D2:      :26.2 :27: 3:0
KPIX DT:      : 5.1 :29: 1:0
KQED-HD:      : 9.1 :30: 3:0
ENCORE :      : 9.2 :30: 4:0
KMTP-DT:      :32.1 :33: 3:0
KCNS   :      :38.1 :39: 3:0
KCSM   :      :43.1 :43: 2:0
JazzTV :      :43.2 :43: 3:0
KBHK-DT:      :44.1 :45: 1:0
KSTS-DT:      :48.1 :49: 3:0
KNTV-DT:      :48.2 :49: 4:0
KTEH-DT:      :54.1 :50: 1:0
KDTV-DT:      :14.1 :51: 1:0
KICU-HD:      :36.1 :52: 3:0
:      :56.1 :56: 2:1
KRON-SD:      : 4.1 :57: 3:0
KRON-HD:      : 4.2 :57: 4:0
</pre>

<p>
After that, to view HDTV channels, it was only a matter of
configuring <code>xine-hd</code> to use the "xine-hd skin" (by
clicking on the little spanner, and, in the "gui" tab, selecting
"xine-hd" for the "gui skin theme" drop-down box), then launching
<code>xine-hd</code>, using:

<pre>
xine dtv://
</pre>

<p>
Recording is done by selecting the number from the second
numeric column corresponding to the channel. For example, to record
from KQED-HD, use the command:

<pre>
getatsc /dev/dtv0 30 &gt; filename.mpg
</pre>

<p>
To play back such recordings, just use either <a href=
"http://www.pchdtv.com/downloads/xine-hd-0.8.tar.gz" target="_top">
xine-hd</a> (which is a version of <a href="http://xinehq.de/"
target="_top">xine</a> patched by pcHDTV for viewing HDTV
streams) or <a href=
"http://www.mplayerhq.hu/homepage/design7/dload.html" target=
"_top">mplayer</a>. It seems that, oftentimes, multiple program
streams are recorded within the MPEG transport, due to the
transmitting station making use of <code>multicasting</code>.
Multicasting is a process whereby a station that is not
broadcasting in HDTV can provide multiple Standard DTV channels.
So what does that mean for us? Essentially, it means that we'll
need to read up in the manuals for our video playback tools, for
info on how to go about selecting the right program stream. For
mplayer, it turns out that the flag to use is
<code>-tsprog</code> followed by the program number. For xine,
use the channel number from the middle column followed by a dot,
followed by the stream number from the third column, and use this
with the uppercase <code>-C</code> flag &mdash; according to the pcHDTV
documentation. Depending on when you initiate the recording, one
or other stream may become the default stream played back by xine
or mplayer. For example, to playback substream number 3 from your
recording of channel 30 (KQED-HD in the list above), use the
following:

<pre>
xine -C 30.3 filename.mpg
mplayer -tsprog 3 filename.mpg
</pre>

<h4><a name="So_what_s_this_I_hear_about_surr" id=
"So_what_s_this_I_hear_about_surr"></a> So what's this I hear
about surround sound?</h4>

<p>
Some of the digital channels, for
example, KTVUHD (channel 56, program stream 3) and KPIX (channel
29, program stream 1), transmit audio using an A/52 5.1 channel
48000 Hz stream.

<p>
Essentially, this means that the audio stream contains five
regular audio channels (center, front left, front right, side
left, and side right) plus one low-frequency effects channel
(subwoofer). It's the same sort of audio stream commonly used for
DVD movies.

<p>
If you have an external audio decoder (for example, I tried this
using a Pioneer VSX-D711 receiver), and your <a href=
"http://www.penlug.org/twiki/bin/view/Main/LinuxHardwareInfoCreativeSoundblasterAudigy2"
target="_top">sound card</a> supports AC3 pass-through, then you
can simply connect up the digital output from the sound card to
the digital input of the receiver, and let the receiver do all
the work of decoding the audio.

<p>
To select AC3 pass-through with <code>xine</code>, just go into
setup, pick the <code>Audio</code> tab, and select <code>AC3
passthrough</code> from the list, then restart xine. Pressing
<code>Ctrl-I</code> in xine will show the info on the audio
stream you're tuned to, and, if it shows <code>A/52 5.1 48000
Hz</code>, then your receiver should indicate that it's decoding a
surround sound stream, usually by lighting up an indicator
displaying the message "Dolby Digital". Most channels transmit
audio in stereo, and <code>xine</code> will indicate this when
you press <code>Ctrl-I</code> with the message <code>A/52 2.0
(stereo) 48000 Hz</code>.

<p>
To get <code>mplayer</code> to do AC3 passthrough, use the
<code>-ao alsa -ac hwac3</code> flags, for example:

<pre>
mplayer -ao alsa -ac hwac3 -tsprog 3 filename.mpg
</pre>

<h4><a name="Is_there_a_command_line_tool_for" id=
"Is_there_a_command_line_tool_for"></a> Is there a command-line
tool for scheduling recordings?</h4>

<p>
<a href=
"http://www.nop.org/inkling/dtv/" target="_top">Inkling's
pchdtvr</a> is probably what you've been looking for. It's an
amazing console application.

<p>
Here's a screen shot of <code>pchdtvr</code> in action, showing
the program guide received from off-the-air:

<p>
<img src=
"http://www.penlug.org/twiki/pub/Main/DigitalTelevision/guide.png"
alt="Inkling's pchdtvr" height="404" width="661">

<p>
Because full ATSC streams eat up large amounts of disk space,
you'll be happy to see that Inkling's latest release, <a href=
"http://www.nop.org/inkling/dtv/pchdtvr-1.0-rc7.tar.bz2" target=
"_top">pchdtvr 1.0-rc7</a>, allows you to select which program
stream to record. Program streams are called Virtual Channels in
the ATSC spec. Inkling also developed <code>atscut</code>, which
you can use to cut out commercials and other junk from your
recordings, to save space and make them more convenient for later
viewing. It can also be used for far more than that, though.

<p>
With <code>pchdtvr</code> you can schedule recordings of specific
program streams using a timer.  E.g., to record channel 30 virtual
channel 3 (KQED-HD) for thirty minutes every Monday, use an entry
in your <code>/etc/pchdtvr.0.conf</code> like this:

<pre>
C30:KQED:PBS
T30:20:00:030:0100000:PBS.3
</pre>

<p>
If your machine is a Pentium 4, please turn off
hyperthreading in the BIOS, before recording using
<code>pchdtvr</code> on 2.6 kernels: I'm not sure yet why, but,
while running with hyperthreading enabled, the system would always
lock up shortly after <code>pchdtvr</code> started recording. With
hyperthreading turned off, everything works fine.

<p>
Now, with <a href=
"http://www.nop.org/inkling/dtv/pchdtvr-1.0-rc7.tar.bz2" target=
"_top">pchdtvr 1.0-rc7</a>, you can enable the use of GNU
<code>screen</code> using <code>pchdtvr -i0 -w</code>, so that,
when you run <code>pchdtvr</code> on the console, you'll still be
able to view it and control it from within X11, without worrying
about X11 crashing and messing up your recording session. Even if
X11 should happen to crash, the <code>screen</code> session will
still be running completely unaffected, and you'll be able to
re-attach to it and resume control using <code>pchdtvr -i0
-R</code>. It also allows you to conveniently control
<code>pchdtvr</code> remotely over <code>ssh</code>.

<h4><a name="Electronic_Program_Guide" id=
"Electronic_Program_Guide"></a> Electronic Program Guide</h4>

<p>
In case you've still not quite gotten around to setting up <a href=
"http://www.mythtv.org/" target="_top">MythTV</a>, Andy Balaam's
<a href="http://freeguide-tv.sourceforge.net/" target=
"_top">freeguide</a> is a nifty Java tool that can download XML
program guides, parse them, and display them in a nice
human-readable channel guide format. On Debian unstable,
<code>freeguide</code> is even available as a <a href=
"http://packages.debian.org/unstable/misc/freeguide.html" target=
"_top">package</a>. For the USA, <code>freeguide</code> will
download the program guides from Zap2it. You can create yourself
an account at <a href="http://labs.zap2it.com/" target=
"_top">Zap2it Labs</a>. The <code>freeguide</code> tool displays
the "Certificate Code" needed to create your Zap2it account, or,
if you prefer, you could use the Certificate Code from the
<a href="http://www.eff.org/broadcastflag/cookbook/guide.php"
target="_top">EFF's MythTV Guide</a>.

<h4><a name="These_ATSC_files_are_huge_Can_I" id=
"These_ATSC_files_are_huge_Can_I"></a> <a name=
"These_ATSC_files_are_huge_Can_I_" id=
"These_ATSC_files_are_huge_Can_I_"></a> These ATSC files are
huge. Can I squash them?</h4>

<p>
Recorded ATSC streams tend to have
the occasional error in them, and, for many video transcoding
tools, this causes them to error out, and stop. One method to get
around this is to use <code>mencoder</code> (from the
<code>mencoder-586</code> package). The following recipe seems to
work relatively reliably to compress single program-stream video
files recorded using <a href="http://www.nop.org/inkling/dtv/"
target="_top">Inkling's pchdtvr</a>, as described above. It uses
the <code>lavc mpeg4</code> codec, and does two-pass encoding at
a very high <code>5000</code> bitrate. This high bitrate is 
needed only if you really want to preserve the high resolution. To
determine the resolution of the stream you're viewing, use the
<code>Ctrl-I</code> key with <code>xine-hd</code>. This recipe
also preserves the original audio stream (which could be 5.1
channel), rather than compressing it using <code>lame</code> to
<code>mp3</code>. Some folks may not have <code>lame</code>
support built into their <code>mencoder</code>. Compressing the
audio to <code>mp3</code> at a low bitrate of <code>96kbps</code>
would provide quite significant space saving: see the
<code>mencoder</code> manual page for an explanation of the
options to use.

<pre>
mencoder -oac copy -ovc frameno -o frameno.avi ABC.3.ts

mencoder -sws 2 \
-oac copy \
-ovc lavc -lavcopts \
vcodec=mpeg4:vhq:vbitrate=5000:vpass=1 \
-vf pp=hb/vb/dr/al/lb  \
-vop scale=1280:720,crop=1280:720:0:0 -o ABC.3.avi ABC.3.ts

mencoder -sws 2 \
-oac copy \
-ovc lavc -lavcopts \
vcodec=mpeg4:vhq:vbitrate=5000:vpass=2 \
-vf pp=hb/vb/dr/al/lb  \
-vop scale=1280:720,crop=1280:720:0:0 -o ABC.3.avi ABC.3.ts
</pre>

<h4><a name="Extracting_the_audio_track" id=
"Extracting_the_audio_track"></a> Extracting the audio
track</h4>

<p>
Sometimes, the video itself is of little interest, but
the audio track is worth preserving. So far, the only way I've
found that works to extract the A52 audio stream from ATSC
recordings is to use mplayer's <code>-dumpaudio</code> flag. This
extracts the A52 audio channel (also known as AC3 audio) into a
file called <code>stream.dump</code>, suitable for processing
with <code>a52dec</code> and <code>lame</code> into an
<code>mp3</code>, as follows:

<pre>
mplayer -dumpaudio input.atsc
a52dec -o wav stream.dump | lame - output.mp3
</pre>

<p>Strangely, using <code>extract_a52</code>, as one would
normally expect to use for this purpose in place of <code>mplayer
-dumpaudio</code>, usually results in audio that plays at the
wrong speed. To hear what it sounds like, use:</p>

<pre>
mplayer -frames 0 input.atsc 2&gt;&amp;1 |grep "AUDIO A52"

# The mplayer output line we're interested in will look something like this:
#
#   VIDEO MPEG2(pid=49)...AUDIO A52(pid=52) NO SUBS (yet)!  PROGRAM N. 3
# 
# Convert the pid=52 into hex, and give it as "-t 0x34" parameter to extract_a52:

extract_a52 -t 0x34 input.atsc | a52dec -o wav | lame - output.mp3
</pre>

<h4><a name="Multiple_monitors" id="Multiple_monitors"></a>
Multiple monitors</h4>

<p>
Using two monitors at the same time turns
out to be very convenient when viewing digital TV, as your
primary monitor can be used for other stuff, while keeping the TV
output running on the secondary monitor. For recent ATI graphics
cards, I try to explain the required configurations <a href=
"http://www.penlug.org/twiki/bin/view/Main/LinuxHardwareInfoATIRadeonX800"
target="_top">here</a>. The way KDE makes the virtual desktops
twice as wide, when the <code>MergedFB</code> setting is used,
makes it possible to switch virtual desktops on one monitor while
leaving <code>xine</code> running on your other monitor, as long
as you right-click on xine and select the "To Desktop -&gt; All
Desktops" setting. That way, xine will still be there when you
switch desktops.

<h4><a name="Experience_with_various_Linux_dist" id=
"Experience_with_various_Linux_dist"></a> Experience with various
Linux distros</h4>

<p>
The pcHDTV drivers for the HD3000 card built
from the <a href=
"http://www.pchdtv.com/downloads/pcHDTV-1.6.tar.gz" target=
"_top">pcHDTV-1.6/kernel-2.6.x/driver</a> module sources work
with:

<ul>
<li>Debian Testing (installed from <a href=
"http://www.penlug.org/twiki/bin/view/Main/DebianSargeNetinst"
target="_top">Sarge Netinst</a>)</li>

<li>Novell SUSE Linux Desktop 9</li>

<li>Novell SUSE SLES-9 SP1, which has kernel 2.6.5-7.139.</li>

<li>Novell SUSE Linux 9.2 professional (the shrink-wrap bundle,
also installable by <a href=
"ftp://ftp.suse.com/pub/suse/i386/9.2/" target="_top">ftp</a>,
using SUSE's <a href=
"http://www.novell.com/products/linuxprofessional/downloads/ftp/eval.html"
target="_top">mini-installation boot CD</a>).</li>

<li>Fedora Core 3 (First remove the line <code>/sbin/modprobe
bttv</code> from the <code>minstall</code> script when building
the <code>pcHDTV-1.6/kernel-2.6.x/driver</code> modules for the
HD-3000 card, as otherwise the <code>cx8800</code> module won't
work properly).</li>

<li>Red Hat RHEL4, which has kernel 2.6.9-5.EL.</li>
</ul>I've tried the newer DVB drivers for the pcHDTV HD3000
card only with:

<ul>
<li>Debian Unstable, with kernel 2.6.12.3 (see below).</li>
</ul>

<h4><a name="The_Air2PC_card" id="The_Air2PC_card"></a> The
Air2PC card</h4>

<p>
According to <a href=
"http://mythtv.org/docs/mythtv-HOWTO-3.html#ss3.1" target=
"_top">the Myth TV project documentation</a>, the Air2PC is an
ATSC card manufactured by BBTI, which makes nothing but digital TV
capture cards. They are the maker of the SkyStar2 card (one of
the best DVB cards available for sale currently). It uses a 4th
generation NXT2002 demodulator. The Air2PC is supported by the
linuxtv-dvb driver set. Support for the pcHDTV cards has also
recently been added (see below). This driver set has been used
for many years, and is designed for Digital TV. The Air2PC driver
should be included in the 2.6.11 kernel, when it comes out. The
Air2PC supports hardware filtering of the transport stream, which
relieves the PCI bus of the entire transport stream, thus making
the burden on your computer less when recording. The Air2PC card
also supports QAM, which allows it to receive unencrypted digital
cable.

<p>ATSC is used for over-the-air (terrestrial) broadcast of TV,
as well as for most digital cable TV in North America (USA,
Canada, and Mexico).</p>

<p>The Air2PC card <em>cannot</em> be used to receive European DVB,
although it does use drivers that are commonly used for European
DVB, hence the confusion.</p>

<p>The Air2PC cannot work with a satellite receiver, because the
Air2PC only accepts 8VSB or QAM-modulated input. This means you
can hook up only a TV antenna or cable TV wire to the Air2PC and
get it to work. Satellite HDTV tends to use QPSK modulation,
rather than 8VSB or QAM modulation.</p>

<p>At the time of writing, March 2005, the Air2PC card was around
$169.95, although it is out of stock until July 2005. More
details may be found on the following pages: <a href=
"http://mythic.tv/product_info.php?products_id=33" target=
"_top">Mythic TV</a> and <a href=
"http://www.cyberestore.com/product_info.php?products_id=103"
target="_top">Cyberstore</a></p>

<h4><a name="The_pcHDTV_Card" id="The_pcHDTV_Card"></a> The
pcHDTV Card</h4>

<p>
The Linux folks at pcHDTV supply two HDTV cards
with Linux drivers, the HD-2000 and HD-3000 cards. The HD3000 is
an NTSC (analog capture) and ATSC (digital) card for HDTV in
North America. The HD3000 uses a 2nd generation Oren demodulator.
The HD3000 is supported by a modified bttv driver that will
probably not be included in the mainline Linux kernel, as well as
by the new DVB driver, which has been included starting from
kernel 2.6.12-rc1. The HD3000 does not support hardware filtering,
and the entire raw transport stream is sent over the PCI bus. The
HD3000 in theory could support QAM for digital cable, and there
have been some success reports on the pcHDTV forums of doing this
using the new DVB drivers. The HD-3000 card has one RF input, one
S-Video input, one Composite Video/Audio input, and one Stereo
Audio output for NTSC. The HD-3000 card is not a universal PCI
card. The HD-3000 card is a PCI 2.2-compliant 5-Volt card. That
means there may be motherboards (that accept only 3.3 Volt
cards) that the HD-3000 cannot be used with, so check that the
PCI slot on your mother-board has a 5V key/riser toward the
center of the motherboard and not a 3.3V-only key/riser toward
the connector-end of the motherboard.

<p>In March 2005, the HD3000 card was $169.98 plus shipping, with
a volume discount, e.g., you get a $9.96 discount if you buy two,
from <a href="http://www.pchdtv.com/" target="_top">pchdtv</a>.
<a href="http://mythic.tv/product_info.php?products_id=42"
target="_top">Mythic TV</a> also sells them at $172.50 with free
shipping.</p>

<p>For driver support, see the <a href=
"http://pchdtv.freedesktop.org/wiki/" target="_top">pcHDTV
HD-2000 and HD-3000 driver wiki</a>. There's also a fledgling
page on the <a href=
"http://www.linuxtv.org/wiki/index.php/PcHDTV" target=
"_top">LinuxTV Wiki</a>.</p>

<h4><a name="So_What_s_the_difference_between" id=
"So_What_s_the_difference_between"></a> So What's the difference
between the Air2PC card and the pcHDTV card?</h4>

<p>
There's a
comparison <a href=
"http://mythtv.beirdo.ca/wiki/index.php/FAQ#What_is_the_difference_between_the_air2pc_and_the_pchdtv_.28hd3000.29_Capture_Cards"
target="_top">here</a>.

<h4><a name="Video_Card_Considerations" id=
"Video_Card_Considerations"></a> Video Card
Considerations</h4>

<p>
Playback of HDTV streams uses quite a lot of
CPU resources. One possible way to get around the issue of HDTV
playback on slower machines is to use <code>XvMC</code> to
offload the MPEG-2 decoding task to the video card itself.
Apparently, some video cards support <code>XvMC</code>,
have <code>DVI</code> outputs, and work in Linux. For a more
in-depth discussion, check out the <a href=
"http://www.linuxis.us/linux/media/howto/linux-htpc/video.html"
target="_top">Linux HTPC HOWTO</a>.

<h4><a name="More_Antenna_Considerations" id=
"More_Antenna_Considerations"></a> More Antenna
Considerations</h4>

<p>
The frequencies for the channels used for ATSC
broadcasts tend to be higher, so the UHF antennas used for HDTV
reception tend to be physically a lot smaller than the VHF
antennas used for NTSC analog reception, because the wavelength
of the signal is shorter.

<p>If the signal strength at your location is high enough, you
may be able to receive HDTV just fine using a plain loop of wire
hooked up to a piece of coaxial feed line. To get an idea of the
frequencies corresponding to the mysterious FCC channel numbers,
refer to the following <a href=
"http://www.fcc.gov/oet/dtv/tvchfreq.html" target=
"_top">list</a>. This <a href=
"http://www.fcc.gov/oet/dtv/start/dtv2-69.txt" target=
"_top">list</a> of channels allotted by the FCC for digital
television may also be of interest. Either use the
<code>TAB</code> key followed by several presses on the
<code>w</code> key in <a href="http://www.nop.org/inkling/dtv/"
target="_top">Inkling's pchdtvr</a> to display the wavelength, or
use this handy little <a href="http://www.1728.org/freqwave.htm"
target="_top">calculator</a>. (Ideally, the antenna loop diameter
should match the wavelength of the channel you want to
receive.)</p>

<p>If you are planning to really go all-out and design an
antenna, it may be best to start by having a professional
spectrum analysis performed at your location. Most satellite
installation technicians will have the equipment to do this, and
it will help to know whether you need to consider multipathing
(reflections) of the received signals in your design.</p>

<h2><a name="Redistribution_Control_Descripto" id=
"Redistribution_Control_Descripto"></a> Redistribution Control
Descriptor</h2>

<p>
The Redistribution Control Descriptor, also known
as the broadcast flag, is described on page 79 of the <a href=
"http://www.atsc.org/standards/a_65b.pdf" target="_top">ATSC
Standard A_65B</a>. To check whether the transport stream you are
receiving has this 0xAA flag set, you can <a href=
"http://www.pchdtv.com/forum/viewtopic.php?t=560&amp;highlight=broadcast+flag"
target="_top">build</a> the <a href=
"http://www.itl.nist.gov/div895/cmr/dase/src/parser.tar.gz"
target="_top">NIST DASE ATSC/MPEG2 parser</a>, which will print
out <code>Content_Protect_Copy_Mngt_descr</code> when it sees the
0xAA flag set in the stream. Inkling's <a href=
"http://www.nop.org/inkling/dtv/" target="_top">pchdtvr</a>, now
at rc7, conveniently strips the RC flag from single VC captures,
and the <code>atscut</code> tool can display its setting and can
also strip the flag from existing captures. During capture,
<code>pchdtvr</code> indicates the RC flag's setting by causing
the packet statistics display <code>PMT</code> to turn an ominous
glowing red color. If statistics are not switched on, then the
presence of the RC flag is indicated by a red <code>R</code>
appearing in the bottom line of the display, to the left of the
<code>TEVM</code> summary display. For more info on the RC flag,
how it may affect your rights, and what you can do before the 1st
of July 2005 deadline, see the <a href=
"http://eff.org/broadcastflag/" target="_top">EFF</a>.

<p>
Update: The U.S. Court of Appeals in Washington <a href=
"http://pacer.cadc.uscourts.gov/docs/common/opinions/200505/04-1037b.pdf"
target="_top">ruled</a> in May 2005 that the FCC does not have
the authority to require manufacturers to implement the broadcast
flag.

<h2><a name="DVB_with_the_pcHDTV_HD3000" id=
"DVB_with_the_pcHDTV_HD3000"></a> DVB with the pcHDTV HD3000</h2>

<p>The DVB driver for the pcHDTV HD2000 and HD3000 card is now in
kernels 2.6.12-rc1 and up. This guide tries to explain the steps
to using this new DVB driver. The initial thread about DVB driver
support in kernel 2.6.12-rc1 in the pcHDTV forums is <a href=
"http://www.pchdtv.com/forum/viewtopic.php?t=645" target=
"_top">here</a>, and the Linuxtv folks also have <a href=
"http://www.linuxtv.org/wiki/index.php/PcHDTV" target=
"_top">this</a> page about it. But let's go slow, and I'll try to
explain all the steps in detail as best I can.</p>

<p>For a similar guide showing how to configure the <a href=
"DigitalTelevision.html#The_Air2PC_card" target="_top">Air2PC</a>
card, see <a href=
"http://www.rsmas.miami.edu/personal/angel/mythtv/air2pc-howto.html"
target="_top">here</a> instead.</p>

<h2><a name="Build_kernel_2_6_12_3" id=
"Build_kernel_2_6_12_3"></a> Build kernel 2.6.12.3</h2>

<p>
I built
<a href=
"http://www.kernel.org/pub/linux/kernel/v2.6/linux-2.6.12.3.tar.bz2"
target="_top">kernel 2.6.12.3</a>, downloaded on July 30,2005,
using <a href=
"http://www.penlug.org/twiki/pub/Main/DigitalTelevisionDVB/dot_config"
target="_top">this</a> <code>.config</code> file on <a href=
"http://www.penlug.org/twiki/bin/view/Main/LinuxHardwareInfoDellDimensionXPS"
target="_top">this</a> machine, and <a href=
"http://www.penlug.org/twiki/pub/Main/DigitalTelevisionDVB/bootmessages"
target="_top">booted</a> it with great optimism.

<p>The module to load for terrestrial digital HDTV (8VSB ATSC) is
<code>cx88-dvb</code>, and the module to load for analog NTSC is
<code>cx8800</code>. More on how to load the modules and what to
expect later, first let's look at what needs to be configured in
the kernel <code>.config</code> file to build them.</p>

<p>When compiling your kernel, <code>DVB_OR51132</code> needs to
be set to <code>"m"</code>. If that gives you the following
problem when you boot:</p>

<pre>
cx88_dvb: Unknown symbol cx22702_attach
</pre>

<p>
then it means you're missing the <code>DVB_CX22702</code>
from your <code>.config</code> file. Also,
<code>CONFIG_VIDEO_CX88</code> and
<code>CONFIG_VIDEO_CX88_DVB</code> both need to be set to
<code>"m"</code> for the analog (NTSC) driver <code>cx8800</code>
to be built.

<p>The config <code>make gconfig</code> graph goes like this:</p>

<pre>
Device-drivers -&gt;

Multimedia devices -&gt;

[-] Video for Linux -&gt;
Video for Linux -&gt;
Video Adapters
[-] Conexant 2388x (bt878 successor) support   (CONFIG_VIDEO_CX88=m)
[-] DVB support for cs2388x based TV Cards   (CONFIG_VIDEO_CX88_DVB=m)

Digital Video Broadcasting Devices -&gt;
[-] DVB for Linux                                (DVB=m)
[-] DVB Core Support                           (DVB_CORE=m)
Customise DVB Frontends -&gt;
[-] Conexant cx22702 demodulator (OFDM)    (DVB_CX22702=m)
[-] OR51132 based (pcHDTV HD3000 card)     (DVB_OR51132=m)

</pre>

<p>Build the kernel however you usually build your kernel. On
Debian, I used Manoj Srivastava's amazing <code>make-kpkg</code>
tool, as follows:</p>

<pre>
tar jxvf linux-2.6.12.3.tar.bz2
cd linux-2.6.12.3
make gconfig
fakeroot make-kpkg --initrd kernel_image modules_image
</pre>

<p>
This produces a file called
<code>kernel-image-2.6.12.3_10.00.Custom_i386.deb</code> in the
directory containing <code>linux-2.6.12.3</code> (i.e., the parent
directory). I installed it using <code>apt-get</code> as follows:

<pre>
apt-get install kernel-image-2.6.12.3_10.00.Custom_i386.deb
</pre>

<p>
During installation, the initial RAMdisk is created. The
contents of the <code>initrd.img-2.6.12.3</code> can be viewed by
loopback-mounting it, to check it has all the modules you expect or
to edit the <code>/mnt/test/loadmodules</code> script to change the
sequence the modules will be loaded in, as follows:

<pre>
mount -t cramfs -o loop initrd.img-2.6.12.3 /mnt/test
</pre>

<p>
For more details on how to decide which modules will be
included, and the order they'll be loaded, see <a href=
"http://www.edseek.com/archives/2004/03/22/creating-an-initrd-image-on-debian-gnulinux/"
target="_top">here</a>. If you need to remove the kernel package,
because you have rebuilt it and want to try with a new one, use:

<pre>
dpkg -r kernel-image-2.6.12.3
dpkg --purge kernel-image-2.6.12.3
</pre>

<p>
Probably all these details will seem excessive if you're
already familiar with Debian, but this is one the first kernels
I've built since I've been using Debian, so it's still fairly new
to me.

<h2><a name="Download_the_Firmware" id=
"Download_the_Firmware"></a> Download the Firmware</h2>

<p>
If you're
behind an HTTP application proxy firewall, set up your
<code>$HOME/.wgetrc</code> with your proxy as follows:

<pre>
http-proxy=http://your-proxy.your-domain:80
</pre>

<p>
Download the firmware using the scripts contained in the
Linux kernel sources <code>Documentation/dvb</code> directory,
e.g.:

<pre>
cd ~/linux-2.6.12.3/Documentation/dvb
perl ./get_dvb_firmware or51132_qam
perl ./get_dvb_firmware or51132_vsb
</pre>

<p>
You can also download the firmware files from <a href=
"http://www.pchdtv.com/downloads/firmware.tar.gz" target=
"_top">here</a> on the pcHDTV downloads page. Now copy the files
<code>dvb-fe-or51132-vsb.fw</code> and
<code>dvb-fe-or51132-qam.fw</code> to either
<code>/lib/firmware</code> or
<code>/usr/lib/hotplug/firmware/</code> (depending on your hotplug
version). For Debian, I copied them as follows:

<pre>
cp dvb-fe-or51132-vsb.fw /usr/lib/hotplug/firmware/
cp dvb-fe-or51132-qam.fw /usr/lib/hotplug/firmware/
</pre>

<p>Sometimes, even though the firmware is present in the correct
location, it still doesn't get uploaded by the hotplug system. If
this is the case for you, it may be because of the same problem
as described <a href=
"http://www.mail-archive.com/lfs-support@linuxfromscratch.org/msg01557.html"
target="_top">here</a> and <a href=
"http://www.pchdtv.com/forum/viewtopic.php?t=914" target=
"_top">here</a>.</p>

<p>The fix I used on Debian was to add the following line to my
<code>/etc/udev/udev.rules</code> file:</p>

<pre>
ENV{UDEVD_EVENT}=="1",   RUN+="/sbin/udev_run_hotplugd"
</pre>

<p>I then restarted <code>udev</code> using:</p>

<pre>
/etc/init.d/udev restart
</pre>

<h2><a name="Load_the_DVB_Kernel_module" id=
"Load_the_DVB_Kernel_module"></a> Load the DVB Kernel
module</h2>


<p>
To load the module for digital over-the-air 8VSB ATSC,
use the following sequence of commands. The reason for all the
"remove" commands is that, after a reboot, you may find that some
modules you don't want have been loaded. It's safest to
really clean things up, before loading the <code>cx88-dvb</code>
module, as follows:

<pre>
modprobe -rv cx88_blackbird
modprobe -rv cx88-dvb
modprobe -rv cx8800
modprobe -v cx88-dvb
</pre>

<p>This should cause the device directory
<code>/dev/dvb/adapter0</code> to appear. It should contain the
following devices: <code>demux0</code>, <code>dvr0</code>,
<code>frontend0</code> and <code>net0</code>. The list would be
as follows (this is for two pcHDTV HD3000 cards), showing the
major/minor numbers and permissions like this:</p>

<pre>
crw-rw----  1 root video 212, 4 2005-07-31 22:42 /dev/dvb/adapter0/demux0
crw-rw----  1 root video 212, 5 2005-07-31 22:42 /dev/dvb/adapter0/dvr0
crw-rw----  1 root video 212, 3 2005-07-31 22:42 /dev/dvb/adapter0/frontend0
crw-rw----  1 root video 212, 7 2005-07-31 22:42 /dev/dvb/adapter0/net0

crw-rw----  1 root video 212, 68 2005-07-31 22:42 /dev/dvb/adapter1/demux0
crw-rw----  1 root video 212, 69 2005-07-31 22:42 /dev/dvb/adapter1/dvr0
crw-rw----  1 root video 212, 67 2005-07-31 22:42 /dev/dvb/adapter1/frontend0
crw-rw----  1 root video 212, 71 2005-07-31 22:42 /dev/dvb/adapter1/net0
</pre>

<p>To unload the <code>cx88-dvb</code> driver (this also
conveniently unloads all of the modules it depends on), use:</p>

<pre>
modprobe -rv cx88-dvb
</pre>

<p>Output of the load command <code>modprobe -v cx88-dvb</code>
should be as follows:</p>

<pre>
insmod /lib/modules/2.6.12.3/kernel/drivers/media/dvb/frontends/dvb-pll.ko
insmod /lib/modules/2.6.12.3/kernel/drivers/media/dvb/frontends/cx22702.ko
insmod /lib/modules/2.6.12.3/kernel/drivers/media/video/video-buf.ko
insmod /lib/modules/2.6.12.3/kernel/drivers/media/dvb/dvb-core/dvb-core.ko
insmod /lib/modules/2.6.12.3/kernel/drivers/media/video/video-buf-dvb.ko
insmod /lib/modules/2.6.12.3/kernel/drivers/base/firmware_class.ko
insmod /lib/modules/2.6.12.3/kernel/drivers/media/dvb/frontends/or51132.ko
insmod /lib/modules/2.6.12.3/kernel/drivers/media/video/videodev.ko
insmod /lib/modules/2.6.12.3/kernel/drivers/media/video/tveeprom.ko
insmod /lib/modules/2.6.12.3/kernel/drivers/media/video/btcx-risc.ko
insmod /lib/modules/2.6.12.3/kernel/drivers/media/common/ir-common.ko
insmod /lib/modules/2.6.12.3/kernel/drivers/i2c/algos/i2c-algo-bit.ko
insmod /lib/modules/2.6.12.3/kernel/drivers/media/video/cx88/cx88xx.ko
insmod /lib/modules/2.6.12.3/kernel/drivers/media/dvb/frontends/mt352.ko
insmod /lib/modules/2.6.12.3/kernel/drivers/media/video/cx88/cx8802.ko
insmod /lib/modules/2.6.12.3/kernel/drivers/media/video/cx88/cx88-dvb.ko
</pre>

<p>Output of the unload command <code>modprobe -rv
cx88-dvb</code> should be as follows:</p>

<pre>
rmmod /lib/modules/2.6.12.3/kernel/drivers/media/video/cx88/cx88-dvb.ko
rmmod /lib/modules/2.6.12.3/kernel/drivers/media/video/cx88/cx8802.ko
rmmod /lib/modules/2.6.12.3/kernel/drivers/media/dvb/frontends/mt352.ko
rmmod /lib/modules/2.6.12.3/kernel/drivers/media/video/cx88/cx88xx.ko
rmmod /lib/modules/2.6.12.3/kernel/drivers/i2c/algos/i2c-algo-bit.ko
rmmod /lib/modules/2.6.12.3/kernel/drivers/media/common/ir-common.ko
rmmod /lib/modules/2.6.12.3/kernel/drivers/media/video/btcx-risc.ko
rmmod /lib/modules/2.6.12.3/kernel/drivers/media/video/tveeprom.ko
rmmod /lib/modules/2.6.12.3/kernel/drivers/media/video/videodev.ko
rmmod /lib/modules/2.6.12.3/kernel/drivers/media/dvb/frontends/or51132.ko
rmmod /lib/modules/2.6.12.3/kernel/drivers/base/firmware_class.ko
rmmod /lib/modules/2.6.12.3/kernel/drivers/media/video/video-buf-dvb.ko
rmmod /lib/modules/2.6.12.3/kernel/drivers/media/dvb/dvb-core/dvb-core.ko
rmmod /lib/modules/2.6.12.3/kernel/drivers/media/video/video-buf.ko
rmmod /lib/modules/2.6.12.3/kernel/drivers/media/dvb/frontends/cx22702.ko
rmmod /lib/modules/2.6.12.3/kernel/drivers/media/dvb/frontends/dvb-pll.ko
</pre>

<h2><a name="Using_the_DVB_kernel_modules" id=
"Using_the_DVB_kernel_modules"></a> Using the DVB kernel
modules</h2>

<p>
Get the latest <code>dvb-apps</code> from the
<a href="http://www.linuxtv.org/cvs.php" target="_top">linuxtv
CVS</a>, using:

<pre>
cvs -z3 -d ':pserver:anonymous@cvs.linuxtv.org:/cvs/linuxtv' co -P dvb-apps
</pre>

<p>
If you're behind an HTTP application proxy firewall, you'll
need to add the proxy to the command like this:

<pre>
cvs -z3 -d ':pserver;proxy=your-proxy.your-domain;proxyport=80:anonymous@cvs.linuxtv.org:/cvs/linuxtv' co -P dvb-apps
</pre>

<p>Some distributions include a <code>dvb-utils</code> package
that has <code>tzap</code>. Don't use <code>tzap</code>; it is
not a replacement for <code>azap</code>. If you can't find
<code>azap</code>, it probably means you have an old version of
the <code>dvb-apps</code>, so just build the
<code>dvb-apps</code> from CVS, and use them locally, as shown in
the examples here.</p>

<p>Build the <code>dvb-apps</code> by running <code>make</code>
in the top directory.</p>

<p>Go into the util/scan directory, and run the following
example:</p>

<pre>
cd dvb-apps/util/scan &amp;&amp; ./atscscan atsc/us-NTSC-center-frequencies-8VSB
</pre>

<p>The kernel module will try to load the firmware for the HD3000
card, at this point. Check your "dmesg" output. If you see this in
"dmesg", then the firmware isn't being uploaded by the hotplug
subsystem:</p>

<pre>
or51132: Waiting for firmware upload(dvb-fe-or51132-vsb.fw)...
or51132: No firmware uploaded(timeout or file not found?)
</pre>

<p>As described in the <a href="#Download_the_Firmware"
target="_top">section</a> above, even though the firmware is present in
the correct location, it may still not get uploaded by the hotplug
system.  Please try the fix described in that section.</p>

<p>Once the firmware loads successfully, <code>dmesg</code> will
show the following message:</p>

<pre>
or51132: Waiting for firmware upload(dvb-fe-or51132-vsb.fw)...
or51132: Version: 10001134-19430000 (113-4-194-3)
or51132: Firmware upload complete.
</pre>

<p>Once the firmware is loaded, the <code>atscscan</code> runs as
follows. The reason to include the <a href=
"http://www.penlug.org/twiki/pub/Main/DigitalTelevisionDVB/atscscan_output"
target="_top">full output</a> is to give an idea of what to
expect. This is for area code <code>94065</code> (for which the
<code>atsc/us-CA-SF-Bay-Area</code> file might be a better choice
for scanning with, but I didn't notice it until just now). Please
scroll on down to the end, where the summary of the run is
output: that's the part we use to make our
<code>$HOME/.azap/channels.conf</code> file, as it contains the
PIDs for the audio and video subchannels.</p>

<pre>
cd dvb-apps/util/scan &amp;&amp; ./atscscan atsc/us-NTSC-center-frequencies-8VSB
</pre>

<p>
The full output of the above command is <a href=
"http://www.penlug.org/twiki/pub/Main/DigitalTelevisionDVB/atscscan_output"
target="_top">here</a>, but only the summary section
<code>dumping lists</code> at the end is what we're interested
in:

<pre>
dumping lists (26 services)
KNTV-HD :207000000:8VSB:65:68:4
NBC Wea :207000000:8VSB:81:84:5
KBWB-HD :503000000:8VSB:49:52:3
KBWB-SD :503000000:8VSB:65:68:4
KGO-DT :533000000:8VSB:49:52:3
KGO-DT :533000000:8VSB:65:68:4
KTSF-D2:551000000:8VSB:49:68:4
KTSF-D1:551000000:8VSB:49:52:3
KPIX DT:563000000:8VSB:49:52:1
KQED-HD:569000000:8VSB:49:52:3
ENCORE:569000000:8VSB:65:68:4
KMTP Digital Television:587000000:8VSB:49:52:3
Telefutira:593000000:8VSB:49:52:3
KCNS-DT:623000000:8VSB:49:52:3
KKPX Faith:635000000:8VSB:97:100:6
KKPX Worship:635000000:8VSB:81:84:5
KKPX Pax East:635000000:8VSB:65:68:4
KKPX Digital Television:635000000:8VSB:49:52:3
KCSM-TV:647000000:8VSB:33:36:2
Jazz-TV:647000000:8VSB:49:52:3
KBHK-DT:659000000:8VSB:49:52:1
KTVUHD:725000000:8VSB:49:52:3
KTVU-DT:725000000:8VSB:65:68:4
KRON-SD:731000000:8VSB:49:52:3
KRON-HD:731000000:8VSB:65:68:4
KTNC DIGITAL TELEVISION:767000000:8VSB:49:52:3
Done.
</pre>

<h2><a name="Creating_the_HOME_azap_channels" id=
"Creating_the_HOME_azap_channels"></a> <a name=
"Creating_the_HOME_azap_channels_" id=
"Creating_the_HOME_azap_channels_"></a> Creating the
<code>$HOME/.azap/channels.conf</code></h2>

<p>
Put the last section
from the above output from <code>atscscan</code> into
<code>$HOME/.azap/channels.conf</code>. (You may need to edit the
first column to remove spaces and unusual characters, as you'll
need to pass the contents of the first column as a command-line
parameter.) Use the "-r" option to
<code>./dvb-apps/util/szap/azap</code> to tune to a terrestrial
8VSB ATSC channel:

<pre>
./dvb-apps/util/szap/azap -r KNTV-HD
</pre>

<p>This will show output something like the following. The thing
to look for is the <code>FE_HAS_LOCK</code>, which means that the
frontend kernel module has tuned to the channel.</p>

<pre>
using '/dev/dvb/adapter0/frontend0' and '/dev/dvb/adapter0/demux0'
tuning to 207000000 Hz
video pid 0x0041, audio pid 0x0044
status 00 | signal 3999 | snr cd37 | ber 00000000 | unc 00000000 |
status 1f | signal cb84 | snr f8cf | ber 00000000 | unc 00000000 | FE_HAS_LOCK
status 1f | signal cb84 | snr f8b3 | ber 00000000 | unc 00000000 | FE_HAS_LOCK
</pre>

<p>While <code>azap</code> is running in one terminal, you can
launch mplayer on <code>/dev/dvb/adapter0/dvr0</code> to watch
the stream. This will display the video without de-interlacing
(not pretty), and output the audio using AC3 passthrough. Remove
the <code>-ac hwac3</code> flag, if you're not using an external
Dolby decoder.</p>

<pre>
mplayer -ac hwac3 /dev/dvb/adapter0/dvr0
</pre>

<p>To save the individual stream to the hard drive, one way is to
use:</p>

<pre>
cat /dev/dvb/adapter0/dvr0 &gt; $HOME/test.mpg
</pre>

<p>To save the full ATSC stream, see <a href=
"DigitalTelevision.html#Recording_a_full_ATSC_stream" target=
"_top">below</a>.</p>

<p>You can playback <code>$HOME/test.mpg</code> with
<code>mplayer</code>, or use <code>xine</code>.</p>

<h2><a name="Viewing_the_PIDs" id="Viewing_the_PIDs"></a> Viewing
the PIDs</h2>

<p>
When a channel is tuned using <code>azap</code>, you
can view the PIDs multiplexed within that channel using
<code>./dvb-apps/util/dvbtraffic/dvbtraffic</code> by just
running it and watching which PIDs it shows having a lot of
bandwidth associated with them:

<pre>
-PID--FREQ-----BANDWIDTH-BANDWIDTH-
0000     9 p/s     1 kb/s    14 kbit
0040    10 p/s     1 kb/s    16 kbit
0041  9659 p/s  1773 kb/s 14527 kbit
0044   280 p/s    51 kb/s   422 kbit
0050    10 p/s     1 kb/s    16 kbit
0051  2146 p/s   393 kb/s  3227 kbit
0054   280 p/s    51 kb/s   422 kbit
1d00     5 p/s     0 kb/s     8 kbit
1d02     2 p/s     0 kb/s     4 kbit
1e00     7 p/s     1 kb/s    11 kbit
1e02     1 p/s     0 kb/s     2 kbit
1e80     0 p/s     0 kb/s     1 kbit
1ffb    40 p/s     7 kb/s    60 kbit
1fff   442 p/s    81 kb/s   665 kbit
2000 12901 p/s  2368 kb/s 19403 kbit
</pre>

<p>For example, with KNTV-HD tuned using <code>azap</code>, the
PIDs 0x0041 and 0x0044 (65 and 68 decimal) as well as the PIDs
0x0051 and 0x0054 (81 and 84 decimal) show a lot of
bandwidth.</p>

<p>You can also find the PIDs by running
<code>./dvb-apps/util/scan -c</code> while the channel is tuned,
which may be easier than viewing the <code>dvbtraffic</code>
output especially if your signal is somewhat noisy.</p>

<p>These PIDs can be seen in your
<code>$HOME/.azap/channels.conf</code> in columns four and five.
They correspond to the audio and video PIDs for the two
"stations" (actually referred to as virtual channels, or VCs in
the ATSC spec) being transmitted with the <code>207000000</code>
frequency, as follows:</p>

<pre>
KNTV-HD:207000000:8VSB:65:68:4
NBC Wea:207000000:8VSB:81:84:5
</pre>

<p>
The <code>4</code> and <code>5</code> in the last column at
the end are the subchannel numbers, which can be selected using the
mplayer option <code>-trprog</code>.  E.g., to play subchannel 4,
use:

<pre>
mplayer -tsprog 4 -ac hwac3 /dev/dvb/adapter0/dvr0
</pre>

<p>In the avsforum, the <a href=
"http://www.avsforum.com/avs-vb/archive/index.php/t-530806.html"
target="_top">post</a> by JarginAU is well worth checking out, as
it provides additional insight to using the DVB tools.</p>

<h2><a name="Recording_a_full_ATSC_stream" id=
"Recording_a_full_ATSC_stream"></a> Recording a full ATSC
stream</h2>

<p>
Although it's possible to dump the output from
<code>/dev/dvb/adapter0/dvr0</code> to the hard drive, sometimes
you want to save the entire raw ATSC stream. To do this, use
<code>./dvb-apps/test/test_dvr</code> as follows:

<pre>
./dvb-apps/util/szap/azap -r KTVUHD
BUF_SIZE=1925120 ./dvb-apps/test/test_dvr $HOME/test.mpg 0x2000
</pre>

<p>Or, to record from a second HD3000 card (if you're using two in
the same machine), use:</p>

<pre>
./dvb-apps/util/szap/azap -a 1 -f 0 -r KQED-HD
DEMUX=/dev/dvb/adapter1/demux0 DVR=/dev/dvb/adapter1/dvr0 BUF_SIZE=1925120 ./dvb-apps/test/test_dvr $HOME/test2.mpg 0x2000
</pre>

<h2><a name="Playback_using_xine" id="Playback_using_xine"></a>
Playback using xine</h2>

<p>
The regular <code>xine-ui</code> package
with Debian is able to play back full ATSC recorded streams. E.g.,
to playback the stream recorded above, you'd use:

<pre>
xine $HOME/test.mpg
</pre>

<p>There's also a tempting-looking "DVB" button in the
<code>xine</code> GUI. Jack Kelliher recently posted this
<a href="http://sourceforge.net/mailarchive/message.php?msg_id=12430910"
target="_top">patch</a> to the <code>xine-devel</code> mailing
list. It has a small typo in the following line, where the second
(<code>"</code>) should be replaced with a single quote
(<code>'</code>), but otherwise it applies fairly cleanly:</p>

<pre>
+       _("input_dvb: dvbc mrl specified but the tuner doesn"t appear to be QAM (DVB-C)\n"));
</pre>

<p>
To apply <a href=
"http://www.penlug.org/twiki/pub/Main/DigitalTelevisionDVB/jack_kelliher_xine_lib_input_dvb_patch"
target="_top">Jack's patch</a> to <code>xine-lib</code>, proceed
something like this:

<pre>
wget http://easynews.dl.sourceforge.net/sourceforge/xine/xine-lib-1.1.0.tar.gz
wget http://easynews.dl.sourceforge.net/sourceforge/xine/xine-ui-0.99.4.tar.gz

tar zxvf xine-lib-1.1.0.tar.gz
ln -s xine-lib-1.1.0 xine-lib
wget http://www.penlug.org/twiki/pub/Main/DigitalTelevisionDVB/jack_kelliher_xine_lib_input_dvb_patch
cat jack_kelliher_xine_lib_input_dvb_patch | patch -p0 &gt;patch.out 2&gt;patch.err
</pre>

<p>
The magical result of Jack's patch is that, once you copy your
<code>channels.conf</code> file into your <code>$HOME/.xine</code>
directory, and launch <code>xine</code>, now, when you press the
"DVB" button in the GUI, it actually plays the first channel it
finds. It works great on standard-definition DTV channels, and on
1280x720 channels.

<p>With the default <code>xine</code> settings, the HDTV
1920x1080 channels had a lot of breakup and glitches, which can
be fixed by increasing the setting for <code>Number of video
buffers</code> under the <code>engine</code> tab in the
<code>xine</code> configuration dialog box. (First, make sure you
have selected the <code>Master of the known universe</code>
setting on the <code>gui</code> tab, then click the right-arrow
at the top of the dialog box to reveal the <code>engine</code>
tab.)</p>

<p>Pressing the KP9 (keypad "9"/"PgUp") and KP3 (keypad
"3"/"PgDn") keys in <code>xine</code> will switch channels to
whatever you have in your <code>$HOME/.xine/channels.conf</code>.
You can also tune directly to a channel by giving the channel
name (from the first column of your
<code>$HOME/.xine/channels.conf</code>, like this:</p>

<pre>
xine dvb://KQED-HD
</pre>

<p>
It's a little bit slow to switch channels, but it's far more
reliable than with the non-DVB drivers, which tended to lose audio
or get into a sort of slow-video mode when changing channels, so
this is a very useful patch for <code>xine</code>, and well worth
trying out. It's fairly short, so it's well worth reading, with a
view to patching other applications for the American/Canadian ATSC
market.

<h2><a name="Compiling_xine_hd" id="Compiling_xine_hd"></a>
Compiling xine-hd</h2>

<p>
The only "gotcha" with plain
<code>xine</code> is that you can't select the subchannel in the
way <code>mplayer</code> can (using its <code>-tsprog</code>
flag). The pcHDTV folks provide a patched version of xine called
"xine-hd" which can select the subchannel using the "-C" option,
e.g.:

<pre>
xine -C 52.4 $HOME/test.mpg
</pre>

<p>The <a href=
"http://www.pchdtv.com/downloads/xine-hd-0.8.tar.gz" target=
"_top">xine-hd</a> download provided by pcHDTV hasn't yet been
patched to compile with gcc4, nor for ATSC DVB support (yet), so,
if your system is using gcc4 by default, it's easiest to just
compile <code>xine-hd</code> using gcc3 instead. Set your PATH to
pick up gcc3 first.</p>

<p>You may run into the following compile problem with building
the <code>xine-hd</code> library:</p>

<pre>
input_dtv.c: In function `dtv_plugin_set_channel':
input_dtv.c:266: error: `VIDEO_MODE_ATSC' undeclared (first use in this function)
</pre>

<p>The above is what happens if you try to compile
<code>xine-hd</code> and haven't yet patched your
<code>videodev.h</code> file as it says in the pcHDTV readme file
within the <a href=
"http://www.pchdtv.com/downloads/pcHDTV-extras.tar.gz" target=
"_top">pcHDTV 2.6.12 extras (04/09/05)</a>. Look in the
<code>pcHDTV-extras/v4l2-driver</code> directory, and notice that
the <code>make install</code> target of the Makefile in that
directory does the following:</p>

<pre>
mkdir -p /usr/include/linux; cp -v videodev2.h videodev.h /usr/include/linux
patch -Np0 /usr/include/linux/videodev2.h &lt;videodev2-patch
</pre>

<p>Don't install the
<code>/lib/modules/2.6.12.3/v4l2/cx88-atsc.ko</code> driver,
though, because, if it gets loaded, it will crash the 2.6.12.3
kernel!</p>

<p>The pcHDTV version of <code>xine</code> has the
<code>-C</code> option for selecting which subchannel to playback
from full ATSC stream captures. For example:</p>

<pre>
./dvb-apps/util/szap/azap -r KQED-HD
BUF_SIZE=1925120 ./dvb-apps/test/test_dvr $HOME/test.mpg 0x2000
xine -C 52.4 $HOME/test.mpg
</pre>

<h2>How about good old Analog (NTSC) with these new DVB
drivers?</h2>

<p>
The "cx8800" module implements the V4L2 driver, used
for analog NTSC reception with the pcHDTV HD3000 card. It seems
to be safest to first clean things up, before loading it, so I use
the following sequence:

<pre>
modprobe -rv cx88_blackbird
modprobe -rv cx88-dvb
modprobe -rv cx8800
modprobe -v cx8800
</pre>

<p>
It works very fine with the <code>tvtime</code> application,
to view local analog NTSC broadcasts. To get sound in
<code>tvtime</code>, apparently one is supposed to use the special
proprietary magical cable provided by pcHDTV (just kidding; any
cable will work) to connect the HD3000's line-out to the line-in on
one's sound card, but I haven't tried that yet. In
<code>tvtime</code>, use the up/down arrows to change the TV
channel, to see if all of your usual broadcast NTSC channels are
there.

<p>The difference in the "dmesg" output is that loading the
<code>cx8800</code> module gives:</p>

<pre>
cx2388x v4l2 driver version 0.0.4 loaded
</pre>

<p>
Whereas, the ATSC DVB module <code>cx88-dvb</code> gives:

<pre>
cx2388x dvb driver version 0.0.4 loaded
</pre>

<p>The output of the load command</p>

<pre>
modprobe -v cx8800
</pre>

for the NTSC <code>cx8800</code> module is as follows:

<pre>
insmod /lib/modules/2.6.12.3/kernel/drivers/media/video/videodev.ko
insmod /lib/modules/2.6.12.3/kernel/drivers/media/video/btcx-risc.ko
insmod /lib/modules/2.6.12.3/kernel/drivers/media/video/v4l2-common.ko
insmod /lib/modules/2.6.12.3/kernel/drivers/media/video/v4l1-compat.ko
insmod /lib/modules/2.6.12.3/kernel/drivers/media/video/tveeprom.ko
insmod /lib/modules/2.6.12.3/kernel/drivers/media/common/ir-common.ko
insmod /lib/modules/2.6.12.3/kernel/drivers/media/video/video-buf.ko
insmod /lib/modules/2.6.12.3/kernel/drivers/i2c/algos/i2c-algo-bit.ko
insmod /lib/modules/2.6.12.3/kernel/drivers/media/video/cx88/cx88xx.ko
insmod /lib/modules/2.6.12.3/kernel/drivers/media/video/cx88/cx8800.ko
</pre>

<p>When the <code>cx8800</code> module is loaded, the major/minor
numbers and permissions of the devices created are like this:</p>

<pre>
crw-rw----  1 root video 81, 64 2005-07-31 22:46 /dev/radio0
crw-rw----  1 root video 81, 65 2005-07-31 22:46 /dev/radio1
crw-rw----  1 root video 81, 224 2005-07-31 22:46 /dev/vbi0
crw-rw----  1 root video 81, 225 2005-07-31 22:46 /dev/vbi1
crw-rw----  1 root video 81, 0 2005-07-31 22:46 /dev/video0
crw-rw----  1 root video 81, 1 2005-07-31 22:46 /dev/video1
</pre>

<p>The output of the unload command</p>

<pre>
modprobe -rv cx8800
</pre>

<p>for the "cx8800" module is:

<pre>
rmmod /lib/modules/2.6.12.3/kernel/drivers/media/video/cx88/cx8800.ko
rmmod /lib/modules/2.6.12.3/kernel/drivers/media/video/cx88/cx88xx.ko
rmmod /lib/modules/2.6.12.3/kernel/drivers/i2c/algos/i2c-algo-bit.ko
rmmod /lib/modules/2.6.12.3/kernel/drivers/media/video/video-buf.ko
rmmod /lib/modules/2.6.12.3/kernel/drivers/media/common/ir-common.ko
rmmod /lib/modules/2.6.12.3/kernel/drivers/media/video/tveeprom.ko
rmmod /lib/modules/2.6.12.3/kernel/drivers/media/video/v4l1-compat.ko
rmmod /lib/modules/2.6.12.3/kernel/drivers/media/video/v4l2-common.ko
rmmod /lib/modules/2.6.12.3/kernel/drivers/media/video/btcx-risc.ko
rmmod /lib/modules/2.6.12.3/kernel/drivers/media/video/videodev.ko
</pre>

<h2><a name="Credits" id="Credits"></a> Credits</h2>Thanks to
Tony Godshall (of Bay Area Debian) for organising and hosting an
<a href="http://eff.org/broadcastflag/cookbook/buildin.php"
target="_top">EFF PVR Build-In</a>.

<h4><a name="Links" id="Links"></a> Links</h4>

<ul>
<li><a href="http://pchdtv.freedesktop.org/wiki/" target=
"_top">pcHDTV HD-2000 and HD-3000 driver support wiki</a>.</li>

<li><a href="http://www.linuxtv.org/wiki/index.php/PcHDTV"
target="_top">LinuxTV Wiki page for the pcHDTV
HD-3000</a>.</li>

<li><a href="http://www.transcoding.org/" target=
"_top">Transcode Wiki</a></li>
</ul>

</p>


<!-- *** BEGIN author bio *** -->
<P>&nbsp;
<P>
<!-- *** BEGIN bio *** -->
<hr>
<p>

<img align="left" alt="[BIO]" src="../gx/authors/knaggs.jpg" class="bio">

<em>

I studied engineering at Universit&eacute; de Li&egrave;ge for a year, then at Trinity 
College Dublin for four more (and where I wish I had paid more attention 
during the networking lectures). I've always been curious about audio and 
video on computers, and Linux has been truly an amazing platform for learning 
about these areas.

</em>
<br clear="all">
<!-- *** END bio *** -->

<!-- *** END author bio *** -->

<div id="articlefooter">

<p>
Copyright &copy; 2005, Peter Knaggs. Released under the <a
href="http://linuxgazette.net/copying.html">Open Publication license</a>
unless otherwise noted in the body of the article. Linux Gazette is not
produced, sponsored, or endorsed by its prior host, SSC, Inc.
</p>

<p>
Published in Issue 118 of Linux Gazette, September 2005
</p>

</div>


<div id="previousnextbottom">
<A HREF="huff.html" >&lt;-- prev</A> | <A HREF="savage.html" >next --&gt;</A>
</div>


</div>






<div id="navigation">

<a href="../index.html">Home</a>
<a href="../faq/index.html">FAQ</a>
<a href="../lg_index.html">Site Map</a>
<a href="../mirrors.html">Mirrors</a>
<a href="../mirrors.html">Translations</a>
<a href="../search.html">Search</a>
<a href="../archives.html">Archives</a>
<a href="../authors/index.html">Authors</a>
<a href="../contact.html">Contact Us</a>

</div>



<div id="breadcrumbs">

<a href="../index.html">Home</a> &gt; 
<a href="index.html">September 2005 (#118)</a> &gt; 
Article

</div>





<img src="../gx/tux_86x95_indexed.png" id="tux" alt="Tux"/>




</body>
</html>

