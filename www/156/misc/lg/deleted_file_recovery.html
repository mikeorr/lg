<!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.0 Transitional//EN'
		 'http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd'>
<html xmlns='http://www.w3.org/1999/xhtml' lang='utf-8' xml:lang='utf-8'>
<head>
<title>deleted file recovery</title>
<meta http-equiv='Content-Type; charset=utf-8' />
<link rel='stylesheet' type='text/css' href='../../../lg.css' />
</head>
<body>
<a href="../../../"><img alt="Linux Gazette" src="../../../gx/2003/newlogo-blank-200-gold2.jpg" id="logo" /></a><img alt="Tux" src="../../../gx/tux_86x95_indexed.png" id="tux" /><p id="fun">...making Linux just a little more fun!</p><div class='content articlecontent'><a name="top"></a><h3>deleted file recovery</h3>
<p>
<b><p>
J.Bakshi [j.bakshi at icmail.net]

</p>
</b><br />
<b>Thu, 16 Oct 2008 20:24:54 +0530</b>
</p>

<p>
Dear list,
</p>

<p>
I generally worked with Linux terminal. Frequently I have to do "rm" to delete 
files/folders which are not required any more. And this actually raised a 
oquestion in mind. what to do if some point of time I need a file/foldr which 
has been already deleted before few min. ago. I have googled a lot but have 
not found any open source tools which can recover the deleted ones. testdisk 
is there but it is totally different. there are some commercial GUI based 
tools available but I am looking for a CLI tool or technique which 
<strong>practically</strong> recover the deleted file/folder.
</p>

<p>
Hope some one can enlighten me.
Thanks
</p>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-deleted_file_recovery">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Ren&eacute; Pfeiffer [lynx at luchs.at]

</p>
</b><br />
<b>Thu, 16 Oct 2008 17:12:30 +0200</b>
</p>

<p>
Hello!
</p>

<p>
On Oct 16, 2008 at 2024 +0530, J.Bakshi appeared and said:
</p>

<pre>
&gt; [...]
&gt; I generally worked with Linux terminal. Frequently I have to do "rm" to delete
&gt; files/folders which are not required any more. And this actually raised a
&gt; oquestion in mind. what to do if some point of time I need a file/foldr which
&gt; has been already deleted before few min. ago. I have googled a lot but have
&gt; not found any open source tools which can recover the deleted ones. testdisk
&gt; is there but it is totally different. there are some commercial GUI based
&gt; tools available but I am looking for a CLI tool or technique which
&gt; <strong>practically</strong> recover the deleted file/folder.
</pre>

<p>
The problem of data recovery heavily depends on which filesystem you are
using and what you do immediately after the deletion. Unfortunately the
common filesystems do not support undeletion. Ext2 does to some extent,
Ext3, XFS and ReiserFS do not. I am not sure about JFS. I dug up some
references, but both are far away from being a GUI-solution.
</p>

<p>
<a href="http://www.xs4all.nl/~carlo17/howto/undelete_ext3.html">http://www.xs4all.nl/~carlo17/howto/undelete_ext3.html</a>
<a href="http://www.cgsecurity.org/wiki/ReiserFS_File_Undelete_HOWTO">http://www.cgsecurity.org/wiki/ReiserFS_File_Undelete_HOWTO</a>
</p>

<p>
In almost all cases of accidental deletion of data you must act
immediately, i.e. you must shutdown the system sitting on the data
storage involved and recover your data immediately. Any delay may cause
your deleted data to be overwritten by disk activity.
</p>

<p>
The best GUI-solution to this problem is implemented by most window
managers - it's the trash can / recycle bin folder. This sounds strange,
but considered the fact that most modern filesystems are designed
without the undeletion feature, copying the data first and then deleting
it some time after that is the safest way.
</p>

<p>
Best,
Ren&eacute;.
</p>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-deleted_file_recovery">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
J.Bakshi [j.bakshi at icmail.net]

</p>
</b><br />
<b>Thu, 16 Oct 2008 21:35:42 +0530</b>
</p>

<p>
On Thursday 16 Oct 2008 8:42:30 pm Ren&eacute; Pfeiffer wrote:
</p>

<pre>
&gt; Hello!
&gt;
&gt; On Oct 16, 2008 at 2024 +0530, J.Bakshi appeared and said:
&gt; &gt; [...]
&gt; &gt; I generally worked with Linux terminal. Frequently I have to do "rm" to
&gt; &gt; delete files/folders which are not required any more. And this actually
&gt; &gt; raised a oquestion in mind. what to do if some point of time I need a
&gt; &gt; file/foldr which has been already deleted before few min. ago. I have
&gt; &gt; googled a lot but have not found any open source tools which can recover
&gt; &gt; the deleted ones. testdisk is there but it is totally different. there
&gt; &gt; are some commercial GUI based tools available but I am looking for a CLI
&gt; &gt; tool or technique which <strong>practically</strong> recover the deleted file/folder.
&gt;
&gt; The problem of data recovery heavily depends on which filesystem you are
&gt; using and what you do immediately after the deletion. Unfortunately the
&gt; common filesystems do not support undeletion. Ext2 does to some extent,
&gt; Ext3, XFS and ReiserFS do not. I am not sure about JFS. I dug up some
&gt; references, but both are far away from being a GUI-solution.
&gt;
&gt; <a href="http://www.xs4all.nl/~carlo17/howto/undelete_ext3.html">http://www.xs4all.nl/~carlo17/howto/undelete_ext3.html</a>
&gt; <a href="http://www.cgsecurity.org/wiki/ReiserFS_File_Undelete_HOWTO">http://www.cgsecurity.org/wiki/ReiserFS_File_Undelete_HOWTO</a>
&gt;
&gt; In almost all cases of accidental deletion of data you must act
&gt; immediately, i.e. you must shutdown the system sitting on the data
&gt; storage involved and recover your data immediately. Any delay may cause
&gt; your deleted data to be overwritten by disk activity.
&gt;
&gt; The best GUI-solution to this problem is implemented by most window
&gt; managers - it's the trash can / recycle bin folder. This sounds strange,
&gt; but considered the fact that most modern filesystems are designed
&gt; without the undeletion feature, copying the data first and then deleting
&gt; it some time after that is the safest way.
&gt;
&gt; Best,
&gt; Ren&eacute;.
</pre>


<p>
Hello Rene,
</p>

<p>
Thanks a lot for the discussion and also sorry for not mentioning the 
filesystem. I generally use reiserfs but in case of a rented hosting server 
space I see ext3 filesystem in general. I'll definately look into the links 
you have provided. I always keep a backup before deletion as you have 
mentioned already but I wounder if there is any tool or command which can 
help to recover deleted file.
</p>

<p>
Thanks
</p>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-deleted_file_recovery">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Kapil Hari Paranjape [kapil at imsc.res.in]

</p>
</b><br />
<b>Thu, 16 Oct 2008 21:51:06 +0530</b>
</p>

<p>
Hello,
</p>

<p>
On Thu, 16 Oct 2008, J.Bakshi wrote:
</p>

<pre>
&gt; And this actually raised a oquestion in mind. what to do if some
&gt; point of time I need a file/foldr which has been already deleted
&gt; before few min. ago.
</pre>

<p>
The command-line trashcan utility "trash-cli" entered Debian lenny a
few days ago.
</p>

<p>
Another utility is "libtrash" which implements are trashcan like
feature by preloading functions that save "unlink"ed files.
</p>

<p>
Kapil.
--
</p>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-deleted_file_recovery">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Jimmy O'Regan [joregan at gmail.com]

</p>
</b><br />
<b>Thu, 16 Oct 2008 19:18:02 +0100</b>
</p>

<p>
2008/10/16 J.Bakshi &lt;j.bakshi@icmail.net&gt;:
</p>

<pre>
&gt; Dear list,
&gt;
&gt; I generally worked with Linux terminal. Frequently I have to do "rm" to delete
&gt; files/folders which are not required any more. And this actually raised a
&gt; oquestion in mind. what to do if some point of time I need a file/foldr which
&gt; has been already deleted before few min. ago. I have googled a lot but have
&gt; not found any open source tools which can recover the deleted ones. testdisk
&gt; is there but it is totally different. there are some commercial GUI based
&gt; tools available but I am looking for a CLI tool or technique which
&gt; <strong>practically</strong> recover the deleted file/folder.
</pre>

<p>
You don't want testdisk, you want the author's other tool - PhotoRec
(<a href="http://www.cgsecurity.org/wiki/PhotoRec">http://www.cgsecurity.org/wiki/PhotoRec</a>). It scans for deleted files
based on their signatures, and by default recovers all deleted files
on a disk image.
</p>

<p>
I've used it a few times, and it works quite well.
</p>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-deleted_file_recovery">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Karl-Heinz Herrmann [kh1 at khherrmann.de]

</p>
</b><br />
<b>Thu, 16 Oct 2008 22:17:31 +0200</b>
</p>

<p>
On Thu, 16 Oct 2008 17:12:30 +0200
Ren&eacute; Pfeiffer &lt;lynx@luchs.at&gt; wrote:
</p>

<pre>
&gt; On Oct 16, 2008 at 2024 +0530, J.Bakshi appeared and said:
&gt; &gt; I have googled a lot but have not found any open
&gt; &gt; source tools which can recover the deleted ones. testdisk is there
&gt; &gt; but it is totally different. 
</pre>


<pre>
&gt; Unfortunately the common filesystems do not support undeletion. Ext2
&gt; does to some extent, Ext3, XFS and ReiserFS do not. I am not sure
</pre>

<p>
Hm... isn't it possible to unmount the ext3 and after that treat it as
ext2 until files are recovered? Once unmounted the transaction journal
should not be changing anymore. After recovery the journal could be
reactivated. 
</p>


<pre>
&gt; about JFS. I dug up some references, but both are far away from being
&gt; a GUI-solution.
</pre>

<p>
Another one for reiserfs....
<a href="http://antrix.net/journal/techtalk/reiserfs_data_recovery_howto.comments?parent=74-1&amp;title=Re:%20Re:%20ReiserFS%20undelete/data%20recovery%20HOWTO">http://antrix.net/journal/techtalk/reiserfs_data_recovery_howto.comments?parent=74-1&amp;title=Re:%20Re:%20ReiserFS%20undelete/data%20recovery%20HOWTO</a>
</p>


<pre>
&gt; The best GUI-solution to this problem is implemented by most window
&gt; managers - it's the trash can / recycle bin folder. This sounds
</pre>

<p>
Hm... there is also the CLI version:
<pre>
alias rm="rm -i"
</pre>

<p>
or  as also stated in:
<a href="http://forums.macosxhints.com/archive/index.php/t-9123.html">http://forums.macosxhints.com/archive/index.php/t-9123.html</a>
</p>

<pre>
del () { /bin/mv -i ${*} ~/.Trash; }
</pre>

<p>
and use del (reason why this can't be achieved with alias in bash is
also given in the url).
</p>


<pre>
&gt; strange, but considered the fact that most modern filesystems are
&gt; designed without the undeletion feature, copying the data first and
</pre>


<p>
I've found that even some gui's tend to create trash folders per
device/filesystem so they do not have to copy all the time to
~/home/kde/trash (or wherever), but can simply move the files inside
the filesystem boundaries. That way the mv is almost as quick as the
rm.
</p>


<p>
K.-h.
</p>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-deleted_file_recovery">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Ren&eacute; Pfeiffer [lynx at luchs.at]

</p>
</b><br />
<b>Thu, 16 Oct 2008 22:46:20 +0200</b>
</p>

<p>
On Oct 16, 2008 at 2217 +0200, Karl-Heinz Herrmann appeared and said:
</p>

<pre>
&gt; On Thu, 16 Oct 2008 17:12:30 +0200
&gt; Ren&eacute; Pfeiffer &lt;lynx@luchs.at&gt; wrote:
&gt; [...]
&gt; &gt; Unfortunately the common filesystems do not support undeletion. Ext2
&gt; &gt; does to some extent, Ext3, XFS and ReiserFS do not. I am not sure
&gt;=20
&gt; Hm... isn't it possible to unmount the ext3 and after that treat it as
&gt; ext2 until files are recovered? Once unmounted the transaction journal
&gt; should not be changing anymore. After recovery the journal could be
&gt; reactivated.=20
</pre>

<p>
Yes, but this means that the filesystem will have to be modified. In an
ideal world you don't modify the filesystem when doing recovery. I'm no
expert at data recovery, so I can't tell what difference it makes and
whether mounting ext3 as ext2 will improve or worsen your chances.
</p>


<pre>
&gt; [...]
&gt; I've found that even some gui's tend to create trash folders per
&gt; device/filesystem so they do not have to copy all the time to
&gt; ~/home/kde/trash (or wherever), but can simply move the files inside
&gt; the filesystem boundaries. That way the mv is almost as quick as the
&gt; rm.
</pre>

<p>
This is a smart trick and is often overlooked.
</p>

<p>
Best,
Ren&eacute;.
</p>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-deleted_file_recovery">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Jimmy O'Regan [joregan at gmail.com]

</p>
</b><br />
<b>Thu, 16 Oct 2008 22:15:32 +0100</b>
</p>

<p>
2008/10/16 Ren&eacute; Pfeiffer &lt;lynx@luchs.at&gt;:
</p>

<pre>
&gt; On Oct 16, 2008 at 2217 +0200, Karl-Heinz Herrmann appeared and said:
&gt;&gt; On Thu, 16 Oct 2008 17:12:30 +0200
&gt;&gt; Ren&eacute; Pfeiffer &lt;lynx@luchs.at&gt; wrote:
&gt;&gt; [...]
&gt;&gt; &gt; Unfortunately the common filesystems do not support undeletion. Ext2
&gt;&gt; &gt; does to some extent, Ext3, XFS and ReiserFS do not. I am not sure
&gt;&gt;
&gt;&gt; Hm... isn't it possible to unmount the ext3 and after that treat it as
&gt;&gt; ext2 until files are recovered? Once unmounted the transaction journal
&gt;&gt; should not be changing anymore. After recovery the journal could be
&gt;&gt; reactivated.
&gt;
&gt; Yes, but this means that the filesystem will have to be modified. In an
&gt; ideal world you don't modify the filesystem when doing recovery. I'm no
&gt; expert at data recovery, so I can't tell what difference it makes and
&gt; whether mounting ext3 as ext2 will improve or worsen your chances.
&gt;
</pre>

<p>
Generally - where possible - it's a better idea to use dd to make an
image of the disk elsewhere and use that instead. If that's not
possible, you could use qemu and COW images to ensure that any changes
made are isolated.
</p>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-deleted_file_recovery">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Paul Sephton [paul at inet.co.za]

</p>
</b><br />
<b>Thu, 16 Oct 2008 23:28:54 +0200</b>
</p>

<p>
On Thu, 2008-10-16 at 22:46 +0200, Ren&eacute; Pfeiffer wrote:
</p>

<pre>
&gt; On Oct 16, 2008 at 2217 +0200, Karl-Heinz Herrmann appeared and said:
&gt; &gt; On Thu, 16 Oct 2008 17:12:30 +0200
&gt; &gt; Ren&eacute; Pfeiffer &lt;lynx@luchs.at&gt; wrote:
&gt; &gt; [...]
&gt; &gt; &gt; Unfortunately the common filesystems do not support undeletion. Ext2
&gt; &gt; &gt; does to some extent, Ext3, XFS and ReiserFS do not. I am not sure
&gt; &gt; 
&gt; &gt; Hm... isn't it possible to unmount the ext3 and after that treat it as
&gt; &gt; ext2 until files are recovered? Once unmounted the transaction journal
&gt; &gt; should not be changing anymore. After recovery the journal could be
&gt; &gt; reactivated. 
&gt; 
&gt; Yes, but this means that the filesystem will have to be modified. In an
&gt; ideal world you don't modify the filesystem when doing recovery. I'm no
&gt; expert at data recovery, so I can't tell what difference it makes and
&gt; whether mounting ext3 as ext2 will improve or worsen your chances.
&gt; 
&gt; &gt; [...]
&gt; &gt; I've found that even some gui's tend to create trash folders per
&gt; &gt; device/filesystem so they do not have to copy all the time to
&gt; &gt; ~/home/kde/trash (or wherever), but can simply move the files inside
&gt; &gt; the filesystem boundaries. That way the mv is almost as quick as the
&gt; &gt; rm.
&gt; 
&gt; This is a smart trick and is often overlooked.
</pre>

<p>
Indeed it is.  Some people go as far as to move the 'rm' command away
and alias the rm command to a mv to trash folder.
</p>

<p>
Something not to be discarded [no pun intended] is the fact that Unix
filesystems allow one file to be hard linked to another file.  This
simply creates two links to the same inode (or physical file decriptor)
and increments a reference counter.  The file will only be ultimately
unlinked and returned to free space once that reference drops to zero.
Multiple links to the same file take only as much space as the file name
in the directory file, so it's a very efficient way to protect files
against accidental deletion.
</p>

<p>
Effectively, create a subdirectory and go "cd mydir;
ln /pathto/protecteddir/* ."
</p>

<p>
Take a look at the GNU options for ln as well;  It allows one to do
versioned backups of files instead of overwriting everything in the
target directory.  So 
<pre>
  cd targetdir; ln -b -V numbered /pathto/sourcedir/* .
</pre>
in a cron script would maintain a set of versioned backups of your
source directory.  Of course, hard links cannot cross file system
boundaries, but I believe some of the backup options apply to other GNU
command line utilities as well as 'ln.
</p>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-deleted_file_recovery">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Ben Okopnik [ben at linuxgazette.net]

</p>
</b><br />
<b>Thu, 16 Oct 2008 18:52:27 -0400</b>
</p>

<p>
On Thu, Oct 16, 2008 at 10:17:31PM +0200, Karl-Heinz Herrmann wrote:
</p>

<pre>
&gt; 
&gt; Hm... there is also the CLI version:
&gt; ``
&gt; alias rm="rm -i"
&gt; ''
</pre>

<p>
That would be the scripted version of "if you're not sure you should
delete it, then don't." Frankly, I have a certain stubborn mindset when
it comes to this: if you don't practice good data hygiene (i.e., backing
it up, <strong>really</strong> thinking about whether you're ever likely to need that
file ever again - not that I'm perfect at it myself...), then you
<em>deserve</em> to suffer an occasional sharp pain for not doing so.
</p>

<pre>
  Be wary of systems that degrade gracefully, for unless they inflict some
  pain in an attempt to right their hurt, they will tend to always operate
  in a degraded state.
   -- Kent Borg
</pre>


<pre>
&gt; or  as also stated in:
&gt; <a href="http://forums.macosxhints.com/archive/index.php/t-9123.html">http://forums.macosxhints.com/archive/index.php/t-9123.html</a>
&gt; 
&gt; ``
&gt; del () { /bin/mv -i ${*} ~/.Trash; }
&gt; ''
&gt; 
&gt; and use del (reason why this can't be achieved with alias in bash is
&gt; also given in the url).
</pre>

<p>
Even if we ignore my first point, above, there are still significant
problems with this approach. It does not (easily) handle identical
filenames - in fact, it will give a highly-confusing message in that
case; it also allows ostensibly deleted files to keep taking up disk
space forever. It would take a bit more than just a simple function to
handle that.
</p>

<p>
Here's something that should address both issues (I have not done any
significant testing on this, and would certainly welcome comments):
</p>

<pre>
#!/bin/bash
# Created by Ben Okopnik on Thu Oct 16 18:17:50 EDT 2008
 
[ -z "$1" ] &amp;&amp; { printf "Usage: ${0##*/} &lt;file_to_safely_delete&gt;\n"; exit; }
 
################ User-defined variables ###########################
savedir=${HOME}/.Trash	# Directory in which files are backed up  #
keeptime=30				# Delete backups after this many days     #
###################################################################
 
# Create $savedir if it doesn't exist
[ -d "$savedir" ] || mkdir "$savedir"
 
# Generate unique, time-stamped filename
savename="${1##*/}:`/bin/date '+%s%N'`"
 
# Delete file <strong>only</strong> if hardlink creation succeeded
/bin/ln "$1" "$savedir/$savename" &amp;&amp; /bin/rm "$1"
 
# Delete any files in $savedir that are older than $keeptime
/usr/bin/find $savedir -mtime +$keeptime -delete
</pre>


<pre>-- 
* Ben Okopnik * Editor-in-Chief, Linux Gazette * <a href="http://LinuxGazette.NET">http://LinuxGazette.NET</a> *
</pre>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-deleted_file_recovery">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Thomas Adam [thomas.adam22 at gmail.com]

</p>
</b><br />
<b>Fri, 17 Oct 2008 00:03:31 +0100</b>
</p>

<p>
2008/10/16 Ben Okopnik &lt;ben@linuxgazette.net&gt;:
<pre>
</p>

<pre>
&gt; # Delete any files in $savedir that are older than $keeptime
&gt; /usr/bin/find $savedir -mtime +$keeptime -delete
&gt; ''
</pre>
 
At least makes this portable:
 
``
find $savedir -mtime +$keeptime -print0 | xargs -0 rm -fr
</pre>

<p>
It moaned on my Solaris system with good reason.
</p>

<p>
-- Thomas Adam
</p>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-deleted_file_recovery">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Francis Daly [francis at daoine.org]

</p>
</b><br />
<b>Fri, 17 Oct 2008 00:58:07 +0100</b>
</p>

<p>
On Thu, Oct 16, 2008 at 06:52:27PM -0400, Ben Okopnik wrote:
</p>


<pre>
&gt; Here's something that should address both issues (I have not done any
&gt; significant testing on this, and would certainly welcome comments):
</pre>

<p>
Even minor nitpicky ones? <img src="../gx/smile.png" alt=":-)">
</p>


<pre>
&gt; ``
&gt; #!/bin/bash
&gt; # Created by Ben Okopnik on Thu Oct 16 18:17:50 EDT 2008
&gt; 
&gt; [ -z "$1" ] &amp;&amp; { printf "Usage: ${0##*/} &lt;file_to_safely_delete&gt;\n"; exit; }
&gt; 
&gt; ################ User-defined variables ###########################
&gt; savedir=${HOME}/.Trash	# Directory in which files are backed up  #
&gt; keeptime=30				# Delete backups after this many days     #
&gt; ###################################################################
&gt; 
&gt; # Create $savedir if it doesn't exist
&gt; [ -d "$savedir" ] || mkdir "$savedir"
</pre>

<p>
I tend to "mkdir -p". Presumably they have similar failure modes if
$savedir exists as a non-directory. Possibly I'm sacrificing pre-POSIX
portability for less typing.
</p>


<pre>
&gt; # Generate unique, time-stamped filename
&gt; savename="${1##*/}:`/bin/date '+%s%N'`"
&gt; 
&gt; # Delete file <strong>only</strong> if hardlink creation succeeded
&gt; /bin/ln "$1" "$savedir/$savename" &amp;&amp; /bin/rm "$1"
</pre>

<p>
I'm not sure I see the difference between this and just "mv" -- apart
from the "cross-filesystem" thing. Maybe that's exactly it. Can't use
this script to delete from a non-$HOME filesystem (on typical
implementations).
</p>


<pre>
&gt; # Delete any files in $savedir that are older than $keeptime
&gt; /usr/bin/find $savedir -mtime +$keeptime -delete
</pre>

<p>
ctime is more likely to be useful than mtime here, I think.
</p>

<p>
Even more nitpicky responses welcome, of course.
</p>

<p>
	f
<pre>-- 
Francis Daly        francis@daoine.org
</pre>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-deleted_file_recovery">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Ben Okopnik [ben at linuxgazette.net]

</p>
</b><br />
<b>Fri, 17 Oct 2008 08:58:09 -0400</b>
</p>

<p>
On Fri, Oct 17, 2008 at 12:03:31AM +0100, Thomas Adam wrote:
</p>

<pre>
&gt; 2008/10/16 Ben Okopnik &lt;ben@linuxgazette.net&gt;:
&gt; ``
&gt; &gt; # Delete any files in $savedir that are older than $keeptime
&gt; &gt; /usr/bin/find $savedir -mtime +$keeptime -delete
&gt; &gt; ''
&gt; 
&gt; At least makes this portable:
&gt; 
&gt; ``
&gt; find $savedir -mtime +$keeptime -print0 | xargs -0 rm -fr
&gt; ''
</pre>

<p>
Reasonable, and smart. Thanks, Thomas!
</p>


<pre>-- 
* Ben Okopnik * Editor-in-Chief, Linux Gazette * <a href="http://LinuxGazette.NET">http://LinuxGazette.NET</a> *
</pre>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-deleted_file_recovery">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Ben Okopnik [ben at linuxgazette.net]

</p>
</b><br />
<b>Fri, 17 Oct 2008 09:06:32 -0400</b>
</p>

<p>
On Fri, Oct 17, 2008 at 12:58:07AM +0100, Francis Daly wrote:
</p>

<pre>
&gt; On Thu, Oct 16, 2008 at 06:52:27PM -0400, Ben Okopnik wrote:
&gt; 
&gt; &gt; Here's something that should address both issues (I have not done any
&gt; &gt; significant testing on this, and would certainly welcome comments):
&gt; 
&gt; Even minor nitpicky ones? <img src="../gx/smile.png" alt=":-)">
</pre>

<p>
Sure. As long as they're at least interesting. <img src="../gx/smile.png" alt=":)">
 
</p>

<pre>
&gt; &gt; ``
&gt; &gt; #!/bin/bash
&gt; &gt; # Created by Ben Okopnik on Thu Oct 16 18:17:50 EDT 2008
&gt; &gt; 
&gt; &gt; [ -z "$1" ] &amp;&amp; { printf "Usage: ${0##*/} &lt;file_to_safely_delete&gt;\n"; exit; }
&gt; &gt; 
&gt; &gt; ################ User-defined variables ###########################
&gt; &gt; savedir=${HOME}/.Trash	# Directory in which files are backed up  #
&gt; &gt; keeptime=30				# Delete backups after this many days     #
&gt; &gt; ###################################################################
&gt; &gt; 
&gt; &gt; # Create $savedir if it doesn't exist
&gt; &gt; [ -d "$savedir" ] || mkdir "$savedir"
&gt; 
&gt; I tend to "mkdir -p". Presumably they have similar failure modes if
&gt; $savedir exists as a non-directory. Possibly I'm sacrificing pre-POSIX
&gt; portability for less typing.
</pre>

<p>
[blink] In what case, pray tell, would <strong>${HOME}</strong> not exist? I suppose
that '-p' would do no harm - frankly, using it in scripts is my own
first inclination - but I couldn't see any situation in which it would
be applicable. Anyone who actually edits the script and changes the
savedir to something bizarre would also theoretically know enough to
create it - or would suffer the consequences.
 
</p>

<pre>
&gt; &gt; # Generate unique, time-stamped filename
&gt; &gt; savename="${1##*/}:`/bin/date '+%s%N'`"
&gt; &gt; 
&gt; &gt; # Delete file <strong>only</strong> if hardlink creation succeeded
&gt; &gt; /bin/ln "$1" "$savedir/$savename" &amp;&amp; /bin/rm "$1"
&gt; 
&gt; I'm not sure I see the difference between this and just "mv" -- apart
&gt; from the "cross-filesystem" thing. Maybe that's exactly it. 
</pre>

<p>
Try it on a, say, 10GB file. You'll see the difference immediately.
(Hint: it takes a while to "mv" something that size.)
</p>


<pre>
&gt; Can't use
&gt; this script to delete from a non-$HOME filesystem (on typical
&gt; implementations).
</pre>

<p>
You have a point; copy-and-delete would cover more stuff, including
other filesystems. That's a pretty easy change.
 
</p>

<pre>
&gt; &gt; # Delete any files in $savedir that are older than $keeptime
&gt; &gt; /usr/bin/find $savedir -mtime +$keeptime -delete
&gt; 
&gt; ctime is more likely to be useful than mtime here, I think.
</pre>

<p>
I'd considered it when I wrote it, but still can't see a reason that it
would be more useful. Reasoning, please?
</p>


<pre>-- 
* Ben Okopnik * Editor-in-Chief, Linux Gazette * <a href="http://LinuxGazette.NET">http://LinuxGazette.NET</a> *
</pre>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-deleted_file_recovery">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Francis Daly [francis at daoine.org]

</p>
</b><br />
<b>Fri, 17 Oct 2008 17:02:03 +0100</b>
</p>

<p>
On Fri, Oct 17, 2008 at 09:06:32AM -0400, Ben Okopnik wrote:
</p>

<pre>
&gt; On Fri, Oct 17, 2008 at 12:58:07AM +0100, Francis Daly wrote:
&gt; &gt; On Thu, Oct 16, 2008 at 06:52:27PM -0400, Ben Okopnik wrote:
</pre>


<pre>
&gt; &gt; &gt; ################ User-defined variables ###########################
&gt; &gt; &gt; savedir=${HOME}/.Trash	# Directory in which files are backed up  #
&gt; &gt; &gt; keeptime=30				# Delete backups after this many days     #
&gt; &gt; &gt; ###################################################################
&gt; &gt; &gt; 
&gt; &gt; &gt; # Create $savedir if it doesn't exist
&gt; &gt; &gt; [ -d "$savedir" ] || mkdir "$savedir"
&gt; &gt; 
&gt; &gt; I tend to "mkdir -p". Presumably they have similar failure modes if
&gt; &gt; $savedir exists as a non-directory. Possibly I'm sacrificing pre-POSIX
&gt; &gt; portability for less typing.
&gt; 
&gt; [blink] In what case, pray tell, would <strong>${HOME}</strong> not exist? I suppose
&gt; that '-p' would do no harm - frankly, using it in scripts is my own
&gt; first inclination - but I couldn't see any situation in which it would
&gt; be applicable. Anyone who actually edits the script and changes the
&gt; savedir to something bizarre would also theoretically know enough to
&gt; create it - or would suffer the consequences.
</pre>

<p>
You're right.
</p>

<p>
$HOME will exist; but I was more thinking about the initial [ -d ]
test being unnecessary.
</p>

<p>
However, most of the time this program runs, $savedir is a directory,
so "-d" is the quickest way to learn that and carry on.
</p>

<p>
For the one time when $savedir doesn't exist, "-d || mkdir" and "mkdir
-p" are irrelevantly close.
</p>

<p>
And for the really odd one time when $savedir is a file or link, the
errors reported are close enough too.
</p>

<p>
So yes, your [blink] was well-founded.
</p>


<pre>
&gt; &gt; &gt; # Delete file <strong>only</strong> if hardlink creation succeeded
&gt; &gt; &gt; /bin/ln "$1" "$savedir/$savename" &amp;&amp; /bin/rm "$1"
&gt; &gt; 
&gt; &gt; I'm not sure I see the difference between this and just "mv" -- apart
&gt; &gt; from the "cross-filesystem" thing. Maybe that's exactly it. 
&gt; 
&gt; Try it on a, say, 10GB file. You'll see the difference immediately.
&gt; (Hint: it takes a while to "mv" something that size.)
</pre>

<p>
Nope; looks superfast to me for each of them.
</p>

<p>
"copying" between /var/tmp and /usr/local, both on the same ext3
filesystem on top of an lvm2 setup.
</p>

<p>
Unless the system is returning control to me before the file is actually
written, of course.
</p>

<p>
But I thought that "mv" within a filesystem was "add entry to new dir,
remove entry from old dir" without needing to copy any data at all,
which seems to match what I see.
</p>


<pre>
&gt; &gt; Can't use
&gt; &gt; this script to delete from a non-$HOME filesystem (on typical
&gt; &gt; implementations).
&gt; 
&gt; You have a point; copy-and-delete would cover more stuff, including
&gt; other filesystems. That's a pretty easy change.
</pre>

<p>
It would be -- but then it becomes slower than mv. (Same speed across
filesystems, slower when on the same one.)
</p>

<p>
The earlier suggestion of "one .Trash per filesystem" would be good,
if there were an easy way of identifying the right .Trash to use within
the script.
</p>


<pre>
&gt; &gt; &gt; # Delete any files in $savedir that are older than $keeptime
&gt; &gt; &gt; /usr/bin/find $savedir -mtime +$keeptime -delete
&gt; &gt; 
&gt; &gt; ctime is more likely to be useful than mtime here, I think.
&gt; 
&gt; I'd considered it when I wrote it, but still can't see a reason that it
&gt; would be more useful. Reasoning, please?
</pre>

<p>
ln (and mv, on the same filesystem) don't change mtime, but do change
ctime.
</p>

<p>
So if the aim is "delete this file, and really delete it 30 days from
now", you need ctime. If the aim is "delete this file, and really delete
it if it was (apparently) modified 30 days ago", you need mtime.
</p>

<p>
It might be due to a different interpretation of the spec.
</p>

<p>
But overall, I agree with your original assessment. Shortly after you
hit control-C following an unintentional "rm * .bak", you'll respect
the command that little bit more, and will have a better chance of not
messing up when you're on a new machine that doesn't come with a safety
net by default.
</p>

<p>
Cheers,
</p>

<p>
	f
<pre>-- 
Francis Daly        francis@daoine.org
</pre>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-deleted_file_recovery">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
J.Bakshi [bakshi12 at gmail.com]

</p>
</b><br />
<b>Sun, 19 Oct 2008 12:05:58 +0530</b>
</p>

<p>
<p class="editorial">
[[[  I've taken the liberty of snipping the quoted text, which was more
than 100 lines long. -- Kat  ]]]
</p>

</p>

<p>
Hello,
</p>

<p>
I am really grateful to you all. The knowledge you have shared, the links you 
have given and the scripts you have designed as the possible solutions. I am 
really thankful to all of you.
</p>

<p>
with best regards.
</p>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-deleted_file_recovery">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Ben Okopnik [ben at linuxgazette.net]

</p>
</b><br />
<b>Sun, 19 Oct 2008 09:05:17 -0400</b>
</p>

<p>
On Sun, Oct 19, 2008 at 12:05:58PM +0530, J.Bakshi wrote:
</p>

<pre>
&gt; 
&gt; Hello,
&gt; 
&gt; I am really grateful to you all. The knowledge you have shared, the links you 
&gt; have given and the scripts you have designed as the possible solutions. I am 
&gt; really thankful to all of you.
</pre>

<p>
[ J. Bakshi: I'd really appreciate it if you'd clip the email you're
replying to and leave only the necessary content - just as I have, here. ]
</p>

<p>
This is also a good place to incorporate all the suggested script
changes:
</p>

<p>
<pre class='code'>
#!/bin/bash
# Created by Ben Okopnik on Thu Oct 16 18:17:50 EDT 2008
# Thanks to Thomas Adam and Francis Daly for their good input!
 
[ -z "$1" ] &amp;&amp; { printf "Usage: ${0##*/} &lt;file_to_safely_delete&gt;\n"; exit; }
 
################ User-defined variables ###########################
savedir=${HOME}/.Trash  # Directory in which files are backed up  #
keeptime=30             # Delete backups after this many days     #
###################################################################
 
# Create $savedir if it doesn't exist
[ -d "$savedir" ] || mkdir "$savedir"
 
# Generate unique, time-stamped filename
savename="${1##*/}:`/bin/date '+%s%N'`"
 
# Move the file to $savedir
/bin/mv "$1" "$savedir/$savename"
 
# Delete any files in $savedir that are older than $keeptime
/usr/bin/find "$savedir" -ctime +$keeptime -print0|/usr/bin/xargs -0 rm
</pre>

<p>
You <em>could</em> create a function to do the above, but I'm not much of a fan
of functions when it comes to anything that you may want to run remotely
(e.g., via 'ssh'.)
</p>


<pre>-- 
* Ben Okopnik * Editor-in-Chief, Linux Gazette * <a href="http://LinuxGazette.NET">http://LinuxGazette.NET</a> *
</pre>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-deleted_file_recovery">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
J.Bakshi [bakshi12 at gmail.com]

</p>
</b><br />
<b>Tue, 21 Oct 2008 20:20:10 +0530</b>
</p>

<p>
On Sunday 19 Oct 2008 6:35:17 pm Ben Okopnik wrote:
</p>


<pre>
&gt; [ J. Bakshi: I'd really appreciate it if you'd clip the email you're
&gt; replying to and leave only the necessary content - just as I have, here. ]
</pre>

<p>
I'll definately follow it,
thanks for the script.
</p>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-deleted_file_recovery">Back</a><hr width="50%" align="left" /><p><br /></p></div>
</body>
</html>