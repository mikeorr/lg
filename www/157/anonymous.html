<!DOCTYPE html
	PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="utf-8" xml:lang="utf-8">
<head>
<title>Keymap Blues in Ubuntu's Text Console LG #157</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="stylesheet" href="../lg.css" type="text/css" media="screen, projection"  />
<link rel="alternate" type="application/rss+xml" title="LG RSS" href="lg.rss" />
<link rel="alternate" type="application/rdf+xml" title="LG RDF" href="lg.rdf" />
<!-- link rel="alternate" type="application/atom+xml" title="LG Atom" href="lg.atom.xml" / -->
<link rel="shortcut icon" href="../favicon.ico" />

<style type="text/css" media="screen, projection">
<!--

-->
</style>

</head>
<body>

<a href="../">
<img src="../gx/2003/newlogo-blank-200-gold2.jpg" id="logo" alt="Linux Gazette"/>
</a>
<p id="fun">...making Linux just a little more fun!</p>

<div id="navigation">
<table summary="masthead" width="100%">
<tr>
<td align="center" colspan="3" style="font-size: 10px; font-weight: bold">
<a href="../index.html">Home</a>
<a href="http://linuxgazette.net">Main Site</a>
<a href="../faq/index.html">FAQ</a>

<a href="../lg_index.html">Site Map</a>
<a href="../mirrors.html">Mirrors</a>
<a href="../mirrors.html">Translations</a>
<a href="../search.html">Search</a>
<a href="../archives.html">Archives</a>
<a href="../authors/index.html">Authors</a>
<a href="http://lists.linuxgazette.net/mailman/listinfo/">Mailing Lists</a>
<a href="../jobs.html">Join Us!</a>
<a href="../contact.html">Contact Us</a>

<hr width="99%" style="border: 1px inset #000033">
</td>
</tr>
<tr>
<td width="40%" align="left" style="font-size: 10px; font-weight: bold">
The Free International Online Linux Monthly
</td>
<td width="20%" align="center" style="font-size: 10px; font-weight: bold">
ISSN: 1934-371X
</td>
<td width="40%" align="right" style="font-size: 10px; font-weight: bold">
Main site: <a href="http://linuxgazette.net">http://linuxgazette.net</a> 
</td>
</table>
</div>


<div id="breadcrumbs1">

<a href="../index.html">Home</a> &gt; 
<a href="index.html">December 2008 (#157)</a> &gt; 
Article

</div>

<div class="articlecontent1">
<div class="content">

<div id="previousnexttop">
<A HREF="amurray.html" >&lt;-- prev</A> | <A HREF="dokopnik.html" >next --&gt;</A>
</div>

<h1>Keymap Blues in Ubuntu's Text Console</h1>
<p id="by"><b>By <a href="../authors/anonymous.html">Anonymous</a></b></p>

<p>
Today's news is that, after years of cosying up to SUSE/openSUSE, I have
decided to move unambiguously to Ubuntu. KDE did it to me. <a
href="http://www.youtube.com/watch?v=DzraMSNvhQI">KDE on plasmoids</a>
gives me the jinx, and GNOME on openSUSE is an innocent abroad. On to
Ubuntu 8.10.
</p>

<p>
Moving to Ubuntu is work - at least if you like the text console and spend
time in it. You have to install lots of packages before Ubuntu's text-mode
environment becomes kind of comfortable for administrative tasks and
leisure programming. The 8.10 repositories don't even offer Midnight
Commander, right now. Also, when you think you are done, there are still
surprises waiting around the corner. Take, for instance, the keymap.
(Warning: We are talking about the text-mode keymap, no X11 involved. I do
not intend to repeat this every second sentence.)
</p>


<h3>1.   Where are the keymaps?</h3>

<p>
Where are Ubuntu's text-mode keymaps for languages and special keyboard
layouts like Dvorak? Out there in the wilderness of distros, you will find
a collection of keymaps below /usr/share/keymaps/ or /usr/share/kbd/. A
past version of Fedora I was playing with, two years ago, had them in
/etc/keymaps. Where are they in Ubuntu?
</p>

<p>
Good question. Go ahead and look for them. Poor reader, I see you coming
back with tail nicely folded between hind legs.  How come? They are not
there! They are nowhere! They are behind Locked Door Number X!
</p>

<p>
A few reminiscences. In the late 90s, the maintainer of the kbd package,
which was the basis for keymaps and keymap handling in symbiosis with the
Linux kernel, appeared to be feebly motivated. A competing project, called
console-tools, sprang up and was promptly embraced by Debian, while Red Hat
and SUSE stuck to kbd. However, kbd gathered momentum and released several
new versions in the early 2000s, while console-tools stagnated and became
moribund. It is fair to say that the project is abandoned, while kbd has
just been blessed with the energy of a new maintainer. Debian and Ubuntu
are now moving back to kbd, and facing annoyances galore with compatibility
issues.
</p>

<p>
For Ubuntu, the approach is simple: they do not care about the text
console, so they ignore, as far as possible, the trouble surrounding
keymaps. There is one and only one keymap in Ubuntu 8.10: it is called
boottime.kmap.gz, and is found in /etc/console-setup.
</p>

<p>
Needless to say, those keymaps must exist, since they are console
configuration options -- but they are in the archives in binary form, not
accessible for tinkering and individual customisation. Not accessible for
fun.
</p>


<h3>2.   Why would you want to change the keymap?</h3>

<p>
Surely: Because you are entitled to your idiosyncrasies (I mean
<em>preferences</em>), and that's a strong enough reason. But there are
also a couple of things that, soberly considered, call for intervention.
</p>

<h4>2.1    Some definitions</h4>
<p>
Sorry, terminology pain ahead: 'Keymap' normally indicates a file where the
key assignments get defined. The assignments can refer to plain keys, but
can also refer to modified keys, e.g., &lt;ctrl&gt; or &lt;left&gt;. In the
keymap file, a set of assignments for given modifiers is
<strong>also</strong> called a keymap, so we get a keymap for &lt;ctrl&gt;,
a keymap for &lt;alt&gt; and so on.  Now, hold yourself tight - because
Ubuntu defines 64 keymaps.  All possible modifier combinations are there.
Do not ask me why odd combinations with 3 or 4 or 5 modifiers are there,
since they cannot possibly be typed as long as humans have only two hands.
But they are there, and that's the end of it. Compare with openSUSE or
Fedora, where you will find only single and double modifiers from
the &lt;shift&gt;-&lt;ctrl&gt;-&lt;alt&gt;-&lt;altgr&gt; set - and not
even all of them. That makes sense.
</p>

<p>
Perhaps this is a marginal issue, but let me point out that Ubuntu's keymap
is <em>20 times</em> larger than openSUSE's and Fedora's, and therefore
must have some impact in memory. I never noticed any difference while using
openSUSE and Ubuntu, but the effect must be there.
</p>

<h4>2.2 Read this thread...</h4>

<p>
<a href="https://bugs.launchpad.net/Ubuntu/+source/console-data/+bug/279973">https://bugs.launchpad.net/Ubuntu/+source/console-data/+bug/279973</a>
</p>

<p>
...and you will realize that pressing &lt;printscreen&gt; in the Ubuntu
console produces a Control_backslash, AKA char 28.  The bug report above
refers to 8.04, but the "feature" is still there in 8.10: character 28 has
vandalizing tendencies in some applications, and so work may be lost -- and
it was, indeed, as the thread points out. Control_backslash can still be
produced with &lt;ctrl&gt;&lt;printscreen&gt;, no objection to that, since
it would be intentional. But pressing just plain &lt;printscreen&gt;
inadvertently is just too likely to happen.
</p>

<p>
2.3
The US default keymap and the default keymap for a couple of languages I
have checked (German, French, Spanish, Italian, Russian) define strings for
variables F1 - F20. They also have variables past F20 (F21 and up), but
without any strings defined for them. This last oddity is a problem
everywhere, but here we are concerned with differences between Ubuntu and
mainstream, i.e., between the legacy approach of console-tools versus kbd.
Distros based on kbd are the overwhelming majority. Contrast them with
Ubuntu, with regard to definitions for &lt;shift&gt;&lt;f1&gt; and up:
</p>


<pre class="code">
                    kbd             console-tools
                    (openSUSE)      (Ubuntu)

    &lt;shift&gt;&lt;f1&gt;     F13             F11
    &lt;shift&gt;&lt;f2&gt;     F14             F12
    &lt;shift&gt;&lt;f3&gt;     F15             F13
    &lt;shift&gt;&lt;f4&gt;     F16             F14
    &lt;shift&gt;&lt;f5&gt;     F17             F15
    &lt;shift&gt;&lt;f6&gt;     F18             F16
    &lt;shift&gt;&lt;f7&gt;     F19             F17
    &lt;shift&gt;&lt;f8&gt;     F20             F18
    &lt;shift&gt;&lt;f9&gt;     F21 (void)      F19
    &lt;shift&gt;&lt;f10&gt;    F22 (void)      F20
    &lt;shift&gt;&lt;f11&gt;    F23 (void)      F21 (void)
    &lt;shift&gt;&lt;f12&gt;    F24 (void)      F22 (void)
</pre>

<p>
My first remark, here, would be that the shifted &lt;f9&gt;, &lt;f10&gt;,
&lt;f11&gt;, &lt;f12&gt; are not usable in openSUSE and others, because F21
and up is not defined; it is just the empty string to which no application
can associate a function. For the same reason, shifted &lt;f11&gt; and
&lt;f12&gt; are not available in Ubuntu.
</p>

<p>
However, owing to that fatal Debian decision to switch to console-tools ten
years ago, what we have now is evil: a text-mode application that binds a
function to, say, &lt;shift&gt;&lt;f4&gt; will have the function executed
either under openSUSE, Fedora and co., or under Debian and Ubuntu. It is
not possible to have both.
</p>

<p>
Therefore, here is a gentle request to Ubuntu, Canonical, and Mark
Shuttleworth: it is time to correct those assignments, and accept the kbd
package's defaults for the modified function keys.
</p>

<p>
On top of that, please give yourself a push and introduce strings for F21,
F22 and up. What's the point of assigning these variables to modified
function keys, if the variables deliver only the empty string?
</p>

<p>
With these two mildly reformist measures, 2-3 dozen modified function keys
would instantly become available to text-mode applications. As an example,
Ubuntu installs the "nano" editor by default. Why is it that "nano" uses
only the plain function keys, and resorts to abstruse measures like using
&lt;alt&gt;&lt;underscore&gt; to extend the set of keybindings? It is
because the modified function keys are not coherently defined across
distros. It's long past time to overcome that, all the more so since the
modified function keys would be international by nature. Just look for
&lt;alt&gt;&lt;underscore&gt; on non-US keyboards.
</p>

<h4>2.4.     The Tao of SAK</h4>

<p>
The Secure Attention Key (SAK) is not a physical key; it is a feature that
may or may not have an assignment compiled into the kernel. If it is
compiled into the kernel, it is triggered by
&lt;alt&gt;&lt;printscreen&gt;&lt;k&gt;. However, whatever the kernel
compile options, SAK can also be assigned to any other key of your choice.
It kills all processes in the current console, and logs you out.  That's
practical when you are playing around with some application and manage to
get a totally unresponsive keyboard: as long as the kernel is alive, SAK
will always respond.
</p>

<p>
The 8.10 kernel has built-in SAK -- but a buggy SAK:
</p>

<p>
<a href="http://ubuntuforums.org/showthread.php?p=6169912">http://ubuntuforums.org/showthread.php?p=6169912</a>
</p>

<p>
Pressing SAK gives you a kernel panic, and only switching the power off
will help. Kind of odd, isn't it? The built-in SAK cannot be disabled, and
so users can just crash the system to their heart's content. Didn't Ubuntu
specialize in security?
</p>

<p>
The remedy here is not editing the keymap; it is leaving out the compile
option for SAK (SysReq). Users will still be able to set up SAK in the
keymap, if they so wish - of course, after the SAK bug has been squashed.
</p>

<p>
(The SAK bug, by the way, has been proven to be hardware-specific, see
<a href="http://article.gmane.org/gmane.linux.ubuntu.user/165993/match=sak+producing+kernel+panic">http://article.gmane.org/gmane.linux.ubuntu.user/165993/match=sak+producing+kernel+panic</a>.)
</p>


<h3>3.  How do you modify the Ubuntu's keymap?</h3>

<p>
First, prepare a text file with the keymap of your liking; you could do
that by extracting boottime.kmap from boottime.kmap.gz and modifying it at
your leisure. However, if your editing includes reducing those 64 keymaps
to sensible size (say, 10), you will be busy for one full hour, at least.
It is easier to copy and edit the keymap from any Fedora, openSUSE, or
Mandriva to which you have access. Avoid typos; any little error will cause
the keymap to be refused. (A CRLF end-of-line is an error; only LF is
accepted.) Not required but useful would be a distinctive name, e.g.,
myown.kmap.
</p>

<p>
When you are through:
</p>

<pre class="code">
    loadkeys -s myown.kmap
</pre>

<p>
The catch is that you would need to issue this command every time you boot.
To have that done automatically, you compress myown.kmap and move it as
boottime.kmap.gz to /etc/console-setup. Surprise, it does not work; Ubuntu
wants a MD5 hash for the file, and it wants it precisely in
/etc/default/console-setup. So, you think you are clever, run md5sum on the
new boottime.kmap.gz, and insert the hash as appropriate. Surprise - it
still does not work. With or without the correct MD5 hash at the correct
place, Ubuntu is determined to not let you muck around with the boot-time
keymap.
</p>

<p>
At that moment, it's like a late Western, post-modern: You do not confront
your enemy face-to-face so that the quicker and better and nobler of the
two wins. No, you shoot your enemy from behind. Safe and effective.
</p>

<p>
Among Ubuntu's (run-level independent) boot-time scripts, the last one in
execution order is called <code>/etc/init.d/console-screen.kbd.sh</code>.
Here, you replace the very first lines of code:
</p>

<pre class="code">
if type setupcon &gt;/dev/null 2&gt;&amp;1; then
    exit 0
fi
</pre>

<p>
with
</p>

<pre class="code">
if type setupcon &gt;/dev/null 2&gt;&amp;1; then
    loadkeys -s /etc/console-setup/myown.kmap
    exit 0
fi
</pre>

<p>
...after placing myown.kmap at the indicated location. It works like a
charm. Ubuntu even obliges with a message that it is loading that keymap of
yours.
</p>


<h3>4.  Where do we go from here?</h3>

<p>
Who knows? However, surely the legacy of console-tools has to be overcome,
and more consistency has to be achieved for text-mode keymaps across
distros.
</p>

<p>
Technically, the issue is trivial: assign strings to the keys with a
functional slant. These are keys that normally do not insert anything;
usually, they trigger functions. We are talking about &lt;f1&gt; to
&lt;f12&gt;, &lt;insert&gt; to &lt;pagedown&gt;, the arrow keys,
&lt;printscreen&gt;, &lt;scrolllock&gt;, &lt;break&gt;. They - plain or in
combination with modifiers - don't have to be different across distros or
across languages. However, to make them consistent, you need consensus.
</p>

<p>
And that seems to be a problem.
</p>


<br clear="all" />

<script type='text/javascript'>
digg_url = 'http://linuxgazette.net/157/anonymous.html';
digg_title = 'Keymap Blues in Ubuntu\'s Text Console';
digg_bodytext = '<p> Today\'s news is that, after years of cosying up to SUSE/openSUSE, I have decided to move unambiguously to Ubuntu. KDE did it to me. <a href="http://www.youtube.com/watch?v=DzraMSNvhQI">KDE on plasmoids</a> gives me the jinx, and GNOME on openSUSE is an innocent abroad. On to Ubuntu 8.10. </p> ';
digg_topic = 'linux_unix';
</script>
<script src="http://digg.com/tools/diggthis.js" type="text/javascript"></script>


<p class="talkback">
Talkback: <a
href="mailto:tag@lists.linuxgazette.net?subject=Talkback:157/anonymous.html">Discuss this article with The Answer Gang</a>
</p>

<!-- *** BEGIN author bio *** -->
<!-- ============================================================= -->
<!-- *** BEGIN bio *** -->
<hr>

<p>
<img ALIGN="LEFT" ALT="Bio picture" SRC="../gx/2002/note.png" class="bio">
<em>

A. N. Onymous has been writing for LG since the early days - generally by
sneaking in at night and leaving a variety of articles on the Editor's
desk. A man (woman?) of mystery, claiming no credit and hiding in
darkness... probably something to do with large amounts of treasure in an
ancient Mayan temple and a beautiful dark-eyed woman with a snake tattoo
winding down from her left hip. Or maybe he just treasures his privacy. In
any case, we're grateful for his contributions.<br>
 -- Editor, Linux Gazette

</em>
<br CLEAR="all">

<!-- *** END bio *** -->

<!-- ============================================================= -->


<!-- *** END author bio *** -->

<div id="articlefooter">

<p>
Copyright &copy; 2008, Anonymous. Released under the <a
href="http://linuxgazette.net/copying.html">Open Publication License</a>
unless otherwise noted in the body of the article. Linux Gazette is not
produced, sponsored, or endorsed by its prior host, SSC, Inc.
</p>

<p>
Published in Issue 157 of Linux Gazette, December 2008
</p>

</div>

<div id="previousnextbottom">
<A HREF="amurray.html" >&lt;-- prev</A> | <A HREF="dokopnik.html" >next --&gt;</A>
</div>

</div>
</div>

<script src="http://www.google-analytics.com/urchin.js"
type="text/javascript">
</script>
<script type="text/javascript">
_uacct = "UA-1204316-1";
urchinTracker();
</script>







<img src="../gx/tux_86x95_indexed.png" id="tux" alt="Tux"/>

</body>
</html>

