<!DOCTYPE html
	PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US">
<head>
<title>Debian on a Slug: Or how a Slug made friends with a GNU and a Penguin LG #138</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="stylesheet" href="../lg.css" type="text/css" media="screen, projection"  />
<link rel="alternate" type="application/rss+xml" title="LG RSS" href="lg.rss" />
<link rel="alternate" type="application/rdf+xml" title="LG RDF" href="lg.rdf" />
<link rel="alternate" type="application/atom+xml" title="LG Atom" href="lg.atom.xml" />
<link rel="shortcut icon" href="../favicon.ico" />

<style type="text/css" media="screen, projection">
<!--

-->
</style>

</head>
<body>

<a href="../">
<img src="../gx/2003/newlogo-blank-200-gold2.jpg" id="logo" alt="Linux Gazette"/>
</a>
<p id="fun">...making Linux just a little more fun!</p>

<div id="navigation">
<table summary="masthead" width="100%">
<tr>
<td align="center" colspan="3" style="font-size: 10px; font-weight: bold">
<a href="../index.html">Home</a>
<a href="http://linuxgazette.net">Main Site</a>
<a href="../faq/index.html">FAQ</a>

<a href="../lg_index.html">Site Map</a>
<a href="../mirrors.html">Mirrors</a>
<a href="../mirrors.html">Translations</a>
<a href="../search.html">Search</a>
<a href="../archives.html">Archives</a>
<a href="../authors/index.html">Authors</a>
<a href="http://lists.linuxgazette.net/mailman/listinfo/">Mailing Lists</a>
<a href="../jobs.html">Join Us!</a>
<a href="../contact.html">Contact Us</a>

<hr width="99%" style="border: 1px inset #000033">
</td>
</tr>
<tr>
<td width="40%" align="left" style="font-size: 10px; font-weight: bold">
The Free International Online Linux Monthly
</td>
<td width="20%" align="center" style="font-size: 10px; font-weight: bold">
ISSN: 1934-371X
</td>
<td width="40%" align="right" style="font-size: 10px; font-weight: bold">
Main site: <a href="http://linuxgazette.net">http://linuxgazette.net</a> 
</td>
</table>
</div>


<div id="breadcrumbs1">

<a href="../index.html">Home</a> &gt; 
<a href="index.html">May 2007 (#138)</a> &gt; 
Article

</div>

<div class="articlecontent1">
<div class="content">

<div id="previousnexttop">
<A HREF="dellomodarme.html" >&lt;-- prev</A> | <A HREF="okopnik.html" >next --&gt;</A>
</div>

<h1>Debian on a Slug: Or how a Slug made friends with a GNU and a Penguin</h1>
<p id="by"><b>By <a href="../authors/kapil.html">Kapil Hari Paranjape</a></b></p>

<h2 class="section"><a name="htoc1">1</a>  What <em>Is</em> a Slug?</h2>

<p>
One of the things that caught my eye at <a href="../136/kapil.html">SCaLE5x</a> was the booth of the
"Sluggers". One consequence of this is that I am typing this article while
listening to music emerging from a <em>slug</em> that is also acting as my file backup
service... but I'm getting ahead of the story. So, let me start in a more
practical way - at the beginning.
</p>

<p>
It is now possible (and has been since about 2003) to set up Debian
GNU/Linux on a small Network Attached Storage (NAS) device, which can act
as:
</p>

<ol class="enumerate" type="1">
	<li class="li-enumerate">a Firewall
	<li class="li-enumerate">a Backup server
	<li class="li-enumerate">a Web server
	<li class="li-enumerate">a Music server
	<li class="li-enumerate">a Print server
</ol>

<p>
...and possibly do all of these at once. One such NAS is called the NSLU2,
and is made by Linksys (now a division of Cisco). There are other such
NASes available -- see <a
href="http://www.nslu2-linux.org/"><tt>http://www.nslu2-linux.org/</tt></a>
for details.
</p>

<blockquote class="figure">
<div class="center">
<hr width="80%" size="2">
</div>

<img src="misc/kapil/kutti_art.jpg" border="0" alt="Kutti in action" width= "480" height="640">

<div class="caption">
<table cellspacing="6" cellpadding="0" summary="caption">
<tr>
<td valign="top" align="left">
Figure 1: <tt>kutti</tt> in action. The flat object on the left is its disk.
The pen leaning against <tt>kutti</tt> is to gauge her size.
</td>
</tr>
</table>
</div>

<div class="center">
<hr width="80%" size="2">
</div>
</blockquote>

<p>
Once a NAS device is "converted" to the "Church of Free Software"
it is known as a "slug" to its friends like "GNU" and "Tux".
</p>

<h2 class="section"><a name="htoc2">2</a>  The Parts of a Slug</h2>

<p>
Placing an order for an NAS device is easy, but one needs to make sure
that one also has a USB disk storage device with at least 2GB of
free space -- I happened to have an 80GB disk which I use to carry
around<sup><a name="text1" href="#note1">1</a></sup> my music collection.
</p>

<p>
A "flash" type disk will also work, but, for the typical installation,
you need at least 1GB and preferably 2GB of space. Since the NSLU2 has only
32MB of RAM, you <em>must</em> create a swap partition. Also note that:
</p>

<ol class="enumerate" type="1">
<li class="li-enumerate">
Using semi-conductor memory ("flash") for repeated read-writes
will mean that it will stop working much sooner than when it is used
only for storage. In particular, using it for "swap" is probably
not a great idea.
<li class="li-enumerate">
If you are going to use the NAS device for large storage, you may as well
get a good-sized USB hard disk.
</ol>

<p>
As part of this process, I got to exercise my patience (or my impatience!)
by waiting for an external disk. It all turned out well in the end, since
the new RC2 Debian installer became available on the same day that the disk
arrived.
</p>

<p>
The NAS has an ethernet port, and you can use that to connect to 
a PC for the installation phase. At the same time, the NAS will
be using that same port to download software, so your PC needs to have
some way to get onto the network. I used my laptop, which has two
interfaces -- ethernet and wi-fi. I connected the NAS to the laptop
via ethernet, and used the wi-fi to connect the laptop to the Internet.
</p>

<p>
An alternative is to plug the NAS directly into a LAN that is
connected to your PC. It is enough if your PC can use this same
connection to access the Internet; you don't want to put your slug
on the internet until it has "grown up"!
</p>

<h2 class="section"><a name="htoc3">3</a>  The Hardest Step</h2>

<p>
As with any conversion process, the initial steps are the hardest.
</p>

<blockquote class="quote">
	Have we burnt all our bridges?
</blockquote>

<p>
I recalled the time when I first installed GNU/Linux on a PC, as the same
fears were present then. It is clear <em>now</em> that they were 
unfounded, and I think the words "Don't Panic" should be printed in 
large letters on all these gadgets<sup><a name="text2" href="#note2"
>2</a></sup>. At the same time, I must say that it <em>is</em> possible 
to "brick" your device. However, if you follow the instructions then it 
is unlikely<sup><a name="text3" href="#note3">3</a></sup>.
</p>

<p>
In the case of PCs, we have learnt that all is well, as long as one does not
damage the BIOS<sup><a name="text4" href="#note4">4</a></sup>. For the
slug, the equivalent is "RedBoot" -- you should not erase/replace the RedBoot
on a slug, unless you are very confident with a soldering iron or are a
slug-killer. Anyway, all the interesting stuff happens after the RedBoot
has done its stuff, so why mess with it?
</p>

<p>
In spite all the helpful hints all over the Web, the actual decision to go
ahead with the installation was the hardest step. After some vacillation,
the following thought occurred to me: "If I don't install Debian on this, it
will feel like a brick to me anyway!"
</p>

<h2 class="section"><a name="htoc4">4</a>  Pre-Packaged Stuff</h2>

<p>
The NSLU2 already runs Linksys's own version of GNU/Linux. They have
posted the sources on their Web page, as well. So you should not feel
guilty about connecting to the NSLU2 and playing with the Web
interface -- even if you are a True Believer. It's Open Source all the way!
</p>

<p>
The default boot-up address of the NSLU2 is <code>192.168.1.77</code>,
so you need to have an address in that range to connect to it. The
simplest way to do this is:
</p>

<pre>   ifconfig eth:0 192.168.1.1 netmask 255.255.0.0
</pre>

<p>
An advantage of using the <code>192.168.1.1</code> address is that the
NSLU2 uses that as its DNS server and gateway. After you have this
set up, you can point your browser window (even <code>w3m</code> works!) at
<code>http://192.168.1.77/</code>, to play with the Linksys Web interface.
The manual explains that you can login as <code>admin</code> with password
<code>admin</code>, in order to perform administrative tasks.
</p>

<p>
The NSLU2 can also be reached during the RedBoot phase. Immediately after
pressing the power-on switch (&lt;2 seconds after boot up), you can do
<code>telnet 192.168.0.77</code>. Note the '<code>0</code>' instead of the
'<code>1</code>'. This is the reason for the netmask chosen above. I didn't
play much with the interface, except to get familiar with it -- "just
in case"! 
</p>

<p>
Meanwhile, you may wish to have the following preparatory tasks done on the
laptop: (I am never <em>that</em> efficient, but at least others can be!):
</p>

<ol class="enumerate" type=1>
<li class="li-enumerate">
Download the patched Debian RC2 via the <code><a
href="http://slug-firmware.net">slug-firmware.net</a></code> web site. The
patch is required, since the NSLU2 ethernet card requires firmware that can
be downloaded from the Intel Web site after accepting an end-user license;
The patch adds this to the RC2 image.
<li class="li-enumerate">Prepare the USB drive. I used a 2GB swap partition
and a 6GB root partition, and kept the rest for LVM to be set up later. I
also ran <code>mke2fs</code> on the partition chosen for root. 
<li class="li-enumerate">Unzip the Debian RC2 image. Something like 

<pre class="verbatim">
    7z x debian-etch-rc2-2007-03-08.zip
</pre>

should do. This will result in a file called <code>di-nslu2.bin</code>.
</ol>

<h2 class="section"><a name="htoc5">5</a>  The NSLU2 Sees the Light</h2>

<p>
The first step of the conversion (appropriately) is to "flash" the NSLU2.
You unplug all hard disks from the NSLU2 (and perhaps reboot it just
to be on the safe side).
</p>

<p>
There are two ways to do the firmware upgrade -- the way I describe below,
and the recommended way. Martin Michlmayr was kind enough to point out that
the recommended way is to use <code>upslug2</code>. To do this, install the
<code>upslug2</code> package on your laptop/PC (it <em>is</em> running
Debian, isn't it?!). The man page that comes with the program is excellent.
</p>

<p>
I felt that "hard reset" was an unkind step to perform on my
soon-to-be slug. So, I followed the steps outlined below.
</p>

<p>
In the Linksys configuration interface, you go to the "Advanced"
configuration menu, and within that, you choose "Upgrade". This will
give you the option of upgrading the firmware by uploading a file. Put
the full path of your Debian Installer image <code>di-nslu2.bin</code> in
the slot for the file name -- don't press the submit button just yet!
</p>

<p>
Open another window or tab in your browser (<code>w3m</code> now has tabs!).
Go through the same steps as above in this other window. Now, press
the submit button (actually it is labelled "Start Upgrade"), in one
of the two windows. The NSLU2 will sometimes close this connection to
the browser (due to some bug in the Linksys software). You then need to
resubmit this "Start Upgrade" request after about 30-60 seconds -- aren't
you glad that you still have another window/tab open at the same place?
</p>

<p>
The NSLU2 will indicate, by means of a flashing amber light, that it is
uploading the firmware and installing it. This takes about 2-3
minutes, and, at the end of it, the NSLU2 will reboot. Didn't work?
Well, you know that adage, "If at first you don't succeed, try, try
again!" It is sometimes tricky getting the timing right. Also, the
"hard reset" approach using <code>upslug2</code> is less tricky.
</p>


<div class="pullquotes">
<a name="pullquote_138_kapil_1"></a>
<table border="2" summary="pullquote">
<tr>
<td align="left" bgcolor="#d9f974">
<sup>Category: User kindness</sup>
<br />
<strong>
I recalled the time when I first installed GNU/Linux on a PC, as the same fears were present then. It is clear now that those fears were unfounded, and I think the words "Don't Panic" should be printed in large letters on all these gadgets.
</strong>
</td>
</tr>
</table>
</div>


<h2 class="section"><a name="htoc6">6</a>  Infant Slug</h2>

<p>
When the NSLU2 next reboots, it has become an "infant slug". It
takes a while for it to boot into the installer (about 7 minutes)
and then it emits three beeps. If you listen carefully, it is saying
"Give me more!" Now that it has a taste of Debian (via the Debian
Installer), it really needs the whole thing. At this point, you can, in
principle, shut the slug down using the power-off button (or be even
more unkind and detach the power cord!). I needed to do this as I had
to move my setup to a place that had good enough network connectivity
to download all the base Debian packages.
</p>

<p>
Next, I set things up to use a proxy service on my laptop to serve
the Debian packages to the slug. I could have used <code>apt-proxy</code>
but since I already have <code>polipo</code> setup on my laptop, I used
that. This service listens to port 8123 on the localhost interface.
</p>

<p>
Next step. Connect the slug to the laptop, as before. This time,
also connect the USB disk to the slug and boot it up.
Wait for the three beeps and then log in with ssh:
</p>

<pre class="verbatim">
    ssh -R 8123:localhost:8123 installer@192.168.1.77
</pre>

<p>
The <code>-R 8123:localhost:8123</code> is a forethought that I wish I
had had! This login takes you into the Debian installer, from which
one can continue as usual for a Debian installation, except for the
following:
</p>

<ol class="enumerate" type="1">
<li class="li-enumerate">
Do <em>not</em> use the "mtd" devices for anything.  These are the firmware
devices, and you do not want to write to them until you are an expert.
<li class="li-enumerate">Make sure that you avoid formatting your root
partition on the slug: you should do this step on your PC. The installer
often takes too long, or runs out of memory while doing this on the slug.
<li class="li-enumerate">You should use an http proxy setting. When the
installer prompts you for one, you type in: 

<pre class="verbatim">
    http://localhost:8123/
</pre>

"Eh?!", you say, "Where is the proxy server on the slug?" Now you
understand the point of the <code>-R</code> switch.  The real proxy server
is on your laptop, and <code>ssh</code> is just forwarding the connection.
<li class="li-enumerate">The slug takes a long while to install. In
particular, it seems to take a lot of time to setup the time!<sup><a
name="text5" href="#note5">5</a></sup> (At this point, you discover
<strong>why</strong> there will never be a flying slug next to the flying
GNU and the flying penguin.)
</li></ol>

<p>
...and two (or more!) hours later your slug is all grown up
and ready to roll.
</p>

<p>
The last stage of the Debian installer is when it writes the kernel
to the firmware of the slug and reboots. It is no longer beeping,
since it now has a base Debian install and can easily feed itself!
You can <code>ssh</code> to it as before. At this point, you may want to
make it a full-fledged member of the network and give it its own static
IP address -- or you may configure it to use DHCP.
</p>

<p>
One nice thing to note is that <em>only</em> the kernel and the initial
ramdisk (<code>initrd</code>) are on the firmware. If your slug is switched
off, you can just connect the USB disk to your laptop in order to edit
the file system. This is useful. For example, if you managed to
completely screw up your network configuration so that you can't
even <code>ssh</code> into the slug. I used this method to create the LVM
partition on the USB disk and copy my music collection to it.
</p>

<h2 class="section"><a name="htoc7">7</a>  The Singing Slug</h2>

<p>
One worthwhile way to spend those two hours is to go and shop for a
USB audio device. Or you may have been clever and bought it at the same
time as you bought the NSLU2!
</p>

<p>
It is relatively easy to setup your slug to use this device. Just
plug the USB audio device into the "other" USB slot on your system,
and you should see the audio device being nicely auto-detected by
<code>udev</code>. Use <code>alsamixer</code> to set up your volume and try
</p>

<pre class="verbatim">
    aplay /usr/share/sounds/alsa/Noise.wav
</pre>

<p>
What - no sound? Did you remember to plug in the speakers into the USB
audio device - or a headset? I didn't!
</p>

<p>
You can now play all your <code>.wav</code> files through the system.
However, don't start installing your favourite music playing software
from the Debian archive just yet. The problem is that the ARM
processor has no floating point unit, and so the players that use
floating point computations to perform music decompression will not
be able to do those computations fast enough to produce anything
resembling music!
</p>

<p>
Luckily, there is already <code>mpg321</code>, which uses an 
integer-arithmetic-based decompression routine for <code>.mp3</code>
files. There is also a version of the Xiph(TM) library for
<code>.ogg</code> files called "Tremor" that does integer arithmetic
base decompression for those files. I found nicely detailed instructions
to set up the <code>mpd</code> music-playing daemon using these libraries
at the <a href="http://nslu2-linux.org">http://nslu2-linux.org</a> site.
Voila! Or if you prefer -- Violin!  
</p>

<p class="editorial">
[ At this point, I was tempted to mark this article as '<a
href="http://en.wikipedia.org/wiki/X-rated">rated X</a>'... too much
sax and violins. -- Ben ]
</p>

<h2 class="section"><a name="htoc8">8</a>  Backup a Bit</h2>

<p>
Your slug is complete Debian system - <em>much</em> faster than
that old 386 box with 20MB hard disk and 4MB of RAM that you use as
a mail and DNS server. So, go ahead and create an account for yourself
where you can backup your files using <code>rsync</code> (with the promise
to yourself that next time you will definitely learn enough to set it
up as a Subversion, GIT, or Mercurial repository).
</p>

<p>
You can also set up a Web server like <code>mathopd</code> (or even
Apache). This is Debian, with 16,000 (...and counting!) packages. The
possibilities are limitless. Remember that it is a slug, but it
"ain't no slouch".
</p>

<p>
You aren't quite done yet. Don't forget to file your Debian installation
report using <code>reportbug</code>. It is also good manners to donate
something to the guys who setup the nslu2-firmware binaries that helped you
to get your slug rolling, and will help in the creation of more slugs in
future. If you have some money left, then investigate all the USB devices
out there - infra-red, bluetooth, Wi-Fi, VGA adaptor.... Of course, you
need to first buy a USB multi-port hub, since the NSLU2 has only two USB
ports!
</p>

<h2 class="section"><a name="htoc9">9</a>  Resources</h2>

<p>
The following sites provided extremely useful information:

</p>
<ol class="enumerate" type="1">
<li class="li-enumerate">
The NSLU2 Linux site at <a href="http://www.nslu2-linux.org/"><tt>http://www.nslu2-linux.org/</tt></a>.
<li class="li-enumerate">
Martin Michlmayr's Debian/NSLU2 Web site at <a href="http://www.cyrius.com/debian/nslu2/"><tt>http://www.cyrius.com/debian/nslu2/</tt></a>.
<li class="li-enumerate">
The Debian Etch Release and Installation pages for the ARM processor at <a
href="http://www.debian.org/releases/etch/arm/"><tt>http://www.debian.org/releases/etch/arm/</tt></a>.
</ol>

<h2 class="section"><a name="htoc10">10</a>  Acknowledgements</h2>

<p>
First of all, I would like to thank CalTech for inviting me for a
long period. This gave me enough resources (time and money) to go
to SCaLE5x and see the NSLU2-Linux booth there. More importantly, I
thank the guys at nslu2-linux, who have worked hard all these years
to make the slug the great friend of the GNU and the Penguin. 
I also thank Martin Michlmayr and the other Debian
developers who have made installation of Debian on the NSLU2 a breeze;
in particular, Martin also answered a number of questions that I
posted in my installation report. I also toast all the contributors
to the Wiki at the nslu2-linux.org web site; there are so many ideas
there it would take a lifetime to try them all!
</p>

<p>
Coming back to the money angle a bit. If I look at the amount of money
(less than USD $100) that I have spent on getting my slug (baptized
<code>kutti</code>) up and running, it is certainly money well spent. Not
just because it is <em>my</em> slug, but because it is a genuinely useful
computer in my menagerie. However, when I translate this amount into Indian
Rupees, I realise that it is not an amount that could be "thrown away" on
an experimental project funded from one's own earnings. Which is why I
wrote this article -- to try to convince others that this is not
"experimental" anymore. Go forth and multiply those slugs!
</p>

<hr class="footnoterule"><dl class="thefootnotes"><dt class="dt-thefootnotes">
<a name="note1" href="#text1">1</a></dt><dd class="dd-thefootnotes">I
presume that I am allowed to do this under "fair use" clauses!
</dd><dt class="dt-thefootnotes"><a name="note2"
href="#text2">2</a></dt><dd class="dd-thefootnotes">Kudos to Douglas Adams
for realising the importance of this phrase.
</dd><dt class="dt-thefootnotes"><a name="note3"
href="#text3">3</a></dt><dd class="dd-thefootnotes">To quote P. Smith:
"Never confuse the impossible with the improbable."
</dd><dt class="dt-thefootnotes"><a name="note4"
href="#text4">4</a></dt><dd class="dd-thefootnotes">A friend managed to
brick his laptop by flashing the BIOS.
</dd><dt class="dt-thefootnotes"><a name="note5"
href="#text5">5</a></dt><dd class="dd-thefootnotes">I thought it was trying
to contact an NTP server, but Martin Michlmayr clarified that it was not.
</dd></dl>
<hr size="2">



<p class="talkback">
Talkback: <a
href="mailto:tag@lists.linuxgazette.net?subject=Talkback:138/kapil.html">Discuss this article with The Answer Gang</a>
</p>

<!-- *** BEGIN author bio *** -->
<!-- *** BEGIN bio *** -->
<hr>
<p>
<img align="left" alt="Bio picture" src="../gx/authors/kapil.jpg" class="bio">
<em>

Kapil Hari Paranjape has been a ``hack''-er since his punch-card days.
Specifically, this means that he has never written a ``real'' program.
He has merely tinkered with programs written by others. After playing
with Minix in 1990-91 he thought of writing his first program---a
``genuine'' *nix kernel for the x86 class of machines. Luckily for him a
certain L. Torvalds got there first---thereby saving him the trouble
(once again) of actually writing code. In eternal gratitude he has spent
a lot of time tinkering with and promoting Linux and GNU since those
days---much to the dismay of many around him who think he should
concentrate on mathematical research---which is his paying job. The
interplay between actual running programs, what can be computed in
principle and what can be shown to exist continues to fascinate him.

</em>
<br clear="all">
<!-- *** END bio *** -->

<!-- *** END author bio *** -->

<div id="articlefooter">

<p>
Copyright &copy; 2007, Kapil Hari Paranjape. Released under the <a
href="http://linuxgazette.net/copying.html">Open Publication License</a>
unless otherwise noted in the body of the article. Linux Gazette is not
produced, sponsored, or endorsed by its prior host, SSC, Inc.
</p>

<p>
Published in Issue 138 of Linux Gazette, May 2007
</p>

</div>

<div id="previousnextbottom">
<A HREF="dellomodarme.html" >&lt;-- prev</A> | <A HREF="okopnik.html" >next --&gt;</A>
</div>

</div>
</div>

<script src="http://www.google-analytics.com/urchin.js"
type="text/javascript">
</script>
<script type="text/javascript">
_uacct = "UA-1204316-1";
urchinTracker();
</script>







<img src="../gx/tux_86x95_indexed.png" id="tux" alt="Tux"/>

</body>
</html>

