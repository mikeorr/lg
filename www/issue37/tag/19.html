<!--startcut ======================================================= -->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<html>
<head>
<META NAME="generator" CONTENT="lgazmail v1.1H.i">
<TITLE>The Answer Guy 37: PPP Disconnects</TITLE>
</HEAD><BODY BGCOLOR="#FFFFFF" TEXT="#000000"
	LINK="#3366FF" VLINK="#A000A0">
<!-- ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::: -->
<H4>"The Linux Gazette...<I>making Linux just a little more fun!</I>"</H4>
<P> <hr> <P>
<!-- ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::: -->
<center>
<H1><A NAME="answer">
	<img src="../../gx/dennis/qbubble.gif" alt="(?)" 
		border="0" align="middle">
	<font color="#B03060">The Answer Guy</font>
	<img src="../../gx/dennis/bbubble.gif" alt="(!)" 
		border="0" align="middle">
</A></H1> 
<BR>
<H4>By James T. Dennis,
	<a href="mailto:tag@lists.linuxgazette.net">tag@lists.linuxgazette.net</a><BR>
	Starshine Technical Services,
	<A HREF="http://www.starshine.org/">http://www.starshine.org/</A> 
</H4>
</center>

<p><hr><p>
<!--  endcut ======================================================= -->
<!-- begin 19 -->
<H3 align="left"><img src="../../gx/dennis/qbubble.gif" 
	height="50" width="60" alt="(?) " border="0"
	>PPP Disconnects</H3>


<p><strong>From sipior on Tue, 05 Jan 1999  
</strong></p>
<!-- ::
PPP Disconnects
~~~~~~~~~~~~~~~
:: -->
<P><STRONG><IMG SRC="../../gx/dennis/qbub.gif" ALT="(?)"
	HEIGHT="28" WIDTH="50" BORDER="0"
	>
Greetings, Mr. Dennis!
</STRONG></P>
<P><STRONG>
Having taken my computer home with me for a couple of weeks, so that
</STRONG></P>
<P><STRONG>
I might not be Quake-deprived for the Christmas season, I found myself
setting up a PPP connection with a local ISP. I was able to manually effect
a PPP connection with little difficulty at all---however, I have been unable
to automate the dialup process with ppp-on and ppp-on-dialer scripts (as
detailed in the PPP-HOWTO). After tailoring these scripts to my particular
setup, I was able to connect well enough, only to have the modem
automatically hang up immediately! The relevant portion of my system log
(sanitised for our mutual protection 
<IMG SRC="../../gx/dennis/smily.gif" ALT=":-)" 
		height="24" width="20" align="middle"> follows:
</STRONG></P>
<Pre><STRONG>
Jan  2 18:17:56 sarnath kernel: PPP: version 2.2.0 (dynamic channel
allocation)
Jan  2 18:17:56 sarnath kernel: PPP Dynamic channel allocation code
copyright 1995 <A HREF="http://www.caldera.com/">Caldera</A>, Inc.
Jan  2 18:17:56 sarnath kernel: PPP line discipline registered.
Jan  2 18:17:56 sarnath kernel: Serial driver version 4.13 with no serial options enabled
Jan  2 18:17:56 sarnath kernel: tty00 at 0x03f8 (irq = 4) is a 16550A
Jan  2 18:17:56 sarnath kernel: tty01 at 0x02f8 (irq = 3) is a 16550A
Jan  2 18:17:56 sarnath kernel: registered device ppp0
Jan  2 18:17:56 sarnath pppd[599]: pppd 2.3.3 started by root, uid 0
Jan  2 18:17:57 sarnath chat[604]: timeout set to 3 seconds
</STRONG></Pre>
<BLOCKQUOTE><IMG SRC="../../gx/dennis/bbub.gif" ALT="(!)"
	HEIGHT="28" WIDTH="50" BORDER="0"
	>
This timeout might be a tad shorter than you'd like.
Try 15 seconds or so.
</BLOCKQUOTE>
<Pre><STRONG><IMG SRC="../../gx/dennis/qbub.gif" ALT="(?)"
	HEIGHT="28" WIDTH="50" BORDER="0"
	>
Jan  2 18:17:57 sarnath chat[604]: ATH0^M^M
Jan  2 18:17:57 sarnath chat[604]: OK
Jan  2 18:17:57 sarnath chat[604]:  -- got it
Jan  2 18:17:57 sarnath chat[604]: send (ATDTXXXXXXX^M)
Jan  2 18:17:58 sarnath chat[604]: expect (CONNECT)
Jan  2 18:17:58 sarnath chat[604]: ^M
Jan  2 18:18:16 sarnath chat[604]: ATDTXXXXXXX^M^M
</STRONG></Pre>
<BLOCKQUOTE><IMG SRC="../../gx/dennis/bbub.gif" ALT="(!)"
	HEIGHT="28" WIDTH="50" BORDER="0"
	>
... your forgot to sanitize your local number
from these logs.  I've done it here.
</BLOCKQUOTE>
<Pre><STRONG><IMG SRC="../../gx/dennis/qbub.gif" ALT="(?)"
	HEIGHT="28" WIDTH="50" BORDER="0"
	>
Jan  2 18:18:16 sarnath chat[604]: CONNECT
Jan  2 18:18:16 sarnath chat[604]:  -- got it
Jan  2 18:18:16 sarnath chat[604]: send (^M)
Jan  2 18:18:16 sarnath chat[604]: expect (ost :) 
Jan  2 18:18:16 sarnath chat[604]:  38400^M
Jan  2 18:18:18 sarnath chat[604]: - Blue Moon K56flex -^M
Jan  2 18:18:18 sarnath chat[604]: ^M
Jan  2 18:18:18 sarnath chat[604]: Select HOST:^M
Jan  2 18:18:18 sarnath chat[604]: ^M
Jan  2 18:18:18 sarnath chat[604]: ppp^M
Jan  2 18:18:18 sarnath chat[604]: shell^M
Jan  2 18:18:18 sarnath chat[604]: bbs^M
Jan  2 18:18:18 sarnath chat[604]: ^M
Jan  2 18:18:18 sarnath chat[604]: Type new to register for net access.^M
Jan  2 18:18:18 sarnath chat[604]: ^M
Jan  2 18:18:18 sarnath chat[604]: host:
Jan  2 18:18:18 sarnath chat[604]:  -- got it
Jan  2 18:18:18 sarnath chat[604]: send (ppp^M)
Jan  2 18:18:18 sarnath chat[604]: expect (ogin :) 
Jan  2 18:18:18 sarnath chat[604]:  ^M
Jan  2 18:18:18 sarnath chat[604]: host: ppp^M
Jan  2 18:18:18 sarnath chat[604]: login:
Jan  2 18:18:18 sarnath chat[604]:  -- got it
Jan  2 18:18:18 sarnath chat[604]: send (xxxxxxx^M)
Jan  2 18:18:18 sarnath chat[604]: expect (assword :) 
Jan  2 18:18:18 sarnath chat[604]:  xxxxxxx^M
Jan  2 18:18:18 sarnath chat[604]: Password:
Jan  2 18:18:18 sarnath chat[604]:  -- got it
Jan  2 18:18:18 sarnath chat[604]: send (********^M)
Jan  2 18:18:18 sarnath pppd[599]: Serial connection established.
Jan  2 18:18:19 sarnath pppd[599]: Using interface ppp0
Jan  2 18:18:19 sarnath pppd[599]: Connect: ppp0 &lt;--&gt; <TT>/dev/ttyS1</TT>
Jan  2 18:18:23 sarnath pppd[599]: Modem hangup
Jan  2 18:18:23 sarnath pppd[599]: Connection terminated.
Jan  2 18:18:24 sarnath pppd[599]: Exit.
Jan  2 18:19:56 sarnath kernel: PPP: ppp line discipline successfully unregistered
</STRONG></Pre>
<P><STRONG>
Sorry for the long excerpt, by the way---if I had a better idea of
where the trouble was, I could perhaps have quoted fewer lines...
<IMG SRC="../../gx/dennis/smily.gif" ALT=":)" 
		height="24" width="20" align="middle">
</STRONG></P>
<P><STRONG>
What I find perplexing is that the modem hangup comes directly after
</STRONG></P>
<P><STRONG>
the connection is established, but with no IP number yet assigned. I have
also attached my <TT>/etc/ppp/options</TT>, <TT>/etc/ppp/scripts/ppp-on</TT>, and
<TT>/etc/ppp/scripts/ppp-on-dialer</TT> files. These all come with the RedHat 5.0
distribution, obviously edited for my circumstances.
</STRONG></P>
<P><STRONG>
Ultimately, I guess my question is: "What am I missing?" Connecting
manually is not exactly a Brobdingnagian task, but it does keep me from
using diald, along with some other clever script-driven ppp utilities. I
have been up and down the PPP-HOWTO, along with other <TT>/usr/doc/ppp</TT> files,
and cannot effect a solution. I assume what I am missing is terribly
obvious, and maybe a fresh pair of eyes can see after a few minutes what
mine cannot after many hours 
<IMG SRC="../../gx/dennis/smily.gif" ALT=":-)" 
		height="24" width="20" align="middle"> If there is any more information you
require, I will be happy to provide it, though I have tried to be as
painfully complete as possible in this e-mail.
</STRONG></P>
<P><STRONG>
Anyway, I thank you for any time you can spare on this problem, and
I look forward to hearing from you!
</STRONG></P>
<P><STRONG>
Regards,
Michael Sipior
</STRONG></P>
<P><STRONG><em>
Finger <A HREF="mailto:sipior@aloha.astro.psu.edu"
	>sipior@aloha.astro.psu.edu</A> for Public PGP Key
<br>DSS -- C1FE AB1E CDE4 0E55 6A7D  BE58 0058 E502 A645 5531
</em></STRONG></P>
<Pre><STRONG>
debug
-detach
/dev/ttyS1
38400
modem
lock
crtscts
defaultroute
asyncmap 0
mtu 552
mru 552
</STRONG></Pre>
<BLOCKQUOTE><IMG SRC="../../gx/dennis/bbub.gif" ALT="(!)"
	HEIGHT="28" WIDTH="50" BORDER="0"
	>
Try it with the -detach directive commented out.
</BLOCKQUOTE>
<PRE><STRONG><IMG SRC="../../gx/dennis/qbub.gif" ALT="(?)"
	HEIGHT="28" WIDTH="50" BORDER="0"
	>
#!/bin/sh
#
# Script to initiate a ppp connection. This is the first part of the
# pair of scripts. This is not a secure pair of scripts as the codes
# are visible with the 'ps' command.  However, it is simple.
#
# These are the parameters. Change as needed.
TELEPHONE=*******	# The telephone number for the connection
ACCOUNT=msipior	# The account name for logon (as in 'George Burns')
PASSWORD=********	# The password for this account (and 'Gracie Allen')
LOCAL_IP=0.0.0.0	# Local IP address if known. Dynamic = 0.0.0.0
REMOTE_IP=0.0.0.0	# Remote IP address if desired. Normally 0.0.0.0
NETMASK=255.255.255.0	# The proper netmask if needed
#
# Export them so that they will be available at 'ppp-on-dialer' time.
export TELEPHONE ACCOUNT PASSWORD
#
# This is the location of the script which dials the phone and logs
# in.  Please use the absolute file name as the $PATH variable is not
# used on the connect option.  (To do so on a 'root' account would be
# a security hole so don't ask.)
#
DIALER_SCRIPT=/etc/ppp/scripts/ppp-on-dialer
#
# Initiate the connection
#
# I put most of the common options on this command. Please, don't
# forget the 'lock' option or some programs such as mgetty will not
# work. The asyncmap and escape will permit the PPP link to work with
# a telnet or rlogin connection. You are welcome to make any changes
# as desired. Don't use the 'defaultroute' option if you currently
# have a default route to an ethernet gateway.
#
exec <TT>/usr/sbin/pppd</TT> debug lock modem crtscts <TT>/dev/ttyS1</TT> 38400 \
</STRONG></PRE>
<PRE><STRONG>
asyncmap 20A0000 escape FF kdebug 0 $LOCAL_IP:$REMOTE_IP noipdefault netmask $NETMASK defaultroute connect $DIALER_SCRIPT
</STRONG></PRE>
<BLOCKQUOTE><IMG SRC="../../gx/dennis/bbub.gif" ALT="(!)"
	HEIGHT="28" WIDTH="50" BORDER="0"
	>
Some of these options conflict with those your list from
<TT>/etc/ppp/options</TT> file above.  In particular I notice that
the asyncmap is different.  I also note that the MTU/MRU
values you have listed are a bit odd.  I usually see 296
for slower modems (14.4 and under) and 576 for faster
modems (28.8 and up).  The 'kdebug' option here results
in those kernel/syslog messages from pppd (and the -v on your
chat script, below, results in the syslog messages from
that command).
</BLOCKQUOTE>
<BLOCKQUOTE>
Try it with an empty <TT>/etc/ppp/options</TT> file (that file is
global and might conflict with the directives that you're
putting on the command line).  Try removing all of these
options from the pppd invocation --- and isolating them
into their own options file.  Replace all the options on
this long command line with just:
</BLOCKQUOTE>
<BLOCKQUOTE><BlockQuote>
<TT>/usr/sbin/pppd</TT> file <TT>/etc/ppp/foo.options</TT>
</BlockQuote></BLOCKQUOTE>
<BLOCKQUOTE>
... and put each option directive (and it's arguments)
on a single line in the foo.options file.
</BLOCKQUOTE>
<PRE><STRONG><IMG SRC="../../gx/dennis/qbub.gif" ALT="(?)"
	HEIGHT="28" WIDTH="50" BORDER="0"
	>
#!/bin/sh
#
# This is part 2 of the ppp-on script. It will perform the connection
# protocol for the desired connection.
#
exec <TT>/usr/sbin/chat</TT> -v				\
</STRONG></PRE>
<PRE><STRONG>
TIMEOUT		3				ABORT		'\nBUSY\r'			ABORT		'\nNO ANSWER\r'			ABORT		'\nRINGING\r\n\r\nRINGING\r'	&quot;		'\rAT'				'OK-+++\c-OK'	ATH0				TIMEOUT		30				OK		ATDT$TELEPHONE			CONNECT		&quot;				ost:		ppp				ogin:--ogin:	$ACCOUNT			assword:	$PASSWORD
</STRONG></PRE>
<BLOCKQUOTE><IMG SRC="../../gx/dennis/bbub.gif" ALT="(!)"
	HEIGHT="28" WIDTH="50" BORDER="0"
	>
This seems like an odd way to do this.  I usually isolate
my chat scripts in their own file and use my ppp/options
file's 'connect' directive to invoke 'chat' with the -f
option --- which points to my standalone chat script like
so:
</BLOCKQUOTE>
<BLOCKQUOTE><BLOCKQUOTE><CODE>
connect <TT>/usr/sbin/chat</TT> -v -f <TT>/etc/ppp/MYISP.chat</TT>
</CODE></BLOCKQUOTE></BLOCKQUOTE>
<BLOCKQUOTE>
... with different files for different chat scripts.
I also invoke 'pppd' with just the 'file' directive
on its command line --- like:
</BLOCKQUOTE>
<BLOCKQUOTE><BlockQuote>
<TT>/usr/sbin/pppd</TT> file <TT>/etc/ppp/MYISP.options</TT>
</BlockQuote></BLOCKQUOTE>
<BLOCKQUOTE>
... and localize my options therein.  My global options
file then just has the "lock" directive --- or is blank
(for some special cases).
</BLOCKQUOTE>
<BLOCKQUOTE>
I really don't see anything that jumps out at me.  However,
I've noted a couple of oddities.  One other suggestion which
relates to a similar problem I had once:
</BLOCKQUOTE>
<BLOCKQUOTE><BlockQuote>
When you log in  interactively, look for the
last bit of plain text that's printed by your ISPs
system before it starts printing the PPP "gibberish"
</BlockQuote></BLOCKQUOTE>
<BLOCKQUOTE>
One of the ISPs I worked with would print
"starting PPP..." after my script would enter the
password.  This was getting "stuck" in a buffer
somewhere and confusing pppd (similar to what
happens in C when you use a '<TT></TT>' library call
with a bad format specifier).  The problem only
showed up when I was using the chat script and
not if I used 'minicom' to start the session,
then quit out of that while leaving the connection
up and using pppd to take over the existing
connection.
</BLOCKQUOTE>
<BLOCKQUOTE>
Adding a last "expect" string to my chat script
to "gobble that last text message up" seemed to
solve the problem.
</BLOCKQUOTE>
<BLOCKQUOTE>
Try that and see if it helps.  Then ask your ISP for
some additional tips.
</BLOCKQUOTE>
<BLOCKQUOTE>
You might also try one or several of the GUI PPP
configuration frontends.  I've never used any of them
--- but they've apparently gotten pretty good for the
common cases.  Any of the good ones should generate
text chat script and options files that you can manually
tweak.
</BLOCKQUOTE>
<!-- sig -->

<!-- end 19 -->
<!--startcut ======================================================= -->
<P> <hr> <P>
<H5 align="center"><a href="http://www.linuxgazette.net/copying.html"
	>Copyright &copy;</a> 1999, James T. Dennis 
<BR>Published in <I>The Linux Gazette</I> Issue 37 February 1999</H5>
<P> <hr> <P>
<!-- ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::: -->
<P align="center">
<table width="98%"><tr valign="center" align="center">
<td rowspan="3" colspan="4"><A HREF="../lg_answer37.html"><IMG
        SRC="../../gx/dennis/answernew.gif"
        ALT="[ Answer Guy Index ]"></A></td>
  <TD width="8%"><A HREF="./1.html">1</A></TD>
  <TD width="8%"><A HREF="./2.html">2</A></TD>
  <TD width="8%"><A HREF="./3.html">3</A></TD>
  <TD width="8%"><A HREF="./4.html">4</A></TD>
  <TD width="8%"><A HREF="./5.html">5</A></TD>
  <TD width="8%"><A HREF="./6.html">6</A></TD>
  <TD width="8%"><A HREF="./7.html">7</A></TD>
  <TD width="8%"><A HREF="./8.html">8</A></TD>
  <TD width="8%"><A HREF="./9.html">9</A></TD>
  <TD width="8%"><A HREF="./10.html">10</A></TD>

</tr><tr valign="center" align="center">
  <TD><A HREF="./11.html">11</A></TD>
  <TD><A HREF="./12.html">12</A></TD>
  <TD><A HREF="./14.html">14</A></TD>
  <TD><A HREF="./15.html">15</A></TD>
  <TD><A HREF="./16.html">16</A></TD>
  <TD><A HREF="./17.html">17</A></TD>
  <TD><A HREF="./18.html">18</A></TD>
  <TD><A HREF="./19.html">19</A></TD>
  <TD><A HREF="./21.html">21</A></TD>
  <TD><A HREF="./22.html">22</A></TD>

</tr><tr valign="center" align="center">
  <TD><A HREF="./23.html">23</A></TD>
  <TD><A HREF="./28.html">28</A></TD>
  <TD><A HREF="./29.html">29</A></TD>
  <TD><A HREF="./30.html">30</A></TD>
  <TD><A HREF="./31.html">31</A></TD>
  <TD><A HREF="./32.html">32</A></TD>
  <TD><A HREF="./33.html">33</A></TD>
  <TD><A HREF="./34.html">34</A></TD>
  <TD><A HREF="./37.html">37</A></TD>
  <TD><A HREF="./38.html">38</A></TD>

</tr><tr valign="center" align="center">
  <TD><A HREF="./39.html">39</A></TD>
  <TD><A HREF="./41.html">41</A></TD>
  <TD><A HREF="./42.html">42</A></TD>
  <TD><A HREF="./43.html">43</A></TD>
  <TD><A HREF="./44.html">44</A></TD>
  <TD><A HREF="./45.html">45</A></TD>
  <TD><A HREF="./46.html">46</A></TD>
  <TD><A HREF="./47.html">47</A></TD>
  <TD><A HREF="./48.html">48</A></TD>
  <TD><A HREF="./49.html">49</A></TD>

</tr></table>
	</P>
<P> <hr> <P>
<!-- ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::: -->
<P> <hr> <P>
<!-- begin lgnav ::::::::::::::::::::::::::::::::::::::::::::::::::: -->
<A HREF="../index.html"
	><IMG SRC="../../gx/indexnew.gif" ALT="[ Table Of Contents ]"></A>
<A HREF="../../index.html"
	><IMG SRC="../../gx/homenew.gif" ALT="[ Front Page ]"></A>
<A HREF="../lg_bytes37.html"
	><IMG SRC="../../gx/back2.gif" ALT="[ Previous Section ]"></A>
<A HREF="../york.html"
	><IMG SRC="../../gx/fwd.gif" ALT="[ Next Section ]"></A>
<!-- end lgnav ::::::::::::::::::::::::::::::::::::::::::::::::::::: -->
<!-- ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::: -->
</BODY></HTML>
<!--endcut ========================================================= -->
