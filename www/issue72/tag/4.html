<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<html>
<head>
<META NAME="generator" CONTENT="lgazmail v1.4F.h">
<TITLE>The Answer Gang 72: Please need help !!! ext2 problem !!!</TITLE>
</HEAD><BODY BGCOLOR="#FFFFFF" TEXT="#000000"
	LINK="#3366FF" VLINK="#A000A0">
<!-- ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::: -->
<P> <hr> 
<!--startcut ======================================================= -->
<CENTER>
<!-- *** BEGIN navbar *** -->
<!-- *** END navbar *** -->
</CENTER>
</p>
<!--endcut ========================================================= -->
<!--startcut ======================================================= -->
<P> <hr> 
<!-- begin tagnav ::::::::::::::::::::::::::::::::::::::::::::::::::-->
<p align="center">
<table width="100%" border="0"><tr>
<td align="right" valign="center"
	><IMG ALT="" SRC="../../gx/navbar/left.jpg"
        WIDTH="14" HEIGHT="45" BORDER="0" ALIGN="middle" border="0"
><A HREF="..//"
	><IMG SRC="../../gx/navbar/toc.jpg" align="middle"
              ALT="[ Table Of Contents ]" border="0"></A
><A HREF="../lg_answer72.html"
	><IMG SRC="../../gx/dennis/answertoc.jpg" align="middle"
              ALT="[ Answer Guy Current Index ]" border="0"></A></td>
<td align="center" valign="center"><A HREF="../lg_answer72.html#greeting"><img align="middle"
	src="../../gx/dennis/smily.gif" alt="greetings" border="0"></A> &nbsp;
  <A HREF="1.html">1</A> &nbsp;
  <A HREF="2.html">2</A> &nbsp;
  <A HREF="3.html">3</A> &nbsp;
  <A HREF="4.html">4</A> &nbsp;
  <A HREF="5.html">5</A> &nbsp;
  <A HREF="6.html">6</A> &nbsp;
  <A HREF="7.html">7</A> &nbsp;
  <A HREF="8.html">8</A> &nbsp;
  <A HREF="9.html">9</A>
  </td>
<td align="left" valign="center"><A HREF="../../tag/kb.html"
	><IMG SRC="../../gx/dennis/answerpast.jpg" align="middle"
              ALT="[ Index of Past Answers ]" border="0"></A
><IMG ALT="" SRC="../../gx/navbar/right.jpg" align="middle"
        WIDTH="14" HEIGHT="45" BORDER="0"></td></tr></table>
</p>
<!-- end tagnav ::::::::::::::::::::::::::::::::::::::::::::::::::::-->
<!--endcut ========================================================= -->
<P> <hr> <P>
<!-- ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::: -->
<center>
<H1><A NAME="answer">
	<img src="../../gx/dennis/qbubble.gif" alt="(?)" 
		border="0" align="middle">
	<font color="#B03060">The Answer Gang</font>
	<img src="../../gx/dennis/bbubble.gif" alt="(!)" 
		border="0" align="middle">
</A></H1> 
<BR>
<H4>By Jim Dennis, Ben Okopnik, Dan Wilder, Breen, Chris, and the Gang,
	the Editors of Linux Gazette... 
	and You!
<br>Send questions (or interesting answers) to
	<a href="mailto:tag@lists.linuxgazette.net">tag@lists.linuxgazette.net</a>
</H4>
<p><em><font color="#990000">There is no guarantee that your questions
	here will <b>ever</b> be answered.  Readers at confidential sites
	must provide permission to publish.  However, you can be published 
	anonymously - just let us know!
</font></em></p>
</center>
<!-- ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::: -->
<p><hr><p>
<!-- begin 4 -->
<H3 align="left"><img src="../../gx/dennis/qbubble.gif" 
	height="50" width="60" alt="(?) " border="0"
	>Please need help !!! ext2 problem !!!</H3>


<p><strong>From Angel Lacal 
</strong></p> 
<p></strong></p>

<p align="right"><strong>Answered By  Thomas Adam, Mike Orr, John Karns, Heather Stern
</strong></p>
<blockQuote>
Please, please, help me... I'm desperated !!!!!!!!!
</blockQuote>
<blockQuote>
<IMG SRC="../../gx/dennis/bbub.gif" ALT="(!)"
	HEIGHT="28" WIDTH="50" BORDER="0"
	> [Thomas] 
Have some coffee, that always helps 
<IMG SRC="../../gx/dennis/smily.gif" ALT=":-)" 
		height="24" width="20" align="middle">
</blockQuote>
<P><STRONG>
<IMG SRC="../../gx/dennis/qbub.gif" ALT="(?)"
	HEIGHT="28" WIDTH="50" BORDER="0"
	> 
I was shutting down our officce server this evening when I realised that
samba daemon didn't stopped fine...
I boot up again when I saw the problem... A Windows 2000 PC of my offcie was
still ON and connected to the server !!!!!!
</STRONG></P>
<blockQuote>
<IMG SRC="../../gx/dennis/bbub.gif" ALT="(!)"
	HEIGHT="28" WIDTH="50" BORDER="0"
	> [Thomas] 
It would be if the samba daemon (smbd) did not "shut
down" as you say
</blockQuote>
<P><STRONG>
<IMG SRC="../../gx/dennis/qbub.gif" ALT="(?)"
	HEIGHT="28" WIDTH="50" BORDER="0"
	> 
We have three IDE disk
</STRONG></P>

<blockquote><em><font color="#000033"><br>hda: It's the boot disk
<br>hdc: It's the disk where we work
<br>hdd: It's a disk where we make the backups.
</font></em></blockquote>
<P><STRONG>
Problem: The backup was unfinshed... so it was completely unusable.
</STRONG></P>
<blockQuote>
<IMG SRC="../../gx/dennis/bbub.gif" ALT="(!)"
	HEIGHT="28" WIDTH="50" BORDER="0"
	> [Mike] 
You'll have to delete the backup and run it again.
</blockQuote>
<blockQuote>
To protect against problems like this in the future, consider a journalling
filesystem.  In a journalling filesystem like ext3 and ReiserFS, there's a
separate file where the filesystem logs every action before it does it.  Then,
if the computer gets shut down or crashes between steps or in the middle of a
step, on the next boot, it can use the journal to continue where it left off.
See the article <A HREF="../..//issue68/dellomodarme.html"
	>http://linuxgazette.net/issue68/dellomodarme.html</A>
for more information.  Ext3 claims to be backwards compatible with ext2, and is
more mature now than when the article was written.  Nevertheless, you may want
to experiment with a journalling filesystem on a test machine first to get
used to it before putting it on your production server.
</blockQuote>
<blockQuote>
<IMG SRC="../../gx/dennis/bbub.gif" ALT="(!)"
	HEIGHT="28" WIDTH="50" BORDER="0"
	> [Heather] 
You might also consider forms of backups which are not complete copies of the
filesystem... since the point is about recovery.  Sure it makes things speedier
if you can just drop a fresh drive into place, but it all depends.  A copy of
a well-configured kickstart floppy or 'dpkg --get-selections' list, and
backups of the couple of dozen textfiles you had to tweak as a sysadmin before
things were ready to start filling with data, can reduce the size of your
regular backup tapes or cdrw media-packs to something much easier to cart
around.
</blockQuote>
<P><STRONG>
<IMG SRC="../../gx/dennis/qbub.gif" ALT="(?)"
	HEIGHT="28" WIDTH="50" BORDER="0"
	> 
Problem2: After advising I had unconsistency problems, I logged as root and
run e2fsck:
</STRONG></P>

<blockquote><code><font color="#000033"><br>    e2fsck /dev/hdd
</font></code></blockquote>
<P><STRONG>
GOD !!! It was full of bad Inodes, references, duplicates... etc...
</STRONG></P>
<blockQuote>
<IMG SRC="../../gx/dennis/bbub.gif" ALT="(!)"
	HEIGHT="28" WIDTH="50" BORDER="0"
	> [Thomas] 
Umm, definate data corruption. A pity that you did not
post us a sample of "ls -al" command. I would have
been interested in it.
</blockQuote>
<P><STRONG>
<IMG SRC="../../gx/dennis/qbub.gif" ALT="(?)"
	HEIGHT="28" WIDTH="50" BORDER="0"
	> 
Problem3: I began to run e2fsck over <TT>/dev/hdc</TT> .... AND THE SAME THING !!! I
CTRL-C ... just when it started... What do I do now ??????
Continue with e2fsck ??? Or try other thing ???
</STRONG></P>
<blockQuote>
<IMG SRC="../../gx/dennis/bbub.gif" ALT="(!)"
	HEIGHT="28" WIDTH="50" BORDER="0"
	> [Mike]
</blockQuote>

<blockquote><code><font color="#000033"><br>********** !!! WAIT !!!  WAIT !!! WAIT !!! ******************
<br>***********  MAYDAY, MAYDAY!!!!! ****************************
</font></code></blockquote>
<blockQuote>
You do <EM>NOT</EM> run fsck on entire drives (<TT>/dev/hdc</TT>, <TT>/dev/hdd</TT>).
YOu run it on <EM>PARTITIONS</EM> (<TT>/dev/hdc1</TT>, <TT>/dev/hdd5</TT>, etc).
Unless you've set up the entire drive as a single partition
without a partition table, which is not normally done.
</blockQuote>
<blockQuote>
Of course, with floppies the partition and the drive are the
same thing, since floppies don't have partition tables, but
we're talking about hard disks.
</blockQuote>
<blockQuote>
<IMG SRC="../../gx/dennis/bbub.gif" ALT="(!)"
	HEIGHT="28" WIDTH="50" BORDER="0"
	> [Thomas] 
ERrr... Mmmm... yeah... I discovered that later... but, well... at last I
noticed my fault and could save the partition with the
superblocks-secret-position gently given by mke2fs... heheehehe--
</blockQuote>
<blockQuote>
<IMG SRC="../../gx/dennis/bbub.gif" ALT="(!)"
	HEIGHT="28" WIDTH="50" BORDER="0"
	> [John] 
man fsck&gt;
</blockQuote>
<blockQuote>
In actuality, fsck is simply a front-end for  the  various
file  system checkers (fsck.fstype) available under Linux.
The file system-specific checker is searched for in  <TT>/sbin</TT>
first, then in <TT>/etc/fs</TT> and <TT>/etc</TT>, and finally in the direc-
tories listed in the PATH  environment  variable.   Please
see the file system-specific checker manual pages for fur-
ther details.
</blockQuote>
<blockQuote>
So it wouldn't give any different results than e2fsck, since it would be
running e2fsck.
</blockQuote>
<P><STRONG>
<IMG SRC="../../gx/dennis/qbub.gif" ALT="(?)"
	HEIGHT="28" WIDTH="50" BORDER="0"
	> 
It seems the partition is broken... The disk can't be mounted obviouesly...
What can I do ??????
</STRONG></P>
<P><STRONG>
PLEASE, PLEASE, PLEASE.... I'm desperated !!!!!!!!!!!!!!!!!
HELP ME !!!!!!!!!
</STRONG></P>
<blockQuote>
<IMG SRC="../../gx/dennis/bbub.gif" ALT="(!)"
	HEIGHT="28" WIDTH="50" BORDER="0"
	> [Mike] 
Continue with fsck.  That will get the partitions in a consistent state so
that you can determine what is intact and what has been lost.  Most of the
time, fsck can fully repair things.
</blockQuote>
<blockQuote>
<IMG SRC="../../gx/dennis/bbub.gif" ALT="(!)"
	HEIGHT="28" WIDTH="50" BORDER="0"
	> [Heather] 
I can vouch for that.  One time Jim Dennis, who wasn't yet the famous
Answer Guy at the time, <EM>really</EM> mangled a drive by, ummm, telling X to
use the drive controllers memory as video controller memory.  Darn typos.
</BLOCKQUOTE>

<blockQuote>
<IMG SRC="../../gx/dennis/bbub.gif" ALT="(!)"
	HEIGHT="28" WIDTH="50" BORDER="0"
	> [Mike] 
Like when Linus told his terminal emulator to dial his hard drive...
that's what motivated him to implement file permissions in Linux.
</BLOCKQUOTE>

<blockQuote>
<IMG SRC="../../gx/dennis/bbub.gif" ALT="(!)"
	HEIGHT="28" WIDTH="50" BORDER="0"
	> [Heather] 
Anyways, he fsck'd it over and over because it was still fixing things. In
6 passes - the system was actually, to our shock, almost usable.  Please
don't try to repeat that at home, kids... unless you enjoy breaking things
horribly.
</blockQuote>
<blockQuote>
<IMG SRC="../../gx/dennis/bbub.gif" ALT="(!)"
	HEIGHT="28" WIDTH="50" BORDER="0"
	> [Mike] 
Sometimes it will put recovered files in <TT>/MOUNT_POINT/lost+found</TT> with filenames
like "#12345" (since the original path/filename has been lost).  If you get
files like that, you'll have to determine whether they are worth keeping (they
may be temporary files you don't care about), whether they are complete, and
what their proper paths/filenames are.
</blockQuote>
<blockQuote>
Fortunately, another part of fsck gives a clue as to what the original
filenames are.  For every recovered file, there's an orphaned directory entry
somewhere that's no longer attached to any file.  Fsck will report these as
"link count is wrong for file FILENAME, is 1, should be 0" or something like
that, and will adjust the link count and/or delete the filename.
Write down the
filenames-without-files it reports, and use that list as you go through the
lost+found files.  Reconstruct the original files as best you can, and move them
back to their original places.
</blockQuote>
<blockQuote>
Normally, you don't have to deal with lost+found files at all, and it's even
less common for them to contain important data.  In your case, I can't tell
whether the errors you describe are an ordinary fsck or something especially
severe.  It really depends on the quantity of errors.  Here's a rundown of
the most common errors (from memory):
</blockQuote>
<blockQuote><BLOCKQuote>
"Deleted inode has zero dtime."  -&gt;  unimportant.
</BLOCKQuote></blockQuote>
<blockQuote>
"link count wrong for file FILENAME"  -&gt;  may or may not be important.
The filesystem has to modify the file itself (the inode) and the filename (a
directory entry) separately, so the crash happened between the two steps.
Fsck prefers to preserve data, so it usually does the right thing.  You'll
probably find that your file still exists under one of its names at least
(or as a lost+found file), and then it'll just be a matter of redoing links to
it that you already created or deleted.
</blockQuote>
<blockQuote>
"block bitmap differences."  -&gt;  a few of these are common.  If you get
hundreds of them, I would be concerned.  However, often it will correct those
hundreds and you'll never have trouble with them again.  It all depends on what
caused the differences, which is something fsck doesn't know.
</blockQuote>
<blockQuote>
There are other common errors, but I can't remember them offhand.
</blockQuote>
<blockQuote>
After fsck successfully completes, run it again to look for more errors.
Continue running it until you get the "clean" message, then run "fsck -f"
once more.  (The "-f" option forces fsck to run, even if it doesn't think it
needs to.)  Repeat for your other ext2 partitions.
</blockQuote>
<blockQuote>
<IMG SRC="../../gx/dennis/bbub.gif" ALT="(!)"
	HEIGHT="28" WIDTH="50" BORDER="0"
	> [John] 
If it were me in that situation and the data was very critical, I would
use dd to do a raw copy of the partitions to another media, either tape or
another disk with sufficient capacity to hold the data.  Then run the
e2fsck, but perhaps specifying an alternate superblock with the -b option.
See man e2fsck for more details.
</blockQuote>
<blockQuote>
Then if e2fsck fails to fix the problem satisfactorily, you would at least
have the option of restoring from the dd dump and trying other options.
</blockQuote>

<blockquote><em><font color="#000033"><br>... our reader replies ...
</font></em></blockquote>
<P><STRONG>
<IMG SRC="../../gx/dennis/qbub.gif" ALT="(?)"
	HEIGHT="28" WIDTH="50" BORDER="0"
	> 
Thanks a lot for your VERY helpfull information,
</STRONG></P>
<blockQuote>
<IMG SRC="../../gx/dennis/bbub.gif" ALT="(!)"
	HEIGHT="28" WIDTH="50" BORDER="0"
	> [Mike] 
And thank YOU for telling us what succeeded.  It would make an
excellent 2-Cent Tip if it weren't already being formatted as an Answer Gang
thread.
</blockQuote>
<P><STRONG>
<IMG SRC="../../gx/dennis/qbub.gif" ALT="(?)"
	HEIGHT="28" WIDTH="50" BORDER="0"
	> 
We're planning to switch to
ext3, because we have a lot of theese errors because win2K + linux-samba is
a risky situation.
</STRONG></P>
<blockQuote>
<IMG SRC="../../gx/dennis/bbub.gif" ALT="(!)"
	HEIGHT="28" WIDTH="50" BORDER="0"
	> [Mike] 
I just saw yesterday afternoon that <A HREF="http://www.redhat.com/">Red Hat</A> 7.2 is out, and its default
filesystem is ext3.  That may encourage other distributions to switch too.
</blockQuote>
<P><STRONG>
<IMG SRC="../../gx/dennis/qbub.gif" ALT="(?)"
	HEIGHT="28" WIDTH="50" BORDER="0"
	> 
Ah... at last I could repair my damaged filesystem... Want to know how... At
the deepest state of my desperation I "mke2fs" the backup disk... And then I
saw the light. Both damaged disk were very likely each other, and when I
formatted the backup disk, mke2fs gave me the clue: THE POSITION OF THE
[SECRET REBEL BASE] BACKUP SUPERBLOCKS !!!!
</STRONG></P>
<P><STRONG>
They weren't at 8193 as docs said, nor 32 as Linux Unleashed claims. They
were at 32XXX, 9XXXX, 12XXXX (I don't remmember the exact numbers) and so
on...
</STRONG></P>
<P><STRONG>
So I tried directly to "fsck -b [One of those superblock positions] -n
<TT>/dev/hdc1</TT>" ...
I checked out that most of the Inode messages dissapeared.
So I decide to run fsck without -n and pray.
GOD !!! IT WORKED !!!
</STRONG></P>
<P><STRONG>
But I had a little problem... Those Inode tables presumebly "repaired" by
fsck in the first and stopped round where lost. But it was a minor problem.
The very rest of the disk was recovered.
</STRONG></P>
<P><STRONG>
So a little moral for this fary tale:
NEVER run fsck when the system ask you to.
</STRONG></P>
<blockQuote>
<IMG SRC="../../gx/dennis/bbub.gif" ALT="(!)"
	HEIGHT="28" WIDTH="50" BORDER="0"
	> [Mike] 
Normally, running fsck <EM>is</EM> what people want to do.  Your case was
unusual.
</blockQuote>
<blockQuote>
<IMG SRC="../../gx/dennis/bbub.gif" ALT="(!)"
	HEIGHT="28" WIDTH="50" BORDER="0"
	> [Heather] 
fsck was wanted, but you needed the "secret rebel base" parameters to
use a superblock that hadn't yet been afflicted by the reformatting side
of The Force.
</blockQuote>
<P><STRONG>
<IMG SRC="../../gx/dennis/qbub.gif" ALT="(?)"
	HEIGHT="28" WIDTH="50" BORDER="0"
	> 
FIRST ask the people who knows something about filesystems.
</STRONG></P>
<blockQuote>
<IMG SRC="../../gx/dennis/bbub.gif" ALT="(!)"
	HEIGHT="28" WIDTH="50" BORDER="0"
	> [Mike] 
Or at least, people who have run fsck many times and know what the
typical errors are like, and what is a typical quantity of errors.
</blockQuote>
<P><STRONG>
<IMG SRC="../../gx/dennis/qbub.gif" ALT="(?)"
	HEIGHT="28" WIDTH="50" BORDER="0"
	> 
SECOND find all the information about your HD and run fsck with -n option
</STRONG></P>
<P><STRONG>
THREE weigh up the consequences.
</STRONG></P>
<P><STRONG>
FOUR back your disk up with "dd" and mount the back up as loop
</STRONG></P>
<blockQuote>
<IMG SRC="../../gx/dennis/bbub.gif" ALT="(!)"
	HEIGHT="28" WIDTH="50" BORDER="0"
	> [Mike] 
I sometimes suggest people back up their disk with dd
(dd if=/dev/hda of=/some/file/on/another/partition)
but people usually say they don't have enough disk space for it.
</blockQuote>
<blockQuote>
<IMG SRC="../../gx/dennis/bbub.gif" ALT="(!)"
	HEIGHT="28" WIDTH="50" BORDER="0"
	> [Heather] 
Which question really comes down to, how important is that data to you,
really?  One customer I had was very desperate - and there sure wasn't
room to spare - we sent it up an ssh pipe to another system, while booted
off of a mini-distro.  Besides, if you can't trust the local hard disk...
you're going to put the bits on the local hard disk?  Maybe not!
</blockQuote>
<P><STRONG>
<IMG SRC="../../gx/dennis/qbub.gif" ALT="(?)"
	HEIGHT="28" WIDTH="50" BORDER="0"
	> 
FIVE... GO FOR IT !
</STRONG></P>
<P><STRONG>
Thanks for your attention.
A happy user.
</STRONG></P>

<!-- end 4 -->
<P> <hr> </p>
<!-- *** BEGIN copyright *** -->
<H5 align="center">This page edited and maintained by the Editors
        of <I>Linux Gazette</I>
<a href="http://www.linuxgazette.net/copying.html"
        >Copyright &copy;</a> 2001
<BR>Published in issue 72 of <I>Linux Gazette</I> November 2001</H5>
<H6 ALIGN="center">HTML script maintained by
        <A HREF="mailto:star@starshine.org">Heather Stern</a> of
        Starshine Technical Services,
        <A HREF="http://www.starshine.org/">http://www.starshine.org/</A>
</H6>
<!-- *** END copyright *** -->
<!--startcut ======================================================= -->
<P> <hr> 
<!-- begin tagnav ::::::::::::::::::::::::::::::::::::::::::::::::::-->
<p align="center">
<table width="100%" border="0"><tr>
<td align="right" valign="center"
	><IMG ALT="" SRC="../../gx/navbar/left.jpg"
        WIDTH="14" HEIGHT="45" BORDER="0" ALIGN="middle" border="0"
><A HREF="..//"
	><IMG SRC="../../gx/navbar/toc.jpg" align="middle"
              ALT="[ Table Of Contents ]" border="0"></A
><A HREF="../lg_answer72.html"
	><IMG SRC="../../gx/dennis/answertoc.jpg" align="middle"
              ALT="[ Answer Guy Current Index ]" border="0"></A></td>
<td align="center" valign="center"><A HREF="../lg_answer72.html#greeting"><img align="middle"
	src="../../gx/dennis/smily.gif" alt="greetings" border="0"></A> &nbsp;
  <A HREF="1.html">1</A> &nbsp;
  <A HREF="2.html">2</A> &nbsp;
  <A HREF="3.html">3</A> &nbsp;
  <A HREF="4.html">4</A> &nbsp;
  <A HREF="5.html">5</A> &nbsp;
  <A HREF="6.html">6</A> &nbsp;
  <A HREF="7.html">7</A> &nbsp;
  <A HREF="8.html">8</A> &nbsp;
  <A HREF="9.html">9</A>
  </td>
<td align="left" valign="center"><A HREF="../../tag/kb.html"
	><IMG SRC="../../gx/dennis/answerpast.jpg" align="middle"
              ALT="[ Index of Past Answers ]" border="0"></A
><IMG ALT="" SRC="../../gx/navbar/right.jpg" align="middle"
        WIDTH="14" HEIGHT="45" BORDER="0"></td></tr></table>
</p>
<!-- end tagnav ::::::::::::::::::::::::::::::::::::::::::::::::::::-->
<!--endcut ========================================================= -->
<P> <hr> 
<!--startcut ======================================================= -->
<CENTER>
<!-- *** BEGIN navbar *** -->
<!-- *** END navbar *** -->
</CENTER>
</p>
<!--endcut ========================================================= -->
</BODY></HTML>
