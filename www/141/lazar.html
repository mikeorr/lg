<!DOCTYPE html
	PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US">
<head>
<title>Serving Your Home Network on a Silver Platter with Ubuntu LG #141</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="stylesheet" href="../lg.css" type="text/css" media="screen, projection"  />
<link rel="alternate" type="application/rss+xml" title="LG RSS" href="lg.rss" />
<link rel="alternate" type="application/rdf+xml" title="LG RDF" href="lg.rdf" />
<link rel="alternate" type="application/atom+xml" title="LG Atom" href="lg.atom.xml" />
<link rel="shortcut icon" href="../favicon.ico" />

<style type="text/css" media="screen, projection">
<!--

-->
</style>

</head>
<body>

<a href="../">
<img src="../gx/2003/newlogo-blank-200-gold2.jpg" id="logo" alt="Linux Gazette"/>
</a>
<p id="fun">...making Linux just a little more fun!</p>

<div id="navigation">
<table summary="masthead" width="100%">
<tr>
<td align="center" colspan="3" style="font-size: 10px; font-weight: bold">
<a href="../index.html">Home</a>
<a href="http://linuxgazette.net">Main Site</a>
<a href="../faq/index.html">FAQ</a>

<a href="../lg_index.html">Site Map</a>
<a href="../mirrors.html">Mirrors</a>
<a href="../mirrors.html">Translations</a>
<a href="../search.html">Search</a>
<a href="../archives.html">Archives</a>
<a href="../authors/index.html">Authors</a>
<a href="http://lists.linuxgazette.net/mailman/listinfo/">Mailing Lists</a>
<a href="../jobs.html">Join Us!</a>
<a href="../contact.html">Contact Us</a>

<hr width="99%" style="border: 1px inset #000033">
</td>
</tr>
<tr>
<td width="40%" align="left" style="font-size: 10px; font-weight: bold">
The Free International Online Linux Monthly
</td>
<td width="20%" align="center" style="font-size: 10px; font-weight: bold">
ISSN: 1934-371X
</td>
<td width="40%" align="right" style="font-size: 10px; font-weight: bold">
Main site: <a href="http://linuxgazette.net">http://linuxgazette.net</a> 
</td>
</table>
</div>


<div id="breadcrumbs1">

<a href="../index.html">Home</a> &gt; 
<a href="index.html">August 2007 (#141)</a> &gt; 
Article

</div>

<div class="articlecontent1">
<div class="content">

<div id="previousnexttop">
<A HREF="kapil.html" >&lt;-- prev</A> | <A HREF="pfeiffer.html" >next --&gt;</A>
</div>

<h1>Serving Your Home Network on a Silver Platter with Ubuntu</h1>
<p id="by"><b>By <a href="../authors/lazar.html">Shane Lazar</a></b></p>

<p>Linux has always been a good choice for a server OS. In practical
terms, however, this functionality has been out of reach for the
everyday computer user, mainly due to the technical know-how required to
manage a dedicated server OS. On the other hand, our homes today are
more filled with computers than ever before - and, in a multi-node
network, a server can provide many benefits. In this article, I am going
to try to guide you in setting up a useful server for your home
network, one that is headless (i.e., without monitor, keyboard, or
mouse) and can be stowed away neatly out of view.</p>

<p>This setup will be ideal for:</p>

<ul>
   <li>securely sharing a single Internet connection to multiple computers,</li>
   <li>streamlining of Internet traffic,</li>
   <li>providing a central file server in the home network,</li>
   <li>preventing bandwidth-hogging by P2P software,</li>
   <li>allowing easy remote administration of the server.</li>
</ul>

<p>Hardware required:</p>

<ul>
   <li>Any old computer with commonly available components (thus ensuring
driver availability for it). My own server is a Pentium III 800MHz with
256MB RAM, Intel chipset, an on-board graphic card, 2 Ethernet cards, 40GB
hard drive (the larger the better, obviously), and a CD-ROM. This is really
overkill - you can use a Pentium I with 64MB RAM (otherwise landfill
material), and it would run moderately well. The two network cards are
required. You can use a wireless card for your Local Area Network (LAN),
but make sure it has Linux drivers available.</li>
   <li>An Ethernet hub with at least as many ports as there are computers you
wish to connect (including your server). If you use a wireless LAN, you
will not need this.<li>
   <li>As much "straight through" Ethernet cable as you will need (not
required in a wireless setup).</li>
</ul>

<p>The basic setup:</p>

<p><tt>Internet &lt;--&gt; Ubuntu Server &lt;--&gt; Ethernet Hub
&lt;--&gt; LAN Machines</tt><p>

<p>Services we are going to be running on our system:</p>

<ul>
   <li><a href="http://webmin.com/">Webmin</a> for remote Web-based administration,</li>
   <li><a href="http://www.shorewall.net/">Shorewall firewall</a> setup up for Internet connection sharing or network address translation (NAT),</li>
   <li><a href="http://www.squid-cache.org/">Squid Proxy server</a> for caching of Internet content,</li>
   <li><a href="http://www.isc.org/index.pl?/sw/bind/">BIND DNS server</a> working hand-in-hand with Squid,</li>
   <li><a href="http://us1.samba.org/samba/">Samba file server</a>,</li>
   <li><a href="http://en.wikipedia.org/wiki/LAMP_(software_bundle)">LAMP Web server</a>, which we are going to use to run <a href="http://www.torrentflux.com/">TorrentFlux</a>, a Web-based Torrent client. You can use LAMP to serve your own Web sites, if you so wish.</li>
</ul>

<p>Let us dive right in!</p>

<h3>1. Getting Ubuntu</h3>

<p>Download the Ubuntu (currently at version 7.04, "Feisty Fawn") Server
CD image from 
<a href="http://www.ubuntu.com/getubuntu/download">Ubuntu's download
page</a>.</p>

<h3>2. Making the installation CD</h3>

<p>Burn the <tt>ubuntu-7.04-server-i386.iso</tt> image to a CD using
your favorite image-burning program. Remember, <em>burn the image</em>; do not
extract the files from the image file. If you are going to be using an
old CD-ROM, burn the CD at the slowest possible speed, for
reliability.</p>

<h3>3. Installing Ubuntu on Your Server</h3>

<p>Ubuntu is well known for having an easy installation process. For
now, plug in a monitor, keyboard, and the network cables (Internet and
LAN, both), put in the Ubuntu server CD, and boot up! You may need to
change your BIOS settings to allow booting from CD.</p>

<ol>
   <li>Select the hard disk installation, choose your desired language,
then pick your country and keyboard.</li>
   <li>Configure the network interface connected to the Internet, using one of
3 options: autoconfiguration, autoconfiguration with DHCP
(automatically assigned IP addresses), or manual. Which one you choose
really depends on your Internet connection; ask your ISP, if in doubt. If
you have to configure manually, configure your Internet connection on the eth0
network card, for simplicity's sake.</li>
   <li>For partitioning, I recommend "Guided - use entire disk", as it is a
no-brainer, and accept the settings, thereby writing changes to disk.</li>
   <li>Allow the system clock to be set to UTC.</li>
   <li>Create the system administrator's user account; enter the full user
name, account name, and administrator's password (which has to be
verified).</li>
   <li>Ubuntu will continue to install the base system.</li>
   <li>Enter your ISP's proxy server settings, if required.</li>
   <li>When you are asked to choose the software to install, select both DNS and LAMP server. You do this using the spacebar to check the boxes, cursor keys, and <tt>TAB</tt>, to navigate through the menu.</li>
   <li>Complete the installation, reboot, and you will be presented with a command-line interface (CLI) prompting you to log in. Use the administrator account name and password to do so.</li>
</ol>

<p>Before we continue, I did mention that I would try to make this as
simple as possible, and now you are probably wondering what you are doing
in a CLI. This is necessary, as we want our server to run as lean as
possible. After all, it is going to be stowed away in a closet, so who
needs a fancy GUI? I promise we won't be spending much longer on the
CLI. A couple of tips for new users:

<ul>
   <li>the cursor keys let you scroll through previous commands you entered,</li>
   <li>the <tt>TAB</tt> key is a God-send for its auto-complete function. Type a couple of keys, hit the <tt>TAB</tt> key, and it will auto-complete or show you the valid commands or paths!</li>
</ul>

<h3>4. Checking Internet connectivity</h3>

<p>First thing we will do on our new system is to check if we are
connected to the Internet. Do this simply by pinging Google.</p>

<tt>ping www.google.com</tt>

<p>Stop the pinging with <tt>Ctrl+C</tt>. If all went well, you should be
getting responses to your pings. If not, try switching the LAN and
Internet cables around. Most probably, you will get a ping response by
now. Keep in mind which card your Internet is configured on,
<tt>eth0</tt> or <tt>eth1</tt>, and modify the instructions accordingly.
In this guide, the Internet is on <tt>eth0</tt> and the LAN is on
<tt>eth1</tt>.

<h3>5. LAN network configuration</h3>

<p>Now, we will configure our LAN network card. We will do this using
<tt>vim</tt>, a CLI text editor.</p>

<p>Four simple commands you will use in <tt>vim</tt> are:</p>

<ul>
   <li>the <tt>I</tt> key, which will put you in Insert mode so you can edit the text file as in any other text editor,</li>
   <li>the <tt>Esc</tt> key, which exits you out of the Insert mode,</li>
   <li><tt>:w!</tt>, which saves/writes the file to disk,</li>
   <li><tt>:x</tt>, which exits the <tt>vim</tt> text editor.</li>
</ul>

<p>Let us open our network configuration file with administrative
privileges:</p>

<tt>sudo vim /etc/network/interfaces</tt>

<p>You will be asked to enter the administrator's password. Navigate
with the cursor key and add the following at the end of this file:</p>

<pre><tt>auto eth1
iface eth1 inet static
	address 192.168.0.1
	netmask 255.255.255.0
	broadcast 192.168.0.255</tt></pre>

<p>If you need to change the configuration of your Internet connection,
you should do this now in the <tt>eth0</tt> section. Restart your
network interfaces using:</p>

<tt>sudo /etc/init.d/networking restart</tt>

<h3>6. Update Ubuntu</h3>
<p>Install any available updates by:</p>

<tt>sudo apt-get update</tt>

<p>and then</p>

<tt>sudo apt-get upgrade</tt>

<h3>7. Installing Webmin</h3>

<p>Now we will install the packages required for Webmin, the Web-based
administration tool:</p>

<tt>sudo apt-get install libnet-ssleay-perl openssl libauthen-pam-perl
libio-pty-perl libmd5-perl</tt>

<p>Download Webmin:</p>

<tt>wget http://prdownloads.sourceforge.net/webadmin/webmin_1.350_all.deb</tt>

<p>If this does not work, there is probably a newer version of Webmin.
Get the link to the latest <tt>*.deb</tt> file from the <a
href="http://webmin.com/download.html">Webmin site</a>. 

<p>Install it:</p>

<tt>sudo dpkg -i webmin_1.350_all.deb</tt>

<p>You will get the following output:</p>

<p>Webmin install complete. You can now login to
https://your-server-name:10000/ as root with your root password, or as
any user who can use sudo to run commands as root.</p>

<p>And that's it! We are done with the CLI. Log out:</p>

<tt>exit</tt>

<p>Now, you can disconnect the monitor and keyboard, stow your server
away, and continue from your desktop machine on a beautiful Web-GUI!</p>

<h3>8. Configure your LAN machines</h3>

<p>However, before you do that, you will have to configure your desktop
machine's network card. Set it up as follows:</p>

<pre><tt>IP address: 192.168.0.2
Subnet mask: 255.255.255.0
Gateway: 192.168.0.1
DNS server: 192.168.0.1</tt></pre>

<p>Your other machines would have incrementing IP addresses, e.g., <tt>192.168.0.3</tt>, <tt>192.169.0.4</tt>,...</p>

<h3>9. Upgrade Webmin</h3>

<p>Open your favorite Web browser and navigate to
<tt>https://192.168.0.1:10000</tt>. Enter the administrator's user name
and password. Welcome to the powerful Webmin!</p>

<p>On the tree menu on the left, go to <tt>Webmin &gt; Webmin
Configuration</tt>. Click <em>Upgrade Webmin</em>, and, with <em>"Latest
version from www.webmin.com"</em> selected, click the <em>Upgrade</em>
button. If there is an upgrade available, it will be installed for
you.</p>

<h3>10. Shorewall Firewall</h3>

<p>To install the Shorewall firewall, go to <tt>System &gt; Software
Packages</tt> and in the <em>"Install a New Package"</em> section,
select <em>"Package from APT"</em>, enter <tt>shorewall</tt>, and click
<em>Install</em>. This may take some time, depending on your Internet
connection, but Shorewall will be installed.</p>

<p>Now, go to <tt>Networking &gt; Shorewall Firewall</tt>, and we'll begin
setting up your firewall. Do <em>not</em> start the firewall yet, or you might
lock yourself out of the server. We will configure Shorewall section by
section.</p>

<p><strong>Network Zones:</strong> This section defines zones to which
we will assign "levels of trust". We will create three zones: the
firewall, Internet, and local zones.</p>

<p>Click <em>Add a new network zone</em>. You will be provided with a
number of options. We are interested in the <em>Zone ID</em> field and
the <em>Zone type</em> list. For each zone, enter the options as follows,
and click <tt>Create</tt> before returning to the page to create the
next.</p>

<ul>
   <li><em>Zone ID</em> = <tt>fwall</tt>; <em>Zone type</em> = <tt>Firewall system</tt></li>
   <li><em>Zone ID</em> = <tt>net</tt>; <em>Zone type</em> = <tt>IPv4</tt></li>
   <li><em>Zone ID</em> = <tt>loc</tt>; <em>Zone type</em> = <tt>IPv4</tt></li>
</ul>

<p><strong>Network Interfaces:</strong> This section tells the firewall
which Ethernet card is connected to the Internet, and which one to the
LAN. In our case, we have only two interfaces.</p>

<p>Click <em>Add a new network interface</em>, and again you will be
presented with a vast array of options. We will define only 
<em>Interface</em>, <em>Zone name</em>, and <em>Broadcast address</em>.
Here, also, you will have to setup one interface at a time, clicking
<em>Create</em> before returning to configure the next. Configure as
follows:</p>

<ul>
   <li><em>Interface</em> = <tt>eth0</tt>; <em>Zone name</em> = <tt>net</tt>; <em>Broadcast address</em> = <tt>Automatic</tt></li>
   <li><em>Interface</em> = <tt>eth1</tt>; <em>Zone name</em> = <tt>loc</tt>; <em>Broadcast address</em> = <tt>Automatic</tt></li>
</ul>

<p><strong>Default Policies:</strong> The default policies tell the
firewall what to do with packets coming from various sources. We will
set it to drop all requests from the Internet, and accept all from the
LAN and the firewall itself. Click <em>Add a new default policy</em>. As
before, we will define one policy at a time, clicking <tt>Create</tt>
before proceeding. Configure the policies as follows:</p>

<ul>
   <li><em>Source zone</em> = <tt>net</tt>; <em>Destination zone</em> = <tt>Any</tt>; <em>Policy</em> = <tt>DROP</tt></li>
   <li><em>Source zone</em> = <tt>fwall</tt>; <em>Destination zone</em> = <tt>Any</tt>; <em>Policy</em> = <tt>ACCEPT</tt></li>
   <li><em>Source zone</em> = <tt>loc</tt>; <em>Destination zone</em> = <tt>Any</tt>; <em>Policy</em> = <tt>ACCEPT</tt></li>
</ul>

<p><strong>Firewall Rules:</strong> This section defines specific rules
for specific services. We will enable them as the need arises, later.</p>

<p><strong>TOS:</strong> This section optimizes Web browsing as much as
you can on your end. Click <em>Add a new type of service</em>, and we
will proceed to configure the services one by one.</p>

<ul>
    <li><em>Source zone</em> = <tt>Any</tt>; <em>Destination zone</em> = <tt>Any</tt>; <em>Protocol</em> = <tt>TCP</tt>, <em>Source ports</em> = <tt>Any</tt>; <em>Destination ports</em> = with the <em>Ports or ranges</em> radio button selected enter <tt>www</tt>; <em>Type of service</em> = <tt>Maximize-Throughput</tt></li>
   <li><em>Source zone</em> = <tt>Any</tt>; <em>Destination zone</em> = <tt>Any</tt>; <em>Protocol</em> = <tt>TCP</tt>, <em>Source ports</em> = <tt>Any</tt>; <em>Destination ports</em> = with the <em>Ports or ranges</em> radio button selected enter <tt>www</tt>; <em>Type of service</em> = <tt>Minimize-Delay</tt></li>
   <li><em>Source zone</em> = <tt>Any</tt>; <em>Destination zone</em> = <tt>Any</tt>; <em>Protocol</em> = <tt>TCP</tt>, <em>Source ports</em> = with the <em>Ports or ranges</em> radio button selected enter <tt>www</tt>; <em>Destination ports</em> = <tt>Any</tt>; <em>Type of service</em> = <tt>Maximize-Throughput</tt></li>
   <li><em>Source zone</em> = <tt>Any</tt>; <em>Destination zone</em> = <tt>Any</tt>; <em>Protocol</em> = <tt>TCP</tt>, <em>Source ports</em> = with the <em>Ports or ranges</em> radio button selected enter <tt>www</tt>; <em>Destination ports</em> = <tt>Any</tt>; <em>Type of service</em> = <tt>Minimize-Delay</tt></li>
</ul>

<p><strong>Masquerading:</strong> This tells the server to forward
requests from the LAN to the Internet, which is required for Internet
connection-sharing. Click <em>Add a new masquerading rule</em>, and enter
the following rule.</p>

<ul>
<li><em>Outgoing interface</em> = <tt>eth0</tt>; <em>Network to masquerade</em> = with <em>Subnet on interface</em> selected, choose <tt>eth1</tt>; leave the rest unchanged</li>
</ul>

<p><strong>When Stopped:</strong> This allows machines whose IP
addresses are specified to access the server even when the firewall is
not running. No other IP addresses will have access. Add as many as you
want, but there should be at least one, just in case. In the example
below, I have allowed access from two IP addresses on the LAN. Click
<em>Add a new stopped address</em>, and configure as follows:</p>

<ul>
<li><em>Interface</em> = <tt>eth1</tt>; select <em>Listed addresses and networks</em>, and enter <tt>192.168.0.2,192.168.0.3</tt> and/or any other addresses you wish.</li>
</ul>

<p>We don't need to add any other settings.</p>

<p>Back on the Shorewall main page, click <em>"Check Firewall"</em>. You
should get the thumbs up. Note that an "OK" result here does <em>not</em>
guarantee the firewall will work properly, or will work at all. It
simply checks the rules syntax.</p>

<p>There is a security feature that prevents an unconfigured Shorewall
from being started up, when booting. This has to be changed manually. For
this, you will need a Java-enabled Web browser to do it using Webmin, or
you could resort to using vim from the CLI.</p>

<p>What you have to do is change the line</p>

<tt>startup=0</tt>

<p>in the file <tt>/etc/default/shorewall</tt> to</p>

<tt>startup=1</tt>

<p>In Webmin, go to <em>Others &gt; File Manager</em>. This will give you a
nice Java-based file manager. Navigate to the above mentioned file, and
click the <em>"Edit"</em> button at the top. A text editor window will
pop up. (Disable pop-up blocker.) Make the change, and then save and 
close.</p>

<p>Again, using this browser, browse to the file
<tt>/etc/shorewall/shorewall.conf</tt>, click <em>"Edit"</em>, and find
the line  <tt>IP_FORWARDING=Keep</tt>. Change the value from
<tt>Keep</tt> to <tt>On</tt>. Save and close.</p>

<p>Now, let us make sure that Shorewall is set to start at bootup. Go to
<em>System &gt; Bootup and Shutdown</em>, look for <tt>shorewall</tt> in the
list. Tick the checkbox, and click <em>"Start Now and On Boot"</em> at
the bottom. Go back to the <em>Networking &gt; Shorewall Firewall</em> page,
and you should see six buttons where there were previously only two. Click
<em>"Show Status"</em>, to verify that all is running well. Your Internet
connection sharing should be set up, now. Try it out!</p>

<h3>11. BIND DNS Server</h3>

<p>Ubuntu server pretty much does all the configurations necessary for a
working BIND DNS server. There is, however, one thing we can do to make
the lookups faster. We can tell our server to forward unknown requests
to your ISP's DNS server.<a href="#1"><strong>[1]</strong></a></p>

<p>Go to <em>Servers &gt; BIND DNS Server</em>, click on <em>"Forwarding and
Transfers"</em>, and, in the fields marked <em>"Server to forward queries
to"</em>, enter the IP addresses of your ISP's DNS servers. Save, and
click <em>"Apply Changes"</em> in the main BIND DNS server page.</p>

<h3>12. Squid Proxy Server</h3>

<p>Now, we will move on to installing and setting up Squid as your <a
href="http://en.wikipedia.org/wiki/Proxy_server#Caching_proxy_server">caching
proxy server</a>. Go to <em>Servers &gt;Squid Proxy Server</em>. Webmin will
inform you that Squid is not installed on your system, and provide you
with an option to install it using APT. Click on the link (labelled
<em>"Click here"</em>) provided, to install Squid. Webmin will keep you
informed of the progress and, once completed, will give you some
information on the installed packages.</p>

<p>Go back to the main page for Squid, and now you should have a host of
configuration tools available. I will not explain all the options
available, but, if you require more clarification, help is available at
the top left of the tool's page. (You will have to disable your browser's
popup blocker.)</p>

<p><strong>Ports and Networking:</strong> Here we will tell Squid which
port it will be listening on. The default is port 3128. We will stick to
this, but you can change it.  In the <em>"Options for port"</em> field,
enter <tt>transparent</tt>. This will make Squid a transparent proxy
server, which eliminates the need to configure machines on your LAN. Save
the changes.</p>

<p><strong>Memory Usage:</strong> Here, you can define memory usage limits
for Squid, or choose to go with the default settings. I would draw
attention to the <em>"Maximum cached object size"</em> option. Here, you can
define the maximum size of cached files.</p>

<p><strong>Cache Options:</strong> The option I would recommend you
changing here is the <em>"Cache Directories"</em> one. Squid defaults to a
100MB cache, which is pretty minuscule for our caching proxy objective.
Decide how much of your hard disk you wish to use for the cache; I
use 5GB out of my 40GB hard disk. In the <em>"Directory"</em> field,
enter <tt>/var/spool/squid</tt>, <em>"Type"</em> as <tt>UFS</tt>, in
<em>"Size (MB)"</em>, enter however much you decided on in megabytes, for
the 1st- and 2nd-level directories, enter one of the following numbers;
<tt>16,32,64,128</tt> or <tt>256</tt> (defaults being <tt>16</tt> and
<tt>256</tt>, respectively). These numbers basically define the file
structure of your cache. Read the help documentation, for more
information on this and other options. Save your changes.</p>

<p><strong>Helper Programs:</strong> In the <em>"DNS server
addresses"</em> field, enter <tt>192.168.0.1</tt>, select the radio
button, and save. This tells Squid to send DNS requests to the BIND DNS
server running on your server.</p>

<p><strong>Access Control:</strong> Here, we will define which LAN
machines will be able to use Squid, by their IP addresses. At the bottom
of the <em>"Access Control Lists"</em> section, select <tt>Client
Address</tt> from the drop down list, and click <em>"Create new
ACL"</em>. In the page that appears, enter a name of your choice in the
<em>"ACL Name"</em> field (e.g., <tt>Local_Network</tt>), define the
range of IP addresses you wish to grant access to, and the Netmask, e.g.,
<em>From</em> = <tt>192.168.0.2</tt>, <em>To</em> =
<tt>192.168.0.7</tt>, <em>Netmask</em> = <tt>255.255.255.0</tt>. If you
would like to grant access to all machines on your LAN, enter as
follows; <em>From</em> = <tt>192.168.0.0</tt>, <em>To</em> = *leave
blank*, <em>Netmask</em> = <tt>255.255.255.0</tt>. Save your
changes.</p>

<p>Having defined the machines on our LAN, we will now tell Squid what to
do with requests from these machines. Click <em>"Add proxy
restriction"</em> in the <em>"Proxy Restrictions"</em> section. Select
the <em>"Allow"</em> action, and the ACL you just created
(<tt>Local_Network</tt>) from the <em>"Match ACLs"</em> list. Save your
changes.</p>

<p>Your new restriction will be at the bottom of the restrictions list,
and, since they are effectuated in order, you will have to move your new
rule up the list to third place. Do this using the <em>"Move"</em>
arrows, to the right of the defined restrictions.</p>

<p>For security reasons, we will create a new user named <tt>squid</tt>
who will run squid. Go to <em>System>Users and Groups</em>. Click
<em>"Create a new user"</em>, and enter the following;</p>

<ul>
   <li><em>Username</em> = <tt>squid</tt>,</li>
   <li><em>Real name</em> = <tt>squid</tt>,</li>
   <li><em>Password</em> = <tt>No login allowed</tt>,</li>
   <li><em>Primary group</em> = <tt>New group with same name as user</tt>,</li>
   <li><em>Create home directory</em> = <tt>No</tt>,</li>
   <li><em>Copy files to home directory</em> = <tt>No</tt>,</li>
   <li><em>Create user in other modules</em> = <tt>Yes</tt>,</li>
</ul>

<p>Leave the rest unchanged. Click <em>"Create"</em>.</p>

<p>Now, we will grant permissions to the user <tt>squid</tt> to write to
our cache. Go to <em>Others &gt; Command Shell</em>, and execute the
following command:</p>

<tt>chown -R squid:squid /var/spool/squid/</tt>

<p>Return to the Squid Proxy Server page.</p>

<p><strong>Administrative Options:</strong> In the <em>"Run as Unix
user"</em> field, click the browse button, and select <tt>squid</tt> from
the list of users. In the <em>"Visible hostname"</em> field, enter the
name of your server. This you can find out from the <em>"System
Information"</em> page in Webmin, as <em>"System hostname"</em>. Save the
changes.</p>

<p>Click <em>"Initialize Cache"</em>. Once this terminates successfully,
return to the Squid main page and click <em>"Start Squid"</em>.

Since we are making a transparent proxy server, we need to add some
rules in the firewall, to redirect requests to pass through Squid. Go to
<em>Networking>Shorewall Firewall>Firewall Rules>Manually Edit
File</em>, and paste the following rule:</p>

<pre><tt>#squid transparent proxy redirect
REDIRECT	loc	3128	tcp	www</tt></pre>

<p>If you changed the port Squid listens to, earlier on, use that
port in this rule, instead of 3128. Save the changes, and <em>Apply
Configuration</em>.</p>

<p>Test if your desktop machines have access to the Internet. The
difference between a simple Internet connection sharing and using a
caching proxy is that frequently visited Web sites will load faster, as
some content is stored on your server.</p>

<h3>13. Samba file sharing</h3>

<p>Now, we'll move on to installing and setting up Samba for file sharing
to both Linux and Windows machines. Go to <em>Servers &gt; Samba Windows File
Sharing</em>. As was the case with Squid, Webmin detects that Samba is
not installed, and provides an easy link to install it using APT. Go
ahead and click the link, to download and install Samba. Once this is
done, we will now configure file sharing.</p>

<p>Since we are sharing on a trusted network, we will setup our file
server with read and write permissions for everybody.</p>

<p>Return to <em>Servers &gt; Samba Windows File Sharing</em>, and, in the
first section, click <em>"Create a new file share"</em>, then complete as
follows:</p>

<ul>
   <li><em>Share name</em> = enter whatever you would like to identify the share as (I am using <tt>public</tt>),</li>
   <li><em>Directory to share</em> = <tt>/home/public</tt>,</li>
   <li><em>Automatically create directory</em> = <tt>Yes</tt>,</li>
   <li><em>Create with owner</em> = <tt>root</tt>,</li>
   <li><em>Available</em> = <tt>Yes</tt>,</li>
   <li><em>Browseable</em> = <tt>Yes</tt>,</li>
   <li><em>Share Comment</em> can be whatever you wish.</li>
</ul>

<p>This will create the share <tt>public</tt>, with Read-only permissions
for all. Using <em>Others &gt; File Manager</em>, navigate to <tt>/home</tt>,
select the folder <tt>public</tt>, and click <em>Info</em>. In the info
window that opens, in the <em>Permissions</em> section, select all the
checkboxes for <em>User</em>, <em>Group</em>, and <em>Other</em>, thereby
giving permission to everybody to read and write to this folder.</p>

<p>Now, navigate to <tt>/etc/samba</tt>, select <tt>smb.conf</tt>, and
click <em>Edit</em>. Look for the line</p>

<tt>; security = user</tt>

<p>and change it to</p>

<tt>; security = share</tt>

<p>Scroll down to the end of the file, to find the section which
describes the share we just created, and edit it to it look like
this:</p>

<pre><tt>[public]
	comment = public
	path = /home/public
	public = yes
	writable = yes
	create mask = 0777
	directory mask = 0777
	force user = nobody
	force group = nogroup</tt></pre>

<p>Save and close. If you need to change your Workgroup, do that from
the <em>Windows Networking</em> tool in the <em>Global
Configuration</em> section on the <em>Samba Windows File Sharing</em>
page. Samba's default workgroup is, ironically, <tt>MSHOME</tt>. Click
<em>Restart Samba Server</em>, and verify that you have access to the
shared folder with read and write permission from your desktop machine,
by creating and deleting a file in the share. The only settings you will
have to enter on your LAN machine to gain access are:</p>

<ul>
   <li>the correct workgroup (Samba defaults to MSHOME),</li>
   <li>the server's address which is <tt>192.168.0.1</tt> in our setup,</li>
   <li>the name of the share which is <tt>public</tt> in our setup,</li>
   <li><b>no</b> username or password is required.</li>
</ul>


<h3>14. TorrentFlux</h3>

<p>For those of us who use Bittorrent for peer-to-peer file sharing, we
will install TorrentFlux, which is a Web-based Bittorrent client. Some of
the advantages of using TorrentFlux include;</p>

<ul>
  <li>running all Torrents on a single machine, so your workstations do not bear that load,</li>
  <li>other machines need not be left running solely for the Torrent connections,</li>
  <li>automatically sharing the downloaded files across the LAN,</li>
  <li>limiting of bandwidth usage of Torrent downloads,</li>
  <li>queueing of Torrent connections.</li>
</ul>

<p>In your Web browser, go to the <a
href="http://www.torrentflux.com">TorrentFlux Web site</a>, and download
the latest version of TorrentFlux. In Webmin, go to <em>Others &gt; Upload and
Download</em>. In the <em>"Upload files to server"</em> section, browse
to the <tt>torrentflux_2.x.tar.gz</tt> file you just downloaded in the
<em>"Files to upload"</em> field. In the field <em>"File or directory to
upload to"</em>, enter <tt>/var/www</tt>. Select in the <em>Extract ZIP
or TAR files</em> options the <tt>Yes, then delete</tt> radio button.
Click <em>"Upload"</em> to upload, and unpack TorrentFlux.</p>

<p>Using <em>Other>File Manager</em>, browse to the
<tt>/var/www/torrentflux_2.x</tt> directory, and double-click the
<tt>INSTALL</tt> file, to open it in your browser. Read the instructions
carefully.</p>

<p>First, and very important, we will set the root password for our
MySQL database. Note that this root user is different from the system
root user. The same applies to all MySQL users.</p>

<p>Go to <em>Servers &gt; MySQL Database Server</em>, and click <em>User
Permissions</em> from the <em>Global Options</em> section. From the list
of users, click on any of the instances of root. In the password field,
select <em>Set to..</em>, and enter a password for the MySQL root user.
You may be asked to log in, after setting the password. Repeat for all
the other instances, with the same password.</p>

<p>TorrentFlux uses MySQL for its database features. So, let us go ahead
and create a database for TorrentFlux. On the main MySQL page, click
<em>Create a new database</em>. In the <em>"Database name"</em> field,
enter <tt>torrentflux</tt> and don't make any other changes. Click
<em>Create</em>.</p>

<p>To create the required tables, click on the torrentflux database we
just created, then click the <em>"Execute SQL"</em> button. In the
second section, which says <em>"Select an SQL commands file to execute on
database"</em>, select <em>"From local file"</em>, and browse to the file
<tt>/var/www/torrentflux_2.x/sql/mysql_torrentflux.sql</tt>, click
<em>Ok</em>, and then <em>Execute</em>. Now, if you return to the table
list, you will see that some tables have been created.</p>

<p>For security reasons, we will create a MySQL user specifically for
TorrentFlux. On the MySQL main page, click <em>"User Permissions"</em>,
and then <em>"Create new user"</em>. Enter the following, and make sure
to select the appropriate radio buttons:</p>

<ul>
   <li><em>Username</em> = <tt>torrentflux</tt>,</li>
   <li><em>Password</em> = *enter a password which you will add to the config.php file later*,</li>
   <li><em>Hosts</em> = <tt>localhost</tt>,</li>
</ul>

<p>Don't select any of the permissions, and Save.</p>

<p>Now, we will allow this new user to modify the torrentflux database,
only. Back on the MySQL main page, click on <em>"Database
Permissions"</em>, and then on <em>"Create new database permissions"</em>.
Remembering to select the appropriate radio buttons, select the
following;</p>

<ul>
   <li><em>Databases</em> = <tt>torrentflux</tt> (from the drop-down menu),</li>
   <li><em>Username</em> = <tt>torrentflux</tt>,</li>
   <li><em>Hosts</em> = <tt>localhost</tt>.</li>
</ul>

<p>For the permissions, hold the Ctrl key, and select the following;</p>

<ul>
<tt>
   <li>Select table data,</li>
   <li>Insert table data,</li>
   <li>Update table data,</li>
   <li>Delete table data,</li>
   <li>Create tables,</li>
   <li>Drop tables,</li>
   <li>Alter tables.</li>
</tt>
</ul>

<p>That's it; we're done with MySQL!</p>

<p>Now, we will tell TorrentFlux about the database settings we have just
implemented. Using the Java browser, navigate to
<tt>/var/www/torrentflux_2.x/html</tt>, select the <tt>config.php</tt>
file, and click <em>"Edit"</em>. Modify the <em>"Your database connection
information"</em> section, entering the correct settings. Hints are
provided. It should look something like this:</p>

<p><tt>$cfg["db_type"] = "mysql";	// mysql, postgres7 view adodb/drivers/<br>
$cfg["db_host"] = "localhost";		// DB host computer name or IP<br>
$cfg["db_name"] = "torrentflux";	// Name of the Database<br>
$cfg["db_user"] = "torrentflux";	// username for your MySQL database<br>
$cfg["db_pass"] = "</tt>*password for MySQL user torrentflux*"<tt>; // password for database</tt></p>

<p>Save and close.</p>

<p>Now, we will tell the Web server, Apache httpd, to serve TorrentFlux on port
80. Go to <em>Servers &gt; Apache Web server</em>. You should have a Default
Server and a Virtual Server, set up for you already. Click on the
<em>Virtual Server</em>, and, at the bottom, in the <em>"Virtual Server
Details"</em> section, make the following changes;</p>

<ul>
   <li><em>Address</em> = <tt>Any</tt>,</li>
   <li><em>Port</em> = <tt>80</tt> (don't forget to select the radio button),</li>
   <li><em>Document Root</em> = <tt>/var/www/torrentflux_2.x/html</tt> (replace the "x" with your version number),</li>
</ul>

<p>and Save. Then, on the Apache server page, click <em>"Apply
Changes"</em> at the top right.</p>

<p>Now, in your browser, navigate to <tt>http://192.168.0.1</tt>, and you
should get the TorrentFlux login page. Note that the username and
password you enter here will create the administrator's account
settings. Don't forget these. Choose wisely, and proceed to login.</p>

<p>You will be taken to the settings page, where we will change a few
things.</p>

<ul>
   <li><em>Path</em> = <tt>/home/public</tt></li>
   <li><em>Max Upload and Download rates</em>: set these to your liking. If you have broadband, I would suggest setting the max upload rate to 5% of your total Internet bandwidth, and your max download rate to 40%. This should allow modest bandwidth for Web browsing, even with two Torrent downloads running. Ultimately, the choice is yours.</li>
   <li><em>Port Range</em> = <tt>40000</tt> - <tt>40010</tt></li>
</ul>

<p>Have a look at the other settings, and change them as you wish. You
can change them later, as well. Click <em>"Update Settings"</em>. There
are "lights" that indicate problems in your settings. All should be
green. Notice that TorrentFlux will download directly to our shared
folder, giving instant access over the LAN.</p>

<p>A nice feature of TorrentFlux is queueing. Click on <em>"queue"</em>
at the top, and choose if you want to enable it, and define how many
torrent connections you want to allow to run in total (server threads)
and per user (user threads). Click <em>"Update Settings"</em>. Going
with the 40% max download bandwidth per Torrent and allowing two
connections total to run at a time still leaves 20% of the bandwidth for
Web browsing.</p>

<p>Use the <em>"new user"</em> page to create normal or admin users for
any one you want to grant access to. Other settings include search
engine options and filters, external links, rss feeds, and database
backups.</p>

<p>Adding torrents is done either by uploading from your desktop
machine, pasting the URL of the torrent file, or searching using the
available search engines. Files will be saved in folders according to
TorrentFlux usernames in the shared folder.</p>

<p>Now, we will open ports 40000-40010 in Shorewall for the Torrent
software to work properly. Go to <em>Networking &gt; Shorewall
Firewall &gt: Firewall Rules &gt; Manually Edit File</em>, and paste
this rule at the end:</p>

<pre><tt>#torrentflux
ACCEPT	net	$FW	tcp	40000:40010</tt></pre>

<p>If you wish to access your TorrentFlux from the Internet, e.g., while
at work, and have a static external IP address, simply open port 80 on
the external firewall, by adding this rule:</p>

<pre><tt>#Apache Web server
ACCEPT	net	$FW	tcp	80</tt></pre>

<p>Click <em>Save</em>, and then <em>Apply Configuration</em> in the
Shorewall main page. You can then access TorrentFlux from anywhere, by
browsing to <tt>http://*your external IP address*</tt></p>

<p>If you have a dynamic IP address, then you will also have to use a
service such as that provided by <a
href="http://www.dyndns.com/services/dns/dyndns">Dynamic DNS</a>, which
is free. Instructions for this are available on <a
href="http://ubuntuguide.org/wiki/Ubuntu:Feisty#How_to_assign_Hostname_to_local_machine_with_dynamic_IP_using_free_DynDNS_service">ubuntuguide.org</a>.
Although they are meant to be done at the actual machine, you can do
them through Webmin, running the sudo commands in <em>Others &gt; Command
Shell</em> and editing the <tt>dyndns_update</tt> file in the Java file
manager tool.</p>

<p>One thing to be wary of is completely filling up your hard disk. This
will inevitably cause problems. So, just make sure you have enough
space, before you decide to run your Torrent session.</p>

<h3>15. System logs</h3>

<p>Speaking of space, although system log files are useful in diagnosing
problems, they sometimes occupy a whole lot of space. We will now limit
the size of the log files.</p>

<p>Go to <em>System &gt; Log File Rotation>Edit Global Options</em> and set
the <em>"Maximum size before rotating"</em> to <tt>50M</tt> (for 50MB)
and the <em>"Number of old logs to keep"</em> to <tt>4</tt>. This should
allow you to have decent system logs, without eating up all your disk
space. For a few days under normal use, keep an eye on the size of log
files in <tt>/var/log</tt> using the Java file manager. See which logs
are huge, fiddle with their settings in <em>System>Log File
Rotation</em> and <em>System>System Logs</em>. Bear in mind that all
that logging might be due to a real problem in your system. In general,
though, the debug logs are pretty massive, and not very important for our
purpose, especially the ones that debug network traffic.</p>

<h3>16. Backing up Webmin configurations</h3>

<p>Once you have set everything up, and all is working fine, it would be
wise to backup your settings, in case you get too adventurous trying to
fiddle around and break something, or even if you decide to change your
server machine. This will enable you to restore all your settings.</p>

Go to <em>Webmin &gt; Backup Configuration Files</em>. In the <em>"Modules to
backup"</em> list, select all of them (using the <tt>Shift</tt> key); for
the <em>Backup destination</em> choose <em>Local file</em>, and enter a
path, e.g., <tt>/home/*admin username*/backup-*date*.tar</tt>; in the
<em>"Include in backup"</em> section, check <em>"Webmin module
configuration files"</em> and <em>"Server configuration files"</em>, and
click <em>"Backup Now"</em>. I recommend naming your backup files
including the date, as choosing which one to restore from becomes
easier.</p>

<p>If you wish, you can set up Webmin to periodically backup your
configurations automatically, in the <em>"Scheduled backups"</em>
section. I set mine to backup up daily and weekly. Previous scheduled
backups are replaced, and only the latest one is kept. Restoring is
simply a matter of choosing which modules to restore, from which backup
file, and whether the configurations should be applied.</p>

<h3>17. Updating your server</h3>

<p>Once in a while, it would be wise to update your server to get the
latest fixes and patches. Do this by going to <em>System>Software
Packages</em>, and in the <em>"Upgrade all Packages"</em> section,
select:</p>


<ul>
<li><em>Resynchronize package list</em> = <tt>Yes</tt>,</li>
<li><em>Upgrade mode</em> = <tt>Normal upgrade</tt>,</li>
<li><em>Only show which packages would be upgraded</em> = <tt>No</tt>.</li>
</ul>

<p>Click <em>"Upgrade Now"</em>, and it will all be done automagically,
giving all the information about the upgrade. Also periodic upgrades to
Webmin, as we did at the beginning of this guide, are advisable.</p>

<h3>Other tools</h3>

<p>Some examples of other functionality you may be interested in including:</p>

<ul>
   <li><a href="http://ubuntuguide.org/wiki/Ubuntu:Feisty#SSH_Server">SSH</a> will allow you log in to your server in CLI over any network, while keeping everything encrypted and secure. I would recommend this, as everything else pales in comparison to the CLI, when it comes to control over your system.</li>
   <li>using <a href="http://ubuntuguide.org/wiki/Ubuntu:Feisty#Apache_HTTP_Server">Apache</a> HTTPd, to host your own Web sites in tandem with services like Dynamic DNS,</li>
   <li><a href="http://coppermine-gallery.net/">Coppermine Gallery</a> or <a href="http://ubuntuguide.org/wiki/Ubuntu:Feisty#Image_Gallery_Server">Image Gallery Server</a>, for sharing your photos online while keeping them off public services,</li>
   <li>hosting an <a href="http://ubuntuguide.org/wiki/Ubuntu:Feisty#FTP_Server">FTP server</a>, to share files over the Internet</li>
   <li>using <a href="http://www.ubuntugeek.com/send-and-receive-your-hotmail-messages-through-evolution.html">hotway</a> and <a href="http://www.freepops.org/en/">freepops</a>, to get your Hotmail and Yahoo mail right in your e-mail client,</li>
   <li>The list is endless, really, from disk quotas to clusters, and to think we have only used a fraction of the features in Webmin! Poke around! It only gets more interesting, and besides... what are backups for, anyway?</li>
</ul>

<p>As you may have gathered by now, administering a Linux server is not
a brain-twisting business, as some may have you think. Once you have
everything set up to meet your needs, your LAN server/gateway should run like
clockwork, requiring only occasional upgrades and maybe a pat on the
back. Moreover, Webmin makes it a pleasant point-and-click affair,
although, like everything else, you have to know what it is you want to
do. This is where the vast documentation and help from the Linux
community is priceless and indispensable.</p>

<p>With luck, everything has worked as expected, so far, and you now
benefit from a free (as in free speech), powerful, flexible,
easy-to-manage, easy-to-use, and cheap solution to your home networking
needs. This, dear friends, is the brilliance of free and open source
software!</p>

<hr />

<p> [1] <span class="editorial">Rick Moen comments</span>: On balance,
I'd recommend against forwarding queries to one's ISP's nameservers. At
minimum, users should understand the tradeoff.</p>

<p>Declaring forwarders in BIND declares a list of nameserver IPs to
consult on all lookups BIND cannot answer from its local cache, in
preference to the various nameservers that are authoritative for those
domains, that would have been otherwise consulted.  In the very short
term, this gives you faster responses on early queries (i.e., for a
short while after your local BIND instance fires up).  After a while,
most likely queries will be hits on the local cache, making your
relatively high speed of access to the ISP's nameservers mostly
irrelevant.</p>

<p>What you lose, through such forwarding, constitutes in my view a very
serious drawback: you are making your DNS rely on the performance,
reliability, and security of your ISP's nameservers. Most ISP
nameservers turn out to have poor performance, are seriously lacking in
performance and reasonableness of configuration, and have alarming
security problems.

<p>To be specific about some of those things:  Many ISPs appear to have 
deliberately overridden the Time to Live (TTL) values that would
normally be shared with cached DNS records, to artificially prolong the
life of that cached information even though it may have been sent with
low TTL values to keep cached copies from being used after becoming
obsolete.  The ISPs presumably do this, subverting the intended
DNS-updating mechanisms, to reduce (needed) network traffic.

<p>The worst problem is the security one:  Studies such as Dan
Kaminsky's have shown that a large number of ISP nameservers are
vulnerable to cache poisoning, a form of attack in which they are
induced to cache fraudulent data. This is especially true when those
nameservers are <a
href="http://www.circleid.com/posts/so_you_think_youre_safe_from_dns_cache_poisoning/">used
by forwarding nameservers</a> in the fashion that this article describes.

<p>The alternative, of course, is to just simply run your own
recursive-resolver nameserver without forwarders, which by default will
then get its data from the root zone and the immense tree of
authoritative servers it defines.  Fortunately, this works just
perfectly without touching anything at all, out of the box, and imposes
no performance deficiencies once you've started loading the cache.

<p>I guess, overall, there's an instinctive tendency in people to think
"Let's rely on the ISP's services, because they're the pros, and we
should get better performance and reliability, that way."  However, it
turns out that, most often, none of those things is actually the case,
and you can do much better on your own, with surprising ease.

<p>One last suggestion:  BIND9 is certainly a respected do-it-all
nameserver, but is vastly overfeatured when all you need is a simple
recursive resolver (and, in particular, aren't serving up locally defined 
domains of your own, which is called authoritative service).  Also,
BIND9 is infamously bloated and slow.   

<p>For all of those reasons, I long ago started keeping a catalogue of 
<a href=http://linuxmafia.com/faq/Network_Other/dns-servers.html">alternatives
to BIND9</a>, and in all honesty cannot say which of them I'd recommend,
since I've stayed with BIND9 despite reservations, but you might browse
the alternatives.



<p class="talkback">
Talkback: <a
href="mailto:tag@lists.linuxgazette.net?subject=Talkback:141/lazar.html">Discuss this article with The Answer Gang</a>
</p>

<!-- *** BEGIN author bio *** -->
<!-- *** BEGIN bio *** -->
<hr>
<P>
<img ALIGN="LEFT" ALT="[picture]" SRC="../gx/authors/lazar.jpg" WIDTH="180" HEIGHT="200" class="bio">
<em>
Shane is a Medical Resident in Romania. He has been a ardent user of FOSS and Linux since 2004. He spends a sizeable amount of time on Linux forums learning about it and helping others where he can. Currently his favorite distro is Ubuntu, while he has used Mandrake/Mandriva in the past on his desktop and still does for his home network server.
</em>
<br CLEAR="all">
<!-- *** END bio *** -->
<br clear="all">


<!-- *** END author bio *** -->

<div id="articlefooter">

<p>
Copyright &copy; 2007, Shane Lazar. Released under the <a
href="http://linuxgazette.net/copying.html">Open Publication License</a>
unless otherwise noted in the body of the article. Linux Gazette is not
produced, sponsored, or endorsed by its prior host, SSC, Inc.
</p>

<p>
Published in Issue 141 of Linux Gazette, August 2007
</p>

</div>

<div id="previousnextbottom">
<A HREF="kapil.html" >&lt;-- prev</A> | <A HREF="pfeiffer.html" >next --&gt;</A>
</div>

</div>
</div>

<script src="http://www.google-analytics.com/urchin.js"
type="text/javascript">
</script>
<script type="text/javascript">
_uacct = "UA-1204316-1";
urchinTracker();
</script>







<img src="../gx/tux_86x95_indexed.png" id="tux" alt="Tux"/>

</body>
</html>

