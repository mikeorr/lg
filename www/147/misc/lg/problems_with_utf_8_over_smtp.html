<!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.0 Transitional//EN'
		 'http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd'>
<html xmlns='http://www.w3.org/1999/xhtml' lang='utf-8' xml:lang='utf-8'>
<head>
<title>Problems with UTF-8 over SMTP</title>
<meta http-equiv='Content-Type; charset=utf-8' />
<link rel='stylesheet' type='text/css' href='../../../lg.css' />
</head>
<body>
<a href="../../../"><img alt="Linux Gazette" src="../../../gx/2003/newlogo-blank-200-gold2.jpg" id="logo" /></a><img alt="Tux" src="../../../gx/tux_86x95_indexed.png" id="tux" /><p id="fun">...making Linux just a little more fun!</p><div class='content articlecontent'><a name="top"></a><h3>Problems with UTF-8 over SMTP</h3>
<p>
<b><p>
Kat Tanaka Okopnik [kat at linuxgazette.net]
</p>
</b><br />
<b>Tue, 22 Jan 2008 12:13:11 -0800</b>
</p>

<p>
<p class="editorial">
[[[  The originating thread for this discussion is
<a href="../../../147/misc/lg/transliterating_arabic.html">http://linuxgazette.net/147/misc/lg/transliterating_arabic.html</a> -- Kat
 ]]]
</p>

</p>

<p>
On Tue, Jan 22, 2008 at 02:39:21PM -0500, Benjamin A. Okopnik wrote:
</p>

<pre>
&gt; Latin character set (ISO-8859-1 and such) to Russian, yes.
&gt; 
&gt; Eh... I'll send this example, and hope the 8-bit stuff makes it through
&gt; the mail. 
&gt; ```
&gt; ben@Tyr:~$ tsl2utf8 -h
&gt; Mappings:
&gt; 
&gt; A|&lt;90&gt;     B|&lt;91&gt;     V|&lt;92&gt;     G|&lt;93&gt;     D|&lt;94&gt;     E|&lt;95&gt;     J|&lt;96&gt;     Z|&lt;97&gt;
&gt; I|&lt;98&gt;     Y|&lt;99&gt;     K|&lt;9a&gt;     L|&lt;9b&gt;     M|&lt;9c&gt;     N|&lt;9d&gt;     O|&lt;9e&gt;     P|&lt;9f&gt;
&gt; R|&lt;a0&gt;     S|&lt;a1&gt;     T|&lt;a2&gt;     U|&lt;a3&gt;     F|&lt;a4&gt;     H|&lt;a5&gt;     C|&lt;a6&gt;     X|&lt;a7&gt;
&gt; 1|&lt;a8&gt;     2|&lt;a9&gt;     3|&lt;aa&gt;     4|&lt;ab&gt;     5|&lt;ac&gt;     6|&lt;ad&gt;     7|&lt;ae&gt;     8|&lt;af&gt;
&gt; a|&lt;b0&gt;     b|&lt;b1&gt;     v|&lt;b2&gt;     g|&lt;b3&gt;     d|&lt;b4&gt;     e|&lt;b5&gt;     j|&lt;b6&gt;     z|&lt;b7&gt;
&gt; i|&lt;b8&gt;     y|&lt;b9&gt;     k|&lt;ba&gt;     l|&lt;bb&gt;     m|&lt;bc&gt;     n|&lt;bd&gt;     o|&lt;be&gt;     p|&lt;bf&gt;
&gt; r|&lt;80&gt;     s|&lt;81&gt;     t|&lt;82&gt;     u|&lt;83&gt;     f|&lt;84&gt;     h|&lt;85&gt;     c|&lt;86&gt;     x|&lt;87&gt;
&gt; !|&lt;88&gt;     @|&lt;89&gt;     #|&lt;8a&gt;     $|&lt;8b&gt;     %|&lt;8c&gt;     ^|&lt;8d&gt;     &amp;|&lt;8e&gt;     *|&lt;8f&gt;
&gt; +|&lt;91&gt;
&gt; 
&gt; ben@Tyr:~$ tsl2utf8
&gt; samovar
&gt; &lt;81&gt;&lt;b0&gt;&lt;bc&gt;&lt;be&gt;&lt;b2&gt;&lt;b0&gt;&lt;80&gt;
&gt; babu!ka
&gt; &lt;b1&gt;&lt;b0&gt;&lt;b1&gt;&lt;83&gt;&lt;88&gt;&lt;ba&gt;&lt;b0&gt;
&gt; 7jno-^fiopskiy grax uv+l m$!% za hobot na s#ezd *@eric.
&gt; &lt;ae&gt;&lt;b6&gt;&lt;bd&gt;&lt;be&gt;-&lt;8d&gt;&lt;84&gt;&lt;b8&gt;&lt;be&gt;&lt;bf&gt;&lt;81&gt;&lt;ba&gt;&lt;b8&gt;&lt;b9&gt; [...]
&gt; '''
</pre>

<p>
Alas, as you may note from the above, it came through as utter
<em>mojibake</em>, even though my system is capable of reading (some) Russian.
</p>

<p>
<a href="http://people.debian.org/~kubota/mojibake/">http://people.debian.org/~kubota/mojibake/</a>
</p>

<p>
<a href="http://en.wikipedia.org/wiki/Mojibake">http://en.wikipedia.org/wiki/Mojibake</a>
</p>

<p>
Hmm. Wikipedia sugests that I call it krakozyabry (крокозя́бры). ;)
</p>

<p>
This looked like a useful gizmo: <a href="http://2cyr.com/decode/?lang=en">http://2cyr.com/decode/?lang=en</a>
but it failed to produce anything ungarbled this time.
</p>

<pre>-- 
Kat Tanaka Okopnik
Linux Gazette Mailbag Editor
kat@linuxgazette.net
</pre>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-problems_with_utf_8_over_smtp">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Ben Okopnik [ben at linuxgazette.net]
</p>
</b><br />
<b>Tue, 22 Jan 2008 17:12:59 -0500</b>
</p>

<p>
On Tue, Jan 22, 2008 at 12:13:11PM -0800, Kat wrote:
</p>

<pre>
&gt; On Tue, Jan 22, 2008 at 02:39:21PM -0500, Benjamin A. Okopnik wrote:
&gt; &gt; 
&gt; &gt; Eh... I'll send this example, and hope the 8-bit stuff makes it through
&gt; &gt; the mail. 
&gt; &gt; ```
&gt; &gt; ben@Tyr:~$ tsl2utf8 -h
&gt; &gt; Mappings:
&gt; &gt; 
&gt; &gt; A|&lt;90&gt;     B|&lt;91&gt;     V|&lt;92&gt;     G|&lt;93&gt;     D|&lt;94&gt;     E|&lt;95&gt;     J|&lt;96&gt;     Z|&lt;97&gt;
&gt; &gt; I|&lt;98&gt;     Y|&lt;99&gt;     K|&lt;9a&gt;     L|&lt;9b&gt;     M|&lt;9c&gt;     N|&lt;9d&gt;     O|&lt;9e&gt;     P|&lt;9f&gt;
&gt; &gt; R|&lt;a0&gt;     S|&lt;a1&gt;     T|&lt;a2&gt;     U|&lt;a3&gt;     F|&lt;a4&gt;     H|&lt;a5&gt;     C|&lt;a6&gt;     X|&lt;a7&gt;
&gt; &gt; 1|&lt;a8&gt;     2|&lt;a9&gt;     3|&lt;aa&gt;     4|&lt;ab&gt;     5|&lt;ac&gt;     6|&lt;ad&gt;     7|&lt;ae&gt;     8|&lt;af&gt;
&gt; &gt; a|&lt;b0&gt;     b|&lt;b1&gt;     v|&lt;b2&gt;     g|&lt;b3&gt;     d|&lt;b4&gt;     e|&lt;b5&gt;     j|&lt;b6&gt;     z|&lt;b7&gt;
&gt; &gt; i|&lt;b8&gt;     y|&lt;b9&gt;     k|&lt;ba&gt;     l|&lt;bb&gt;     m|&lt;bc&gt;     n|&lt;bd&gt;     o|&lt;be&gt;     p|&lt;bf&gt;
&gt; &gt; r|&lt;80&gt;     s|&lt;81&gt;     t|&lt;82&gt;     u|&lt;83&gt;     f|&lt;84&gt;     h|&lt;85&gt;     c|&lt;86&gt;     x|&lt;87&gt;
&gt; &gt; !|&lt;88&gt;     @|&lt;89&gt;     #|&lt;8a&gt;     $|&lt;8b&gt;     %|&lt;8c&gt;     ^|&lt;8d&gt;     &amp;|&lt;8e&gt;     *|&lt;8f&gt;
&gt; &gt; +|&lt;91&gt;
&gt; &gt; 
&gt; &gt; ben@Tyr:~$ tsl2utf8
&gt; &gt; samovar
&gt; &gt; &lt;81&gt;&lt;b0&gt;&lt;bc&gt;&lt;be&gt;&lt;b2&gt;&lt;b0&gt;&lt;80&gt;
&gt; &gt; babu!ka
&gt; &gt; &lt;b1&gt;&lt;b0&gt;&lt;b1&gt;&lt;83&gt;&lt;88&gt;&lt;ba&gt;&lt;b0&gt;
&gt; &gt; 7jno-^fiopskiy grax uv+l m$!% za hobot na s#ezd *@eric.
&gt; &gt; &lt;ae&gt;&lt;b6&gt;&lt;bd&gt;&lt;be&gt;-&lt;8d&gt;&lt;84&gt;&lt;b8&gt;&lt;be&gt;&lt;bf&gt;&lt;81&gt;&lt;ba&gt;&lt;b8&gt;&lt;b9&gt; [...]
&gt; &gt; '''
&gt; 
&gt; Alas, as you may note from the above, it came through as utter
&gt; <em>mojibake</em>, even though my system is capable of reading (some) Russian.
</pre>

<p>
Bleh. As I'm responding to this, using 'vi', I can see exactly where the
UTF-8 characters got turned back into the... other... stuff. I.e., the
first letter pair looks like 'A|&lt;83&gt;&lt;90&gt;' (the '&lt;90&gt;' part being the value
of the second byte in hex, i.e. dec144/oct221) - which is actually what
the UTF-8 two-byte pair for the character is supposed to be.
</p>

<p>
To the best of my troubleshooting ability so far, everything breaks
somewhere between the time that it leaves my mail client and the time
that it arrives at the LG mail server - but I've checked everything on
my end, and I'm sending it out with 'utf-8' as the charset and 8 bits
set for the SMTP transaction. I'm pretty much stuck at that point, and
have been for a while.
</p>


<pre>
&gt; Hmm. Wikipedia sugests that I call it krakozyabry (крокозя́бры). ;)
</pre>
                                          ^            ^
</p>

<p>
The translit version is fine; the so-called Russian isn't (it's 'kra',
not 'kro'.) I also get somewhat annoyed when people put accent marks
into plain Russian text anywhere outside a primer without denoting it:
given that Russian uses a mark of that sort as part of a letter... well,
there's no such letter as a "ya-tilde" in Russian, although anyone looking at the
above cite would think so.
</p>


<pre>-- 
* Ben Okopnik * Editor-in-Chief, Linux Gazette * <a href="http://LinuxGazette.NET">http://LinuxGazette.NET</a> *
</pre>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-problems_with_utf_8_over_smtp">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Ren&eacute; Pfeiffer [lynx at luchs.at]
</p>
</b><br />
<b>Wed, 23 Jan 2008 00:45:37 +0100</b>
</p>

<p>
On Jan 22, 2008 at 1712 -0500, Ben Okopnik appeared and said:
</p>

<pre>
&gt; On Tue, Jan 22, 2008 at 12:13:11PM -0800, Kat wrote:
&gt; &gt; On Tue, Jan 22, 2008 at 02:39:21PM -0500, Benjamin A. Okopnik wrote:
&gt; &gt; &gt;
&gt; &gt; &gt; Eh... I'll send this example, and hope the 8-bit stuff makes it through
&gt; &gt; &gt; the mail.
&gt; &gt; [...]
&gt; &gt; Alas, as you may note from the above, it came through as utter
&gt; &gt; <em>mojibake</em>, even though my system is capable of reading (some) Russian.
&gt;
&gt; Bleh. As I'm responding to this, using 'vi', I can see exactly where the
&gt; UTF-8 characters got turned back into the... other... stuff. I.e., the
&gt; first letter pair looks like 'A|=C3=90&lt;90&gt;' (the '&lt;90&gt;' part being the value
&gt; of the second byte in hex, i.e. dec144/oct221) - which is actually what
&gt; the UTF-8 two-byte pair for the character is supposed to be.
</pre>

<p>
It looks a bit unreadable to me (not that I could understand Arabic or
Russian though).
</p>


<pre>
&gt; To the best of my troubleshooting ability so far, everything breaks
&gt; somewhere between the time that it leaves my mail client and the time
&gt; that it arrives at the LG mail server - but I've checked everything on
&gt; my end, and I'm sending it out with 'utf-8' as the charset and 8 bits
&gt; set for the SMTP transaction. I'm pretty much stuck at that point, and
&gt; have been for a while.
</pre>

<p>
It took me some time to convert all my workstations and my mutt mail
enviroment to UTF-8. Basically I have the following configuration.
<pre>
 - I use LANG=3Den_GB.UTF-8 as locale setting (don't like the German
   translations ;-).
 - I use UTF-8-capable xterms. "ps ax" says they were started with the
   following options:
   xterm -class UXTerm -title uxterm -u8 -bg black -fg green
 - My .muttrc offers mutt the following encodings when writing emails:
   set send_charset=3D"us-ascii:iso-8859-15:utf-8"
 - Additionally I have the following two lines in my .muttrc:
   set charset=3D"utf-8"
   set editor=3D"vim +':set textwidth=3D72' +':set wrap' +':set encoding=3Dutf-8' +'set si'"
</pre>
With this combination the encoding is fairly sure to survive (even
PGP/MIME and other manglings on the way out).
</p>

<p>
We now return to your regular scheduled programme.
</p>

<p>
Best,
Ren&eacute;.
</p>

<p>
P.S.: I wonder what happens to the &amp;eacute; in Ben's
      mutt/xterm/window/thing.
</p>


<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-problems_with_utf_8_over_smtp">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Ben Okopnik [ben at linuxgazette.net]
</p>
</b><br />
<b>Wed, 23 Jan 2008 00:09:59 -0500</b>
</p>

<p>
On Wed, Jan 23, 2008 at 12:45:37AM +0100, Ren&lt;a9&gt; Pfeiffer wrote:
</p>

<pre>
&gt; On Jan 22, 2008 at 1712 -0500, Ben Okopnik appeared and said:
&gt; 
&gt; &gt; To the best of my troubleshooting ability so far, everything breaks
&gt; &gt; somewhere between the time that it leaves my mail client and the time
&gt; &gt; that it arrives at the LG mail server - but I've checked everything on
&gt; &gt; my end, and I'm sending it out with 'utf-8' as the charset and 8 bits
&gt; &gt; set for the SMTP transaction. I'm pretty much stuck at that point, and
&gt; &gt; have been for a while.
&gt; 
&gt; It took me some time to convert all my workstations and my mutt mail
&gt; enviroment to UTF-8. Basically I have the following configuration.
&gt; 
&gt;  - I use LANG=en_GB.UTF-8 as locale setting (don't like the German
&gt;    translations ;-).
</pre>

<p>
I've got LANG=en_US.UTF-8; did that pretty early on, since I often have
a need for mixing different languages.
</p>


<pre>
&gt;  - I use UTF-8-capable xterms. "ps ax" says they were started with the
&gt;    following options:
&gt;    xterm -class UXTerm -title uxterm -u8 -bg black -fg green
</pre>

<p>
I've got most of that, except I set it in my .Xresources:
</p>

<pre>
xterm*utf8:1
xterm*background: black
xterm*foreground: gold
</pre>
Not sure what the UXTerm class does beyond turning on '-u8' and
providing a different class for font settings, etc., but I can
display/read Unicode stuff just fine (':dig' in Vim is a pretty good
test; so is Markus Kuhn's "UTF-8-demo.txt.gz".) I'll try adding it, just
to see.
</p>


<pre>
&gt;  - My .muttrc offers mutt the following encodings when writing emails:
&gt;    set send_charset="us-ascii:iso-8859-15:utf-8"
</pre>

<p>
Hmm, I didn't have that one - I'll try adding it. Frankly, I doubt that
it'll change anything, since the messages queued in my SMTP spool look
fine.
</p>


<pre>
&gt;  - Additionally I have the following two lines in my .muttrc:
&gt;    set charset="utf-8"
</pre>

<p>
Got that one.
</p>


<pre>
&gt;    set editor="vim +':set textwidth=72' +':set wrap' +':set encoding=utf-8' +'set si'"
</pre>

<p>
Set in my ~/.vimrc, except for "si" and "encoding". I'll add that too -
although, again, the UTF-8 stuff that I write in my files saves and
displays just fine.
</p>

<p>
I suspect that I'm just missing something in my understanding of how
SMTP works - although I've studied everything I thought was relevant.
Mutt is pretty smart, so my messages (both the one I sent to the list
earlier and the test ones I've just sent on a round trip) went out with
the following relevant headers:
</p>

<pre>
MIME-Version: 1.0
Content-Type: text/plain; charset=utf-8
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
</pre>
The method that I invoke on the Net::SMTP object that does the server
interaction is:
</p>

<pre>
$smtp{connection}-&gt;mail( $message{from}, Bits =&gt; 8 )
</pre>
This is the belt <strong>and</strong> the suspenders <strong>and</strong> the no-wrinkle fabric with
the double-stitched pockets with special coin holders on the sides,
y'know what I mean? 
 
</p>

<pre>
&gt; With this combination the encoding is fairly sure to survive (even
&gt; PGP/MIME and other manglings on the way out).
</pre>

<p>
All I can say is <img src="../gx/frown.png" alt=":(">((((( ...
 
</p>

<pre>
&gt; Ren&lt;a9&gt;.
&gt; 
&gt; P.S.: I wonder what happens to the &amp;eacute; in Ben's
&gt;       mutt/xterm/window/thing.
</pre>

<p>
I can see it just fine right now - but it's going to break once I send
it back to the list. 
</p>


<pre>-- 
* Ben Okopnik * Editor-in-Chief, Linux Gazette * <a href="http://LinuxGazette.NET">http://LinuxGazette.NET</a> *
</pre>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-problems_with_utf_8_over_smtp">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Ren&eacute; Pfeiffer [lynx at luchs.at]
</p>
</b><br />
<b>Wed, 23 Jan 2008 14:52:49 +0100</b>
</p>

<p>
On Jan 23, 2008 at 0009 -0500, Ben Okopnik appeared and said:
</p>

<pre>
&gt; On Wed, Jan 23, 2008 at 12:45:37AM +0100, Ren&eacute; Pfeiffer wrote:
&gt; &gt; [...]
&gt; &gt;  - I use LANG=3Den_GB.UTF-8 as locale setting (don't like the German
&gt; &gt;    translations ;-).
&gt;
&gt; I've got LANG=3Den_US.UTF-8; did that pretty early on, since I often have
&gt; a need for mixing different languages.
</pre>

<p>
Ok.
</p>


<pre>
&gt; &gt;  - I use UTF-8-capable xterms. "ps ax" says they were started with the
&gt; &gt;    following options:
&gt; &gt;    xterm -class UXTerm -title uxterm -u8 -bg black -fg green
&gt;
&gt; I've got most of that, except I set it in my .Xresources:
&gt;
&gt; ``
&gt; xterm*utf8:1
&gt; xterm*background: black
&gt; xterm*foreground: gold
&gt; ''
</pre>

<p>
This looks good, too.
</p>


<pre>
&gt; Not sure what the UXTerm class does beyond turning on '-u8' and
&gt; providing a different class for font settings, etc., but I can
&gt; display/read Unicode stuff just fine (':dig' in Vim is a pretty good
&gt; test; so is Markus Kuhn's "UTF-8-demo.txt.gz".) I'll try adding it, just
&gt; to see.
</pre>

<p>
I use xterm with "-u8" out of habit since it's in my xfce menu
configuration. xterms with this option handle the UTF-8-demo.txt file
just fine.
</p>


<pre>
&gt; &gt;  - My .muttrc offers mutt the following encodings when writing emails:
&gt; &gt;    set send_charset=3D"us-ascii:iso-8859-15:utf-8"
&gt;
&gt; Hmm, I didn't have that one - I'll try adding it. Frankly, I doubt that
&gt; it'll change anything, since the messages queued in my SMTP spool look
&gt; fine.
</pre>

<p>
Yes, and your headers also look good. I use the above line mainly
because then mutt can use an appropriate encoding. UTF-8 isn't always
necessary.
</p>


<pre>
&gt; &gt;  - Additionally I have the following two lines in my .muttrc:
&gt; &gt;    set charset=3D"utf-8"
&gt;
&gt; Got that one.
</pre>

<p>
Hm.
</p>


<pre>
&gt; &gt;    set editor=3D"vim +':set textwidth=3D72' +':set wrap' +':set encoding=3Dutf-8' +'set si'"
&gt;
&gt; Set in my ~/.vimrc, except for "si" and "encoding". I'll add that too -
&gt; although, again, the UTF-8 stuff that I write in my files saves and
&gt; displays just fine.
</pre>

<p>
Well, what can I say? <img src="../gx/smile.png" alt=":-)"> Looks good to me.
</p>


<pre>
&gt; I suspect that I'm just missing something in my understanding of how
&gt; SMTP works - although I've studied everything I thought was relevant.
</pre>

<p>
Most modern MTAs are 8-bit clean. From personal experience I know that
Postfix, Sendmail, Exim and CommuniGate Pro deal with 8-bit mail bodies
just fine.
</p>


<pre>
&gt; Mutt is pretty smart, so my messages (both the one I sent to the list
&gt; earlier and the test ones I've just sent on a round trip) went out with
&gt; the following relevant headers:
&gt;
&gt; ``
&gt; MIME-Version: 1.0
&gt; Content-Type: text/plain; charset=3Dutf-8
&gt; Content-Disposition: inline
&gt; Content-Transfer-Encoding: 8bit
&gt; ''
</pre>

<p>
Yes, I saw that, and that's correct - apart from the content in your
email. ;-)
</p>


<pre>
&gt; The method that I invoke on the Net::SMTP object that does the server
&gt; interaction is:
&gt;
&gt; ``
&gt; $smtp{connection}-&gt;mail( $message{from}, Bits =3D&gt; 8 )
&gt; ''
&gt;
&gt; This is the belt <strong>and</strong> the suspenders <strong>and</strong> the no-wrinkle fabric with
&gt; the double-stitched pockets with special coin holders on the sides,
&gt; y'know what I mean?
</pre>

<p>
Yes, basically the take away variant with everything and extra cheese.
The only difference is that I carry a Postfix around all the time which
handles the submitted emails.
</p>


<pre>
&gt; &gt; With this combination the encoding is fairly sure to survive (even
&gt; &gt; PGP/MIME and other manglings on the way out).
&gt;
&gt; All I can say is <img src="../gx/frown.png" alt=":(">((((( ...
</pre>

<p>
Which leaves me with ?????????...
</p>


<pre>
&gt; &gt; Ren&eacute;.
&gt; &gt;
&gt; &gt; P.S.: I wonder what happens to the &amp;eacute; in Ben's
&gt; &gt;       mutt/xterm/window/thing.
&gt;
&gt; I can see it just fine right now - but it's going to break once I send
&gt; it back to the list.
</pre>

<p>
Why not use screenshots for the quoted text then? <img src="../gx/smile.png" alt=":-)">
On my end of your email I see a "Ren =C3=A9" which looks like "Ren&eacute;" encoded
in UTF-8 and displayed as ISO-8859-1(5). Maybe wireshark can help us
out.
</p>

<p>
Best,
Ren&eacute;.
</p>


<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-problems_with_utf_8_over_smtp">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Ben Okopnik [ben at linuxgazette.net]
</p>
</b><br />
<b>Wed, 23 Jan 2008 09:44:27 -0500</b>
</p>

<p>
On Wed, Jan 23, 2008 at 02:52:49PM +0100, Ren&lt;a9&gt; Pfeiffer wrote:
</p>

<pre>
&gt; On Jan 23, 2008 at 0009 -0500, Ben Okopnik appeared and said:
&gt; 
&gt; &gt; I suspect that I'm just missing something in my understanding of how
&gt; &gt; SMTP works - although I've studied everything I thought was relevant.
&gt; 
&gt; Most modern MTAs are 8-bit clean. From personal experience I know that
&gt; Postfix, Sendmail, Exim and CommuniGate Pro deal with 8-bit mail bodies
&gt; just fine.
</pre>

<p>
I'm pretty sure that 8bit is the default method, but I wanted to nail it
down just in case. I've even tried 'Bits =&gt; "binary"', with no better
result.
</p>


<pre>
&gt; &gt; Mutt is pretty smart, so my messages (both the one I sent to the list
&gt; &gt; earlier and the test ones I've just sent on a round trip) went out with
&gt; &gt; the following relevant headers:
&gt; &gt; 
&gt; &gt; ``
&gt; &gt; MIME-Version: 1.0
&gt; &gt; Content-Type: text/plain; charset=utf-8
&gt; &gt; Content-Disposition: inline
&gt; &gt; Content-Transfer-Encoding: 8bit
&gt; &gt; ''
&gt; 
&gt; Yes, I saw that, and that's correct - apart from the content in your
&gt; email. ;-)
</pre>

<p>
Heh.
</p>


<pre>
&gt; &gt; &gt; RenA&lt;a9&gt;.
</pre>
<pre>
250 2.1.0 ben@linuxgazette.net... Sender ok
250 2.1.5 ben@linuxgazette.net... Recipient ok
354 Enter mail, end with "." on a line by itself
test
тест
</pre>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-problems_with_utf_8_over_smtp">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Ben Okopnik [ben at linuxgazette.net]
</p>
</b><br />
<b>Wed, 23 Jan 2008 09:44:27 -0500</b>
</p>

<p>
On Wed, Jan 23, 2008 at 02:52:49PM +0100, Ren&lt;a9&gt; Pfeiffer wrote:
</p>

<pre>
&gt; On Jan 23, 2008 at 0009 -0500, Ben Okopnik appeared and said:
&gt; 
&gt; &gt; I suspect that I'm just missing something in my understanding of how
&gt; &gt; SMTP works - although I've studied everything I thought was relevant.
&gt; 
&gt; Most modern MTAs are 8-bit clean. From personal experience I know that
&gt; Postfix, Sendmail, Exim and CommuniGate Pro deal with 8-bit mail bodies
&gt; just fine.
</pre>

<p>
I'm pretty sure that 8bit is the default method, but I wanted to nail it
down just in case. I've even tried 'Bits =&gt; "binary"', with no better
result.
</p>


<pre>
&gt; &gt; Mutt is pretty smart, so my messages (both the one I sent to the list
&gt; &gt; earlier and the test ones I've just sent on a round trip) went out with
&gt; &gt; the following relevant headers:
&gt; &gt; 
&gt; &gt; ``
&gt; &gt; MIME-Version: 1.0
&gt; &gt; Content-Type: text/plain; charset=utf-8
&gt; &gt; Content-Disposition: inline
&gt; &gt; Content-Transfer-Encoding: 8bit
&gt; &gt; ''
&gt; 
&gt; Yes, I saw that, and that's correct - apart from the content in your
&gt; email. ;-)
</pre>

<p>
Heh.
</p>


<pre>
&gt; &gt; &gt; Ren?????^F&lt;a9&gt;.
</pre>

<p>
Yep - that's what I see after I've sent it on a round trip.
</p>


<pre>
&gt; Maybe wireshark can help us
&gt; out.
</pre>

<p>
Oh, I'm pretty sure it's Net::SMTP at this point. Since the queued message
is OK, and manually sending the text is OK as well, that's pretty much
the only set of gears left in between.
</p>

<p>
(I'm going to try sending this email manually - launch 'bssmtp' with the
'-odq' ("only queue") option and copy the queued result to the telnet
session. We'll see what that looks like.)
</p>


<pre>-- 
* Ben Okopnik * Editor-in-Chief, Linux Gazette * <a href="http://LinuxGazette.NET">http://LinuxGazette.NET</a> *
</pre>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-problems_with_utf_8_over_smtp">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Ben Okopnik [ben at linuxgazette.net]
</p>
</b><br />
<b>Wed, 23 Jan 2008 09:53:12 -0500</b>
</p>

<p>
On Wed, Jan 23, 2008 at 09:44:27AM -0500, Benjamin Okopnik wrote:
</p>

<pre>
&gt; On Wed, Jan 23, 2008 at 02:52:49PM +0100, Ren? Pfeiffer wrote:
&gt; &gt; On Jan 23, 2008 at 0009 -0500, Ben Okopnik appeared and said:
&gt; &gt; 
&gt; &gt; &gt; I suspect that I'm just missing something in my understanding of how
&gt; &gt; &gt; SMTP works - although I've studied everything I thought was relevant.
&gt; &gt; 
&gt; &gt; Most modern MTAs are 8-bit clean. From personal experience I know that
&gt; &gt; Postfix, Sendmail, Exim and CommuniGate Pro deal with 8-bit mail bodies
&gt; &gt; just fine.
&gt; 
&gt; I'm pretty sure that 8bit is the default method, but I wanted to nail it
&gt; down just in case. I've even tried 'Bits =&gt; "binary"', with no better
&gt; result.
&gt; 
&gt; &gt; &gt; Mutt is pretty smart, so my messages (both the one I sent to the list
&gt; &gt; &gt; earlier and the test ones I've just sent on a round trip) went out with
&gt; &gt; &gt; the following relevant headers:
&gt; &gt; &gt; 
&gt; &gt; &gt; ``
&gt; &gt; &gt; MIME-Version: 1.0
&gt; &gt; &gt; Content-Type: text/plain; charset=utf-8
&gt; &gt; &gt; Content-Disposition: inline
&gt; &gt; &gt; Content-Transfer-Encoding: 8bit
&gt; &gt; &gt; ''
&gt; &gt; 
&gt; &gt; Yes, I saw that, and that's correct - apart from the content in your
&gt; &gt; email. ;-)
&gt; 
&gt; Heh.
&gt; 
&gt; &gt; &gt; &gt; Ren?????^F?.
&gt; 250 2.1.0 ben@linuxgazette.net... Sender ok
&gt; 250 2.1.5 ben@linuxgazette.net... Recipient ok
&gt; 354 Enter mail, end with "." on a line by itself
</pre>

<p>
[laugh] Whoops. I tried sending this manually, so the UTF-8 content
would make it through; knowing that '.' by itself means "End of
session", I added spaces after the period at this point, but I
guess the upstream mail server I was using didn't take me seriously.
I'll try resending the whole thing, this time "renaming" that period.
</p>


<pre>-- 
* Ben Okopnik * Editor-in-Chief, Linux Gazette * <a href="http://LinuxGazette.NET">http://LinuxGazette.NET</a> *
</pre>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-problems_with_utf_8_over_smtp">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Ben Okopnik [ben at linuxgazette.net]
</p>
</b><br />
<b>Wed, 23 Jan 2008 10:08:32 -0500</b>
</p>

<p>
On Wed, Jan 23, 2008 at 09:44:27AM -0500, Benjamin Okopnik wrote:
</p>

<pre>
&gt; On Wed, Jan 23, 2008 at 02:52:49PM +0100, Ren&lt;a9&gt; Pfeiffer wrote:
&gt; &gt; On Jan 23, 2008 at 0009 -0500, Ben Okopnik appeared and said:
&gt; &gt; 
&gt; &gt; &gt; I suspect that I'm just missing something in my understanding of how
&gt; &gt; &gt; SMTP works - although I've studied everything I thought was relevant.
&gt; &gt; 
&gt; &gt; Most modern MTAs are 8-bit clean. From personal experience I know that
&gt; &gt; Postfix, Sendmail, Exim and CommuniGate Pro deal with 8-bit mail bodies
&gt; &gt; just fine.
</pre>

<p>
[snip]
</p>

<p>
Bleh. Never mind the manual method; the interaction times out before I
can glue it all in, and the console hoses some of the text. I'll just
send it as is, and let the UTF-8 characters do their thing for now.
</p>


<pre>-- 
* Ben Okopnik * Editor-in-Chief, Linux Gazette * <a href="http://LinuxGazette.NET">http://LinuxGazette.NET</a> *
</pre>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-problems_with_utf_8_over_smtp">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Ben Okopnik [ben at linuxgazette.net]
</p>
</b><br />
<b>Wed, 23 Jan 2008 10:09:22 -0500</b>
</p>

<p>
On Wed, Jan 23, 2008 at 02:52:49PM +0100, Ren&lt;83&gt;&lt;a9&gt; Pfeiffer wrote:
</p>

<pre>
&gt; On Jan 23, 2008 at 0009 -0500, Ben Okopnik appeared and said:
&gt; 
&gt; &gt; I suspect that I'm just missing something in my understanding of how
&gt; &gt; SMTP works - although I've studied everything I thought was relevant.
&gt; 
&gt; Most modern MTAs are 8-bit clean. From personal experience I know that
&gt; Postfix, Sendmail, Exim and CommuniGate Pro deal with 8-bit mail bodies
&gt; just fine.
</pre>

<p>
I'm pretty sure that 8bit is the default method, but I wanted to nail it
down just in case. I've even tried 'Bits =&gt; "binary"', with no better
result.
 
</p>

<pre>
&gt; &gt; Mutt is pretty smart, so my messages (both the one I sent to the list
&gt; &gt; earlier and the test ones I've just sent on a round trip) went out with
&gt; &gt; the following relevant headers:
&gt; &gt; 
&gt; &gt; ``
&gt; &gt; MIME-Version: 1.0
&gt; &gt; Content-Type: text/plain; charset=utf-8
&gt; &gt; Content-Disposition: inline
&gt; &gt; Content-Transfer-Encoding: 8bit
&gt; &gt; ''
&gt; 
&gt; Yes, I saw that, and that's correct - apart from the content in your
&gt; email. ;-)
</pre>

<p>
Heh.
 
</p>

<pre>
&gt; &gt; &gt; Ren&lt;83&gt;&lt;a9&gt;.
&gt; &gt; &gt; 
&gt; &gt; &gt; P.S.: I wonder what happens to the &amp;eacute; in Ben's
&gt; &gt; &gt;       mutt/xterm/window/thing.
&gt; &gt; 
&gt; &gt; I can see it just fine right now - but it's going to break once I send
&gt; &gt; it back to the list. 
&gt; 
&gt; Why not use screenshots for the quoted text then? <img src="../gx/smile.png" alt=":-)">
</pre>

<p>
Well, yes, that would fix this specific instance of the problem - and it
would still suck to have an SMTP server that doesn't do the right thing.
I just tested a part of my SMTP chain with the following:
</p>

<p>
<pre class="code">
ben@Tyr:~$ telnet linuxgazette.net 25
Trying 64.246.26.120...
Connected to linuxgazette.net.
Escape character is '^]'.
220 genetikayos.com ESMTP Sendmail 8.12.11.20060308/8.12.11; Wed, 23 Jan 2008 06:34:44 -0800
HELO Tyr.Thor
MAIL FROM: ben@linuxgazette.net
RCPT TO: ben@linuxgazette.net
DATA
250 genetikayos.com Hello 72.sub-75-203-218.myvzw.com [75.203.218.72], pleased to meet you
250 2.1.0 ben@linuxgazette.net... Sender ok
250 2.1.5 ben@linuxgazette.net... Recipient ok
354 Enter mail, end with "." on a line by itself
test
&lt;82&gt;&lt;b5&gt;&lt;81&gt;&lt;82&gt;
.                                                    
250 2.0.0 m0NEYiOR015906 Message accepted for delivery
QUIT
221 2.0.0 genetikayos.com closing connection
Connection closed by foreign host.
</pre>
and that came through just fine, the UTF-8 content makes it across
<strong>without</strong> any special headers (the only header I actually put in was
'Subject: ...'.) This means that Net::SMTP is hosing my content while
doing the transaction - which is not great news. On the one hand, I
wrote/rewrote 'bssmtp' to be modular and easy to service; on the other
hand, I <em>really</em> don't feel like reloading my brain with all the
SMTP-relevant guck and sitting down to rewrite that part of it. [sigh]
I'm going to have to do that, it seems. Maybe I'll just do the SMTP
stuff manually instead of using a module; it's not <strong>that</strong> tough, and I
won't have someone else's code handing me this kind of surprises
anymore.
</p>


<pre>
&gt; On my end of your email I see a "Ren&lt;83&gt;&lt;a9&gt;" which looks like "Ren&lt;83&gt;&lt;a9&gt;" encoded
&gt; in UTF-8 and displayed as ISO-8859-1(5). 
</pre>

<p>
Yep - that's what I see after I've sent it on a round trip.
</p>


<pre>
&gt; Maybe wireshark can help us
&gt; out.
</pre>

<p>
Oh, I'm pretty sure it's Net::SMTP at this point. Since the queued message
is OK, and manually sending the text is OK as well, that's pretty much
the only set of gears left in between.
</p>


<pre>-- 
* Ben Okopnik * Editor-in-Chief, Linux Gazette * <a href="http://LinuxGazette.NET">http://LinuxGazette.NET</a> *
</pre>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-problems_with_utf_8_over_smtp">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Breen Mullins [breen.mullins at gmail.com]
</p>
</b><br />
<b>Wed, 23 Jan 2008 06:35:11 -0800</b>
</p>

<p>
* Ben Okopnik &lt;ben@linuxgazette.net&gt; [2008-01-23 00:09 -0500]:
</p>


<pre>
&gt;On Wed, Jan 23, 2008 at 12:45:37AM +0100, Ren&lt;a9&gt; Pfeiffer wrote:
&gt;&gt; On Jan 22, 2008 at 1712 -0500, Ben Okopnik appeared and said:
&gt;&gt; 
&gt;&gt; &gt; To the best of my troubleshooting ability so far, everything breaks
&gt;&gt; &gt; somewhere between the time that it leaves my mail client and the time
&gt;&gt; &gt; that it arrives at the LG mail server - but I've checked everything on
&gt;&gt; &gt; my end, and I'm sending it out with 'utf-8' as the charset and 8 bits
&gt;&gt; &gt; set for the SMTP transaction. I'm pretty much stuck at that point, and
&gt;&gt; &gt; have been for a while.
</pre>

<p>
Hmm. Your headers don't look good to me.
<pre>
=========
X-MIME-Autoconverted: from 8bit to quoted-printable by genetikayos.com id
	m0N59WPL030073
 Subject: Re: [TAG] Problems with UTF-8 over SMTP
 Content-Type: text/plain; charset="iso-8859-1"
 Content-Transfer-Encoding: quoted-printable
 X-SA-Exim-Version: 4.2.1 (built Mon, 27 Mar 2006 13:42:28 +0200)
======
</pre>
It definitely says that it's iso-8859-1 here. The Content-Type line
is at the end of the headers, just before the Spamassassin stuff. 
The autoconverted line is several up from there. I suspect that the
conversion is misflagging the message.
</p>

<p>
Breen
<pre>-- 
Breen Mullins
Menlo Park, California
</pre>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-problems_with_utf_8_over_smtp">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Ben Okopnik [ben at linuxgazette.net]
</p>
</b><br />
<b>Wed, 23 Jan 2008 10:28:46 -0500</b>
</p>

<p>
On Wed, Jan 23, 2008 at 06:35:11AM -0800, Breen Mullins wrote:
</p>

<pre>
&gt; * Ben Okopnik &lt;ben@linuxgazette.net&gt; [2008-01-23 00:09 -0500]:
&gt; 
&gt; &gt;On Wed, Jan 23, 2008 at 12:45:37AM +0100, Ren&lt;83&gt;&lt;a9&gt; Pfeiffer wrote:
&gt; &gt;&gt; On Jan 22, 2008 at 1712 -0500, Ben Okopnik appeared and said:
&gt; &gt;&gt; 
&gt; &gt;&gt; &gt; To the best of my troubleshooting ability so far, everything breaks
&gt; &gt;&gt; &gt; somewhere between the time that it leaves my mail client and the time
&gt; &gt;&gt; &gt; that it arrives at the LG mail server - but I've checked everything on
&gt; &gt;&gt; &gt; my end, and I'm sending it out with 'utf-8' as the charset and 8 bits
&gt; &gt;&gt; &gt; set for the SMTP transaction. I'm pretty much stuck at that point, and
&gt; &gt;&gt; &gt; have been for a while.
&gt; 
&gt; Hmm. Your headers don't look good to me.
&gt; 
&gt; =========
&gt; X-MIME-Autoconverted: from 8bit to quoted-printable by genetikayos.com id
&gt; 	m0N59WPL030073
&gt; ======
</pre>

<p>
[blink] How the hell did I miss *that*?
</p>

<p>
Wow. Thanks, Breen - that sounds like the place where it's getting
hosed, all right (I'll test that in a moment by sending it through
another server.) The question is, how do I stop it? Anybody familiar
with that aspect of SMTP?
</p>

<p>
I'm definitely sending out a character set - again, this is even before
it gets to 'bssmtp', Mutt sets it based on the content and it definitely
does the right thing when I have UTF-8 in there. Why it would get
converted is a mystery to me.
</p>


<pre>-- 
* Ben Okopnik * Editor-in-Chief, Linux Gazette * <a href="http://LinuxGazette.NET">http://LinuxGazette.NET</a> *
</pre>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-problems_with_utf_8_over_smtp">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Neil Youngman [Neil.Youngman at youngman.org.uk]
</p>
</b><br />
<b>Wed, 23 Jan 2008 15:45:52 +0000</b>
</p>

<p>
On Wednesday 23 January 2008 15:28, Ben Okopnik wrote:
</p>

<pre>
&gt; On Wed, Jan 23, 2008 at 06:35:11AM -0800, Breen Mullins wrote:
&gt; &gt; * Ben Okopnik &lt;ben@linuxgazette.net&gt; [2008-01-23 00:09 -0500]:
&gt; &gt; Hmm. Your headers don't look good to me.
&gt; &gt;
&gt; &gt; =========
&gt; &gt; X-MIME-Autoconverted: from 8bit to quoted-printable by genetikayos.com id
&gt; &gt; 	m0N59WPL030073
&gt; &gt; ======
&gt;
&gt; [blink] How the hell did I miss *that*?
&gt;
&gt; Wow. Thanks, Breen - that sounds like the place where it's getting
&gt; hosed, all right (I'll test that in a moment by sending it through
&gt; another server.) The question is, how do I stop it? Anybody familiar
&gt; with that aspect of SMTP?
&gt;
&gt; I'm definitely sending out a character set - again, this is even before
&gt; it gets to 'bssmtp', Mutt sets it based on the content and it definitely
&gt; does the right thing when I have UTF-8 in there. Why it would get
&gt; converted is a mystery to me.
</pre>

<p>
That sounds to me very much like a server receiving it as 8 bit and deciding 
that the host it is sending to doesn't accept 8 bit ESMTP. The correct thing 
to do in that circumstance is to encode it, so it can be accepted by a 7 bit 
only server. 
</p>

<p>
RFC 1652 says
</p>

<pre>
"If a server SMTP does not support the 8-bit MIME transport extension
   (either by not responding with code 250 to the EHLO command, or by
   not including the EHLO keyword value 8BITMIME in its response), then
   the client SMTP must not, under any circumstances, attempt to
   transfer a content which contains characters outside the US-ASCII
   octet range (hex 00-7F).
  
   A client SMTP has two options in this case: first, it may implement a
   gateway transformation to convert the message into valid 7bit MIME,
   or second, or may treat this as a permanent error and handle it in
  
   the usual manner for delivery failures.  The specifics of the
   transformation from 8bit MIME to 7bit MIME are not described by this
   RFC; the conversion is nevertheless constrained in the following
   ways:
 
      (1)  it must cause no loss of information; MIME transport
           encodings must be employed as needed to insure this is
           the case, and
 
      (2)  the resulting message must be valid 7bit MIME."
</pre>
I assume that the headers should be altered to correctly reflect the encoding, 
as otherwise it wouldn't be "valid 7bit MIME".
</p>

<p>
Neil
</p>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-problems_with_utf_8_over_smtp">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Ben Okopnik [ben at linuxgazette.net]
</p>
</b><br />
<b>Wed, 23 Jan 2008 11:15:06 -0500</b>
</p>

<p>
On Wed, Jan 23, 2008 at 03:45:52PM +0000, Neil Youngman wrote:
</p>

<pre>
&gt; On Wednesday 23 January 2008 15:28, Ben Okopnik wrote:
&gt; &gt; On Wed, Jan 23, 2008 at 06:35:11AM -0800, Breen Mullins wrote:
&gt; &gt; &gt; * Ben Okopnik &lt;ben@linuxgazette.net&gt; [2008-01-23 00:09 -0500]:
&gt; &gt; &gt; Hmm. Your headers don't look good to me.
&gt; &gt; &gt;
&gt; &gt; &gt; =========
&gt; &gt; &gt; X-MIME-Autoconverted: from 8bit to quoted-printable by genetikayos.com id
&gt; &gt; &gt; 	m0N59WPL030073
&gt; &gt; &gt; ======
&gt; &gt;
&gt; &gt; [blink] How the hell did I miss *that*?
&gt; &gt;
&gt; &gt; Wow. Thanks, Breen - that sounds like the place where it's getting
&gt; &gt; hosed, all right (I'll test that in a moment by sending it through
&gt; &gt; another server.) The question is, how do I stop it? Anybody familiar
&gt; &gt; with that aspect of SMTP?
&gt; &gt;
&gt; &gt; I'm definitely sending out a character set - again, this is even before
&gt; &gt; it gets to 'bssmtp', Mutt sets it based on the content and it definitely
&gt; &gt; does the right thing when I have UTF-8 in there. Why it would get
&gt; &gt; converted is a mystery to me.
&gt; 
&gt; That sounds to me very much like a server receiving it as 8 bit and deciding 
&gt; that the host it is sending to doesn't accept 8 bit ESMTP. The correct thing 
&gt; to do in that circumstance is to encode it, so it can be accepted by a 7 bit 
&gt; only server. 
&gt; 
&gt; RFC 1652 says
&gt; 
&gt; "If a server SMTP does not support the 8-bit MIME transport extension
&gt;    (either by not responding with code 250 to the EHLO command, or by
&gt;    not including the EHLO keyword value 8BITMIME in its response)
</pre>

<p>
Hmm. If I'm sending a message to myself, then the receiving host is
'linuxgazette.net'.
</p>

<pre>
ben@Tyr:~$ telnet linuxgazette.net 25
Trying 64.246.26.120...
Connected to linuxgazette.net.
Escape character is '^]'.
EHLO Tyr.Thor
250-genetikayos.com Hello 72.sub-75-203-218.myvzw.com [75.203.218.72], pleased to meet you
250-ENHANCEDSTATUSCODES
250-PIPELINING
250-8BITMIME
250-SIZE
250-DSN
250-ETRN
250-AUTH GSSAPI
250-STARTTLS
250-DELIVERBY
250 HELP
</pre>
Doesn't seem like that would trigger it off. In fact, I don't know that
anybody out there is still doing 7bit-only stuff.
</p>


<pre>
&gt;    , then
&gt;    the client SMTP must not, under any circumstances, attempt to
&gt;    transfer a content which contains characters outside the US-ASCII
&gt;    octet range (hex 00-7F).
&gt; 
&gt;    A client SMTP has two options in this case: first, it may implement a
&gt;    gateway transformation to convert the message into valid 7bit MIME,
&gt;    or second, or may treat this as a permanent error and handle it in
&gt; 
&gt;    the usual manner for delivery failures.  The specifics of the
&gt;    transformation from 8bit MIME to 7bit MIME are not described by this
&gt;    RFC; the conversion is nevertheless constrained in the following
&gt;    ways:
&gt; 
&gt;       (1)  it must cause no loss of information; MIME transport
&gt;            encodings must be employed as needed to insure this is
&gt;            the case, and
&gt; 
&gt;       (2)  the resulting message must be valid 7bit MIME."
&gt; 
&gt; I assume that the headers should be altered to correctly reflect the encoding, 
&gt; as otherwise it wouldn't be "valid 7bit MIME".
</pre>

<p>
Right... I don't think that "quoted-printable" is exactly equivalent to
"7bit MIME" (although it would indeed pass through that filter.) Even
more to the point, the headers on this email still say
"Content-Transfer-Encoding: 8bit".
</p>


<pre>-- 
* Ben Okopnik * Editor-in-Chief, Linux Gazette * <a href="http://LinuxGazette.NET">http://LinuxGazette.NET</a> *
</pre>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-problems_with_utf_8_over_smtp">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Ben Okopnik [ben at linuxgazette.net]
</p>
</b><br />
<b>Wed, 23 Jan 2008 11:15:06 -0500</b>
</p>

<p>
On Wed, Jan 23, 2008 at 03:45:52PM +0000, Neil Youngman wrote:
</p>

<pre>
&gt; On Wednesday 23 January 2008 15:28, Ben Okopnik wrote:
&gt; &gt; On Wed, Jan 23, 2008 at 06:35:11AM -0800, Breen Mullins wrote:
&gt; &gt; &gt; * Ben Okopnik &lt;ben@linuxgazette.net&gt; [2008-01-23 00:09 -0500]:
&gt; &gt; &gt; Hmm. Your headers don't look good to me.
&gt; &gt; &gt;
&gt; &gt; &gt; =========
&gt; &gt; &gt; X-MIME-Autoconverted: from 8bit to quoted-printable by genetikayos.com id
&gt; &gt; &gt; 	m0N59WPL030073
&gt; &gt; &gt; ======
&gt; &gt;
&gt; &gt; [blink] How the hell did I miss *that*?
&gt; &gt;
&gt; &gt; Wow. Thanks, Breen - that sounds like the place where it's getting
&gt; &gt; hosed, all right (I'll test that in a moment by sending it through
&gt; &gt; another server.) The question is, how do I stop it? Anybody familiar
&gt; &gt; with that aspect of SMTP?
&gt; &gt;
&gt; &gt; I'm definitely sending out a character set - again, this is even before
&gt; &gt; it gets to 'bssmtp', Mutt sets it based on the content and it definitely
&gt; &gt; does the right thing when I have UTF-8 in there. Why it would get
&gt; &gt; converted is a mystery to me.
&gt; 
&gt; That sounds to me very much like a server receiving it as 8 bit and deciding 
&gt; that the host it is sending to doesn't accept 8 bit ESMTP. The correct thing 
&gt; to do in that circumstance is to encode it, so it can be accepted by a 7 bit 
&gt; only server. 
&gt; 
&gt; RFC 1652 says
&gt; 
&gt; "If a server SMTP does not support the 8-bit MIME transport extension
&gt;    (either by not responding with code 250 to the EHLO command, or by
&gt;    not including the EHLO keyword value 8BITMIME in its response)
</pre>

<p>
Hmm. If I'm sending a message to myself, then the receiving host is
'linuxgazette.net'.
</p>

<pre>
ben@Tyr:~$ telnet linuxgazette.net 25
Trying 64.246.26.120...
Connected to linuxgazette.net.
Escape character is '^]'.
EHLO Tyr.Thor
250-genetikayos.com Hello 72.sub-75-203-218.myvzw.com [75.203.218.72], pleased to meet you
250-ENHANCEDSTATUSCODES
250-PIPELINING
250-8BITMIME
250-SIZE
250-DSN
250-ETRN
250-AUTH GSSAPI
250-STARTTLS
250-DELIVERBY
250 HELP
</pre>
Doesn't seem like that would trigger it off. In fact, I don't know that
anybody out there is still doing 7bit-only stuff.
</p>


<pre>
&gt;    , then
&gt;    the client SMTP must not, under any circumstances, attempt to
&gt;    transfer a content which contains characters outside the US-ASCII
&gt;    octet range (hex 00-7F).
&gt; 
&gt;    A client SMTP has two options in this case: first, it may implement a
&gt;    gateway transformation to convert the message into valid 7bit MIME,
&gt;    or second, or may treat this as a permanent error and handle it in
&gt; 
&gt;    the usual manner for delivery failures.  The specifics of the
&gt;    transformation from 8bit MIME to 7bit MIME are not described by this
&gt;    RFC; the conversion is nevertheless constrained in the following
&gt;    ways:
&gt; 
&gt;       (1)  it must cause no loss of information; MIME transport
&gt;            encodings must be employed as needed to insure this is
&gt;            the case, and
&gt; 
&gt;       (2)  the resulting message must be valid 7bit MIME."
&gt; 
&gt; I assume that the headers should be altered to correctly reflect the encoding, 
&gt; as otherwise it wouldn't be "valid 7bit MIME".
</pre>

<p>
Right... I don't think that "quoted-printable" is exactly equivalent to
"7bit MIME" (although it would indeed pass through that filter.) Even
more to the point, the headers on this email still say
"Content-Transfer-Encoding: 8bit".
</p>


<pre>-- 
* Ben Okopnik * Editor-in-Chief, Linux Gazette * <a href="http://LinuxGazette.NET">http://LinuxGazette.NET</a> *
</pre>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-problems_with_utf_8_over_smtp">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Neil Youngman [Neil.Youngman at youngman.org.uk]
</p>
</b><br />
<b>Wed, 23 Jan 2008 16:27:22 +0000</b>
</p>

<p>
On Wednesday 23 January 2008 16:15, Ben Okopnik wrote:
</p>

<pre>
&gt; Doesn't seem like that would trigger it off. In fact, I don't know that
&gt; anybody out there is still doing 7bit-only stuff.
</pre>

<p>
I don't have the headers to look at, so I can only guess. Is the last received 
header "genetikayos.com"? 
</p>


<pre>
&gt; Right... I don't think that "quoted-printable" is exactly equivalent to
&gt; "7bit MIME" (although it would indeed pass through that filter.) Even
&gt; more to the point, the headers on this email still say
&gt; "Content-Transfer-Encoding: 8bit".
</pre>

<p>
I would say that "quoted-printable" is a subset of 7bit mime and in my (very 
limited) experience, it seems to be the default choice. It does sound as 
though the headers haven't been correctly updated.
</p>

<p>
Neil
</p>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-problems_with_utf_8_over_smtp">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Ben Okopnik [ben at linuxgazette.net]
</p>
</b><br />
<b>Wed, 23 Jan 2008 14:17:44 -0500</b>
</p>

<p>
On Wed, Jan 23, 2008 at 04:27:22PM +0000, Neil Youngman wrote:
</p>

<pre>
&gt; On Wednesday 23 January 2008 16:15, Ben Okopnik wrote:
&gt; &gt; Doesn't seem like that would trigger it off. In fact, I don't know that
&gt; &gt; anybody out there is still doing 7bit-only stuff.
&gt; 
&gt; I don't have the headers to look at, so I can only guess. Is the last received 
&gt; header "genetikayos.com"? 
</pre>

<p>
Here's a header from a successful one (i.e., the one I sent via a manual
SMTP session):
</p>

<pre>
 From ben  Wed Jan 23 09:37:32 2008
Return-Path: ben@linuxgazette.net
Received: from genetikayos.com [64.246.26.120]
        by Tyr with POP3 (fetchmail-6.3.2)
        for &lt;ben@localhost&gt; (single-drop); Wed, 23 Jan 2008 09:37:32 -0500 (EST)
Received: from Tyr.Thor (72.sub-75-203-218.myvzw.com [75.203.218.72])
        by genetikayos.com (8.12.11.20060308/8.12.11) with SMTP id m0NEYiOR015906
        for ben@linuxgazette.net; Wed, 23 Jan 2008 06:34:51 -0800
<pre>
Date: Wed, 23 Jan 2008 06:34:44 -0800
From: Ben Okopnik &lt;ben@linuxgazette.net&gt;
</pre>Message-Id: &lt;200801231434.m0NEYiOR015906@genetikayos.com&gt;
X-Spam-Status: No, score=-0.7 required=5.0 tests=BAYES_00,MISSING_SUBJECT,
        RCVD_IN_PBL,TO_CC_NONE autolearn=no version=3.1.8
X-Spam-Checker-Version: SpamAssassin 3.1.8 (2007-02-13) on genetikayos.com
Status: RO
Content-Length: 14
Lines: 2
</pre>
And here's one from an email with the same content (which came through
broken), sent via Mutt and bssmtp:
</p>

<pre>
 From ben  Wed Jan 23 14:08:26 2008
Return-Path: ben@linuxgazette.net
Received: from localhost [127.0.0.1]
        by Tyr with POP3 (fetchmail-6.3.2)
        for &lt;ben@localhost&gt; (single-drop); Wed, 23 Jan 2008 14:08:26 -0500 (EST)
Received: from localhost.localdomain (genetikayos.com [64.246.26.120])
        by genetikayos.com (8.12.11.20060308/8.12.11) with ESMTP id m0NJ7G4Q026459
        for &lt;ben@linuxgazette.net&gt;; Wed, 23 Jan 2008 11:07:28 -0800
Received: from localhost ([127.0.0.1]) by Fenrir (bssmtp 0.3) with SMTP id 70419937;
        Wed, 23 Jan 2008 14:07:40 -0500
<pre>
From: Ben Okopnik &lt;ben@linuxgazette.net&gt;
Message-ID: &lt;20080123190740.GC8843@linuxgazette.net&gt;
Date: Wed, 23 Jan 2008 14:07:40 -0500
To: Ben Okopnik &lt;ben@linuxgazette.net&gt;
</pre>MIME-Version: 1.0
Content-Type: text/plain; charset=utf-8
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
<pre>
User-Agent: Mutt/1.5.11
</pre>X-Spam-Status: No, score=-1.6 required=5.0 tests=AWL,BAYES_00,MISSING_SUBJECT
        autolearn=no version=3.1.8
X-Spam-Checker-Version: SpamAssassin 3.1.8 (2007-02-13) on genetikayos.com
</pre>
I note that there's no conversion warning in it - and yet, it's broken.
 
</p>

<pre>
&gt; &gt; Right... I don't think that "quoted-printable" is exactly equivalent to
&gt; &gt; "7bit MIME" (although it would indeed pass through that filter.) Even
&gt; &gt; more to the point, the headers on this email still say
&gt; &gt; "Content-Transfer-Encoding: 8bit".
&gt; 
&gt; I would say that "quoted-printable" is a subset of 7bit mime and in my (very 
&gt; limited) experience, it seems to be the default choice. 
</pre>

<p>
That sounds reasonable. Perhaps converting anything that's not 100%
clear to 7bit is some servers' default policy.
</p>


<pre>
&gt; It does sound as 
&gt; though the headers haven't been correctly updated.
</pre>

<p>
Again, possible - but the UTF-8 does come through in a manual session,
where I've used <strong>no</strong> headers from the sender side beyond the 'From:'
(the 'RCPT TO:' just gets used to determine where to send it, and
doesn't get added to the headers.)
</p>


<pre>-- 
* Ben Okopnik * Editor-in-Chief, Linux Gazette * <a href="http://LinuxGazette.NET">http://LinuxGazette.NET</a> *
</pre>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-problems_with_utf_8_over_smtp">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Neil Youngman [Neil.Youngman at youngman.org.uk]
</p>
</b><br />
<b>Wed, 23 Jan 2008 20:06:08 +0000</b>
</p>

<p>
On Wednesday 23 January 2008 19:17, Ben Okopnik wrote:
</p>

<pre>
&gt; On Wed, Jan 23, 2008 at 04:27:22PM +0000, Neil Youngman wrote:
&gt; &gt; On Wednesday 23 January 2008 16:15, Ben Okopnik wrote:
&gt; &gt; &gt; Doesn't seem like that would trigger it off. In fact, I don't know that
&gt; &gt; &gt; anybody out there is still doing 7bit-only stuff.
&gt; &gt;
&gt; &gt; I don't have the headers to look at, so I can only guess. Is the last
&gt; &gt; received header "genetikayos.com"?
&gt;
&gt; Here's a header from a successful one (i.e., the one I sent via a manual
&gt; SMTP session):
&gt;
&gt; ``
&gt; From ben  Wed Jan 23 09:37:32 2008
&gt; Return-Path: ben@linuxgazette.net
&gt; Received: from genetikayos.com [64.246.26.120]
&gt;         by Tyr with POP3 (fetchmail-6.3.2)
&gt;         for &lt;ben@localhost&gt; (single-drop); Wed, 23 Jan 2008 09:37:32 -0500
&gt; (EST) Received: from Tyr.Thor (72.sub-75-203-218.myvzw.com [75.203.218.72])
&gt; by genetikayos.com (8.12.11.20060308/8.12.11) with SMTP id m0NEYiOR015906
&gt; for ben@linuxgazette.net; Wed, 23 Jan 2008 06:34:51 -0800
&gt; Date: Wed, 23 Jan 2008 06:34:44 -0800
&gt; From: Ben Okopnik &lt;ben@linuxgazette.net&gt;
&gt; Message-Id: &lt;200801231434.m0NEYiOR015906@genetikayos.com&gt;
&gt; X-Spam-Status: No, score=-0.7 required=5.0 tests=BAYES_00,MISSING_SUBJECT,
&gt;         RCVD_IN_PBL,TO_CC_NONE autolearn=no version=3.1.8
&gt; X-Spam-Checker-Version: SpamAssassin 3.1.8 (2007-02-13) on genetikayos.com
&gt; Status: RO
&gt; Content-Length: 14
&gt; Lines: 2
</pre>

<p>
No MIME headers, should be treated as plain US-ASCII for most purposes IIRC. 
Probably most 8 bit clean MTAs wouldn't check that it's seven bit clean, 
especially if they're handling ESMTP.
</p>


<pre>
&gt; And here's one from an email with the same content (which came through
&gt; broken), sent via Mutt and bssmtp:
&gt;
&gt; ``
&gt; From ben  Wed Jan 23 14:08:26 2008
&gt; Return-Path: ben@linuxgazette.net
&gt; Received: from localhost [127.0.0.1]
&gt;         by Tyr with POP3 (fetchmail-6.3.2)
&gt;         for &lt;ben@localhost&gt; (single-drop); Wed, 23 Jan 2008 14:08:26 -0500
&gt; (EST) Received: from localhost.localdomain (genetikayos.com
&gt; [64.246.26.120]) by genetikayos.com (8.12.11.20060308/8.12.11) with ESMTP
&gt; id m0NJ7G4Q026459 for &lt;ben@linuxgazette.net&gt;; Wed, 23 Jan 2008 11:07:28
&gt; -0800 Received: from localhost ([127.0.0.1]) by Fenrir (bssmtp 0.3) with
&gt; SMTP id 70419937; Wed, 23 Jan 2008 14:07:40 -0500
&gt; From: Ben Okopnik &lt;ben@linuxgazette.net&gt;
&gt; Message-ID: &lt;20080123190740.GC8843@linuxgazette.net&gt;
&gt; Date: Wed, 23 Jan 2008 14:07:40 -0500
&gt; To: Ben Okopnik &lt;ben@linuxgazette.net&gt;
&gt; MIME-Version: 1.0
&gt; Content-Type: text/plain; charset=utf-8
&gt; Content-Disposition: inline
&gt; Content-Transfer-Encoding: 8bit
&gt; User-Agent: Mutt/1.5.11
&gt; X-Spam-Status: No, score=-1.6 required=5.0
&gt; tests=AWL,BAYES_00,MISSING_SUBJECT autolearn=no version=3.1.8
&gt; X-Spam-Checker-Version: SpamAssassin 3.1.8 (2007-02-13) on genetikayos.com
&gt; ''
&gt;
&gt; I note that there's no conversion warning in it - and yet, it's broken.
</pre>

<p>
That's got all the proper MIME headers. While I wouldn't normally expect MTAs 
to rely on the MIME headers, if they've got to update the MIME headers when 
they convert, maybe they do require MIME headers to be present before doing 
the conversion?
</p>

<p>
I'm afraid the headers don't suggest much to me. 
</p>

<p>
The 2 big differences are the MIME headers and the use of mutt/bssmtp. I don't 
have much info on bssmtp. I wonder if it offers 8bitmime? If not, maybe Mutt 
does the 8bit to 7bit conversion when handing of bssmtp? I think that's 
clutching at straws, but you never know.
</p>

<p>
Neil
</p>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-problems_with_utf_8_over_smtp">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Neil Youngman [Neil.Youngman at youngman.org.uk]
</p>
</b><br />
<b>Wed, 23 Jan 2008 20:19:59 +0000</b>
</p>

<p>
On Wednesday 23 January 2008 20:06, Neil Youngman wrote:
</p>

<pre>
&gt; On Wednesday 23 January 2008 19:17, Ben Okopnik wrote:
&gt; &gt; From ben  Wed Jan 23 14:08:26 2008
&gt; &gt; Return-Path: ben@linuxgazette.net
&gt; &gt; Received: from localhost [127.0.0.1]
&gt; &gt;         by Tyr with POP3 (fetchmail-6.3.2)
&gt; &gt;         for &lt;ben@localhost&gt; (single-drop); Wed, 23 Jan 2008 14:08:26
&gt; &gt; -0500 (EST) Received: from localhost.localdomain (genetikayos.com
&gt; &gt; [64.246.26.120]) by genetikayos.com (8.12.11.20060308/8.12.11) with ESMTP
&gt; &gt; id m0NJ7G4Q026459 for &lt;ben@linuxgazette.net&gt;; Wed, 23 Jan 2008 11:07:28
&gt; &gt; -0800 Received: from localhost ([127.0.0.1]) by Fenrir (bssmtp 0.3) with
&gt; &gt; SMTP id 70419937; Wed, 23 Jan 2008 14:07:40 -0500
&gt; &gt; From: Ben Okopnik &lt;ben@linuxgazette.net&gt;
&gt; &gt; Message-ID: &lt;20080123190740.GC8843@linuxgazette.net&gt;
&gt; &gt; Date: Wed, 23 Jan 2008 14:07:40 -0500
&gt; &gt; To: Ben Okopnik &lt;ben@linuxgazette.net&gt;
&gt; &gt; MIME-Version: 1.0
&gt; &gt; Content-Type: text/plain; charset=utf-8
&gt; &gt; Content-Disposition: inline
&gt; &gt; Content-Transfer-Encoding: 8bit
&gt; &gt; User-Agent: Mutt/1.5.11
&gt; &gt; X-Spam-Status: No, score=-1.6 required=5.0
&gt; &gt; tests=AWL,BAYES_00,MISSING_SUBJECT autolearn=no version=3.1.8
&gt; &gt; X-Spam-Checker-Version: SpamAssassin 3.1.8 (2007-02-13) on
&gt; &gt; genetikayos.com ''
&gt; &gt;
&gt; &gt; I note that there's no conversion warning in it - and yet, it's broken.
</pre>

<p>
I missed that there's no mention of "quoted-printable" at all, which suggests 
that conversion to quoted-printable is a red herring, absent any other 
indication of quoted-printable encoding.
</p>

<p>
Neil
</p>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-problems_with_utf_8_over_smtp">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Ren&eacute; Pfeiffer [lynx at luchs.at]
</p>
</b><br />
<b>Wed, 23 Jan 2008 21:32:22 +0100</b>
</p>

<p>
On Jan 23, 2008 at 2019 +0000, Neil Youngman appeared and said:
</p>

<pre>
&gt; On Wednesday 23 January 2008 20:06, Neil Youngman wrote:
&gt; &gt; On Wednesday 23 January 2008 19:17, Ben Okopnik wrote:
&gt; &gt; &gt; From ben  Wed Jan 23 14:08:26 2008
&gt; &gt; &gt; Return-Path: ben@linuxgazette.net
&gt; &gt; &gt; Received: from localhost [127.0.0.1]
&gt; &gt; &gt;         by Tyr with POP3 (fetchmail-6.3.2)
&gt; &gt; &gt;         for &lt;ben@localhost&gt; (single-drop); Wed, 23 Jan 2008 14:08:26
&gt; &gt; &gt; -0500 (EST) Received: from localhost.localdomain (genetikayos.com
&gt; &gt; &gt; [64.246.26.120]) by genetikayos.com (8.12.11.20060308/8.12.11) with ESMTP
&gt; &gt; &gt; id m0NJ7G4Q026459 for &lt;ben@linuxgazette.net&gt;; Wed, 23 Jan 2008 11:07:28
&gt; &gt; &gt; -0800 Received: from localhost ([127.0.0.1]) by Fenrir (bssmtp 0.3) with
&gt; &gt; &gt; SMTP id 70419937; Wed, 23 Jan 2008 14:07:40 -0500
&gt; &gt; &gt; From: Ben Okopnik &lt;ben@linuxgazette.net&gt;
&gt; &gt; &gt; Message-ID: &lt;20080123190740.GC8843@linuxgazette.net&gt;
&gt; &gt; &gt; Date: Wed, 23 Jan 2008 14:07:40 -0500
&gt; &gt; &gt; To: Ben Okopnik &lt;ben@linuxgazette.net&gt;
&gt; &gt; &gt; MIME-Version: 1.0
&gt; &gt; &gt; Content-Type: text/plain; charset=3Dutf-8
&gt; &gt; &gt; Content-Disposition: inline
&gt; &gt; &gt; Content-Transfer-Encoding: 8bit
&gt; &gt; &gt; User-Agent: Mutt/1.5.11
&gt; &gt; &gt; X-Spam-Status: No, score=3D-1.6 required=3D5.0
&gt; &gt; &gt; tests=3DAWL,BAYES_00,MISSING_SUBJECT autolearn=3Dno version=3D3.1.8
&gt; &gt; &gt; X-Spam-Checker-Version: SpamAssassin 3.1.8 (2007-02-13) on
&gt; &gt; &gt; genetikayos.com ''
&gt; &gt; &gt;
&gt; &gt; &gt; I note that there's no conversion warning in it - and yet, it's broken.
&gt;
&gt; I missed that there's no mention of "quoted-printable" at all, which suggests
&gt; that conversion to quoted-printable is a red herring, absent any other
&gt; indication of quoted-printable encoding.
</pre>

<p>
In this case the only thing I can think of is a filter plugin, be it
anti-virus, anti-spam or even anti-UTF-8. <img src="../gx/smile.png" alt=":)">
</p>

<p>
Best,
Ren&eacute;.
</p>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-problems_with_utf_8_over_smtp">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Ren&eacute; Pfeiffer [lynx at luchs.at]
</p>
</b><br />
<b>Wed, 23 Jan 2008 16:56:20 +0100</b>
</p>

<p>
On Jan 23, 2008 at 1028 -0500, Ben Okopnik appeared and said:
</p>

<pre>
&gt; On Wed, Jan 23, 2008 at 06:35:11AM -0800, Breen Mullins wrote:
&gt; &gt; * Ben Okopnik &lt;ben@linuxgazette.net&gt; [2008-01-23 00:09 -0500]:
&gt; &gt;
&gt; &gt; &gt;On Wed, Jan 23, 2008 at 12:45:37AM +0100, Ren=C3=83=C2=A9 Pfeiffer wrote:
&gt; &gt; &gt;&gt; On Jan 22, 2008 at 1712 -0500, Ben Okopnik appeared and said:
&gt; &gt; &gt;&gt;
&gt; &gt; &gt;&gt; &gt; To the best of my troubleshooting ability so far, everything breaks
&gt; &gt; &gt;&gt; &gt; somewhere between the time that it leaves my mail client and the time
&gt; &gt; &gt;&gt; &gt; that it arrives at the LG mail server - but I've checked everything on
&gt; &gt; &gt;&gt; &gt; my end, and I'm sending it out with 'utf-8' as the charset and 8 bits
&gt; &gt; &gt;&gt; &gt; set for the SMTP transaction. I'm pretty much stuck at that point, and
&gt; &gt; &gt;&gt; &gt; have been for a while.
&gt; &gt;
&gt; &gt; Hmm. Your headers don't look good to me.
&gt; &gt;
&gt; &gt; =3D=3D=3D=3D=3D=3D=3D=3D=3D
&gt; &gt; X-MIME-Autoconverted: from 8bit to quoted-printable by genetikayos.com id
&gt; &gt; 	m0N59WPL030073
&gt; &gt; =3D=3D=3D=3D=3D=3D
&gt;
&gt; [blink] How the hell did I miss *that*?
</pre>

<p>
I missed it as well.
</p>


<pre>
&gt; Wow. Thanks, Breen - that sounds like the place where it's getting
&gt; hosed, all right (I'll test that in a moment by sending it through
&gt; another server.) The question is, how do I stop it? Anybody familiar
&gt; with that aspect of SMTP?
</pre>

<p>
Yes, Sendmail does a conversion when it's not configured to pass 8-bit
data. This can be changed in the mailer flags; AFAIK one has to use the
smtp8 mailer for SMTP.
</p>

<p>
Now I know why I don't see this problem. Postfix passes 8-bit data and
PGP/MIME uses quoted-printable encoding to be on the safe side.
</p>


<pre>
&gt; I'm definitely sending out a character set - again, this is even before
&gt; it gets to 'bssmtp', Mutt sets it based on the content and it definitely
&gt; does the right thing when I have UTF-8 in there. Why it would get
&gt; converted is a mystery to me.
</pre>

<p>
I think it's due to the MTA doing the conversion mentioned above.
</p>

<p>
Best,
Ren&eacute;.
</p>


<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-problems_with_utf_8_over_smtp">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Ben Okopnik [ben at linuxgazette.net]
</p>
</b><br />
<b>Wed, 23 Jan 2008 11:10:41 -0500</b>
</p>

<p>
On Wed, Jan 23, 2008 at 04:56:20PM +0100, Ren&lt;a9&gt; Pfeiffer wrote:
</p>

<pre>
&gt; On Jan 23, 2008 at 1028 -0500, Ben Okopnik appeared and said:
&gt; 
&gt; &gt; Wow. Thanks, Breen - that sounds like the place where it's getting
&gt; &gt; hosed, all right (I'll test that in a moment by sending it through
&gt; &gt; another server.) The question is, how do I stop it? Anybody familiar
&gt; &gt; with that aspect of SMTP?
&gt; 
&gt; Yes, Sendmail does a conversion when it's not configured to pass 8-bit
&gt; data. This can be changed in the mailer flags; AFAIK one has to use the
&gt; smtp8 mailer for SMTP. 
</pre>

<p>
In theory, that's what the 'Bits =&gt; 8' was supposed to do - but somehow,
it's not having any effect.
 
</p>

<pre>
&gt; Now I know why I don't see this problem. Postfix passes 8-bit data and
&gt; PGP/MIME uses quoted-printable encoding to be on the safe side.
</pre>

<p>
I've been coming around to thinking that I should wrap up my messages as
MIME attachments rather than inlining them. Again, a bit of a pain, but
better than this.
 
</p>

<pre>
&gt; &gt; I'm definitely sending out a character set - again, this is even before
&gt; &gt; it gets to 'bssmtp', Mutt sets it based on the content and it definitely
&gt; &gt; does the right thing when I have UTF-8 in there. Why it would get
&gt; &gt; converted is a mystery to me.
&gt; 
&gt; I think it's due to the MTA doing the conversion mentioned above.
</pre>

<p>
I'll poke at it in the next day or two and see how it goes.
</p>


<pre>-- 
* Ben Okopnik * Editor-in-Chief, Linux Gazette * <a href="http://LinuxGazette.NET">http://LinuxGazette.NET</a> *
</pre>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-problems_with_utf_8_over_smtp">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Breen Mullins [breen.mullins at gmail.com]
</p>
</b><br />
<b>Wed, 23 Jan 2008 21:19:13 -0800</b>
</p>

<p>
* Ben Okopnik &lt;ben@linuxgazette.net&gt; [2008-01-23 10:28 -0500]:
</p>


<pre>
&gt;
&gt;[blink] How the hell did I miss *that*?
&gt;
&gt;Wow. Thanks, Breen - that sounds like the place where it's getting
&gt;hosed, all right (I'll test that in a moment by sending it through
&gt;another server.) The question is, how do I stop it? Anybody familiar
&gt;with that aspect of SMTP?
</pre>

<p>
It's not SMTP. I think Ren?'s right - it's a filter of some sort. 
</p>

<p>
Note that after it's changed your Content-Type declaration, it puts
the new one right after your subject line and just before the
spamassassin line - which makes me think that the filter on that
server is getting called just before SA. 
</p>

<p>
Looks like it's just 'smart' enough to get triggered only part of the 
time.
</p>

<p>
(FWIW, your message <em>was</em> in Quoted-Printable by the time I got it 
from the list.)
</p>

<p>
Breen
<pre>-- 
Breen Mullins
Menlo Park, California
</pre>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-problems_with_utf_8_over_smtp">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Ben Okopnik [ben at linuxgazette.net]
</p>
</b><br />
<b>Thu, 24 Jan 2008 10:53:54 -0500</b>
</p>

<p>
On Wed, Jan 23, 2008 at 09:19:13PM -0800, Breen Mullins wrote:
</p>

<pre>
&gt; * Ben Okopnik &lt;ben@linuxgazette.net&gt; [2008-01-23 10:28 -0500]:
&gt; 
&gt; &gt;
&gt; &gt;[blink] How the hell did I miss *that*?
&gt; &gt;
&gt; &gt;Wow. Thanks, Breen - that sounds like the place where it's getting
&gt; &gt;hosed, all right (I'll test that in a moment by sending it through
&gt; &gt;another server.) The question is, how do I stop it? Anybody familiar
&gt; &gt;with that aspect of SMTP?
&gt; 
&gt; It's not SMTP. I think Ren&lt;a9&gt;'s right - it's a filter of some sort. 
</pre>

<p>
Actually, it turns out that the Net::SMTP module on my end is screwing
it up. I was pretty sure that was it by this point - since doing a
manual SMTP transaction with the LG mail server made the UTF-8 content
come through without any problems - and then I found a smoking gun.
</p>

<p>
Ren&lt;a9&gt;'s idea of using 'wireshark' got me started on troubleshooting the
actual transaction nitty-gritty; I used 'tcpdump'... which, of course,
showed nothing since I'm using SSH to port-forward LG:25 to my
localhost:2025 (duh!) So then, I set 'Debug =&gt; 1' in Net::SMTP, and saw
the following:
</p>

<p>
<pre class="code">
Net::SMTP&gt;&gt;&gt; Net::SMTP(2.30)
Net::SMTP&gt;&gt;&gt;   Net::Cmd(2.27)
Net::SMTP&gt;&gt;&gt;     Exporter(5.58)
Net::SMTP&gt;&gt;&gt;   IO::Socket::INET(1.31)
Net::SMTP&gt;&gt;&gt;     IO::Socket(1.30)
Net::SMTP&gt;&gt;&gt;       IO::Handle(1.27)
Net::SMTP=GLOB(0x1150240)&lt;&lt;&lt; 220 genetikayos.com ESMTP Sendmail 8.12.11.20060308/8.12.11; Thu, 24 Jan 2008 07:38:36 -0800
Net::SMTP=GLOB(0x1150240)&gt;&gt;&gt; EHLO localhost.localdomain
Net::SMTP=GLOB(0x1150240)&lt;&lt;&lt; 250-genetikayos.com Hello genetikayos.com [64.246.26.120], pleased to meet you
Net::SMTP=GLOB(0x1150240)&lt;&lt;&lt; 250-ENHANCEDSTATUSCODES
Net::SMTP=GLOB(0x1150240)&lt;&lt;&lt; 250-PIPELINING
Net::SMTP=GLOB(0x1150240)&lt;&lt;&lt; 250-8BITMIME
Net::SMTP=GLOB(0x1150240)&lt;&lt;&lt; 250-SIZE
Net::SMTP=GLOB(0x1150240)&lt;&lt;&lt; 250-DSN
Net::SMTP=GLOB(0x1150240)&lt;&lt;&lt; 250-ETRN
Net::SMTP=GLOB(0x1150240)&lt;&lt;&lt; 250-AUTH GSSAPI
Net::SMTP=GLOB(0x1150240)&lt;&lt;&lt; 250-STARTTLS
Net::SMTP=GLOB(0x1150240)&lt;&lt;&lt; 250-DELIVERBY
Net::SMTP=GLOB(0x1150240)&lt;&lt;&lt; 250 HELP
Net::SMTP=GLOB(0x1150240)&gt;&gt;&gt; MAIL FROM<img src="../gx/frown.png" alt=":&lt;">ben@linuxgazette.net&gt; BODY=8BITMIME
Net::SMTP=GLOB(0x1150240)&lt;&lt;&lt; 250 2.1.0 &lt;ben@linuxgazette.net&gt;... Sender ok
Net::SMTP=GLOB(0x1150240)&gt;&gt;&gt; RCPT TO<img src="../gx/frown.png" alt=":&lt;">ben@linuxgazette.net&gt;
Net::SMTP=GLOB(0x1150240)&lt;&lt;&lt; 250 2.1.5 &lt;ben@linuxgazette.net&gt;... Recipient ok
Net::SMTP=GLOB(0x1150240)&gt;&gt;&gt; DATA
Net::SMTP=GLOB(0x1150240)&lt;&lt;&lt; 354 Enter mail, end with "." on a line by itself
Net::SMTP=GLOB(0x1150240)&gt;&gt;&gt; Received: from localhost ([127.0.0.1]) by Fenrir (bssmtp 0.3) with SMTP id 4796104;
Net::SMTP=GLOB(0x1150240)&gt;&gt;&gt;    Thu, 24 Jan 2008 10:38:10 -0500
Net::SMTP=GLOB(0x1150240)&gt;&gt;&gt; From: Ben Okopnik &lt;ben@linuxgazette.net&gt;
Net::SMTP=GLOB(0x1150240)&gt;&gt;&gt; Message-ID: &lt;20080124153809.GC8283@linuxgazette.net&gt;
Net::SMTP=GLOB(0x1150240)&gt;&gt;&gt; Date: Thu, 24 Jan 2008 10:38:09 -0500
Net::SMTP=GLOB(0x1150240)&gt;&gt;&gt; To: Ben Okopnik &lt;ben@linuxgazette.net&gt;
Net::SMTP=GLOB(0x1150240)&gt;&gt;&gt; Subject: Ttt-ttt
Net::SMTP=GLOB(0x1150240)&gt;&gt;&gt; MIME-Version: 1.0
Net::SMTP=GLOB(0x1150240)&gt;&gt;&gt; Content-Type: text/plain; charset=utf-8
Net::SMTP=GLOB(0x1150240)&gt;&gt;&gt; Content-Disposition: inline
Net::SMTP=GLOB(0x1150240)&gt;&gt;&gt; Content-Transfer-Encoding: 8bit
Net::SMTP=GLOB(0x1150240)&gt;&gt;&gt; User-Agent: Mutt/1.5.11
Net::SMTP=GLOB(0x1150240)&gt;&gt;&gt; 
Net::SMTP=GLOB(0x1150240)&gt;&gt;&gt; test
Net::SMTP=GLOB(0x1150240)&gt;&gt;&gt; &lt;b5&gt;&lt;91&gt;
Net::SMTP=GLOB(0x1150240)&gt;&gt;&gt; .
Net::SMTP=GLOB(0x1150240)&lt;&lt;&lt; 250 2.0.0 m0OFcaKj019698 Message accepted for delivery
Jan 24 10:39:25 bssmtp: Removing c-4796104 and m-4796104
Jan 24 10:39:25 bssmtp: Unlocking message 4796104
Net::SMTP=GLOB(0x1150240)&gt;&gt;&gt; QUIT
Net::SMTP=GLOB(0x1150240)&lt;&lt;&lt; 221 2.0.0 genetikayos.com closing connection
</pre>
I don't know if the above characters are going to come through, but the
content (lines 7 and 8 from the bottom) are already munged. Game, set,
and match - it's on my end.
</p>

<p>
Net::SMTP does not appear to have any user-controllable handles for
twiddling this kind of thing, so I'm going to a) see if I can fix the
internal bits in it, b) if I can't do that in a reasonably short amount
of time, I'm going to give up and replicate the above manually, /sans/
conversion, and c) file a bug report.
</p>

<p>
Thanks very much for the help, everybody!
</p>


<pre>-- 
* Ben Okopnik * Editor-in-Chief, Linux Gazette * <a href="http://LinuxGazette.NET">http://LinuxGazette.NET</a> *
</pre>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-problems_with_utf_8_over_smtp">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Ben Okopnik [ben at linuxgazette.net]
</p>
</b><br />
<b>Thu, 24 Jan 2008 11:38:46 -0500</b>
</p>

<p>
Woo-HOO. Nailed it.
</p>


<p>
Marcus Kuhn's UTF-8 test file:
</p>

<p>
<p class="editorial">
[[[  Elided for publication. You can see it at:
<a href="http://www.cl.cam.ac.uk/~mgk25/ucs/examples/UTF-8-demo.txt">http://www.cl.cam.ac.uk/~mgk25/ucs/examples/UTF-8-demo.txt</a>  ]]]
</p>

</p>

<pre>-- 
* Ben Okopnik * Editor-in-Chief, Linux Gazette * <a href="http://LinuxGazette.NET">http://LinuxGazette.NET</a> *
</pre>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-problems_with_utf_8_over_smtp">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Karl-Heinz Herrmann [kh1 at khherrmann.de]
</p>
</b><br />
<b>Wed, 23 Jan 2008 20:28:33 +0100</b>
</p>

<p>
Hi,
</p>

<p>
I see the same garbage in my mailer (sylpheed-claws) which does support
utf-8 usually. 
</p>

<p>
A look in the header says.... 
</p>

<p>
On Tue, 22 Jan 2008 14:39:21 -0500
Ben Okopnik &lt;ben@linuxgazette.net&gt; wrote:
</p>


<pre>
&gt; X-MIME-Autoconverted: from 8bit to base64 by genetikayos.com id m0MJcqEJ007364 
&gt; translation Content-Type: text/plain; charset="utf-8"
&gt; Content-Transfer-Encoding: base64
</pre>

<p>
but if I force utf8 the characters look a bit differnt (less chars per
group). If I force the base64 decode as well I get:
 
</p>

<pre>
&gt; [Error decoding BASE64]
&gt; [Error decoding BASE64]
&gt; [Error decoding BASE64]
&gt; [Error decoding BASE64]
&gt; [Error decoding BASE64]
</pre>

<p>
So something must have decoded the base64 already (and it seems not to
tell in the header)  and messed it up.
</p>


<p>
K.-H.
</p>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-problems_with_utf_8_over_smtp">Back</a><hr width="50%" align="left" /><p><br /></p></div>
</body>
</html>