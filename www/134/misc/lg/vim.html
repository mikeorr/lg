<!DOCTYPE html
	PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
	 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US">
<head>
<title>Mailbag</title>
<link rel="stylesheet" type="text/css" href="../../../lg.css" />
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
</head>
<body>
<a href="../../../"><img alt="Linux Gazette" src="../../../gx/2003/newlogo-blank-200-gold2.jpg" id="logo" /></a><img alt="Tux" src="../../../gx/tux_86x95_indexed.png" id="tux" /><p id="fun">...making Linux just a little more fun!</p><div class='content articlecontent'><a name="top"></a><h3>vim?</h3>
<p>
<b>Peter Knaggs [peter.knaggs at gmail.com]</b><br />
<b>Wed, 6 Dec 2006 01:30:25 -0800</b>
</p>

<p>
Greetings!
</p>

<p>
I guess Emacs users (and all non-vim users) can cheerfully skip this
question.
</p>

<p>
Have you ever noticed when you're typing quickly in "vim" that things
sometimes go haywire?
I only recently got around to figuring out how to reproduce this "vim"
glitch, I guess because
I was so used to "vi" that I didn't consciously remember the names of the
keys I was pressing.
</p>

<p>
So anyways, if you open a file with some text in it, then pick a line of
reasonable length,
and use shift A to append, then press the Esc key to leave append mode, then
immediately
press shift O to insert a new line above and start typing immediately, bad
things happen.
It seems that occasionally after pressing shift O that it takes vim almost
half a second to
catch up, during which I guess it's not yet in insert mode.
</p>

<p>
Does the same thing happen for you?
</p>

<p>
And why only for shift O, not for any of the other ways of getting into
insert mode?
</p>

<p>
I didn't find the answer in the vim FAQ.
I guess I might have to go to the source code, any hints on where to start
looking?
</p>

<p>
Cheers,
Peter.
</p>


<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-vim">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b>Thomas Adam [thomas.adam22 at gmail.com]</b><br />
<b>Wed, 6 Dec 2006 11:49:44 +0000</b>
</p>

<p>
On Wed, Dec 06, 2006 at 01:30:25AM -0800, Peter Knaggs wrote:
</p>

<pre>
&gt; Does the same thing happen for you?
</pre>

<p>
I bet it's not so bad if you do:
</p>

<pre>
:syn off
</pre>
to turn of syntax hilighting.
</p>

<p>
-- Thomas Adam
</p>

<pre>-- 
"Wanting to feel; to know what is real.  Living is a lie." -- Purpoise
Song, by The Monkees.
</pre>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-vim">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b>Benjamin A. Okopnik [ben at linuxgazette.net]</b><br />
<b>Wed, 6 Dec 2006 09:26:34 -0500</b>
</p>

<p>
Hi, Peter -
</p>

<p>
You're probably unaware of this, but you sent your message in HTML
format. This doubled the size of your message without any benefit in
return, and will create extra work for our Mailbag editor.
</p>

<p>
Please change your mailer's settings to stop it from doing this. For
more info, please see &lt;<a href="http://expita.com/nomime.html">http://expita.com/nomime.html</a>&gt;.
</p>

<p>
On Wed, Dec 06, 2006 at 01:30:25AM -0800, Peter Knaggs wrote:
</p>

<pre>
&gt; 
&gt;    Greetings!
&gt;    I guess Emacs users (and all non-vim users) can cheerfully skip this
&gt;    question.
&gt;    Have you ever noticed when you're typing quickly in "vim" that things
&gt;    sometimes go haywire?
</pre>

<p>
Can't say I have. I imagine that this would happen if you had mapped
some sort of key combination in which the first key was that same as a
common command key in Vim, though.
</p>

<p>
Example:
</p>

<pre>
imap OX :s/sheep/ox/&lt;CR&gt;
</pre>
If you did this, then Vim would wait for that half a second (or whatever
you've changed the standard delay to) every time you typed 'O' - it
would be checking to see if you're going to add an 'X' after it.
Needless to say, You Shouldn't Do That. 
</p>


<pre>
&gt;    I only recently got around to figuring out how to reproduce this "vim"
&gt;    glitch, I guess because
&gt;    I was so used to "vi" that I didn't consciously remember the names of the
&gt;    keys I was pressing.
&gt;    So anyways, if you open a file with some text in it, then pick a line of
&gt;    reasonable length,
&gt;    and use shift A to append, then press the Esc key to leave append mode, then
&gt;    immediately
&gt;    press shift O to insert a new line above and start typing immediately, bad
&gt;    things happen.
&gt;    It seems that occasionally after pressing shift O that it takes vim almost
&gt;    half a second to
&gt;    catch up, during which I guess it's not yet in insert mode.
&gt;    Does the same thing happen for you?
</pre>

<p>
Nope. I've just tried it several times, and I don't see any glitches.
</p>


<pre>
&gt;    And why only for shift O, not for any of the other ways of getting into
&gt;    insert mode?
</pre>

<p>
Try typing 'map O' at your Vim command line, and see what it says. Just
for reference, mine says 'No mapping found'. You might also want to
check your /etc/vimrc (although I doubt that the Vim folks would leave
you a nasty present like that) and your ~/.vimrc - which is where the
problem is mostly likely to be. Also, test it without a .vimrc (use the
'-u' option with an empty file as an argument) and see if it persists.
</p>


<pre>-- 
* Ben Okopnik * Editor-in-Chief, Linux Gazette * <a href="http://LinuxGazette.NET">http://LinuxGazette.NET</a> *
</pre>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-vim">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b>John Karns [johnkarns at gmail.com]</b><br />
<b>Wed, 6 Dec 2006 11:25:38 -0500</b>
</p>

<p>
Note: I'm replying via the gmail web interface and don't know if it
sends in html format or not.  So apologies if it does.
</p>

<p>
On 12/6/06, Benjamin A. Okopnik &lt;ben@linuxgazette.net&gt; wrote:
</p>

<pre>
&gt; Hi, Peter -
&gt;
</pre>


<pre>
&gt; On Wed, Dec 06, 2006 at 01:30:25AM -0800, Peter Knaggs wrote:
&gt; &gt;
&gt; &gt;    Greetings!
&gt; &gt;    I guess Emacs users (and all non-vim users) can cheerfully skip this
&gt; &gt;    question.
&gt; &gt;    Have you ever noticed when you're typing quickly in "vim" that things
&gt; &gt;    sometimes go haywire?
&gt;
&gt; Can't say I have. I imagine that this would happen if you had mapped
&gt; some sort of key combination in which the first key was that same as a
&gt; common command key in Vim, though.
</pre>

<p>
Indeed it would have to be due to vim being busy with  executing a
macro during that time.  Which macro gets executed may be dependent on
the extension of the file name you're opening for edit, and how your
distro has vim configured.
</p>

<p>
Ben's suggestion of using the "-u" option flag should confirm that.
</p>

<pre>-- 
John Karns
</pre>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-vim">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b>Peter Knaggs [peter.knaggs at gmail.com]</b><br />
<b>Wed, 6 Dec 2006 10:14:20 -0800</b>
</p>

<p>
On 12/6/06, Benjamin A. Okopnik &lt;ben@linuxgazette.net&gt; wrote:
</p>

<pre>
&gt; Hi, Peter -
&gt;
&gt; You're probably unaware of this, but you sent your message in HTML
&gt; format. This doubled the size of your message without any benefit in
&gt; return, and will create extra work for our Mailbag editor.
</pre>

<p>
Hi Ben,
   Thanks for letting me know about the HTML issue: I had apparently
   replied to an HTML message in the past, and doing that seems to "flip"
   gmail over into "Rich text" mode. Once it's in that mode, though, it
   stays with it for all subsequent new messages. So effectively, the
   "Compose Mail" is actually a modal button. Not something I'd have
   expected from a user interface for an email client. But I guess if I'm
   lazy and don't run my own email server, I can hardly complain <img src="../gx/smile.png" alt=":)">
</p>



<pre>
&gt; Please change your mailer's settings to stop it from doing this. For
&gt; more info, please see &lt;<a href="http://expita.com/nomime.html">http://expita.com/nomime.html</a>&gt;.
</pre>

<p>
   I hope it's OK this time, there's no "Rich formatting", and I tested
   by sending an email to myself and it doesn't show any HTML.
</p>



<pre>
&gt; Can't say I have. I imagine that this would happen if you had mapped
&gt; some sort of key combination in which the first key was that same as a
&gt; common command key in Vim, though.
</pre>

<p>
   You guys are the greatest, thanks for Thomas and John's comments too.
   It turns out the problem happens for me if I have any vimrc whatsoever.
   So once I remove $HOME/.vimrc <strong>and</strong> /usr/share/vim/vimrc
   then the problem goes away. Putting back /usr/share/vim/vimrc causes
   the problem to come back. I'm using Ubuntu Dapper Drake at the moment,
   but I've seen this problem on almost all the distros I've ever used.
</p>


<pre>
&gt; Nope. I've just tried it several times, and I don't see any glitches.
</pre>

<p>
   It does take a bit of trial and error. Maybe this is a better
sequence to reproduce it:
   Pick a line with some text. Type the number key "0", the "A" key,
then "Esc" key.
   Now press the "O" key. It seems to only happen intermittently, so
try it a few
   times with that sequence.
</p>


<pre>
&gt;
&gt; &gt;    And why only for shift O, not for any of the other ways of getting into
&gt; &gt;    insert mode?
</pre>

<p>
   Indeed, it's probably my bad habit <img src="../gx/smile.png" alt=":)">
   Well, I can't make up my mind whether I want to add text above
   or below the line I'm currently on. So oftentimes, I'm about to use
"A" to append
   and then I realize I need to stick the stuff in above the line and
not below it.
   So I hit "Esc". Well now you see "O" is the natural choice to insert above.
   Otherwise, I have to use "ko" and after that I'm unconscious for a while <img src="../gx/smile.png" alt=":)">
</p>


<pre>
&gt; Try typing 'map O' at your Vim command line, and see what it says.
&gt; Just for reference, mine says 'No mapping found'.
</pre>

<p>
It says
   No mapping found
for me too.
</p>


<pre>
&gt; You might also want to
&gt; check your /etc/vimrc (although I doubt that the Vim folks would leave
&gt; you a nasty present like that) and your ~/.vimrc - which is where the
&gt; problem is mostly likely to be. Also, test it without a .vimrc (use the
&gt; '-u' option with an empty file as an argument) and see if it persists.
</pre>

<p>
Indeed, using a blank file works fine, no glitch.
So I guess my new favorite way of using vim is going to be something like:
touch $HOME/empty_file
vim -u $HOME/empty_file file_I_want_to_edit_without_fear_of_glitch
</p>

<p>
Cheers,
Peter.
</p>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-vim">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b>Benjamin A. Okopnik [ben at linuxgazette.net]</b><br />
<b>Thu, 7 Dec 2006 18:10:18 -0500</b>
</p>

<p>
On Wed, Dec 06, 2006 at 10:14:20AM -0800, Peter Knaggs wrote:
</p>

<pre>
&gt; On 12/6/06, Benjamin A. Okopnik &lt;ben@linuxgazette.net&gt; wrote:
&gt; &gt; Hi, Peter -
&gt; &gt;
&gt; &gt; You're probably unaware of this, but you sent your message in HTML
&gt; &gt; format. This doubled the size of your message without any benefit in
&gt; &gt; return, and will create extra work for our Mailbag editor.
&gt; 
&gt; Hi Ben,
&gt;    Thanks for letting me know about the HTML issue: I had apparently
&gt;    replied to an HTML message in the past, and doing that seems to "flip"
&gt;    gmail over into "Rich text" mode. Once it's in that mode, though, it
&gt;    stays with it for all subsequent new messages. So effectively, the
&gt;    "Compose Mail" is actually a modal button. Not something I'd have
&gt;    expected from a user interface for an email client.
</pre>

<p>
Neither would I; in fact, I'd probably start looking for an alternate
explanation and doing a bit of testing to narrowit down to the exact
cause. That interface sounds like it was written by a maniac who's
realized that he can't stick forks in people's yes over the Net but has
thought up an electronic equivalent.
</p>


<pre>
&gt; &gt; Please change your mailer's settings to stop it from doing this. For
&gt; &gt; more info, please see &lt;<a href="http://expita.com/nomime.html">http://expita.com/nomime.html</a>&gt;.
&gt; 
&gt;    I hope it's OK this time, there's no "Rich formatting", and I tested
&gt;    by sending an email to myself and it doesn't show any HTML.
</pre>
 
It looks fine now - although I don't know that thinking of plain text as
"Poor formatting" would be useful.
 
</p>

<pre>
&gt; &gt; You might also want to
&gt; &gt; check your /etc/vimrc (although I doubt that the Vim folks would leave
&gt; &gt; you a nasty present like that) and your ~/.vimrc - which is where the
&gt; &gt; problem is mostly likely to be. Also, test it without a .vimrc (use the
&gt; &gt; '-u' option with an empty file as an argument) and see if it persists.
&gt; 
&gt; Indeed, using a blank file works fine, no glitch.
&gt; So I guess my new favorite way of using vim is going to be something like:
&gt; touch $HOME/empty_file
&gt; vim -u $HOME/empty_file file_I_want_to_edit_without_fear_of_glitch
</pre>

<p>
Why not find the offending line (either by using the "divide and
conquer" method, or via deleting one line at a time if it's reasonably
short) instead?  That way, you'd know what to avoid in the future. In
fact, once you found it, you could file a bug report with the Vim
maintainers. That could be, you know, kinda like Open Source and stuff.
Might even benefit other people. <img src="../gx/smile.png" alt=":)">
</p>


<pre>-- 
* Ben Okopnik * Editor-in-Chief, Linux Gazette * <a href="http://LinuxGazette.NET">http://LinuxGazette.NET</a> *
</pre>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-vim">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b>Peter Knaggs [peter.knaggs at gmail.com]</b><br />
<b>Thu, 7 Dec 2006 17:22:36 -0800</b>
</p>

<p>
On 12/7/06, Benjamin A. Okopnik &lt;ben@linuxgazette.net&gt; wrote:
</p>

<pre>
&gt; On Wed, Dec 06, 2006 at 10:14:20AM -0800, Peter Knaggs wrote:
&gt; &gt; Hi Ben,
&gt; &gt;    Thanks for letting me know about the HTML issue: I had apparently
&gt; &gt;    replied to an HTML message in the past, and doing that seems to "flip"
&gt; &gt;    gmail over into "Rich text" mode. Once it's in that mode, though, it
&gt; &gt;    stays with it for all subsequent new messages. So effectively, the
&gt; &gt;    "Compose Mail" is actually a modal button. Not something I'd have
&gt; &gt;    expected from a user interface for an email client.
&gt;
&gt; Neither would I; in fact, I'd probably start looking for an alternate
&gt; explanation and doing a bit of testing to narrowit down to the exact
&gt; cause. That interface sounds like it was written by a maniac who's
&gt; realized that he can't stick forks in people's yes over the Net but has
&gt; thought up an electronic equivalent.
&gt;
&gt; &gt; Indeed, using a blank file works fine, no glitch.
&gt; &gt; So I guess my new favorite way of using vim is going to be something like:
&gt; &gt; touch $HOME/empty_file
&gt; &gt; vim -u $HOME/empty_file file_I_want_to_edit_without_fear_of_glitch
&gt;
&gt; Why not find the offending line (either by using the "divide and
&gt; conquer" method, or via deleting one line at a time if it's reasonably
&gt; short) instead?  That way, you'd know what to avoid in the future. In
&gt; fact, once you found it, you could file a bug report with the Vim
&gt; maintainers. That could be, you know, kinda like Open Source and stuff.
&gt; Might even benefit other people. <img src="../gx/smile.png" alt=":)">
</pre>

<p>
I find that  the presence of the following line
in /usr/share/vim/vimrc is perhaps the entire cause of the glitch:
</p>

<pre>
runtime! debian.vim
</pre>
As it is ominously preceded by the following comments,
I'm wondering is it safe to remove?
</p>

<pre>
" This line should not be removed as it ensures that various options are
" properly set to work with the Vim-related packages available in Debian.
</pre>
Or does it just mean that the rabit-hold goes deeper,
and I need to look into what a debian.vim runtime consists of?
</p>

<p>
Thanks,
Peter.
</p>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-vim">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b>Benjamin A. Okopnik [ben at linuxgazette.net]</b><br />
<b>Thu, 7 Dec 2006 21:01:51 -0500</b>
</p>

<p>
On Thu, Dec 07, 2006 at 05:22:36PM -0800, Peter Knaggs wrote:
</p>

<pre>
&gt; 
&gt; I find that  the presence of the following line
&gt; in /usr/share/vim/vimrc is perhaps the entire cause of the glitch:
&gt; 
&gt; runtime! debian.vim
</pre>

<p>
Ah-hah! Well done, Peter.
 
</p>

<pre>
&gt; As it is ominously preceded by the following comments,
&gt; I'm wondering is it safe to remove?
&gt; 
&gt; " This line should not be removed as it ensures that various options are
&gt; " properly set to work with the Vim-related packages available in Debian.
&gt; 
&gt; Or does it just mean that the rabit-hold goes deeper,
&gt; and I need to look into what a debian.vim runtime consists of?
</pre>

<p>
Indeed you should - as an extension of the troubleshooting process I
suggested. 'runtime', incidentally, is similar to the 'source' command:
it loads all rc files from the "runtimepath" defined by Vim ($HOME/.vim,
$VIM/vimfiles, $VIMRUNTIME, $VIM/vimfiles/after, $HOME/.vim/after in
Unix.) So, the right thing to do is to look in those directories, find
"debian.vim", and troubleshoot it the same way that I suggested.
</p>

<pre>-- 
* Ben Okopnik * Editor-in-Chief, Linux Gazette * <a href="http://LinuxGazette.NET">http://LinuxGazette.NET</a> *
</pre>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-vim">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b>Peter Knaggs [peter.knaggs at gmail.com]</b><br />
<b>Sat, 9 Dec 2006 11:27:39 -0800</b>
</p>

<p>
Hi Gang,
</p>

<p>
    Sorry it took me so long, I've gotten the vim glitch
    narrowed down to just turning on one option:
       set nocompatible
    I'm pretty sure now that's the culprit, because the glitch
    happens even if I entirely remove
</p>

<pre>
      $HOME/.vimrc
      /usr/share/vim/vimrc
      /usr/share/vim/vim64
</pre>
   so that the strace of vim startup only shows $HOME/.viminfo being opened.
</p>

<p>
    Assuming no other config files are involved at this point, so if I have
''
cat $HOME/config_glitch
set nocompatible
''
   and then start up vim using essentially just that config file using
the -u option:
<pre>
vi -u $HOME/config_glitch
</pre>
   will reproduce the slow-insert-line-above glitch using this sequence:
   Pick a line with some text. Type the number key "0", the "A" key,
   then "Esc" key. Now press the "O" key. It seems to sometimes happen
   intermittently, so try it over again a few times with that sequence.
</p>

<p>
   It seems that I can't just comment out the "set nocompatible" because
   then none of the startup macros will work, e.g. one that I tend to use a lot
   to restart editing at the same place as when I closed the file,
goes like this:
<pre>
set nocompatible
if has("autocmd")
 filetype plugin off
 autocmd BufReadPost *
 \ if line("'\"") &gt; 0 &amp;&amp; line ("'\"") &lt;= line("$") |
 \   exe "normal! g'\"" |
 \ endif
endif
</pre>
   So it looks like the next thing is going to involve diving into
   the vim source to see how the codepath changes with or without
   the "set nocompatible" flag. It's usually easy to debug C stuff,
   I'll give it a try, hopefully get enough to file a bug with the vim folks.
</p>

<p>
   Thanks for all the help narrowing down the problem and suggesting
   the "-u" option.
Cheers,
Peter.
</p>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-vim">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b>Peter Knaggs [peter.knaggs at gmail.com]</b><br />
<b>Sat, 9 Dec 2006 16:06:51 -0800</b>
</p>

<p>
On 12/9/06, Peter Knaggs &lt;peter.knaggs@gmail.com&gt; wrote:
</p>

<pre>
&gt;
&gt; cat $HOME/config_glitch
&gt; set nocompatible
&gt;
&gt;    and then start up vim using essentially just that config file using
&gt; the -u option:
&gt;
&gt; vi -u $HOME/config_glitch
&gt;
&gt;    will reproduce the slow-insert-line-above glitch using this sequence:
&gt;    Pick a line with some text. Type the number key "0", the "A" key,
&gt;    then "Esc" key. Now press the "O" key. It seems to sometimes happen
&gt;    intermittently, so try it over again a few times with that sequence.
&gt;
&gt;    So it looks like the next thing is going to involve diving into
&gt;    the vim source to see how the codepath changes with or without
&gt;    the "set nocompatible" flag. It's usually easy to debug C stuff,
&gt;    I'll give it a try, hopefully get enough to file a bug with the vim folks.
&gt;
</pre>


<p>
So the vim sources are pretty interesting, there's lots of stuff
in there to keep me busy for a while. But anyways, I've found where
the "glitch" is coming from: there's a 1000 millisecond "wait" for nothing.
There are no characters available when it calls RealWaitForChar with
a 1000 millisecond timeout, which causes a long pause. I attached
gdb to vim compiled with debug like this
<pre>
         cvs -z3 -d:pserver:anonymous@vim.cvs.sf.net:/cvsroot/vim checkout vim7
         cd vim7
         CFLAGS=-g make
</pre>
then put a breakpoint on getchar.c:1519 and entered my testcase
all in one fell swoop (i.e. "cont" in gdb, then pressing A Esc O one after the
other in the vim window). Then I used single-step in gdb using the
"step" command.
It was a lot of tracing, I didn't include it all here. But if you hold
down the Enter key
in gdb it will quickly re-do the "step" command over and over. Then, I
just watch
for a "gap" (see below). The "gap" means that vim is doing something (waiting
on "select" in this case), when it should be doing useful work getting back to
interact with the user (yours truly, in this instance). The trace
looks like the
following, but the reason why it's doing this call to RealWaitForChar with a
one-second timeout I still need to go back and figure out. At least it's some
progress for one day <img src="../gx/smile.png" alt=":)">
</p>

<p>
Cheers,
Peter.
<pre>
WaitForChar (msec=1000) at os_unix.c:4463
4463            if (rest != 0)
(gdb)
4476            avail = RealWaitForChar(read_cmd_fd, msec, NULL);
(gdb)
RealWaitForChar (fd=0, msec=1000, check_for_gpm=0x0) at os_unix.c:4534
4534        if (msec &gt; 0 &amp;&amp; (
(gdb)
4551            gettimeofday(&amp;start_tv, NULL);
(gdb)
4556        if (busy)
(gdb)
4565            int             finished = TRUE; /* default is to
'loop' just once */
(gdb)
4693            long            towait = msec;
(gdb)
4710            if (towait &gt;= 0)
(gdb)
4712                tv.tv_sec = towait / 1000;
(gdb)
4713                tv.tv_usec = (towait % 1000) * (1000000/1000);
(gdb)
4714                tvp = &amp;tv;
(gdb)
4722            FD_ZERO(&amp;rfds); /* calls bzero() on a sun */
(gdb)
4723            FD_ZERO(&amp;efds);
(gdb)
4724            FD_SET(fd, &amp;rfds);
(gdb)
4727            FD_SET(fd, &amp;efds);
(gdb)
4729            maxfd = fd;
(gdb)
4741            if (xterm_Shell != (Widget)0)
(gdb)
4743                FD_SET(ConnectionNumber(xterm_dpy), &amp;rfds);
(gdb)
4744                if (maxfd &lt; ConnectionNumber(xterm_dpy))
(gdb)
4745                    maxfd = ConnectionNumber(xterm_dpy);
(gdb)
4758            if (xsmp_icefd != -1)
(gdb)
4760                FD_SET(xsmp_icefd, &amp;rfds);
(gdb)
4761                FD_SET(xsmp_icefd, &amp;efds);
(gdb)
4762                if (maxfd &lt; xsmp_icefd)
(gdb)
4772            ret = select(maxfd + 1, &amp;rfds, NULL, &amp;efds, tvp);
(gdb)
4792            if (ret &gt; 0 &amp;&amp; xterm_Shell != (Widget)0
(gdb)
4815            if (ret &gt; 0 &amp;&amp; xsmp_icefd != -1)
(gdb)
4839            if (finished || msec == 0)
(gdb)
4862        return (ret &gt; 0);
(gdb)
4863    }
</pre>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-vim">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b>Benjamin A. Okopnik [ben at linuxgazette.net]</b><br />
<b>Sat, 9 Dec 2006 20:53:17 -0500</b>
</p>

<p>
On Sat, Dec 09, 2006 at 11:27:39AM -0800, Peter Knaggs wrote:
</p>

<pre>
&gt; Hi Gang,
&gt; 
&gt;     Sorry it took me so long, I've gotten the vim glitch
&gt;     narrowed down to just turning on one option:
&gt;        set nocompatible
</pre>

<p>
[skipping a recount of the tracing procedure]
</p>

<p>
Good job, Peter! You've hunted it down, clearly; I'd suggest reporting
it to the Vim maintainers.
</p>

<p>
The curious thing is, 'set nocp' is supposed to be the default setting
for Vim:
</p>

<p>
(from the 'help nocompatible' entry in Vim)
<pre>
  By default this option is on and the Vi defaults are used for the
  options.  This default was chosen for those people who want to use Vim
  just like Vi, and don't even (want to) know about the 'compatible'
  option.
</pre>
I wonder what happens if you try living without it - the above
documentation implies (elsewhere in the same entry) that 'set cp' is an
interesting option to explore for people who want to use Vim as Vim,
instead of as Vi.
</p>

<pre>-- 
* Ben Okopnik * Editor-in-Chief, Linux Gazette * <a href="http://LinuxGazette.NET">http://LinuxGazette.NET</a> *
</pre>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-vim">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b>Peter Knaggs [peter.knaggs at gmail.com]</b><br />
<b>Sat, 9 Dec 2006 19:21:37 -0800</b>
</p>

<p>
On 12/9/06, Benjamin A. Okopnik &lt;ben@linuxgazette.net&gt; wrote:
</p>


<pre>
&gt;
&gt; Good job, Peter! You've hunted it down, clearly; I'd suggest reporting
&gt; it to the Vim maintainers.
</pre>

<p>
I'm here at Rick's consipre linux meeting, and got a lot of hints:
It turns out that after setting "TERM=linux" instead of using "TERM=xterm",
the glitch no longer occurs. So it doesn't occur by default when using the
console, which is reassuring <img src="../gx/smile.png" alt=":)">
</p>

<p>
Another hint, was to use "strace -r -p &lt;pid_of_vim&gt;" and then type
the sequence into the vim session. The strace output shows in the
left hand column the elapsed time of the previous system call. So
it's easy to spot where the one-second pause is coming from <img src="../gx/smile.png" alt=":)">
</p>


<pre>
&gt;
&gt; The curious thing is, 'set nocp' is supposed to be the default setting
&gt; for Vim:
</pre>

<p>
Hmm, true. But I think they mean non-compatible with vi, as opposed
to non-compatible with vim. I'm still puzzled <img src="../gx/smile.png" alt=":)">
</p>


<pre>
&gt;
&gt; (from the 'help nocompatible' entry in Vim)
&gt; ``
&gt;   By default this option is on and the Vi defaults are used for the
&gt;   options.  This default was chosen for those people who want to use Vim
&gt;   just like Vi, and don't even (want to) know about the 'compatible'
&gt;   option.
</pre>

<p>
This explanation seems pretty confusing to me.
In the context, am I supposed to interpret "vi" as meaning "vim"?
</p>


<pre>
&gt; I wonder what happens if you try living without it - the above
&gt; documentation implies (elsewhere in the same entry) that 'set cp' is an
&gt; interesting option to explore for people who want to use Vim as Vim,
&gt; instead of as Vi.
</pre>

<p>
Hmm, I find that using "set cp" causes the following macro not to work,
I have to change it back to "set nocp":
<pre>
set cp
if has("autocmd")
 filetype plugin off
 autocmd BufReadPost *
 \ if line("'\"") &gt; 0 &amp;&amp; line ("'\"") &lt;= line("$") |
 \   exe "normal! g'\"" |
 \ endif
endif
</pre>
Guess it's time to file a bug, we've come a fair ways
to getting a solid testcase, and learned a good few
useful tricks for debugging stuff along the way <img src="../gx/smile.png" alt=":)">
</p>

<p>
Cheers,
Peter.
</p>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-vim">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b>Benjamin A. Okopnik [ben at linuxgazette.net]</b><br />
<b>Sat, 9 Dec 2006 23:16:34 -0500</b>
</p>

<p>
On Sat, Dec 09, 2006 at 07:21:37PM -0800, Peter Knaggs wrote:
</p>

<pre>
&gt; On 12/9/06, Benjamin A. Okopnik &lt;ben@linuxgazette.net&gt; wrote:
&gt; 
&gt; &gt;
&gt; &gt; Good job, Peter! You've hunted it down, clearly; I'd suggest reporting
&gt; &gt; it to the Vim maintainers.
&gt; 
&gt; I'm here at Rick's consipre linux meeting, and got a lot of hints:
</pre>

<p>
Oh, I didn't realize you were geographically-capable of conspiring with
Rick. Next time I'm in the area, it would be nice to meet you F2F - not
that I make it out to the West coast all that often these days. In fact,
rather than warm and sunny California, I'm headed for Madison, Wisconsin
tomorrow... anybody have a pair of snowshoes I could use?
</p>


<pre>
&gt; It turns out that after setting "TERM=linux" instead of using "TERM=xterm",
&gt; the glitch no longer occurs. So it doesn't occur by default when using the
&gt; console, which is reassuring <img src="../gx/smile.png" alt=":)">
</pre>

<p>
That's <em>really</em> odd - and solidifies my concept of it as a bug. I'd been
thinking that it was possible to "configure it out", but if it's
coll[ui]ding with an essentially random factor like the TERM setting, it
needs to go.
</p>


<pre>
&gt; Another hint, was to use "strace -r -p &lt;pid_of_vim&gt;" and then type
&gt; the sequence into the vim session. The strace output shows in the
&gt; left hand column the elapsed time of the previous system call. So
&gt; it's easy to spot where the one-second pause is coming from <img src="../gx/smile.png" alt=":)">
</pre>
 
Oh, good call. I hadn't even thought of that, although I'm certainly
used to looking for something that can trigger a watch condition when
I'm troubleshooting. I guess that interval sequences are a "human-only"
watch condition, and I'm usually searching for the other kind.
</p>


<pre>
&gt; &gt; The curious thing is, 'set nocp' is supposed to be the default setting
&gt; &gt; for Vim:
&gt; 
&gt; Hmm, true. But I think they mean non-compatible with vi, as opposed
&gt; to non-compatible with vim. I'm still puzzled <img src="../gx/smile.png" alt=":)">
&gt; 
&gt; &gt; (from the 'help nocompatible' entry in Vim)
&gt; &gt; ``
&gt; &gt;   By default this option is on and the Vi defaults are used for the
&gt; &gt;   options.  This default was chosen for those people who want to use Vim
&gt; &gt;   just like Vi, and don't even (want to) know about the 'compatible'
&gt; &gt;   option.
&gt; 
&gt; This explanation seems pretty confusing to me.
&gt; In the context, am I supposed to interpret "vi" as meaning "vim"?
</pre>

<p>
Now that I've re-parsed it... yeah, it doesn't make a whole lot of sense
either. Does 'nocp' mean "make Vim not compatible with *itself*"??? That
would be an example of taking the English language around the bend,
beating it silly, and stealing its shoes.
 
</p>

<pre>
&gt; &gt; I wonder what happens if you try living without it - the above
&gt; &gt; documentation implies (elsewhere in the same entry) that 'set cp' is an
&gt; &gt; interesting option to explore for people who want to use Vim as Vim,
&gt; &gt; instead of as Vi.
&gt; 
&gt; Hmm, I find that using "set cp" causes the following macro not to work,
&gt; I have to change it back to "set nocp":
&gt; 
&gt; set cp
&gt; if has("autocmd")
&gt;  filetype plugin off
</pre>

<p>
If you look up ':help filetype', the reason is stated immediately above
the definition: "{Vi does not have any of these commands}".
</p>


<pre>-- 
* Ben Okopnik * Editor-in-Chief, Linux Gazette * <a href="http://LinuxGazette.NET">http://LinuxGazette.NET</a> *
</pre>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-vim">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b>Brian Bilbrey [bilbrey at orbdesigns.com]</b><br />
<b>Sun, 10 Dec 2006 09:07:14 -0500</b>
</p>

<p>
On Sat, Dec 09, 2006 at 11:16:34PM -0500, Benjamin A. Okopnik wrote:
</p>

<p>
 [snip through partial quoting from :help nocompatible ]
</p>


<pre>
&gt; &gt; This explanation seems pretty confusing to me.
&gt; &gt; In the context, am I supposed to interpret "vi" as meaning "vim"?
&gt; 
&gt; Now that I've re-parsed it... yeah, it doesn't make a whole lot of sense
&gt; either. Does 'nocp' mean "make Vim not compatible with *itself*"??? That
&gt; would be an example of taking the English language around the bend,
&gt; beating it silly, and stealing its shoes.
</pre>

<p>
Let's give that a little more context:
<pre>
                        <strong>'compatible'</strong> *'cp'* <strong>'nocompatible'</strong> *'nocp'*
'compatible' 'cp'       boolean (default on, off when a |vimrc| or |gvimrc|
                                                                file is found)
                        global
                        {not in Vi}
        This option has the effect of making Vim either more Vi-compatible, or
        make Vim behave in a more useful way.
        This is a special kind of option, because when it's set or reset,
        other options are also changed as a side effect.  CAREFUL: Setting or
        resetting this option can have a lot of unexpected effects: Mappings
        are interpreted in another way, undo behaves differently, etc.  If you
        set this option in your vimrc file, you should probably put it at the
        very start.
        By default this option is on and the Vi defaults are used for the
        options.  This default was chosen for those people who want to use Vim
        just like Vi, and don't even (want to) know about the 'compatible'
        option.
         ...
</pre>
So, observe that the paragraph in question is actually talking about the
"compatible" option, not the "nocompatible" option (which are really two
sides of a coin, after all. It goes on to say that once a .vimrc is found
(either global or ~), that setting flips implicitly to nocp, and turns on
all the non-VI-like behavior that Vim is capable of.
</p>

<p>
Sometimes I think it's better to have options like this:
<pre>
# set compatible = 1		# Default [1] is option and command compatible 
							# with Vi. Disable this option [0] to use all
							# of the Vim enhancements and extensions.
</pre>
So that when discussing the options in a help file, there's no confusion
about whether the text refers to the option or it's opposite. But that's not
the path that Bram chose, so ....
</p>

<p>
best,
</p>

<p>
.brian
</p>



<pre>-- 
Brian Bilbrey : <a href="http://www.orbdesigns.com/">http://www.orbdesigns.com/</a> 
	"Kirk to Enterprise -- beam down yeoman Rand and a six-pack."
</pre>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-vim">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b>Peter Knaggs [peter.knaggs at gmail.com]</b><br />
<b>Sun, 10 Dec 2006 14:38:42 -0800</b>
</p>

<p>
On 12/9/06, Benjamin A. Okopnik &lt;ben@linuxgazette.net&gt; wrote:
</p>

<pre>
&gt;
&gt; Oh, I didn't realize you were geographically-capable of conspiring with
&gt; Rick. Next time I'm in the area, it would be nice to meet you F2F - not
&gt; that I make it out to the West coast all that often these days. In fact,
&gt; rather than warm and sunny California, I'm headed for Madison, Wisconsin
&gt; tomorrow... anybody have a pair of snowshoes I could use?
</pre>

<p>
No snowshoes here. Don't penguins like us just grip the
ice with our claws, give a shove, then slide along the rest of
the way on our tummies?
</p>


<pre>
&gt; That's <em>really</em> odd - and solidifies my concept of it as a bug. I'd been
&gt; thinking that it was possible to "configure it out", but if it's
&gt; coll[ui]ding with an essentially random factor like the TERM setting, it
&gt; needs to go.
</pre>

<p>
I sent the following email over to the vim-dev list, in the meantime reading the
vim sources. It'll take time, hopefully the vim-dev folks have some
hints on where
to look.
</p>

<p>
Hi All,
</p>

<p>
   I'm new to this list, and would like to help with
   looking into this apparent timing bug in vim (on the Linux platform).
</p>

<p>
   When vim is running with "set nocompatible" and with TERM=xterm
   the following sequence (when typed fairly quickly) on a blank line
   in an empty file causes an asterisk (*) character, instead of the
   expected "j" character, to be inserted in the file:
</p>

<p>
   A Esc O j Esc   (typed quickly)
   The result is:
   *
</p>

<p>
   The A causes vim to go into insert mode, Escape leaves
   insert mode again. The O inserts a new line above the blank line,
   and the lower case "j" should normally become the contents
   of the new line. So the result should be:
   j
</p>


<p>
   But instead, a single line containing only an asterisk is the result.
</p>

<p>
   When running with TERM=linux or with the setting "set compatible",
   a single "j" on a line by itself above a blank line is the result,
   which I think is what is expected.
</p>

<p>
   Another aspect of the same bug can be seen by looking at
   the timeout value passed to the "select()" call in the routine
   "RealWaitForChar()", when the following sequence is entered
   into an empty vim session:
</p>

<p>
   A Esc O
</p>


<p>
   Using "strace -r -p &lt;pid&gt;" where &lt;pid&gt; is the process id of the vim
   process, I can see there is a one-second timeout of a select call.
   Using gdb, I find that it's from the "RealWaitForChar()" which is called
   with msec=1000 from the following call stack:
<pre>
Breakpoint 1, RealWaitForChar (fd=0, msec=1000, check_for_gpm=0x0)
    at os_unix.c:4772
4772            ret = select(maxfd + 1, &amp;rfds, NULL, &amp;efds, tvp);
(gdb) where
#0  RealWaitForChar (fd=0, msec=1000, check_for_gpm=0x0) at os_unix.c:4772
#1  0x0811c29b in WaitForChar (msec=1000) at os_unix.c:4476
#2  0x08118f09 in mch_inchar (buf=0x81a3b6c "", maxlen=62, wtime=1000,
    tb_change_cnt=68) at os_unix.c:328
#3  0x08171c96 in ui_inchar (buf=0x81a3b6c "", maxlen=62, wtime=1000,
    tb_change_cnt=68) at ui.c:189
#4  0x080bd166 in inchar (buf=0x81a3b6c "", maxlen=188, wait_time=1000,
    tb_change_cnt=68) at getchar.c:2899
#5  0x080bce41 in vgetorpeek (advance=1) at getchar.c:2685
#6  0x080bb7ca in vgetc () at getchar.c:1536
#7  0x080bbbc3 in safe_vgetc () at getchar.c:1733
#8  0x0805997f in edit (cmdchar=65, startln=0, count=1) at edit.c:708
#9  0x081026c7 in invoke_edit (cap=0xbfef9fa0, repl=0, cmd=65, startln=0)
    at normal.c:8725
#10 0x0810266c in nv_edit (cap=0xbfef9fa0) at normal.c:8698
#11 0x080f7086 in normal_cmd (oap=0xbfefa02c, toplevel=1) at normal.c:1136
#12 0x080c77ca in main_loop (cmdwin=0, noexmode=0) at main.c:1154
#13 0x080c7395 in main (argc=1, argv=0xbfefa214) at main.c:934
</pre>
   From what I understand, the timeout (during which "O" is displayed by vim)
   is happening because there are no further input characters from the user.
   But the one-second delay before the newly-inserted line "opens up" seems
   somewhat disconcerting. As the sequence "A Esc O j Esc" shows, the
   mode that vim is in during this one-second "window" doesn't appear to
   properly be "insert mode", and so an opportunity for stray characters
   to be inserted into the file appears to exist.
</p>

<p>
   Similarly, the following sequences result in unexpected "+" and "-" being
   entered, so there appears to be enough scope for this behavior to cause
   typos or unexpected characters to be entered by a hurried typist:
<pre>
     A Esc O k Esc
     Result:
     +
 
     A Esc O m Esc
     Result:
     -
</pre>
   I'm still looking into the vim sources, and also trying to understand
   why the
      TERM=xterm
   setting influences this behavior, whereas with the setting
      TERM=linux
   vim works fine and the above sequences all give the expected result.
</p>

<p>
   Is there a bugzilla or another way for reporting vim bugs?
   Please feel free to point me in the right direction.
</p>

<p>
   I'm new to this list, and would like to help with vim in future.
</p>

<p>
Thanks,
Peter.
</p>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-vim">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b>Peter Knaggs [peter.knaggs at gmail.com]</b><br />
<b>Mon, 11 Dec 2006 15:26:24 -0800</b>
</p>

<p>
On 12/9/06, Benjamin A. Okopnik &lt;ben@linuxgazette.net&gt; wrote:
</p>

<pre>
&gt; On Sat, Dec 09, 2006 at 07:21:37PM -0800, Peter Knaggs wrote:
&gt; &gt; On 12/9/06, Benjamin A. Okopnik &lt;ben@linuxgazette.net&gt; wrote:
&gt; &gt;
&gt; &gt; &gt;
&gt; &gt; &gt; Good job, Peter! You've hunted it down, clearly; I'd suggest reporting
&gt; &gt; &gt; it to the Vim maintainers.
</pre>

<p>
OK. Here's the thread that was the result, it covers a lot of ground:
</p>

<p>
<a href="http://marc.theaimsgroup.com/?l=vim-dev&amp;m=116578941422995&amp;w=2">http://marc.theaimsgroup.com/?l=vim-dev&amp;m=116578941422995&amp;w=2</a>
(Keep clicking on the "[next in thread]", it goes on for a ways).
</p>

<p>
The vim-dev folks are amazingly friendly and helpful, and explained
the various aspects of the problem. The timeout behavior is needed
because as you can see from ":set termcap" when TERM=xterm, there
are a bunch of terminal keys whose escape sequence starts with Esc O,
so vim has to wait for potentially more input before deciding there isn't
any and opening up the new line in insert mode.
The simplest workaround is to decrease the "ttimeoutlen" setting
  :set ttimeoutlen=250
when using TERM=xterm locally. Over remote connection, sticking with
the vim defaults and waiting a bit after pressing Esc O would be safer.
</p>

<p>
Cheers,
Peter.
</p>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-vim">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b>Rick Moen [rick at linuxmafia.com]</b><br />
<b>Mon, 11 Dec 2006 18:21:55 -0800</b>
</p>

<p>
Quoting Peter Knaggs (peter.knaggs@gmail.com):
</p>


<pre>
&gt; I'm here at Rick's conspire linux meeting, and got a lot of hints:
</pre>

<p>
In case anyone's simultaneously confused by the above and also cares:
There's a Linux user group called CABAL that, for quite a few years
after losing its meeting space in San Francisco, has met, twice monthly,
at my and my wife's house, about 60km south of S.F.  It operates a
mailing list called (what else?) "conspire".
</p>


<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-vim">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b>Benjamin A. Okopnik [ben at linuxgazette.net]</b><br />
<b>Sat, 16 Dec 2006 18:23:56 -0600</b>
</p>

<p>
On Mon, Dec 11, 2006 at 03:26:24PM -0800, Peter Knaggs wrote:
</p>

<pre>
&gt; On 12/9/06, Benjamin A. Okopnik &lt;ben@linuxgazette.net&gt; wrote:
&gt; &gt; On Sat, Dec 09, 2006 at 07:21:37PM -0800, Peter Knaggs wrote:
&gt; &gt; &gt; On 12/9/06, Benjamin A. Okopnik &lt;ben@linuxgazette.net&gt; wrote:
&gt; &gt; &gt;
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; Good job, Peter! You've hunted it down, clearly; I'd suggest reporting
&gt; &gt; &gt; &gt; it to the Vim maintainers.
&gt; 
&gt; OK. Here's the thread that was the result, it covers a lot of ground:
&gt; 
&gt; <a href="http://marc.theaimsgroup.com/?l=vim-dev&amp;m=116578941422995&amp;w=2">http://marc.theaimsgroup.com/?l=vim-dev&amp;m=116578941422995&amp;w=2</a>
&gt; (Keep clicking on the "[next in thread]", it goes on for a ways).
&gt; 
&gt; The vim-dev folks are amazingly friendly and helpful, and explained
&gt; the various aspects of the problem. The timeout behavior is needed
&gt; because as you can see from ":set termcap" when TERM=xterm, there
&gt; are a bunch of terminal keys whose escape sequence starts with Esc O,
&gt; so vim has to wait for potentially more input before deciding there isn't
&gt; any and opening up the new line in insert mode.
&gt; The simplest workaround is to decrease the "ttimeoutlen" setting
&gt;   :set ttimeoutlen=250
&gt; when using TERM=xterm locally. Over remote connection, sticking with
&gt; the vim defaults and waiting a bit after pressing Esc O would be safer.
</pre>

<p>
Interesting that you'd have to do that - and now I know the reason that
mine doesn't need it, although my TERM is indeed set to 'xterm'. I've
just looked at the above setting in my Vim, and -
</p>

<pre>
:set ttimeoutlen
  ttimeoutlen=-1
</pre>
According to Vim:
</p>

<pre>
'ttimeoutlen' 'ttm'  number  (default -1)
                     global
                     {not in Vi}
   The time in milliseconds that is waited for a key code or mapped key
   sequence to complete.  Also used for CTRL-\ CTRL-N and CTRL-\ CTRL-G
   when part of a command has been typed.
   Normally only 'timeoutlen' is used and 'ttimeoutlen' is -1.  When a
   different timeout value for key codes is desired set 'ttimeoutlen' to
   a non-negative number.
 
[ ... ]
</pre>
My 'timeoutlen' is set to 1000, but that does not appear to create the
problem you're describing.
</p>


<pre>-- 
* Ben Okopnik * Editor-in-Chief, Linux Gazette * <a href="http://LinuxGazette.NET">http://LinuxGazette.NET</a> *
</pre>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-vim">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b>Peter Knaggs [peter.knaggs at gmail.com]</b><br />
<b>Sat, 16 Dec 2006 23:11:28 -0800</b>
</p>

<p>
On 12/16/06, Benjamin A. Okopnik &lt;ben@linuxgazette.net&gt; wrote:
</p>

<pre>
&gt; On Mon, Dec 11, 2006 at 03:26:24PM -0800, Peter Knaggs wrote:
&gt; &gt; On 12/9/06, Benjamin A. Okopnik &lt;ben@linuxgazette.net&gt; wrote:
&gt; &gt; &gt; On Sat, Dec 09, 2006 at 07:21:37PM -0800, Peter Knaggs wrote:
&gt; &gt; &gt; &gt; On 12/9/06, Benjamin A. Okopnik &lt;ben@linuxgazette.net&gt; wrote:
&gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt;
&gt; &gt; &gt; &gt; &gt; Good job, Peter! You've hunted it down, clearly; I'd suggest reporting
&gt; &gt; &gt; &gt; &gt; it to the Vim maintainers.
&gt; &gt;
&gt; &gt; OK. Here's the thread that was the result, it covers a lot of ground:
&gt; &gt;
&gt; &gt; <a href="http://marc.theaimsgroup.com/?l=vim-dev&amp;m=116578941422995&amp;w=2">http://marc.theaimsgroup.com/?l=vim-dev&amp;m=116578941422995&amp;w=2</a>
&gt; &gt; (Keep clicking on the "[next in thread]", it goes on for a ways).
&gt; &gt;
&gt; &gt; The vim-dev folks are amazingly friendly and helpful, and explained
&gt; &gt; the various aspects of the problem. The timeout behavior is needed
&gt; &gt; because as you can see from ":set termcap" when TERM=xterm, there
&gt; &gt; are a bunch of terminal keys whose escape sequence starts with Esc O,
&gt; &gt; so vim has to wait for potentially more input before deciding there isn't
&gt; &gt; any and opening up the new line in insert mode.
&gt; &gt; The simplest workaround is to decrease the "ttimeoutlen" setting
&gt; &gt;   :set ttimeoutlen=250
&gt; &gt; when using TERM=xterm locally. Over remote connection, sticking with
&gt; &gt; the vim defaults and waiting a bit after pressing Esc O would be safer.
&gt;
&gt; Interesting that you'd have to do that - and now I know the reason that
&gt; mine doesn't need it, although my TERM is indeed set to 'xterm'. I've
&gt; just looked at the above setting in my Vim, and -
&gt;
&gt; ``
&gt; :set ttimeoutlen
&gt;   ttimeoutlen=-1
&gt; ''
&gt;
&gt; According to Vim:
&gt;
&gt; ``
&gt; 'ttimeoutlen' 'ttm'  number  (default -1)
&gt;                      global
&gt;                      {not in Vi}
&gt;    The time in milliseconds that is waited for a key code or mapped key
&gt;    sequence to complete.  Also used for CTRL-\ CTRL-N and CTRL-\ CTRL-G
&gt;    when part of a command has been typed.
&gt;    Normally only 'timeoutlen' is used and 'ttimeoutlen' is -1.  When a
&gt;    different timeout value for key codes is desired set 'ttimeoutlen' to
&gt;    a non-negative number.
&gt;
&gt; [ ... ]
&gt; ''
&gt;
&gt; My 'timeoutlen' is set to 1000, but that does not appear to create the
&gt; problem you're describing.
</pre>

<p>
It involves some nifty-fast typing, but if you try this sequence over a few
times in an empty vim session, you'll eventually get it to produce a "*"
instead of the expected "j" if your TERM=xterm and you haven't modified
the default timeoutlen or ttimeoutlen settings.
</p>

<pre>
   A Esc O j Esc
</pre>
One second seems like such a long time, but it even takes my
fingers a while to "warm up" enough to get it to give me an "*".
</p>

<p>
The thread
  <a href="http://marc.theaimsgroup.com/?l=vim-dev&amp;m=116578941422995&amp;w=2">http://marc.theaimsgroup.com/?l=vim-dev&amp;m=116578941422995&amp;w=2</a>
over on vim-dev shows some nifty tricks to type in the sequence really
fast, using vim's ":normal" command, and ends with an explanation
of where the mysterious "*" is coming from.
</p>

<p>
One way to be free of the bug by default is to use gvim, the graphical
vim from the package "vim-gnome", but that seems overkill compared
to just setting ttimeoutlen a little shorter. I've been setting it to 1 with
no bad consequences thus far.
</p>

<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-vim">Back</a><hr width="50%" align="left" /><p><br /></p></div>
</body>
</html>
