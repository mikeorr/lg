<!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.0 Transitional//EN'
		 'http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd'>
<html xmlns='http://www.w3.org/1999/xhtml' lang='utf-8' xml:lang='utf-8'>
<head>
<title>DNS Exploit: Fix for older Fedora machines??</title>
<meta http-equiv='Content-Type; charset=utf-8' />
<link rel='stylesheet' type='text/css' href='../../../lg.css' />
</head>
<body>
<a href="../../../"><img alt="Linux Gazette" src="../../../gx/2003/newlogo-blank-200-gold2.jpg" id="logo" /></a><img alt="Tux" src="../../../gx/tux_86x95_indexed.png" id="tux" /><p id="fun">...making Linux just a little more fun!</p><div class='content articlecontent'><a name="top"></a><h3>DNS Exploit: Fix for older Fedora machines??</h3>
<p>
<b><p>
Rick Moen [rick at linuxmafia.com]

</p>
</b><br />
<b>Thu, 24 Jul 2008 19:45:20 -0700</b>
</p>

<p>
Two posts that help clarify the threat model.
</p>

<p>
----- Forwarded message from Keith Owens &lt;kaos@ocs.com.au&gt; -----
</p>

<p>
X-Mailer: exmh version 2.7.2 01/07/2005 (debian 1:2.7.2-12) with nmh-1.2
<pre>
From: Keith Owens &lt;kaos@ocs.com.au&gt;
To: luv-main@luv.asn.au
Date: Fri, 25 Jul 2008 12:10:40 +1000
Subject: Re: DNS Exploit: Fix for older Fedora machines?? 
</pre>
"Leigh Sharpe" (on Fri, 25 Jul 2008 11:56:41 +1000) wrote:
</p>

<pre>
&gt; I have a couple of older FC2 machines running bind DNS. Is there an rpm
&gt;available with the fix for the recent DNS exploit? Or am I stuck with
&gt;the choice of compiling from source or upgrading the OS?
</pre>

<p>
You need a version of bind9 that is less than 2 months old.  bind8 is
not being fixed.  If Redhat do not have a recent bind9 for FC2 then get
the latest src.rpm and build your own.
</p>

<p>
Alternatively install a small machine running a newer OS with a fixed
DNS server and direct all DNS queries via that machine.  It is only the
final query (the one that hits the outside world) that needs to come
from a fixed DNS server.  Add firewall rules to block DNS queries from
any other machine to the outside world.
</p>

<p>
Also turn off recursion for DNS queries that come from outside your
site and are not for sites in your DNS.  One of the ways that attackers
are getting information is by issuing recursive requests to your DNS
and pointing back at their machines.  If you allow external recursive
requests then it is much easier for an attacker to get information
about your DNS's internal state.
</p>

<p>
Not sure how to turn off recursion for external requests?  See
<a href="http://www.cymru.com/Documents/secure-bind-template.html">http://www.cymru.com/Documents/secure-bind-template.html</a>
</p>


<p>
----- End forwarded message -----
----- Forwarded message from Keith Owens &lt;kaos@ocs.com.au&gt; -----
</p>

<p>
X-Mailer: exmh version 2.7.2 01/07/2005 (debian 1:2.7.2-12) with nmh-1.2
<pre>
From: Keith Owens &lt;kaos@ocs.com.au&gt;
To: James Harper &lt;james.harper@bendigoit.com.au&gt;
</pre>cc: luv-main@luv.asn.au
<pre>
Date: Fri, 25 Jul 2008 11:24:36 +1000
Subject: Re: DNS exploit: watch out for NAT boxes 
</pre>
"James Harper" (on Fri, 25 Jul 2008 11:04:15 +1000) wrote:
</p>

<pre>
&gt;&gt; Even if your DNS server is using random ports (say 10978, 15737,
&gt;60925,
&gt;&gt; 24758 from a recent trace), the NAT box may map those random ports to
&gt;a
&gt;&gt; sequential sequence (say 12786, 12787, 12788, 12789).  This is a nasty
&gt;&gt; side effect of the way that some NAT boxes do the mapping from
&gt;internal
&gt;&gt; to external port numbers, many just pick the next free external port
&gt;&gt; number.  This effectively removes the effect of source port
&gt;&gt; randomization and you are left with just the 16 bits of the TXID for
&gt;&gt; protection.  That reduces the number of possible TXID/source port
&gt;&gt; combinations from 4294967296 to 65536 and makes it much easier for an
&gt;&gt; attacker to hack your DNS.  All right, maybe 65536*(a small number)
&gt;&gt; possibilities.
&gt;
&gt;Doesn't the attacker still have to guess the port number though? If the
&gt;attacker knew that the box had just started up it could make some
&gt;assumptions about the port number being low, but apart from that, a
&gt;series of incrementing numbers is still 'random' as far as a third party
&gt;is concerned, unless that third party can somehow gain some insight into
&gt;where in the sequence your nat box is up to, and if they could do that
&gt;then you are probably pwned already.
</pre>

<p>
All the exploits start by making a query using your DNS, either a
direct query from outside or via some external code that generates a
DNS query from inside.  If the initial query is from inside (say a link
on a poisoned web page which you view) then that gives the attacker a
starting point for the source port sequence.  You are not pwned at that
stage, it is just a normal DNS operation.
</p>


<pre>
&gt;It might be a good idea to make sure your firewall isn't sending any
&gt;responses to undeliverable udp packets too, as that would be giving the
&gt;attacker information they could use, eg by finding a port that is
&gt;accepting udp responses they might be able to determine where in the
&gt;sequence you are up to...
</pre>

<p>
A NAT box will only accept a UDP packet if it matches the entire tuple
of source IP, source port, destination IP and destination port.  While
the last two are fixed (your IP, port 53) the attacker would have to
use a valid source IP and port to get a response from an open port and,
by definition, that response will then go the source IP of the query,
not to the attacker.  IOW, mapping which ports are open to the attacker
gives no information about which ports are open to other IP addresses
and vice versa.
</p>

<p>
Of course, you are still vulnerable to man in the middle attacks from
anybody who can intercept your packets upstream.  Unfortunately that is
true even with the DNS fixes.  AFAIK the only way of avoiding MIM
attacks on DNS over open circuits is to use DNSSEC.
</p>

<p>
----- End forwarded message -----
</p>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail2.html#mb-dns_exploit__fix_for_older_fedora_machines">Back</a><hr width="50%" align="left" /><p><br /></p></div>
</body>
</html>