<!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.0 Transitional//EN'
		 'http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd'>
<html xmlns='http://www.w3.org/1999/xhtml' lang='utf-8' xml:lang='utf-8'>
<head>
<title>Odd system load situation</title>
<meta http-equiv='Content-Type' content='text/html; charset=utf-8' />
<link rel='stylesheet' type='text/css' href='../../../lg.css' />
</head>
<body>
<a href="../../../"><img alt="Linux Gazette" src="../../../gx/2003/newlogo-blank-200-gold2.jpg" id="logo" /></a><img alt="Tux" src="../../../gx/tux_86x95_indexed.png" id="tux" /><p id="fun">...making Linux just a little more fun!</p><div class='content articlecontent'><a name="top"></a><h3>Odd system load situation</h3>
<p>
<b><p>
Ben Okopnik [ben at linuxgazette.net]
</p>

<p>

</p>
</b><br />
<b>Mon, 10 Jan 2011 21:21:19 -0500</b>
</p>

<p>
Hi, all -
</p>

<p>
I've got something odd going on, and I'm trying to get some perspective
on it. Perhaps someone here can cast a light.
</p>

<p>
I'm running a long-term rsync job (a full backup, after way too long of
a hiatus. I know - <strong>really</strong> *bad* for someone who hounds people to keep
on top of their backups professionally... but you know the saying about
the cobbler's kids being the last to have new shoes.) It's copying the
files to an external drive, connected via USB. Here's the problem: now
that it's running, my system has become extremely "sensitive" to any
additional loads - even very light ones. Firing up an xterm visibly
spikes the CPU (which, with nothing more than two xterms open, is
running at a load average of ~4.) Starting 'vim' takes about 4 seconds.
Opening a PDF with the rather lightweight 'xpdf' takes about 9 seconds.
Reformatting a paragraph in 'vim' turns the xterm gray for a good 5
seconds and almost freezes the cursor. Opening Firefox <em>does</em> freeze the
cursor and prevents me from being able to tab between open applications
for a good 30 seconds - and when it's open, the system is essentially
useless for anything else. Needless to say, all but the last one are
usually nearly instant, and Firefox normally takes just a couple of
seconds, and doesn't lock anything up while loading.
</p>

<p>
Here's the kicker: "top" shows... nothing particularly unusual.
vmstat/iostat report essentially the same story.
</p>

<p>
<pre class='code'>
$ (vmstat -a;iostat)
procs -----------memory---------- ---swap-- -----io---- -system-- ----cpu----
 r  b   swpd   free  inact active   si   so    bi    bo   in   cs us sy id wa
 2  2 492908  15776 580684 341224    3    4    14     9    2   21 17  4 74  6
Linux 2.6.31-22-generic (Jotunheim)     01/10/2011      <em>i686</em>  (2 CPU)
 
avg-cpu:  %user   %nice %system %iowait  %steal   %idle
          16.70    0.20    3.81    5.71    0.00   73.59
 
Device:            tps   Blk_read/s   Blk_wrtn/s   Blk_read   Blk_wrtn
sda               3.27       131.12        48.13  219433573   80544152
sdb               0.62         0.85        72.43    1429100  121212480
</pre>

<p>
Memory usage is reasonable, swap is barely being touched, the CPU is
spending 3/4 of its time being idle, even the number of context switches
is very reasonable as compared to the I/O rate. If I saw this on a
remote machine, I'd figure it was being under-utilized. :\ 
</p>

<p>
Now, it is true that I'm not running some mad smokin' powerhouse machine
that requires a dedicated nuclear power plant:
</p>

<p>
<pre class='code'>
$ cat /proc/cpuinfo|egrep '^(processor|model name)'
processor       : 0
model name      : Intel(R) Atom(TM) CPU N270   @ 1.60GHz
processor       : 1
model name      : Intel(R) Atom(TM) CPU N270   @ 1.60GHz
$ cat /proc/meminfo|grep MemTotal
MemTotal:        1016764 kB
</pre>

<p>
It's just a little Acer laptop... but this is usually enough for pretty
much anything I need, including serving fairly heavy-duty Perl and PHP
scripting via Apache. So... what's going on? What is "rsync" doing that
is essentially invisible but is enough to make this thing behave like a
286 with 64k of memory? I thought I understood what the above numbers
mean, and could reasonably estimate system state from them - but it
seems that I'm wrong.
</p>

<p>
Does anyone see anything that I'm missing? Or is there another place I
should be looking?
</p>


<pre>-- 
* Ben Okopnik * Editor-in-Chief, Linux Gazette * <a href='http://LinuxGazette.NET'>http://LinuxGazette.NET</a> *
</pre>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-odd_system_load_situation">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
afsilva at gmail.com [(afsilva at gmail.com)]
</p>

<p>

</p>
</b><br />
<b>Mon, 10 Jan 2011 21:56:59 -0500</b>
</p>

<pre>
&gt;
&gt; Does anyone see anything that I'm missing? Or is there another place I
&gt; should be looking?
&gt;
</pre>

<p>
try this:
</p>

<p>
<a href='http://blog.internetnews.com/skerner/2010/11/forget-200-lines-red-hat-speed.html'>http://blog.internetnews.com/skerner/2010/11/forget-200-lines-red-hat-speed.html</a>
</p>

<p>
AS
</p>


<pre>-- 
<a href='http://www.the-silvas.com'>http://www.the-silvas.com</a>
</pre>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-odd_system_load_situation">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Ben Okopnik [ben at linuxgazette.net]
</p>

<p>

</p>
</b><br />
<b>Mon, 10 Jan 2011 22:42:48 -0500</b>
</p>

<p>
On Mon, Jan 10, 2011 at 09:56:59PM -0500, Anderson Silva wrote:
</p>

<pre>
&gt; &gt;
&gt; &gt; Does anyone see anything that I'm missing? Or is there another place I
&gt; &gt; should be looking?
&gt; 
&gt; try this:
&gt; 
&gt; <a href='http://blog.internetnews.com/skerner/2010/11/forget-200-lines-red-hat-speed.html'>http://blog.internetnews.com/skerner/2010/11/forget-200-lines-red-hat-speed.html</a>
</pre>

<pre>
if [ "$PS1" ] ; then
 
echo $$ &gt; /sys/fs/cgroup/cpu/user/$$/tasks
fi
Then, as the superuser do this:
 
mount -t cgroup cgroup /sys/fs/cgroup/cpu -o cpu
mkdir -m 0777 /sys/fs/cgroup/cpu/user
</pre>

<p>
Damn, that's pretty cool. However, it doesn't work for me:
</p>

<pre>
$ sudo mkdir -m 0700 /sys/fs/cgroup/cpu/user/$$
mkdir: cannot create directory `/sys/fs/cgroup/cpu/user/23436': No such file or directory
$ dir=/sys/fs/cgroup/cpu/user/$$; until [ -d "$dir" ]; do echo "Does not exist: $dir"; dir=${dir%/*}; done
Does not exist: /sys/fs/cgroup/cpu/user/23436
Does not exist: /sys/fs/cgroup/cpu/user
Does not exist: /sys/fs/cgroup/cpu
Does not exist: /sys/fs/cgroup
</pre>

<p>
Perhaps it takes a different kind of kernel option set or something.
Besides, 'sudo nice' would probably whack 'rsync' over the head and make
it behave... but that's not what the real problem is.
</p>

<p>
To put it in different words, if a remote user called you up and said
"my system is really dragging", how would you identify the problem if it
was this one? As far as the system tools are telling me, everything is
Just Peachy Keen - except that I see turtles passing my CPU at what
looks like jet speeds, and foot-thick geological strata are accreting
while it does a single NOP. It's making me doubt my sysadmin-fu.
</p>


<pre>-- 
* Ben Okopnik * Editor-in-Chief, Linux Gazette * <a href='http://LinuxGazette.NET'>http://LinuxGazette.NET</a> *
</pre>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-odd_system_load_situation">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Henry Grebler [henrygrebler at optusnet.com.au]
</p>

<p>

</p>
</b><br />
<b>Tue, 11 Jan 2011 15:14:21 +1100</b>
</p>

<p>
A smart doctor wouldn't treat you over the phone. Too much danger of
missing something.
</p>

<p>
But, I'm not a doctor, and nobody's health is at stake. So, if we
stipulate that, from this distance, I might not see the whole picture,
here's my take.
</p>

<p>
I guess you're sort of asking 2 questions: what is responsible for the
rotten performance? what can I do about it?
</p>

<p>
But first a digression <img src="../gx/smile.png" alt=":-)"> Back in the days of the DECsystem10 (maybe
also VAX/VMS), there were 3 top-like commands: TOPCPU, TOPBIO, TOPDIO.
TOPCPU was like top. Despite frequently looking, I have never found a
Linux command that matched the other 2 tops (buffered IO and direct
IO).
</p>

<p>
You can probably simulate your symptoms on most machines with
something like
</p>

<p>
	dd if=/dev/hda of=/dev/null
</p>

<p>
My theory is that rsync is hammering the disk bus. Whenever you try to
do something, disk is involved so it runs slowly. My suspicion is
that, if you had a CPU-bound job, you would notice no slowing down,
because there's CPU to spare.
</p>

<p>
Instead of a two CPUs, for this application you'd be better off with 2
paths to each disk. If you have another computer, you might be better
off attaching the USB disk to the other computer and doing the rsync
over the network.
</p>

<p>
Of course I could be entirely wrong, but try ^Z on the rsync and see
if everything else gets to be ok.
</p>

<p>
Sadly, "nice" is for CPU usage and I'm not aware of anything that does
the equivalent for IO. We want something that says, in effect, the
human at the keyboard is important. In the overall scheme of things,
humans actually don't take a lot of servicing, so prioritise the
human. The moment you detect a single keystroke or mouse movement,
pause any daemon or long running resource hog, and give the human your
full attention. If there is no human activity for, oh, 10 seconds,
then cause the paused job to continue. You could adjust the basic idea
so that even resource hogs got a bit of a look in.
</p>

<p>
You ought to be able to detect if the disk is utilising much of the io
bandwidth, because the disk light should be mainly on.
</p>

<p>
But, then again, I might have it completely wrong.
</p>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-odd_system_load_situation">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Ben Okopnik [ben at linuxgazette.net]
</p>

<p>

</p>
</b><br />
<b>Mon, 10 Jan 2011 23:56:04 -0500</b>
</p>

<p>
On Tue, Jan 11, 2011 at 03:14:21PM +1100, Henry Grebler wrote:
</p>

<pre>
&gt; 
&gt; A smart doctor wouldn't treat you over the phone. Too much danger of
&gt; missing something.
</pre>

<p>
There's a really serious problem with that analogy, though: a human
cannot return precise self-diagnostic measurements. A computer can.
 
</p>

<pre>
&gt; But, I'm not a doctor, and nobody's health is at stake. So, if we
&gt; stipulate that, from this distance, I might not see the whole picture,
&gt; here's my take.
</pre>

<p>
Hey, you're down there on the lower side of the planet, where you guys
have to magnetize your shoes to stay attached or something. If I'm
asking for a different perspective, who better? <img src="../gx/smile.png" alt=":)">
</p>


<pre>
&gt; I guess you're sort of asking 2 questions: what is responsible for the
&gt; rotten performance? what can I do about it?
</pre>

<p>
Yep - with the second (currently) being a lot less important than the
first. Actually, even the first breaks down further: "...and what can I
look at that is a specific indicator of that rotten performance?"
 
</p>

<pre>
&gt; My theory is that rsync is hammering the disk bus.
</pre>

<p>
Except that 'iostat' should show that. Besides, why would a running
instance of Firefox (which I can't imagine doing a whole bunch of I/O,
especially while it's not being used) bring everything to a screaming
halt in that case?
</p>

<p>
<pre class='code'>
$ iostat -dkz
Linux 2.6.31-22-generic (Jotunheim)     01/10/2011      <em>i686</em>  (2 CPU)
 
Device:            tps    kB_read/s    kB_wrtn/s    kB_read    kB_wrtn
sda               3.36        70.90        24.07  119328822   40504964
sdb               0.71         0.52        41.38     879590   69641056
</pre>

<p>
That's the rate in <strong>kilobytes</strong> per second (sda is my /, and sdb is the
external drive.)
</p>

<p>
I've just restarted 'rsync' with a '--progress' option, and here's what
that looks like:
</p>

<pre>
...
ben/Music/Bach - Lifescapes/05 - Allegro (from Viola da Gamba Sonata in Gm).mp3
     3248339 100%  642.02kB/s    0:00:04 (xfer#100, to-check=1023/329223)
ben/Music/Bach - Lifescapes/06 - Andante (from Sonata for Violin in Am).mp3
     5043474 100%    1.11MB/s    0:00:04 (xfer#101, to-check=1022/329223)
ben/Music/Bach - Lifescapes/07 - Wachet Auf.mp3
     4196271 100%    2.88MB/s    0:00:01 (xfer#102, to-check=1021/329223)
ben/Music/Bach - Lifescapes/08 - Allegro (from Concerto for Oboe &amp; Violin in Cm).mp3
     5174295 100%  998.42kB/s    0:00:05 (xfer#103, to-check=1020/329223)
ben/Music/Bach - Lifescapes/09 - Adagio &amp; Allegro (from Viola da Gamba Sonata in D).mp3
     4826553 100%  677.02kB/s    0:00:06 (xfer#104, to-check=1019/329223)
ben/Music/Bach - Lifescapes/10 - Sarabande (from Violin Partita in Dm).mp3
     4276519 100%    1.86MB/s    0:00:02 (xfer#105, to-check=1018/329223)
ben/Music/Bach - Lifescapes/11 - Nun Komm der Heiden Heilund.mp3
     4377665 100%  675.47kB/s    0:00:06 (xfer#106, to-check=1017/329223)
ben/Music/Bach - Lifescapes/12 - Gavotte (from Violin Partita in E).mp3
     3596081 100%  688.59kB/s    0:00:05 (xfer#107, to-check=1016/329223)
ben/Music/Bach - Lifescapes/13 - Fantasia in Am.mp3
     5079000 100%  935.67kB/s    0:00:05 (xfer#108, to-check=1015/329223)
...
</pre>

<p>
No huge network transfer speeds there. I mean, it's going over USB -
that's enough of a bottleneck that the system bus shouldn't even notice
it! Now, it could be that the USB code is hammering the kernel in some
weird way... but how it could do so without showing up on the CPU is
beyond me.
</p>


<pre>
&gt; Whenever you try to
&gt; do something, disk is involved so it runs slowly. My suspicion is
&gt; that, if you had a CPU-bound job, you would notice no slowing down,
&gt; because there's CPU to spare.
</pre>

<p>
Same deal; 'iostat' would show it.
</p>

<p>
<pre class='code'>
iostat -c
Linux 2.6.31-22-generic (Jotunheim)     01/10/2011      <em>i686</em>  (2 CPU)
 
avg-cpu:  %user   %nice %system %iowait  %steal   %idle
          16.59    0.23    3.82    6.38    0.00   72.98
</pre>
 
It's just about asleep.
</p>


<pre>
&gt; Instead of a two CPUs, for this application you'd be better off with 2
&gt; paths to each disk. If you have another computer, you might be better
&gt; off attaching the USB disk to the other computer and doing the rsync
&gt; over the network.
</pre>

<p>
Nope, don't have one on board. I used to have two of these laptops - one
as a backup - but one died. Which reminds me - gotta get a replacement
sometime soon.
 
</p>

<pre>
&gt; Of course I could be entirely wrong, but try ^Z on the rsync and see
&gt; if everything else gets to be ok.
</pre>

<p>
Yep. Load average starts dropping right away, etc.
 
</p>

<pre>
&gt; You ought to be able to detect if the disk is utilising much of the io
&gt; bandwidth, because the disk light should be mainly on.
</pre>

<p>
Bursts of activity, along with multi-second pauses - as expected.
 
</p>

<pre>
&gt; But, then again, I might have it completely wrong.
</pre>

<p>
Hey, welcome to my club. :-} I'm clearly completely wrong in what I'm
thinking, and can't find a way to re-init my thinking process; that's
the worst kind of wrong for this sort of work. That's why I'm asking,
anyway.
</p>

<p>
I really do appreciate the input, though - it's really useful to see
that I'm not the only one thinking along this kind of track!
</p>


<pre>-- 
* Ben Okopnik * Editor-in-Chief, Linux Gazette * <a href='http://LinuxGazette.NET'>http://LinuxGazette.NET</a> *
</pre>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-odd_system_load_situation">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Mulyadi Santosa [mulyadi.santosa at gmail.com]
</p>

<p>

</p>
</b><br />
<b>Tue, 11 Jan 2011 12:25:21 +0700</b>
</p>

<p>
Dear Ben...
</p>

<p>
On Tue, Jan 11, 2011 at 09:21, Ben Okopnik &lt;ben at linuxgazette.net&gt; wrote:
</p>

<pre>
&gt; I'm running a long-term rsync job (a full backup, after way too long of
&gt; a hiatus. I know - <strong>really</strong> *bad* for someone who hounds people to keep
&gt; on top of their backups professionally... but you know the saying about
&gt; the cobbler's kids being the last to have new shoes.) It's copying the
&gt; files to an external drive, connected via USB. Here's the problem: now
&gt; that it's running, my system has become extremely "sensitive" to any
&gt; additional loads - even very light ones. Firing up an xterm visibly
&gt; spikes the CPU (which, with nothing more than two xterms open, is
&gt; running at a load average of ~4.) Starting 'vim' takes about 4 seconds.
</pre>
&lt;............ and lots other......&gt;
</p>

<p>
Here's my advices:
- switch the I/O scheduler. Specifically for the external drive,
switch to "deadline"....avoid cfq since sometimes the timeslicing
isn't so good.
</p>

<p>
- make sure you mount the external drive using "async" and add
"relatime" too. Updating access time sometimes sucks....
</p>

<p>
- Is it using journalling I/O? try to switch it off temporarily (e.g
mount it as ext2 instead off ext3), or you could just mount it in
writeback mode (assuming it's ext3)
</p>

<p>
That's in userland, in kernel space, not much we can do but things like:
- use latest stable...not the longterm ones....I believe backporting
is a pain in the ass. Better use latest one....but avoid -rc, -git,
-next etc since it will ruin your days :D
</p>

<p>
- make sure it's using highest HZ (1000 right now), full preemption
(CONFIG_PREEMPT=y) and using CONFIG_NO_HZ. The latter brough some
controversies, since most believes timer rearming does indeed another
latency, but I personally think it's negligible.
</p>

<p>
- Use con kolivas Brain Fuck Scheduler. It somewhat lower the latency
on every aspect of your latency issues (I/O, context switch, you name
it)
</p>

<p>
- This is really subjective, but if you have plenty of RAM, try to
lower your /proc/sys/vm/swappiness, try 10 or 20, so page cache aren't
flushed too often. It might help to prevent the kernel block layer to
re-read your block devices too much (in some degree, of course)
</p>

<p>
As a bonus, if you somewhat battery savvy, turns of USB suspend...that
just add slight latency....
</p>

<p>
-- 
regards,
</p>

<p>
Mulyadi Santosa
Freelance Linux trainer and consultant
</p>

<p>
blog: the-hydra.blogspot.com
training: mulyaditraining.blogspot.com
</p>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-odd_system_load_situation">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Ben Okopnik [ben at linuxgazette.net]
</p>

<p>

</p>
</b><br />
<b>Tue, 11 Jan 2011 01:01:07 -0500</b>
</p>

<p>
On Tue, Jan 11, 2011 at 12:25:21PM +0700, Mulyadi Santosa wrote:
</p>

<pre>
&gt; Dear Ben...
</pre>

<p>
Hey, Mulyadi!
 
</p>

<pre>
&gt; On Tue, Jan 11, 2011 at 09:21, Ben Okopnik &lt;ben at linuxgazette.net&gt; wrote:
&gt; &gt; I'm running a long-term rsync job (a full backup, after way too long of
&gt; &gt; a hiatus. I know - <strong>really</strong> *bad* for someone who hounds people to keep
&gt; &gt; on top of their backups professionally... but you know the saying about
&gt; &gt; the cobbler's kids being the last to have new shoes.) It's copying the
&gt; &gt; files to an external drive, connected via USB. Here's the problem: now
&gt; &gt; that it's running, my system has become extremely "sensitive" to any
&gt; &gt; additional loads - even very light ones. Firing up an xterm visibly
&gt; &gt; spikes the CPU (which, with nothing more than two xterms open, is
&gt; &gt; running at a load average of ~4.) Starting 'vim' takes about 4 seconds.
&gt; &lt;............ and lots other......&gt;
&gt; 
&gt; Here's my advices:
</pre>

<p>
Well, all of this tries to address problem #2 (per Henry's email); "how
to fix". OK, this isn't a bad thing - but right now, I'm still on "how
to diagnose reliably".
</p>


<pre>
&gt; - switch the I/O scheduler. Specifically for the external drive,
&gt; switch to "deadline"....avoid cfq since sometimes the timeslicing
&gt; isn't so good.
</pre>

<p>
This might actually be a decent idea for handling it. If we make the
assumption that I/O <strong>priority</strong> is being given to the USB transfer, then
- despite the relatively low I/O rate - that might explain everything
grinding to a halt. That's the first glimmer of a possibility that I've
seen so far - definitely worth exploring!
</p>


<pre>
&gt; - make sure you mount the external drive using "async" and add
&gt; "relatime" too. Updating access time sometimes sucks....
</pre>

<p>
As I understand it, "relatime" has been the default for a while now.
</p>

<p>
<pre class='code'>
$ perl -wle'print scalar localtime((stat "/etc/passwd")[8])'
Mon Jan 10 16:25:01 2011
$ cat /etc/passwd &gt; /dev/null
$ perl -wle'print scalar localtime((stat "/etc/passwd")[8])'
Mon Jan 10 16:25:01 2011
</pre>

<p>
Right, no change in atime after reading the file.
</p>


<pre>
&gt; - Is it using journalling I/O? try to switch it off temporarily (e.g
&gt; mount it as ext2 instead off ext3), or you could just mount it in
&gt; writeback mode (assuming it's ext3)
</pre>

<p>
The external drive? It's just plain ext2. Journalling would be too much
of a good thing for a backup drive. <img src="../gx/smile.png" alt=":)">
</p>


<pre>
&gt; That's in userland, in kernel space, not much we can do but things like:
&gt; - use latest stable...not the longterm ones....I believe backporting
&gt; is a pain in the ass. Better use latest one....but avoid -rc, -git,
&gt; -next etc since it will ruin your days :D
&gt;
&gt; - make sure it's using highest HZ (1000 right now), full preemption
&gt; (CONFIG_PREEMPT=y) and using CONFIG_NO_HZ. The latter brough some
&gt; controversies, since most believes timer rearming does indeed another
&gt; latency, but I personally think it's negligible.
&gt; 
&gt; - Use con kolivas Brain Fuck Scheduler. It somewhat lower the latency
&gt; on every aspect of your latency issues (I/O, context switch, you name
&gt; it)
</pre>

<p>
Heh. That's a bit too much work... I can't see this becoming a huge
issue; I just want to know what's going on, and how to reliably diagnose
it.
 
</p>

<pre>
&gt; - This is really subjective, but if you have plenty of RAM, try to
&gt; lower your /proc/sys/vm/swappiness, try 10 or 20, so page cache aren't
&gt; flushed too often. It might help to prevent the kernel block layer to
&gt; re-read your block devices too much (in some degree, of course)
</pre>

<p>
Nice! I don't have a huge amount of RAM, but a little to spare at least.
Just tried it... doesn't seem to make any difference, unfortunately.
 
</p>

<pre>
&gt; As a bonus, if you somewhat battery savvy, turns of USB suspend...that
&gt; just add slight latency....
</pre>

<p>
Well, I don't think that trying to tune this is the answer; it's a
pretty "binary" type of problem, where running this thing just whacks my
system - and it really shouldn't.
</p>

<p>
Just for more data, I stopped 'rsync' and tried a simple 'cp' on a large
directory. Yeah, it does about the same thing; the load average shoots
right up - BUT, starting up a browser, although slow, does not make the
system grind to a halt (in fact, I'm typing this at my normal speed,
which I wouldn't have been able to do with rsync and FF running.) 
</p>


<pre>-- 
* Ben Okopnik * Editor-in-Chief, Linux Gazette * <a href='http://LinuxGazette.NET'>http://LinuxGazette.NET</a> *
</pre>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-odd_system_load_situation">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Mulyadi Santosa [mulyadi.santosa at gmail.com]
</p>

<p>

</p>
</b><br />
<b>Tue, 11 Jan 2011 13:20:57 +0700</b>
</p>

<p>
Hi Ben <img src="../gx/smile.png" alt=":)">
</p>

<p>
Shall we go straight to your last paragraph? :D
</p>

<p>
On Tue, Jan 11, 2011 at 13:01, Ben Okopnik &lt;ben at linuxgazette.net&gt; wrote:
</p>

<pre>
&gt; Just for more data, I stopped 'rsync' and tried a simple 'cp' on a large
&gt; directory. Yeah, it does about the same thing; the load average shoots
&gt; right up - BUT, starting up a browser, although slow, does not make the
&gt; system grind to a halt (in fact, I'm typing this at my normal speed,
&gt; which I wouldn't have been able to do with rsync and FF running.)
</pre>

<p>
I read somewhere that it's the rsync algorithm itself that in some
degree slow down things, quite likely it's "finding the difference"
algorithm (that's how I name it). It could be worse with compression
IMHO.
</p>

<p>
So, getting rid of rsync and simply use cp might be the answer.
</p>

<p>
As to pin point it, I think you need tools like oprofile or systemtap
or ftrace. Oh wait, I forgot to mention latencytop too...have you
tried it? It has some dependencies in several kernel features, so just
check it out. Plus iotop and/or dstat I guess....
</p>

<p>
-- 
regards,
</p>

<p>
Mulyadi Santosa
Freelance Linux trainer and consultant
</p>

<p>
blog: the-hydra.blogspot.com
training: mulyaditraining.blogspot.com
</p>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-odd_system_load_situation">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Ben Okopnik [ben at okopnik.com]
</p>

<p>

</p>
</b><br />
<b>Tue, 11 Jan 2011 01:40:20 -0500</b>
</p>

<p>
On Tue, Jan 11, 2011 at 01:20:57PM +0700, Mulyadi Santosa wrote:
</p>

<pre>
&gt; Hi Ben <img src="../gx/smile.png" alt=":)">
&gt; 
&gt; Shall we go straight to your last paragraph? :D
</pre>

<p>
Works for me. <img src="../gx/smile.png" alt=":)">
 
</p>

<pre>
&gt; I read somewhere that it's the rsync algorithm itself that in some
&gt; degree slow down things, quite likely it's "finding the difference"
&gt; algorithm (that's how I name it). It could be worse with compression
&gt; IMHO.
&gt; 
&gt; So, getting rid of rsync and simply use cp might be the answer.
</pre>

<p>
Whoops - can't do that. I'm using 'rsync' specifically for the features
that 'cp' doesn't have. I suppose I could do the initial, full backup
with 'cp -a', but the subsequent incrementals aren't going to be all
that small.
 
</p>

<pre>
&gt; As to pin point it, I think you need tools like oprofile or systemtap
&gt; or ftrace. Oh wait, I forgot to mention latencytop too...have you
&gt; tried it? 
</pre>

<p>
Wow. Would you believe I've never used of any of those? I think I've
heard of 'oprofile', at least. I'll check'em out - thanks!
</p>


<pre>
&gt; It has some dependencies in several kernel features, so just
&gt; check it out. Plus iotop and/or dstat I guess....
</pre>

<p>
I just tried these two out - oh, cool! <img src="../gx/smile.png" alt=":)"> Two more nifty gadgets for my
toolbox. I particularly like 'iotop' ('dstat' is cute and colorful, but
easily done with a simple shell script.)
</p>


<pre>-- 
                       OKOPNIK CONSULTING
        Custom Computing Solutions For Your Business
Expert-led Training | Dynamic, vital websites | Custom programming
  443-250-7895   <a href='http://okopnik.com'>http://okopnik.com</a>   <a href='http://twitter.com/okopnik'>http://twitter.com/okopnik</a>
</pre>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-odd_system_load_situation">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Mulyadi Santosa [mulyadi.santosa at gmail.com]
</p>

<p>

</p>
</b><br />
<b>Tue, 11 Jan 2011 14:30:36 +0700</b>
</p>

<p>
On Tue, Jan 11, 2011 at 13:40, Ben Okopnik &lt;ben at okopnik.com&gt; wrote:
</p>

<pre>
&gt;&gt; It has some dependencies in several kernel features, so just
&gt;&gt; check it out. Plus iotop and/or dstat I guess....
&gt;
&gt; I just tried these two out - oh, cool! <img src="../gx/smile.png" alt=":)"> Two more nifty gadgets for my
&gt; toolbox. I particularly like 'iotop' ('dstat' is cute and colorful, but
&gt; easily done with a simple shell script.)
</pre>

<p>
Nice <img src="../gx/smile.png" alt=":)"> Indeed, it's a must for every admin now...oh wait, let me
clarify that...even casual users should know about them <img src="../gx/smile.png" alt=":)">
</p>

<p>
IMO, Linux really shines in monitoring aspects lately. Once (i'm sure
you agree), we're just left with top, vmstat and ps. Now, we have
more. of course, old saying still apply here "it's not about the gun,
but the man behind the gun" <img src="../gx/smile.png" alt=":)">
</p>

<p>
-- 
regards,
</p>

<p>
Mulyadi Santosa
Freelance Linux trainer and consultant
</p>

<p>
blog: the-hydra.blogspot.com
training: mulyaditraining.blogspot.com
</p>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-odd_system_load_situation">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Kapil Hari Paranjape [kapil at imsc.res.in]
</p>

<p>

</p>
</b><br />
<b>Tue, 11 Jan 2011 19:39:32 +0530</b>
</p>

<p>
Hello,
</p>

<p>
On Tue, 11 Jan 2011, Ben Okopnik wrote:
</p>

<pre>
&gt; &gt; So, getting rid of rsync and simply use cp might be the answer.
&gt; 
&gt; Whoops - can't do that. I'm using 'rsync' specifically for the features
&gt; that 'cp' doesn't have. I suppose I could do the initial, full backup
&gt; with 'cp -a', but the subsequent incrementals aren't going to be all
&gt; that small.
</pre>

<p>
Note that the delta-xfer mechanism is <em>not</em> used when source and
destination are local (as there is no transfer of data taking place!);
in this case the "-W" switch is the default.
</p>

<p>
Is there really much[*] of a difference between "rsync -a /src/. dst/."
the following?
</p>

<p>
 Step 1. Compute the list of files that are newer (time-stamp only) or do
 not exist in /src/.
</p>

<p>
 Step 2. Apply a (cd /src/; cp -a ${list} /dst/; cd -)
</p>

<p>
Regards,
</p>

<p>
Kapil.
</p>

<p>
[*] OK. "rsync" does not delete/unlink files before it has finished
copying them which is safer for a backup.
--
</p>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-odd_system_load_situation">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Ben Okopnik [ben at linuxgazette.net]
</p>

<p>

</p>
</b><br />
<b>Tue, 11 Jan 2011 11:05:01 -0500</b>
</p>

<p>
On Tue, Jan 11, 2011 at 07:39:32PM +0530, Kapil Hari Paranjape wrote:
</p>

<pre>
&gt; Hello,
&gt; 
&gt; On Tue, 11 Jan 2011, Ben Okopnik wrote:
&gt; &gt; &gt; So, getting rid of rsync and simply use cp might be the answer.
&gt; &gt; 
&gt; &gt; Whoops - can't do that. I'm using 'rsync' specifically for the features
&gt; &gt; that 'cp' doesn't have. I suppose I could do the initial, full backup
&gt; &gt; with 'cp -a', but the subsequent incrementals aren't going to be all
&gt; &gt; that small.
&gt; 
&gt; Note that the delta-xfer mechanism is <em>not</em> used when source and
&gt; destination are local (as there is no transfer of data taking place!);
&gt; in this case the "-W" switch is the default.
</pre>

<p>
I figured that out in the process of watching 'rsync' run after enabling
'--progress'. The files that had changed - that I knew had only been
appended to, in fact - were being recopied whole.
 
</p>

<pre>
&gt; Is there really much[*] of a difference between "rsync -a /src/. dst/."
&gt; the following?
&gt; 
&gt;  Step 1. Compute the list of files that are newer (time-stamp only) or do
&gt;  not exist in /src/.
</pre>

<p>
You mean 'cp -u' ? <img src="../gx/smile.png" alt=":)">
</p>


<pre>
&gt; [*] OK. "rsync" does not delete/unlink files before it has finished
&gt; copying them which is safer for a backup.
</pre>

<p>
Not much of an issue, since I'm not deleting the source files.
</p>

<p>
'rsync' has <strong>many</strong> other advantages, though. If I found that the system
<strong>was</strong> I/O bound, I could use --bwlimit=NNN to limit it to a set kB/s. I
can watch its progress. I can easily filter the file list to ignore,
say, cache directories and stuff that I already have backed up
elsewhere. I can print a change summary update at the end of the run.
Handling sparse files is easy. I can do a dry run that'll show me
what'll get done. I can prune empty directories.  And, yes, I always
have the option of shifting the whole shebang onto a remote machine just
by adding a hostname and a colon.
</p>

<p>
'cp' has some pretty good options - most people have no idea what it can
really do - but it would have to pump a lot of iron and climb a lot of
mountains to even begin to compete with 'rsync'.
</p>


<pre>-- 
* Ben Okopnik * Editor-in-Chief, Linux Gazette * <a href='http://LinuxGazette.NET'>http://LinuxGazette.NET</a> *
</pre>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-odd_system_load_situation">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Ben Okopnik [ben at linuxgazette.net]
</p>

<p>

</p>
</b><br />
<b>Tue, 11 Jan 2011 11:05:01 -0500</b>
</p>

<p>
On Tue, Jan 11, 2011 at 07:39:32PM +0530, Kapil Hari Paranjape wrote:
</p>

<pre>
&gt; Hello,
&gt; 
&gt; On Tue, 11 Jan 2011, Ben Okopnik wrote:
&gt; &gt; &gt; So, getting rid of rsync and simply use cp might be the answer.
&gt; &gt; 
&gt; &gt; Whoops - can't do that. I'm using 'rsync' specifically for the features
&gt; &gt; that 'cp' doesn't have. I suppose I could do the initial, full backup
&gt; &gt; with 'cp -a', but the subsequent incrementals aren't going to be all
&gt; &gt; that small.
&gt; 
&gt; Note that the delta-xfer mechanism is <em>not</em> used when source and
&gt; destination are local (as there is no transfer of data taking place!);
&gt; in this case the "-W" switch is the default.
</pre>

<p>
I figured that out in the process of watching 'rsync' run after enabling
'--progress'. The files that had changed - that I knew had only been
appended to, in fact - were being recopied whole.
 
</p>

<pre>
&gt; Is there really much[*] of a difference between "rsync -a /src/. dst/."
&gt; the following?
&gt; 
&gt;  Step 1. Compute the list of files that are newer (time-stamp only) or do
&gt;  not exist in /src/.
</pre>

<p>
You mean 'cp -u' ? <img src="../gx/smile.png" alt=":)">
</p>


<pre>
&gt; [*] OK. "rsync" does not delete/unlink files before it has finished
&gt; copying them which is safer for a backup.
</pre>

<p>
Not much of an issue, since I'm not deleting the source files.
</p>

<p>
'rsync' has <strong>many</strong> other advantages, though. If I found that the system
<strong>was</strong> I/O bound, I could use --bwlimit=NNN to limit it to a set kB/s. I
can watch its progress. I can easily filter the file list to ignore,
say, cache directories and stuff that I already have backed up
elsewhere. I can print a change summary update at the end of the run.
Handling sparse files is easy. I can do a dry run that'll show me
what'll get done. I can prune empty directories.  And, yes, I always
have the option of shifting the whole shebang onto a remote machine just
by adding a hostname and a colon.
</p>

<p>
'cp' has some pretty good options - most people have no idea what it can
really do - but it would have to pump a lot of iron and climb a lot of
mountains to even begin to compete with 'rsync'.
</p>


<pre>-- 
* Ben Okopnik * Editor-in-Chief, Linux Gazette * <a href='http://LinuxGazette.NET'>http://LinuxGazette.NET</a> *
</pre>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-odd_system_load_situation">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Kapil Hari Paranjape [kapil at imsc.res.in]
</p>

<p>

</p>
</b><br />
<b>Tue, 11 Jan 2011 21:57:57 +0530</b>
</p>

<p>
Hello,
</p>

<p>
On Tue, 11 Jan 2011, Ben Okopnik wrote:
</p>

<pre>
&gt; On Tue, Jan 11, 2011 at 07:39:32PM +0530, Kapil Hari Paranjape wrote:
&gt; &gt;  Step 1. Compute the list of files that are newer (time-stamp only) or do
&gt; &gt;  not exist in /src/.
&gt; 
&gt; You mean 'cp -u' ? <img src="../gx/smile.png" alt=":)">
</pre>

<p>
Uh-oh! I know I should have read the man page of cp more carefully <img src="../gx/smile.png" alt=":-)">
</p>

<p>
Regards,
</p>

<p>
Kapil.
--
</p>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-odd_system_load_situation">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Ben Okopnik [ben at okopnik.com]
</p>

<p>

</p>
</b><br />
<b>Tue, 11 Jan 2011 13:16:26 -0500</b>
</p>

<p>
On Tue, Jan 11, 2011 at 09:57:57PM +0530, Kapil Hari Paranjape wrote:
</p>

<pre>
&gt; Hello,
&gt; 
&gt; On Tue, 11 Jan 2011, Ben Okopnik wrote:
&gt; &gt; On Tue, Jan 11, 2011 at 07:39:32PM +0530, Kapil Hari Paranjape wrote:
&gt; &gt; &gt;  Step 1. Compute the list of files that are newer (time-stamp only) or do
&gt; &gt; &gt;  not exist in /src/.
&gt; &gt; 
&gt; &gt; You mean 'cp -u' ? <img src="../gx/smile.png" alt=":)">
&gt; 
&gt; Uh-oh! I know I should have read the man page of cp more carefully <img src="../gx/smile.png" alt=":-)">
</pre>

<p>
The man page is (as is often the case with 'info'-centric religious
fanatics^W^Wauthors) somewhat less than informative - e.g., it doesn't
list any of the rich set of arguments to the options. In this case,
'info' is the best source.
</p>

<p>
Couple of nifty 'cp' tricks:
</p>

<p>
<pre class='code'>
# Create date+time-stamped backups for any changed/new files
/bin/cp -ubaS .`date '+%Y%m%d%H%M%S'` file1 file2 file3 ... backup
 
# Create old-style Unix backup files (file~)
for n in *; do cp -bf "$n" "$n"; done
</pre>


<pre>-- 
                       OKOPNIK CONSULTING
        Custom Computing Solutions For Your Business
Expert-led Training | Dynamic, vital websites | Custom programming
  443-250-7895   <a href='http://okopnik.com'>http://okopnik.com</a>   <a href='http://twitter.com/okopnik'>http://twitter.com/okopnik</a>
</pre>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-odd_system_load_situation">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Karl Vogel [vogelke+tag at pobox.com]
</p>

<p>

</p>
</b><br />
<b>Tue, 11 Jan 2011 14:49:11 -0500 (EST)</b>
</p>

<p>
[ Ben, please excuse the CC: I'm not sure mail to "tag" is getting through. ]
</p>


<pre>
&gt;&gt; On Mon, 10 Jan 2011 21:21:19 -0500, 
&gt;&gt; Ben Okopnik &lt;ben at linuxgazette.net&gt; said:
</pre>

<p>
B&gt; I'm running a long-term rsync job (a full backup, after way too long of
B&gt; a hiatus. [...]  Here's the kicker: "top" shows... nothing particularly
B&gt; unusual.  vmstat/iostat report essentially the same story.
</p>

<p>
   I've had the same problem with full backups via rsync.  You might want
   to check the read-ahead setting on your drives -- the default setting is
   usually very conservative:
      root# cat /sys/block/sda/queue/read_ahead_kb
      128
</p>

<p>
   After some fiddling, I found my system sweet spot (2Gb RAM, 2 CPUs) was 8k:
      root# echo 8192 &gt; /sys/block/sda/queue/read_ahead_kb
</p>

<p>
   Your system might expect the setting to be in blocks:
      root# blockdev --getra /dev/sda
      256
      root# blockdev --setra 16384 /dev/sda
      root# blockdev --getra /dev/sda
      16384
</p>

<p>
   Even with these settings, rsync still occasionally slows to a dead crawl
   if the filetree is big enough and I'm doing a full backup.  I've gotten
   faster results doing something like this once, and using rsync after:
</p>

<p>
      # mkdir /tmp/toc /tmp/work
      # cd /directory/to/copy
      # find . -depth -print | split -l500 - /tmp/toc/x
</p>

<p>
   Then copy one batch at a time, using an unprivileged user (bkup) and a
   directory on the destination host that the user can write to:
</p>

<p>
      for file in /tmp/toc/x*; do
          arch=/tmp/work/$file.pax.gz
          pax -wd &lt; $file | gzip -1c &gt; $arch
          logger -t bkup $arch
          su -f bkup -c "scp -c arcfour $arch some.host:/staging/area"
          rm $file $arch
      done
</p>

<p>
   Unpack on some.host:
</p>

<p>
      cd /destination/directory
      for arch in /staging/area/*.pax.gz; do
          gunzip -c $arch | pax -rd -pe &amp;&amp; rm $arch
      done
</p>

<p>
   This is for copies over an insecure network -- if you run rsync plus ssh,
   definitely use the "arcfour" cipher, it's a hell of a lot faster than
   the default.
</p>

<p>
-- 
Karl Vogel                      I don't speak for the USAF or my company
</p>

<p>
Diane, last night I dreamed I was eating a large, tasteless gumdrop, and
awoke to discover I was chewing on one of my foam disposable earplugs.
Perhaps I should consider moderating my nighttime coffee consumption.
                              --FBI Special Agent Dale Cooper, "Twin Peaks"
</p>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-odd_system_load_situation">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Ben Okopnik [ben at linuxgazette.net]
</p>

<p>

</p>
</b><br />
<b>Tue, 11 Jan 2011 16:04:40 -0500</b>
</p>

<p>
On Tue, Jan 11, 2011 at 02:49:11PM -0500, Karl Vogel wrote:
</p>

<pre>
&gt; [ Ben, please excuse the CC: I'm not sure mail to "tag" is getting through. ]
</pre>

<p>
I appreciate the thoughtfulness, actually.
 
</p>

<pre>
&gt; &gt;&gt; On Mon, 10 Jan 2011 21:21:19 -0500, 
&gt; &gt;&gt; Ben Okopnik &lt;ben at linuxgazette.net&gt; said:
&gt; 
&gt; B&gt; I'm running a long-term rsync job (a full backup, after way too long of
&gt; B&gt; a hiatus. [...]  Here's the kicker: "top" shows... nothing particularly
&gt; B&gt; unusual.  vmstat/iostat report essentially the same story.
&gt; 
&gt;    I've had the same problem with full backups via rsync.  You might want
&gt;    to check the read-ahead setting on your drives -- the default setting is
&gt;    usually very conservative:
&gt;       root# cat /sys/block/sda/queue/read_ahead_kb
&gt;       128
&gt; 
&gt;    After some fiddling, I found my system sweet spot (2Gb RAM, 2 CPUs) was 8k:
&gt;       root# echo 8192 &gt; /sys/block/sda/queue/read_ahead_kb
&gt; 
&gt;    Your system might expect the setting to be in blocks:
&gt;       root# blockdev --getra /dev/sda
&gt;       256
&gt;       root# blockdev --setra 16384 /dev/sda
&gt;       root# blockdev --getra /dev/sda
&gt;       16384
</pre>

<p>
Wow. <strong>Significant</strong> improvement, just with those (untuned) values. I just
ran an incremental backup, and LA stayed between 2.5 and 3, with only
minimal latency in program response - and that's with Firefox, Evince,
and 5 xterms up and running. Karl, you're officially awesome. <img src="../gx/smile.png" alt=":)">
</p>

<p>
(BTW, that reminds me - when are you going to write up your "most-common
directory changer" gadget for me? A lot of folks would enjoy it.)
 
</p>

<pre>
&gt;    Even with these settings, rsync still occasionally slows to a dead crawl
&gt;    if the filetree is big enough and I'm doing a full backup.  I've gotten
&gt;    faster results doing something like this once, and using rsync after:
&gt; 
&gt;       # mkdir /tmp/toc /tmp/work
&gt;       # cd /directory/to/copy
&gt;       # find . -depth -print | split -l500 - /tmp/toc/x
&gt; 
&gt;    Then copy one batch at a time, using an unprivileged user (bkup) and a
&gt;    directory on the destination host that the user can write to:
&gt; 
&gt;       for file in /tmp/toc/x*; do
&gt;           arch=/tmp/work/$file.pax.gz
&gt;           pax -wd &lt; $file | gzip -1c &gt; $arch
&gt;           logger -t bkup $arch
&gt;           su -f bkup -c "scp -c arcfour $arch some.host:/staging/area"
&gt;           rm $file $arch
&gt;       done
&gt; 
&gt;    Unpack on some.host:
&gt; 
&gt;       cd /destination/directory
&gt;       for arch in /staging/area/*.pax.gz; do
&gt;           gunzip -c $arch | pax -rd -pe &amp;&amp; rm $arch
&gt;       done
&gt; 
&gt;    This is for copies over an insecure network -- if you run rsync plus ssh,
&gt;    definitely use the "arcfour" cipher, it's a hell of a lot faster than
&gt;    the default.
</pre>

<p>
[grin] You know me, always kibitzing on stuff like this. Besides, I find
tar options so fascinatingly arcane that I'm still looking for the one
where I can send it out to stand on a street corner and earn money for
me while I lay about and enjoy the good life (I'm <strong>sure</strong> it exists; I
just haven't found the right manpage yet.) Meanwhile, I keep running
across stuff I can use. This should automate the above process a bit
more.
</p>

<p>
1) Create a 'send' script in some temp directory. Pick a $DELAY value.
</p>

<p>
<pre class='code'>
$ mkdir /tmp/x
$ cat &lt;&lt;! &gt;/tmp/x
</p>

<pre>
&gt; #!/bin/sh
&gt; 
&gt; ts=`date '+%s%N'`
&gt; # Don't use '-C' (compression) on fast networks
&gt; scp -C -2 -c arcfour /tmp/x/foo.tar some.host:/staging/area/foo$ts.tar
&gt; echo "Chunk $ts sent; sleeping..."
&gt; sleep $DELAY
</pre>
!
</pre>

<p>
2) From now on, all you need is to issue this command in the directory
to be backed up; chunking and delays (per the above script) are built
in. 
</p>

<p>
<pre class='code'>
$ yes|tar -ML $CHUNK_SIZE_in_KB -F /tmp/x/send -cf /tmp/x/foo.tar *
</pre>

<p>
On fast networks, compression just eats up CPU, so '-C' may be
unnecessary.
</p>


<pre>-- 
* Ben Okopnik * Editor-in-Chief, Linux Gazette * <a href='http://LinuxGazette.NET'>http://LinuxGazette.NET</a> *
</pre>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-odd_system_load_situation">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Ben Okopnik [ben at linuxgazette.net]
</p>

<p>

</p>
</b><br />
<b>Tue, 11 Jan 2011 16:20:43 -0500</b>
</p>

<p>
On Tue, Jan 11, 2011 at 04:04:40PM -0500, Benjamin Okopnik wrote:
</p>

<pre>
&gt; 
&gt; 1) Create a 'send' script in some temp directory. Pick a $DELAY value.
&gt; 
&gt; ```
&gt; $ mkdir /tmp/x
&gt; $ cat &lt;&lt;! &gt;/tmp/x
&gt; &gt; #!/bin/sh
&gt; &gt; 
&gt; &gt; ts=`date '+%s%N'`
&gt; &gt; # Don't use '-C' (compression) on fast networks
&gt; &gt; scp -C -2 -c arcfour /tmp/x/foo.tar some.host:/staging/area/foo$ts.tar
&gt; &gt; echo "Chunk $ts sent; sleeping..."
&gt; &gt; sleep $DELAY
&gt; !
&gt; '''
</pre>

<p>
I just realized that I made it sound like "this script has to be in that
temp directory." It doesn't, of course - you can keep it wherever you
like, as long as you use the same temp directory name (or change it in
the script, or make it an option.) Just change the invocation in the
'-F' tar option.
</p>

<p>
Oh - something I want to mention explicitly while I'm thinking about it:
I'm always doing something like "oh, and here's a different way to do
it" here, especially with scripts from people like Henry Grebler and
Karl Vogel; that is <strong>NOT</strong>, by any stretch of imagination, a criticism of
their scripts - in fact, both of these folks are <em>excellent</em> scripters,
and I admire the hell out of their skills. It's because they come up
with ideas that make me go "ooh, OOH!" - for which I owe them much
gratitude. The script is just a wrapper around an idea - and some ideas
are cool enough to get all bouncy about.
</p>


<pre>-- 
* Ben Okopnik * Editor-in-Chief, Linux Gazette * <a href='http://LinuxGazette.NET'>http://LinuxGazette.NET</a> *
</pre>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-odd_system_load_situation">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Raj Shekhar [rajlist2 at rajshekhar.net]
</p>

<p>

</p>
</b><br />
<b>Tue, 11 Jan 2011 14:05:50 -0800</b>
</p>

<p>
In infinite wisdom Ben Okopnik said the following On 1/10/11 6:21 PM:
</p>


<pre>
&gt; Memory usage is reasonable, swap is barely being touched, the CPU is
&gt; spending 3/4 of its time being idle, even the number of context switches
&gt; is very reasonable as compared to the I/O rate. If I saw this on a
&gt; remote machine, I'd figure it was being under-utilized. :\
</pre>

<p>
Have you tried doing an 'strace -c xterm' and checking which syscall 
takes the most amount of time?  That can usually point you in the right 
direction.
</p>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-odd_system_load_situation">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Ben Okopnik [ben at linuxgazette.net]
</p>

<p>

</p>
</b><br />
<b>Mon, 24 Jan 2011 22:21:29 -0500</b>
</p>

<p>
Whoops, just spotted this (digging out my inbox after a bit of a
hiatus):
</p>

<p>
On Tue, Jan 11, 2011 at 02:05:50PM -0800, Raj Shekhar wrote:
</p>

<pre>
&gt; In infinite wisdom Ben Okopnik said the following On 1/10/11 6:21 PM:
&gt; 
&gt; &gt;Memory usage is reasonable, swap is barely being touched, the CPU is
&gt; &gt;spending 3/4 of its time being idle, even the number of context switches
&gt; &gt;is very reasonable as compared to the I/O rate. If I saw this on a
&gt; &gt;remote machine, I'd figure it was being under-utilized. :\
&gt; 
&gt; Have you tried doing an 'strace -c xterm' and checking which syscall
&gt; takes the most amount of time?  That can usually point you in the
&gt; right direction.
</pre>

<p>
Why xterm? The problem was being caused by rsync. Besides, in situations
like this one, strace is the perfect demonstration of the Heisenberg
principle: it would slow rsync down by a huge factor so you'd never be
sure whether it was rsync or strace that was causing the largest
slowdown.
</p>

<p>
It's a fairly easy and reasonable guess that it wasn't getting bogged
down in the network end: I can certainly transfer things faster than
that via Ethernet and not get overloaded. It's also not disk I/O - same
reasoning. Something on the CPU end, possibly rsync calculating all the
necessary bits - transferring things via 'tar|ssh' didn't slam it quite
as hard - plus a bit of disk read priority tuning. Karl's approach,
including testing readahead settings for future reference, made a lot of
sense and gave some improvement.
</p>

<p>
Overall, I think the answer is that you need some decent horsepower to
run big transfers (and even more so if you're doing it via rsync.)
That's a really good factor to be aware of.
</p>


<pre>-- 
* Ben Okopnik * Editor-in-Chief, Linux Gazette * <a href='http://LinuxGazette.NET'>http://LinuxGazette.NET</a> *
</pre>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-odd_system_load_situation">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Mulyadi Santosa [mulyadi.santosa at gmail.com]
</p>

<p>

</p>
</b><br />
<b>Tue, 25 Jan 2011 11:32:51 +0700</b>
</p>

<p>
On Tue, Jan 25, 2011 at 10:21, Ben Okopnik &lt;ben at linuxgazette.net&gt; wrote:
</p>

<pre>
&gt; Overall, I think the answer is that you need some decent horsepower to
&gt; run big transfers (and even more so if you're doing it via rsync.)
&gt; That's a really good factor to be aware of.
</pre>

<p>
Just crossing my mind, do you enable tcp offloading in your ethernet
card (if it is supported, of course)?
</p>


<p>
-- 
regards,
</p>

<p>
Mulyadi Santosa
Freelance Linux trainer and consultant
</p>

<p>
blog: the-hydra.blogspot.com
training: mulyaditraining.blogspot.com
</p>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-odd_system_load_situation">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Ben Okopnik [ben at linuxgazette.net]
</p>

<p>

</p>
</b><br />
<b>Mon, 24 Jan 2011 23:45:12 -0500</b>
</p>

<p>
On Tue, Jan 25, 2011 at 11:32:51AM +0700, Mulyadi Santosa wrote:
</p>

<pre>
&gt; On Tue, Jan 25, 2011 at 10:21, Ben Okopnik &lt;ben at linuxgazette.net&gt; wrote:
&gt; &gt; Overall, I think the answer is that you need some decent horsepower to
&gt; &gt; run big transfers (and even more so if you're doing it via rsync.)
&gt; &gt; That's a really good factor to be aware of.
&gt; 
&gt; Just crossing my mind, do you enable tcp offloading in your ethernet
&gt; card (if it is supported, of course)?
</pre>

<p>
Not relevant to the original question, of course, since I'm just backing
up to a USB-connected external drive, but - that would take a
specially-built NIC, right? I've just got an Atheros AR8132/L1c in my
little netbook; I doubt that it's supported. Not that I ever have
traffic across it that would require anything like that.
</p>


<pre>-- 
* Ben Okopnik * Editor-in-Chief, Linux Gazette * <a href='http://LinuxGazette.NET'>http://LinuxGazette.NET</a> *
</pre>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-odd_system_load_situation">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Mulyadi Santosa [mulyadi.santosa at gmail.com]
</p>

<p>

</p>
</b><br />
<b>Tue, 25 Jan 2011 12:04:20 +0700</b>
</p>

<p>
On Tue, Jan 25, 2011 at 11:45, Ben Okopnik &lt;ben at linuxgazette.net&gt; wrote:
</p>

<pre>
&gt; Not relevant to the original question, of course, since I'm just backing
&gt; up to a USB-connected external drive,
</pre>

<p>
c**p, sorry, I forgot that....pass :D
</p>


<p>
-- 
regards,
</p>

<p>
Mulyadi Santosa
Freelance Linux trainer and consultant
</p>

<p>
blog: the-hydra.blogspot.com
training: mulyaditraining.blogspot.com
</p>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-odd_system_load_situation">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Ben Okopnik [ben at linuxgazette.net]
</p>

<p>

</p>
</b><br />
<b>Tue, 25 Jan 2011 00:15:12 -0500</b>
</p>

<p>
On Tue, Jan 25, 2011 at 12:04:20PM +0700, Mulyadi Santosa wrote:
</p>

<pre>
&gt; On Tue, Jan 25, 2011 at 11:45, Ben Okopnik &lt;ben at linuxgazette.net&gt; wrote:
&gt; &gt; Not relevant to the original question, of course, since I'm just backing
&gt; &gt; up to a USB-connected external drive,
&gt; 
&gt; c**p, sorry, I forgot that....pass :D
</pre>

<p>
No worries - it's all good technical knowledge, right? Besides, it's
actually pretty cool to hear about all the stuff you know. You sound
really knowledgeable about bits where I have little or no clue - all the
kernel internals, for example. Great to have that on the list.
</p>


<pre>-- 
* Ben Okopnik * Editor-in-Chief, Linux Gazette * <a href='http://LinuxGazette.NET'>http://LinuxGazette.NET</a> *
</pre>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-odd_system_load_situation">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Mulyadi Santosa [mulyadi.santosa at gmail.com]
</p>

<p>

</p>
</b><br />
<b>Wed, 26 Jan 2011 01:02:46 +0700</b>
</p>

<p>
Hi Ben...
</p>

<p>
On Tue, Jan 25, 2011 at 12:15, Ben Okopnik &lt;ben at linuxgazette.net&gt; wrote:
</p>

<pre>
&gt; No worries - it's all good technical knowledge, right? Besides, it's
&gt; actually pretty cool to hear about all the stuff you know. You sound
&gt; really knowledgeable about bits where I have little or no clue - all the
&gt; kernel internals, for example. Great to have that on the list.
</pre>

<p>
Thanks a lot Ben, I recall the motivation I join TAG is to share ..and
that's what I do and I hope I still can do. ..but...
</p>

<p>
people, I don't want to ruin your day or asking for great care or
anything alike...but maybe in near future maybe I couldn't contribute
as much as I do now. SInce I regularly under epilepsy medication, the
nerve pills (that's how I call it) slowly chew out my thinking
ability. I get easily forget things and sometimes I hardly focus on
something.
</p>

<p>
So now you all know that I am not so healthy....and with this e-mail,
I want to say "sorry" if in near future I can't contribute like I did
today....but I hope what I had done have meanings for you all.
</p>

<p>
-- 
regards,
</p>

<p>
Mulyadi Santosa
Freelance Linux trainer and consultant
</p>

<p>
blog: the-hydra.blogspot.com
training: mulyaditraining.blogspot.com
</p>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-odd_system_load_situation">Back</a><hr width="50%" align="left" /><p><br /></p><p>
<b><p>
Ben Okopnik [ben at okopnik.com]
</p>

<p>

</p>
</b><br />
<b>Wed, 26 Jan 2011 22:20:19 -0500</b>
</p>

<p>
Hi, Mulyadi -
</p>

<p>
On Wed, Jan 26, 2011 at 01:02:46AM +0700, Mulyadi Santosa wrote:
</p>

<pre>
&gt; 
&gt; people, I don't want to ruin your day or asking for great care or
&gt; anything alike...but maybe in near future maybe I couldn't contribute
&gt; as much as I do now. SInce I regularly under epilepsy medication, the
&gt; nerve pills (that's how I call it) slowly chew out my thinking
&gt; ability. I get easily forget things and sometimes I hardly focus on
&gt; something.
</pre>

<p>
Man, that's really rough. You and I have talked about it a bit... I can
only hope that things get better for you - perhaps you can see about
getting a different type of medicine, or something that will counteract
that effect. The main thing, the mot important thing, is that you never,
ever give up on yourself. Whatever ability you have is <strong>yours</strong>, to be
used to its fullest, to bring you whatever power and joy that can be
extracted out of life. Fight for that every moment that you can, however
tough the circumstances may be. I know that you do anyway; this post of
yours is an example of your courage and your sense of responsibility
toward others - but I just want to give you what encouragement I can,
because I know how important it can be.
</p>

<p>
I've been going through some fairly harsh life stuff myself this past
year, so staying focused on that upward climb is an ever-present
challenge for me, every minute of the day. This awareness is at least a
small bit of positive energy that I can share.
</p>


<pre>
&gt; So now you all know that I am not so healthy....and with this e-mail,
&gt; I want to say "sorry" if in near future I can't contribute like I did
&gt; today....but I hope what I had done have meanings for you all.
</pre>

<p>
Thanks for everything you have contributed, Mulyadi. You helped me with
this last question that I had; I'm sure that what you've given here has
helped other people as well (pretty much the entire point of LG, that.)
You know my email address, and we cross paths in other places; I can
always lend an ear, at least.
</p>


<p>
Ben
<pre>-- 
                       OKOPNIK CONSULTING
        Custom Computing Solutions For Your Business
Expert-led Training | Dynamic, vital websites | Custom programming
  443-250-7895   <a href='http://okopnik.com'>http://okopnik.com</a>   <a href='http://twitter.com/okopnik'>http://twitter.com/okopnik</a>
</pre>

<p>

</p>
<br /><a href="#top">Top</a>&nbsp;&nbsp;&nbsp;&nbsp;<a href="../../lg_mail.html#mb-odd_system_load_situation">Back</a><hr width="50%" align="left" /><p><br /></p></div>
</body>
</html>